<!-- POLYFILL PARA DRAG AND DROP NO CELULAR -->
<script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

<!-- ESTILOS GERAIS -->
<style>
    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    ::-webkit-scrollbar-thumb { background: #3498db; border-radius: 3px; }
    
    /* GERAIS */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); 
        z-index: 11000; display: none; justify-content: center; align-items: center; 
        animation: fadeIn 0.2s ease-out; font-family: 'Rajdhani', sans-serif;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content { 
        background: #0f172a; width: 95%; max-width: 500px; 
        border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); 
        box-shadow: 0 20px 50px rgba(0,0,0,0.9); color: #e2e8f0; 
        overflow: hidden; display: flex; flex-direction: column; max-height: 90vh;
    }

    .modal-header {
        padding: 15px 20px; background: rgba(15, 23, 42, 0.95);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { margin: 0; font-family: 'Press Start 2P'; font-size: 0.8rem; color: #f1c40f; letter-spacing: 1px; }
    .close-btn { background: none; border: none; color: #94a3b8; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .close-btn:hover { color: #e74c3c; transform: scale(1.1); }

    .modal-body { padding: 20px; overflow-y: auto; flex: 1; position: relative; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }

    /* BOT√ïES FLUTUANTES */
    .float-container { position: fixed; right: 20px; bottom: 100px; z-index: 9999; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
    .float-btn { 
        width: 55px; height: 55px; border-radius: 50%; 
        background: #1e293b; border: 2px solid rgba(255,255,255,0.1); 
        color: #f1c40f; font-size: 1.4rem; cursor: pointer; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; 
        display: flex; align-items: center; justify-content: center;
        position: relative;
    }
    .float-btn:hover { transform: scale(1.1); border-color: #f1c40f; }
    .float-menu-items { display: none; flex-direction: column-reverse; gap: 12px; }
    .float-menu-items.show { display: flex; animation: slideUp 0.3s; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* √çCONES PIXELADOS 17x17px */
    .pixel-icon { 
        width: 17px !important; 
        height: 17px !important; 
        min-width: 17px;
        image-rendering: pixelated; 
        object-fit: contain;
    }

    /* CARDS DE MONSTRO */
    .poke-card { 
        background: linear-gradient(135deg, #1e293b, #0f172a); 
        border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 8px; padding: 10px; margin-bottom: 10px; 
        display: flex; align-items: center; gap: 15px; transition: 0.2s;
        position: relative; overflow: hidden;
    }
    .poke-card.leader { border: 1px solid #f1c40f; background: linear-gradient(135deg, #2c2005, #0f172a); }
    .poke-card.leader::after { content: 'L√çDER'; position: absolute; top: 5px; right: 5px; font-size: 0.5rem; color: #f1c40f; font-family: 'Press Start 2P'; opacity: 0.5; }
    
    .poke-img-container { 
        width: 54px; height: 54px; 
        background: rgba(0,0,0,0.3); border-radius: 8px; 
        display: flex; align-items: center; justify-content: center; 
        border: 1px solid rgba(255,255,255,0.1); 
    }
    .poke-img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    
    .poke-details { flex: 1; }
    .poke-name { font-weight: bold; color: #fff; font-size: 0.95rem; margin-bottom: 4px; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
    
    .stat-bar-box { width: 100%; height: 6px; background: #000; border-radius: 3px; margin-top: 4px; overflow: hidden; position: relative; }
    .stat-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
    .hp-fill { background: linear-gradient(90deg, #2ecc71, #27ae60); }
    .xp-fill { background: linear-gradient(90deg, #3498db, #2980b9); }
    .stat-label { font-size: 0.6rem; color: #aaa; display: flex; justify-content: space-between; margin-top: 2px; font-weight: bold; }

    .card-actions { display: flex; gap: 8px; }
    .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; font-size: 1.1rem; cursor: pointer; padding: 6px 10px; transition: 0.2s; color: #ccc; }
    .icon-btn:hover { background: rgba(255,255,255,0.15); color: #fff; border-color: #fff; }

    /* --- PC SYSTEM (MOBILE FIX & DESIGN) --- */
    #modalPC .modal-content { max-width: 650px; background: #080808; border: 1px solid #333; }
    
    .pc-layout { display: flex; flex-direction: column; height: 100%; gap: 15px; padding: 5px; }
    
    .pc-box-header { 
        font-family: 'Rajdhani'; font-weight: 700; font-size: 1rem; color: #fff; 
        margin-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-end;
        background: linear-gradient(90deg, #1e293b, transparent); padding: 5px 10px; border-left: 4px solid #3498db;
    }
    
    .pc-storage-area {
        background: #0f1115;
        border: 2px solid #222;
        border-radius: 4px;
        padding: 10px;
        display: grid;
        grid-template-columns: repeat(6, 1fr); 
        gap: 8px;
        height: 230px; 
        overflow-y: scroll; /* For√ßa o scroll no mobile */
        -webkit-overflow-scrolling: touch; /* Suaviza no iOS */
        overflow-x: hidden;
        transition: border-color 0.2s;
    }
    .pc-storage-area.drag-over { border-color: #f1c40f; background: #131313; }

    .pc-team-area {
        height: 90px;
        background: #0f1510;
        border: 2px solid #1a2e1a;
        border-radius: 4px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: border-color 0.2s;
        overflow-x: auto;
    }
    .pc-team-area.drag-over { border-color: #f1c40f; background: #131313; }

    .pc-slot {
        aspect-ratio: 1/1;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 4px;
        display: flex; flex-direction: column;
        align-items: center; justify-content: center;
        cursor: grab;
        position: relative;
        touch-action: none; /* Importante para o DragDropTouch funcionar */
    }
    .pc-slot:hover { background: rgba(255,255,255,0.08); border-color: #777; }
    .pc-slot:active { cursor: grabbing; }
    .pc-slot img { width: 40px; height: 40px; image-rendering: pixelated; pointer-events: none; }
    .pc-slot .lvl-badge { 
        position: absolute; bottom: 2px; right: 2px; 
        font-size: 0.6rem; background: rgba(0,0,0,0.8); color: #fff; 
        padding: 1px 3px; border-radius: 2px; pointer-events: none; font-family: monospace;
    }
    .pc-slot.dragging { opacity: 0.3; border: 1px dashed #f1c40f; }

    /* --- SKILL CARDS (DESIGN PRO COM CORES) --- */
    .skills-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    
    .skill-card {
        border: 1px solid rgba(255,255,255,0.1);
        border-left-width: 4px;
        border-radius: 6px;
        padding: 12px 10px;
        cursor: pointer;
        transition: 0.2s;
        display: flex; flex-direction: column; justify-content: center;
        position: relative; overflow: hidden;
        background: #111;
    }
    .skill-card:hover { transform: translateX(3px); filter: brightness(1.2); }
    
    /* Cores por Tipo */
    .type-fire { border-left-color: #e74c3c; background: linear-gradient(90deg, rgba(231, 76, 60, 0.1), transparent); }
    .type-water { border-left-color: #3498db; background: linear-gradient(90deg, rgba(52, 152, 219, 0.1), transparent); }
    .type-grass { border-left-color: #2ecc71; background: linear-gradient(90deg, rgba(46, 204, 113, 0.1), transparent); }
    .type-electric { border-left-color: #f1c40f; background: linear-gradient(90deg, rgba(241, 196, 15, 0.1), transparent); }
    .type-normal { border-left-color: #95a5a6; background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), transparent); }
    .type-poison { border-left-color: #9b59b6; background: linear-gradient(90deg, rgba(155, 89, 182, 0.1), transparent); }
    .type-ground { border-left-color: #d35400; background: linear-gradient(90deg, rgba(211, 84, 0, 0.1), transparent); }
    .type-flying { border-left-color: #ecf0f1; background: linear-gradient(90deg, rgba(236, 240, 241, 0.1), transparent); }
    .type-psychic { border-left-color: #e056fd; background: linear-gradient(90deg, rgba(224, 86, 253, 0.1), transparent); }
    .type-bug { border-left-color: #badc58; background: linear-gradient(90deg, rgba(186, 220, 88, 0.1), transparent); }
    .type-rock { border-left-color: #7f8c8d; background: linear-gradient(90deg, rgba(127, 140, 141, 0.1), transparent); }
    .type-ghost { border-left-color: #4834d4; background: linear-gradient(90deg, rgba(72, 52, 212, 0.1), transparent); }
    .type-dragon { border-left-color: #30336b; background: linear-gradient(90deg, rgba(48, 51, 107, 0.1), transparent); }
    .type-steel { border-left-color: #95a5a6; background: linear-gradient(90deg, rgba(149, 165, 166, 0.1), transparent); }
    .type-fairy { border-left-color: #ff9ff3; background: linear-gradient(90deg, rgba(255, 159, 243, 0.1), transparent); }
    .type-dark { border-left-color: #2d3436; background: linear-gradient(90deg, rgba(45, 52, 54, 0.3), transparent); }

    /* Estado Equipado */
    .skill-card.equipped {
        box-shadow: inset 0 0 10px rgba(255,255,255,0.1);
        border-color: #fff;
    }
    .skill-card.equipped::after {
        content: '‚úî';
        position: absolute; top: 50%; right: 10px; transform: translateY(-50%);
        font-size: 1rem; color: #fff;
    }

    .skill-name { color: #eee; font-weight: bold; font-family: 'Rajdhani'; font-size: 1rem; text-transform: uppercase; text-shadow: 1px 1px 0 #000; }
    .skill-type { color: #aaa; font-size: 0.65rem; font-family: monospace; margin-top: 2px; text-transform: uppercase; }

    /* LOJA E ITENS */
    .shop-item { background: #1e293b; border-radius: 10px; padding: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.1); }
    .qty-input { width: 50px; background: #000; border: 1px solid #444; color: white; padding: 5px; border-radius: 5px; text-align: center; }
    .btn-success { background: #2ecc71; color: #000; border:none; padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer; }

    /* DEX LOCKED */
    .locked-sprite { filter: brightness(0) contrast(100%); opacity: 0.4; }
    .dex-icon.locked { border-color: #333 !important; background: rgba(0,0,0,0.3) !important; }
</style>

<!-- MENU FLUTUANTE -->
<div class="float-container" id="floatMenu">
    <div id="menuItems" class="float-menu-items">
        <button class="float-btn" onclick="openBag()" title="Mochila de Itens" style="color:#e67e22; border-color:#e67e22;">üéí</button>
        <button class="float-btn" onclick="openPokemon()" title="Meus Monstros" style="color:#fff; border-color:#aaa;">
            <img src="/uploads/catchcube.gif" class="pixel-icon" style="width:24px; height:24px;">
        </button>
        <button class="float-btn" onclick="openPC()" title="PC de Armazenamento" style="color:#33ff33; border-color:#33ff33;">üíª</button>
        <button class="float-btn" onclick="openPokedex()" title="Dex" style="color:#00d2ff; border-color:#00d2ff;">üìö</button>
    </div>
    <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
</div>

<!-- MODAL PC (DRAG & DROP COM SCROLL) -->
<div class="modal-overlay" id="modalPC">
    <div class="modal-content">
        <div class="modal-header">
            <h2>PC STORAGE</h2>
            <button class="close-btn" onclick="closeModal('modalPC')">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 0;">
            <div class="pc-layout">
                <!-- CAIXA (PC) - TOPO -->
                <div>
                    <div class="pc-box-header">
                        <span>üì¶ BOX 01</span> 
                        <span style="color:#aaa; font-size:0.6rem; font-family:'Roboto';">Arrastar para mover</span>
                    </div>
                    <div class="pc-storage-area" id="pcStorageArea" ondrop="handleDrop(event, 'pc')" ondragover="handleDragOver(event)">
                        <!-- Slots gerados via JS -->
                    </div>
                </div>

                <!-- TIME (ACTIVE) - RODAP√â -->
                <div style="margin-top: auto;">
                    <div class="pc-box-header" style="border-left-color: #2ecc71;">
                        <span style="color:#2ecc71;">‚ö° EQUIPE ATIVA</span>
                    </div>
                    <div class="pc-team-area" id="pcTeamArea" ondrop="handleDrop(event, 'team')" ondragover="handleDragOver(event)">
                        <!-- Slots gerados via JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL MONSTROS (TIME & XP & SKILLS) -->
<div class="modal-overlay" id="modalPokemon">
    <div class="modal-content">
        <div class="modal-header">
            <h2>MEUS MONSTROS</h2>
            <button class="close-btn" onclick="closeModal('modalPokemon')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="pokemonListContent">Carregando...</div>
        </div>
    </div>
</div>

<!-- MODAL MOCHILA (APENAS ITENS) -->
<div class="modal-overlay" id="modalBag">
    <div class="modal-content">
        <div class="modal-header">
            <h2>MOCHILA</h2>
            <button class="close-btn" onclick="closeModal('modalBag')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="bagItemsContent">Carregando...</div>
        </div>
    </div>
</div>

<!-- MODAL LOJA -->
<div class="modal-overlay" id="modalShop">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color:#f1c40f">MERCADO</h2>
            <button class="close-btn" onclick="closeModal('modalShop')">‚úï</button>
        </div>
        <div class="modal-body">
            <div style="text-align:center; margin-bottom:20px; padding:10px; background:rgba(241,196,15,0.1); border-radius:8px; border:1px solid #f1c40f; color:#f1c40f;">
                Saldo: <strong>$ <span id="shopBalance">0</span></strong>
            </div>
            <div class="shop-item">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img src="/uploads/catchcube.gif" class="pixel-icon">
                    <div><div style="font-weight:bold;">CatchCube</div><div style="font-size:0.7rem; color:#aaa;">Captura monstros</div></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <input id="buyPokeballQty" type="number" class="qty-input" value="1" min="1">
                    <button onclick="buyItem('pokeball')" class="btn-success">$50</button>
                </div>
            </div>
            <div class="shop-item">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="font-size:1.5rem;">üç¨</div>
                    <div><div style="font-weight:bold;">Rare Candy</div><div style="font-size:0.7rem; color:#aaa;">+1 N√≠vel</div></div>
                </div>
                <div style="display:flex; gap:5px;">
                    <input id="buyRareQty" type="number" class="qty-input" value="1" min="1">
                    <button onclick="buyItem('rareCandy')" class="btn-success" style="background:#3498db;">$2000</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DEX -->
<div class="modal-overlay" id="modalPokedex">
    <div class="modal-content" style="max-width:800px; height:600px; flex-direction:row;">
        <button class="close-btn" onclick="closeModal('modalPokedex')" style="position:absolute; top:10px; right:10px; z-index:100;">‚úï</button>
        <div style="width:35%; border-right:1px solid #333; display:flex; flex-direction:column; background: #0b1120;">
            <div style="padding:10px; border-bottom:1px solid #333;"><input type="text" id="dexSearch" placeholder="Buscar..." onkeyup="filterDex()" style="width:100%; padding:8px; background:#000; border:1px solid #333; color:#fff; border-radius:5px;"></div>
            <div id="dexGrid" style="flex:1; overflow-y:auto; padding:10px; display:grid; grid-template-columns:repeat(auto-fill, minmax(60px, 1fr)); gap:5px; align-content: flex-start;"></div>
        </div>
        <div id="dexDetailsView" style="flex:1; padding:20px; overflow-y:auto; background:radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); position: relative;">
            <div style="text-align:center; color:#555; margin-top:50px;">Selecione uma criatura.</div>
        </div>
    </div>
</div>

<script>
    // --- MAPA DE TIPOS (PARA CORES DOS ATAQUES) ---
    // Adicione aqui os IDs dos ataques e seus tipos
    const MOVE_TYPES = {
        'tackle': 'normal', 'scratch': 'normal', 'bite': 'dark',
        'ember': 'fire', 'flamethrower': 'fire',
        'watergun': 'water', 'bubble': 'water',
        'vinewhip': 'grass', 'razorleaf': 'grass',
        'thundershock': 'electric', 'thunderbolt': 'electric',
        'poisonsting': 'poison', 'sludge': 'poison',
        'peck': 'flying', 'gust': 'flying',
        'confusion': 'psychic', 'psybeam': 'psychic',
        'rockthrow': 'rock', 'earthquake': 'ground',
        'shadowball': 'ghost', 'ironclaw': 'steel'
    };

    function getMoveType(moveId) {
        return MOVE_TYPES[moveId] || 'normal';
    }

    // --- UTILS & UI ---
    let currentMonId = null;
    function toggleFloatMenu() { document.getElementById('menuItems').classList.toggle('show'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;

    // --- PC SYSTEM (DRAG & DROP) ---
    async function openPC() { document.getElementById('modalPC').style.display='flex'; loadPCData(); }
    
    async function loadPCData() {
        const storageDiv = document.getElementById('pcStorageArea'); 
        const teamDiv = document.getElementById('pcTeamArea');
        storageDiv.innerHTML = '<span style="color:#555; grid-column:span 6; text-align:center;">Carregando...</span>'; 
        teamDiv.innerHTML = '...';
        try {
            const res = await fetch('/api/pc?userId=<%= user._id %>'); 
            const data = await res.json(); 
            renderDragPC(data.team, data.pc);
        } catch(e) { console.error(e); }
    }

    function renderDragPC(team, pc) {
        const createDragSlot = (p, from) => `
            <div class="pc-slot" draggable="true" ondragstart="handleDragStart(event, '${p.instanceId}', '${from}')">
                <img src="${_resImg(p.sprite)}">
                <div class="lvl-badge">Lv.${p.level}</div>
            </div>`;
        
        document.getElementById('pcTeamArea').innerHTML = team.map(p => createDragSlot(p, 'team')).join('');
        document.getElementById('pcStorageArea').innerHTML = pc.map(p => createDragSlot(p, 'pc')).join('');
    }

    function handleDragStart(ev, pokeId, source) {
        ev.dataTransfer.setData("text/plain", JSON.stringify({ pokeId, source }));
        ev.currentTarget.classList.add('dragging');
    }

    function handleDragOver(ev) {
        ev.preventDefault();
        ev.currentTarget.classList.add('drag-over');
    }

    document.getElementById('pcStorageArea').addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));
    document.getElementById('pcTeamArea').addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));

    async function handleDrop(ev, targetContainer) {
        ev.preventDefault();
        ev.currentTarget.classList.remove('drag-over');
        
        const dataRaw = ev.dataTransfer.getData("text/plain");
        if(!dataRaw) return;
        
        const { pokeId, source } = JSON.parse(dataRaw);
        if (source === targetContainer) return; 

        try {
            const res = await fetch('/api/pc/move', { 
                method: 'POST', 
                headers: {'Content-Type':'application/json'}, 
                body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: pokeId, from: source, to: targetContainer }) 
            });
            const data = await res.json(); 
            if(data.success) loadPCData(); 
            else alert(data.error);
        } catch(e) { alert("Erro ao mover."); }
    }

    // --- MONSTER LIST ---
    async function openPokemon() { 
        document.getElementById('modalPokemon').style.display='flex'; 
        const content = document.getElementById('pokemonListContent'); content.innerHTML = 'Carregando...'; 
        try { const res = await fetch('/api/me?userId=<%= user._id %>'); const data = await res.json(); renderPokemonList(data.team); } catch(e) { content.innerHTML = 'Erro.'; } 
    }

    function renderPokemonList(team) {
        const content = document.getElementById('pokemonListContent'); 
        if (!team || team.length === 0) { content.innerHTML = '<p style="text-align:center; color:#777;">Sem monstros na equipe.</p>'; return; }
        
        let html = '';
        team.forEach((p, index) => {
            const hpPct = Math.min(100, (p.hp / p.maxHp) * 100);
            const xpPct = (p.xp && p.xpToNext) ? Math.min(100, (p.xp / p.xpToNext) * 100) : 0;
            
            html += `
            <div class="poke-card ${index === 0 ? 'leader' : ''}">
                <div class="poke-img-container"><img src="${_resImg(p.sprite)}" class="poke-img"></div>
                <div class="poke-details">
                    <div class="poke-name">${p.name} <span style="font-size:0.7rem; color:#f1c40f;">Lv.${p.level}</span></div>
                    
                    <div class="stat-label"><span>HP</span> <span>${p.hp}/${p.maxHp}</span></div>
                    <div class="stat-bar-box"><div class="stat-fill hp-fill" style="width:${hpPct}%"></div></div>
                    
                    <div class="stat-label"><span>XP</span> <span>${p.xp}/${p.xpToNext}</span></div>
                    <div class="stat-bar-box" style="height:6px; background:#111;"><div class="stat-fill xp-fill" style="width:${xpPct}%"></div></div>
                </div>
                <div class="card-actions" style="flex-direction:column;">
                    ${index !== 0 ? `<button onclick="setLead('${p.instanceId}')" class="icon-btn" title="Tornar L√≠der">‚≠ê</button>` : `<span title="L√≠der Atual" style="font-size:1.2rem; text-align:center;">üëë</span>`}
                    <button onclick="showMoveEditor('${p.instanceId}', '${p.name}', ${JSON.stringify(p.moves).replace(/"/g, '&quot;')}, ${JSON.stringify(p.learnedMoves).replace(/"/g, '&quot;')})" class="icon-btn" title="Habilidades">‚öîÔ∏è</button>
                    <button onclick="abandonPokemon('${p.instanceId}')" class="icon-btn" title="Libertar" style="color:#e74c3c">üóëÔ∏è</button>
                </div>
            </div>`;
        });
        content.innerHTML = html;
    }

    // --- MOVE EDITOR (ATUALIZADO COM CORES) ---
    function showMoveEditor(id, name, equipped, learned) {
        currentMonId = id;
        const pool = (learned && learned.length > 0) ? learned : equipped;
        
        let html = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">
                <h3 style="color:#3498db; margin:0;">${name}</h3>
                <span style="font-size:0.7rem; color:#777;">Selecione at√© 4</span>
            </div>
            <div class="skills-grid">`; 
        
        pool.forEach(moveId => { 
            const isEquipped = equipped.includes(moveId); 
            const type = getMoveType(moveId);
            const cardClass = isEquipped ? `skill-card equipped type-${type}` : `skill-card type-${type}`; 
            
            html += `
                <div onclick="toggleMove('${moveId}', this)" class="${cardClass}" data-id="${moveId}">
                    <div class="skill-name">${moveId}</div>
                    <div class="skill-type">${type}</div>
                </div>`; 
        }); 
        
        html += `</div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="saveMoves()" class="btn-success" style="flex:2; padding:12px; font-size:1rem;">SALVAR</button>
                <button onclick="openPokemon()" style="flex:1; background:transparent; border:1px solid #555; color:#aaa; border-radius:6px; cursor:pointer;">VOLTAR</button>
            </div>`; 
        
        document.getElementById('pokemonListContent').innerHTML = html; 
    }

    function toggleMove(moveId, el) {
        const isEquipped = el.classList.contains('equipped');
        const equippedCount = document.querySelectorAll('.skill-card.equipped').length;
        
        if (isEquipped) { 
            if (equippedCount <= 1) return alert('M√≠nimo 1 habilidade!'); 
            el.classList.remove('equipped');
        } else { 
            if (equippedCount >= 4) return alert('M√°ximo 4 habilidades!'); 
            el.classList.add('equipped');
        }
    }

    async function saveMoves() {
        const cards = document.querySelectorAll('.skill-card.equipped'); 
        let finalMoves = [];
        cards.forEach(c => finalMoves.push(c.getAttribute('data-id')));
        
        const res = await fetch('/api/equip-move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: currentMonId, moves: finalMoves }) }); 
        const data = await res.json(); 
        if(data.success) openPokemon(); else alert(data.error);
    }

    // --- BAG (ITENS 17px) ---
    async function openBag() {
        document.getElementById('modalBag').style.display='flex';
        const content = document.getElementById('bagItemsContent'); content.innerHTML = 'Carregando...';
        try { const res = await fetch('/api/me?userId=<%= user._id %>'); const data = await res.json(); renderBagItems(data); } catch(e) { content.innerHTML = 'Erro.'; }
    }

    function renderBagItems(data) {
        document.getElementById('bagItemsContent').innerHTML = `
            <div class="poke-card" style="display:block;">
                <h3 style="color:#e2e8f0; margin-bottom:15px; font-size:0.9rem; text-transform:uppercase;">Invent√°rio</h3>
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px;">
                    <span style="display:flex; align-items:center; gap:10px;"><img src="/uploads/catchcube.gif" class="pixel-icon"> CatchCubes</span> 
                    <strong style="color:#fff; font-size:1.1rem;">${data.pokeballs || 0}</strong>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="display:flex; align-items:center; gap:10px;"><span style="font-size:1.4rem; line-height:1;">üç¨</span> Rare Candy</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong style="color:#fff; font-size:1.1rem;">${data.rareCandy || 0}</strong>
                        ${(data.rareCandy > 0) ? `<button onclick="startRareCandySelection()" class="btn-success" style="padding:5px 10px; font-size:0.7rem;">USAR</button>` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    async function startRareCandySelection() {
        closeModal('modalBag');
        openPokemon(); 
        setTimeout(() => {
            alert("Selecione um Monstro para dar o doce.");
            const cards = document.querySelectorAll('#pokemonListContent .poke-card');
            cards.forEach(card => {
                card.style.border = '2px dashed #f1c40f';
                card.style.cursor = 'pointer';
                const actions = card.querySelector('.card-actions');
                if(actions) actions.style.display = 'none';
                
                const html = card.innerHTML;
                const match = html.match(/setLead\('([^']+)'\)/) || html.match(/abandonPokemon\('([^']+)'\)/) || html.match(/showMoveEditor\('([^']+)'/);
                if(match) {
                    const pokeId = match[1];
                    card.onclick = () => applyRareCandy(pokeId);
                }
            });
        }, 500);
    }

    async function applyRareCandy(pokeId) {
        try {
            const res = await fetch('/api/use-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) });
            const data = await res.json();
            if(data.success) {
                alert(data.evolved ? 'Sua criatura evoluiu!' : 'N√≠vel subiu!');
                openPokemon(); 
            } else { alert(data.error); }
        } catch(e) {}
    }

    // --- MANAGE POKEMON ---
    async function setLead(pokeId) {
        const res = await fetch('/api/set-lead', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: pokeId }) });
        const data = await res.json();
        if(data.success) openPokemon();
    }
    async function abandonPokemon(instanceId) { 
        if(!confirm('Tem certeza? Isso n√£o pode ser desfeito.')) return; 
        const res = await fetch('/api/abandon-pokemon', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: instanceId }) }); 
        const data = await res.json(); 
        if(data.success) openPokemon(); else alert(data.error);
    }

    // --- LOJA ---
    async function openShop() {
        document.getElementById('modalShop').style.display = 'flex';
        try { const res = await fetch('/api/me?userId=<%= user._id %>'); const data = await res.json(); document.getElementById('shopBalance').innerText = data.money || 0; } catch(e){}
    }
    async function buyItem(item) {
        const inputId = item === 'pokeball' ? 'buyPokeballQty' : 'buyRareQty';
        const qty = document.getElementById(inputId).value;
        const res = await fetch('/api/buy-item', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', itemId: item, qty }) });
        const data = await res.json();
        if(data.success) { alert('Compra realizada!'); document.getElementById('shopBalance').innerText = data.money; if(document.getElementById('modalBag').style.display === 'flex') openBag(); } else { alert(data.error); }
    }

    // --- DEX ---
    const ALL_ENTITIES = <%- JSON.stringify(entities) %>;
    const USER_TEAM = <%- JSON.stringify(user.pokemonTeam || []) %>;
    const USER_PC = <%- JSON.stringify(user.pc || []) %>;
    const UNLOCKED_IDS = new Set([ ...USER_TEAM.map(p => p.baseId), ...USER_PC.map(p => p.baseId) ]);

    async function openPokedex() {
        document.getElementById('modalPokedex').style.display = 'flex';
        const grid = document.getElementById('dexGrid'); grid.innerHTML = '';
        
        ALL_ENTITIES.forEach((p, index) => {
            const isUnlocked = UNLOCKED_IDS.has(p.id);
            const sprite = _resImg(p.sprite);
            const imgClass = isUnlocked ? '' : 'locked-sprite';
            const displayName = isUnlocked ? p.name : '???';
            const itemClass = isUnlocked ? '' : 'locked';

            grid.innerHTML += `
                <div class="dex-icon ${itemClass}" onclick="selectDexMonster(${index}, this)" data-name="${p.name.toLowerCase()}" 
                     style="cursor:pointer; background:rgba(255,255,255,0.05); border:1px solid #333; border-radius:8px; padding:8px; display:flex; flex-direction:column; align-items:center; transition:0.2s;">
                    <img src="${sprite}" class="${imgClass}" style="width:40px; height:40px; image-rendering:pixelated; margin-bottom:5px;">
                    <span style="font-size:0.65rem; color:#aaa;">${displayName}</span>
                </div>`;
        });
        const first = document.querySelector('.dex-icon');
        if(first) selectDexMonster(0, first);
    }

    function filterDex() {
        const v = document.getElementById('dexSearch').value.toLowerCase();
        document.querySelectorAll('.dex-icon').forEach(el => { el.style.display = el.getAttribute('data-name').includes(v) ? 'flex' : 'none'; });
    }

    function selectDexMonster(i, el) {
        document.querySelectorAll('.dex-icon').forEach(e => { e.style.border = '1px solid #333'; if(!e.classList.contains('locked')) e.style.background = 'rgba(255,255,255,0.05)'; });
        if(el) { el.style.borderColor = '#f1c40f'; if(!el.classList.contains('locked')) el.style.background = 'rgba(241, 196, 15, 0.1)'; }

        const m = ALL_ENTITIES[i]; if(!m) return;
        const isUnlocked = UNLOCKED_IDS.has(m.id);
        const sprite = _resImg(m.sprite);

        if(!isUnlocked) {
            document.getElementById('dexDetailsView').innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; color:#555;"><div style="width:150px; height:150px; background:#000; border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px dashed #333;"><img src="${sprite}" class="locked-sprite" style="width:100px; height:100px; image-rendering:pixelated; opacity:0.2;"></div><h1 style="margin-top:20px; font-size:2rem; color:#333;">???</h1><p style="font-size:0.8rem; margin-top:10px;">Criatura n√£o capturada.</p></div>`;
            return;
        }

        const s = m.baseStats;
        let evoHtml = '';
        if(m.evolution && m.evolution.targetId) {
            const target = ALL_ENTITIES.find(x => x.id === m.evolution.targetId);
            const targetUnlocked = target && UNLOCKED_IDS.has(target.id);
            evoHtml = `<div style="margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1); color:#94a3b8; font-size:0.8rem;">Evolui para: <br><strong style="color:${targetUnlocked ? '#fff' : '#777'}">${target ? (targetUnlocked ? target.name : '???') : '???'}</strong> <span style="font-size:0.7rem">(Lv.${m.evolution.level})</span></div>`;
        }

        document.getElementById('dexDetailsView').innerHTML = `
            <div class="dex-featured" style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
                <div class="dex-big-sprite" style="width:100px; height:100px; background:rgba(0,0,0,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid rgba(255,255,255,0.1);"><img src="${sprite}" style="width:80px; height:80px; image-rendering:pixelated;"></div>
                <div class="dex-info"><h1 style="margin:0; font-size:1.5rem; color:#fff;">${m.name}</h1><div style="margin-top:5px;"><span style="background:#222; padding:3px 8px; border-radius:4px; font-size:0.7rem; color:#aaa; border:1px solid #444;">${m.type}</span> <span style="background:rgba(52, 152, 219, 0.2); padding:3px 8px; border-radius:4px; font-size:0.7rem; color:#3498db; border:1px solid rgba(52, 152, 219, 0.4);">Rate: ${m.catchRate}</span></div>${evoHtml}</div>
            </div>
            <h3 style="color:#aaa; font-size:0.9rem; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">Base Stats</h3>
            <div class="dex-stats" style="display:flex; flex-direction:column; gap:8px;">${renderStatRow('HP', s.hp, '#2ecc71')}${renderStatRow('ATK', s.attack, '#e74c3c')}${renderStatRow('DEF', s.defense, '#f1c40f')}${renderStatRow('SPD', s.speed, '#3498db')}</div>`;
    }

    function renderStatRow(label, val, color) {
        const pct = Math.min(100, (val / 150) * 100);
        return `<div style="display:flex; align-items:center; gap:10px; font-size:0.8rem;"><span style="width:30px; font-weight:bold; color:#777;">${label}</span><div style="flex:1; height:6px; background:#111; border-radius:3px; overflow:hidden;"><div style="width:${pct}%; height:100%; background:${color};"></div></div><span style="width:25px; text-align:right; color:#fff;">${val}</span></div>`;
    }
</script>
