<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

<!-- POLYFILL PARA DRAG AND DROP MOBILE -->
<script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

<!-- ESTILOS -->
<style>
    :root {
        --bg-core: #0f172a;
        --bg-glass: rgba(30, 41, 59, 0.7);
        --border-glass: rgba(255, 255, 255, 0.08);
        --accent-primary: #3b82f6; /* Azul Tech */
        --accent-secondary: #8b5cf6; /* Roxo */
        --accent-gold: #fbbf24;
        --text-main: #f1f5f9;
        --text-muted: #94a3b8;
        --danger: #ef4444;
        --success: #10b981;
        --radius-lg: 16px;
        --radius-sm: 8px;
    }

    /* RESET & BASE */
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { font-family: 'Rajdhani', sans-serif; background: #000; color: var(--text-main); margin: 0; overflow: hidden; }
    
    /* UTILS */
    .pixel-art { image-rendering: pixelated; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }

    /* --- MODAIS (Redesenhados) --- */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); 
        z-index: 11000; display: none; justify-content: center; align-items: flex-end; 
        animation: fadeIn 0.2s ease-out;
    }
    @media(min-width: 768px) { .modal-overlay { align-items: center; } }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

    .modal-content { 
        background: #111827; 
        width: 100%; max-width: 600px; height: 85vh; 
        border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
        border-top: 1px solid var(--border-glass);
        box-shadow: 0 -10px 40px rgba(0,0,0,0.5); 
        display: flex; flex-direction: column; overflow: hidden;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }
    @media(min-width: 768px) { 
        .modal-content { height: auto; max-height: 85vh; border-radius: var(--radius-lg); border: 1px solid var(--border-glass); animation: fadeIn 0.2s; } 
    }

    .modal-header {
        padding: 18px 24px; background: rgba(255,255,255,0.02);
        border-bottom: 1px solid var(--border-glass);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { 
        margin: 0; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 1.2rem; 
        color: var(--text-main); letter-spacing: 0.5px; text-transform: uppercase;
        display: flex; align-items: center; gap: 10px;
    }
    .close-btn { 
        background: transparent; border: none; color: var(--text-muted); 
        font-size: 1.5rem; cursor: pointer; padding: 5px;
    }

    .modal-body { 
        padding: 20px; overflow-y: auto; flex: 1; 
        background: linear-gradient(to bottom, #111827, #030712);
        position: relative;
    }

    /* --- CARDS DOS MONSTROS (Estilo App) --- */
    .mon-card { 
        background: rgba(30, 41, 59, 0.4); border: 1px solid var(--border-glass);
        border-radius: var(--radius-lg); padding: 12px; margin-bottom: 12px;
        display: grid; grid-template-columns: 60px 1fr auto; gap: 12px;
        align-items: center; position: relative; overflow: hidden;
        transition: transform 0.2s;
    }
    .mon-card:active { transform: scale(0.98); background: rgba(30, 41, 59, 0.6); }
    .mon-card.leader { border-color: var(--accent-gold); background: rgba(251, 191, 36, 0.05); }
    
    .mon-avatar { 
        width: 60px; height: 60px; background: rgba(0,0,0,0.3); 
        border-radius: 12px; display: flex; align-items: center; justify-content: center;
        border: 1px solid var(--border-glass);
    }
    
    .mon-stats { display: flex; flex-direction: column; justify-content: center; gap: 4px; }
    .mon-name { font-weight: 700; font-size: 1.1rem; color: #fff; }
    .mon-lvl { font-size: 0.75rem; color: var(--accent-gold); background: rgba(251,191,36,0.1); padding: 2px 6px; border-radius: 4px; margin-left: 6px; }
    
    /* BARRAS DE STATUS E XP */
    .bar-wrapper { display: flex; align-items: center; gap: 6px; font-size: 0.65rem; color: var(--text-muted); font-weight: 600; }
    .bar-track { flex: 1; height: 6px; background: rgba(0,0,0,0.6); border-radius: 3px; overflow: hidden; position: relative; }
    .bar-fill { height: 100%; border-radius: 3px; transition: width 0.5s; }
    .hp-fill { background: linear-gradient(90deg, #22c55e, #10b981); }
    .xp-fill { background: linear-gradient(90deg, #06b6d4, #3b82f6); }
    
    .mon-actions { display: flex; flex-direction: column; gap: 6px; }
    .icon-btn { 
        width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-glass);
        background: rgba(255,255,255,0.05); color: var(--text-muted);
        display: flex; align-items: center; justify-content: center; cursor: pointer;
    }

    /* --- POKEDEX MODERNA --- */
    .dex-container { display: flex; height: 100%; overflow: hidden; position: relative; }
    
    /* SEARCH BAR */
    .dex-search-box { padding: 0 0 15px 0; }
    .dex-input { width: 100%; padding: 12px 16px; background: rgba(0,0,0,0.4); border: 1px solid var(--border-glass); border-radius: 12px; color: #fff; font-family: 'Inter', sans-serif; }

    /* GRID */
    .dex-grid { 
        display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); 
        gap: 10px; overflow-y: auto; padding-bottom: 20px; 
    }
    .dex-entry { 
        aspect-ratio: 1; background: rgba(255,255,255,0.03); 
        border-radius: 12px; border: 1px solid transparent;
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: pointer; position: relative; transition: 0.2s;
    }
    .dex-entry.unlocked { background: rgba(59, 130, 246, 0.1); border-color: rgba(59, 130, 246, 0.3); }
    .dex-entry.locked img { filter: grayscale(100%) contrast(0.5) brightness(0.7); opacity: 0.6; }
    .dex-entry .dex-num { position: absolute; top: 4px; left: 6px; font-size: 0.6rem; color: rgba(255,255,255,0.3); font-family: monospace; }
    
    /* DEX DETAILS (OVERLAY) */
    .dex-details { 
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
        background: #111827; z-index: 10; transform: translateX(110%); 
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column;
    }
    .dex-details.active { transform: translateX(0); }
    
    .dex-header-img { 
        height: 180px; background: radial-gradient(circle at center, rgba(59, 130, 246, 0.2), transparent);
        display: flex; align-items: center; justify-content: center; flex-shrink: 0;
    }
    .dex-header-img img { width: 100px; height: 100px; filter: drop-shadow(0 0 20px rgba(59,130,246,0.3)); transform: scale(1.5); }
    .dex-info-scroll { flex: 1; overflow-y: auto; padding: 20px; }
    
    .type-badge { 
        display: inline-block; padding: 4px 12px; border-radius: 20px; 
        font-size: 0.7rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
        background: #333; color: #fff; margin-top: 5px;
    }

    /* STATS BARS NA DEX */
    .stat-row-dex { display: flex; align-items: center; margin-bottom: 8px; font-size: 0.8rem; }
    .stat-label { width: 40px; color: var(--text-muted); font-weight: 600; }
    .stat-val { width: 30px; text-align: right; font-family: monospace; }

    /* MENU FLUTUANTE */
    .float-container { position: fixed; right: 20px; bottom: 100px; z-index: 9999; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
    .float-btn { width: 56px; height: 56px; border-radius: 20px; background: #1f2937; border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 1.5rem; cursor: pointer; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .float-btn:active { transform: scale(0.9); }
    .float-menu-items { display: none; flex-direction: column-reverse; gap: 12px; }
    .float-menu-items.show { display: flex; animation: slideUp 0.3s; }

    /* PC SYSTEM */
    .pc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 12px; }
    .pc-slot { aspect-ratio: 1; background: rgba(255,255,255,0.05); border-radius: 8px; display: flex; align-items: center; justify-content: center; position: relative; border: 1px solid rgba(255,255,255,0.05); }
    .pc-slot img { width: 40px; }
    .drag-over { border-color: var(--accent-gold); background: rgba(251, 191, 36, 0.1); }

    /* SKILL SELECTOR */
    .skill-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .skill-item { padding: 12px; background: #1f2937; border-radius: 8px; border: 1px solid transparent; cursor: pointer; }
    .skill-item.active { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }

    .btn-block { width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: 700; font-family: 'Rajdhani'; text-transform: uppercase; font-size: 1rem; cursor: pointer; margin-top: 10px; }
    .btn-save { background: var(--success); color: #fff; }
    .btn-cancel { background: #374151; color: #fff; }

</style>

<!-- MENU FLUTUANTE -->
<div class="float-container" id="floatMenu">
    <div id="menuItems" class="float-menu-items">
        <button class="float-btn" onclick="openBag()" style="color:#fbbf24;">üéí</button>
        <button class="float-btn" onclick="openPokemon()" style="color:#ef4444;">
            <img src="/uploads/catchcube.gif" class="pixel-art" style="width:28px;">
        </button>
        <button class="float-btn" onclick="openPC()" style="color:#22c55e;">üíª</button>
        <button class="float-btn" onclick="openPokedex()" style="color:#3b82f6;">üì±</button>
    </div>
    <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
</div>

<!-- MODAL: MEU TIME (MONSTROS) -->
<div class="modal-overlay" id="modalPokemon">
    <div class="modal-content">
        <div class="modal-header">
            <h2><span style="color:#ef4444;">‚óè</span> Equipe</h2>
            <button class="close-btn" onclick="closeModal('modalPokemon')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="pokemonListContent">Carregando...</div>
        </div>
    </div>
</div>

<!-- MODAL: POKEDEX (DEX) -->
<div class="modal-overlay" id="modalPokedex">
    <div class="modal-content" style="max-width:800px; height:90vh;">
        <div class="dex-container">
            <!-- LISTA LATERAL / PRINCIPAL -->
            <div style="flex:1; display:flex; flex-direction:column; padding:20px;">
                <div class="dex-search-box">
                    <input type="text" id="dexSearch" class="dex-input" placeholder="üîç Pesquisar na Database..." onkeyup="filterDex()">
                </div>
                <div id="dexGrid" class="dex-grid"></div>
            </div>

            <!-- DETALHES (OVERLAY ANIMADO) -->
            <div id="dexDetailsView" class="dex-details">
                <button onclick="closeDexDetails()" style="position:absolute; top:15px; left:15px; z-index:20; background:rgba(0,0,0,0.5); border:none; color:#fff; padding:8px 16px; border-radius:20px; cursor:pointer;">‚¨Ö Voltar</button>
                <div id="dexContentInner" style="display:flex; flex-direction:column; height:100%;">
                    <!-- Conte√∫do via JS -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: PC STORAGE -->
<div class="modal-overlay" id="modalPC">
    <div class="modal-content">
        <div class="modal-header">
            <h2><span style="color:#22c55e;">‚óè</span> Storage System</h2>
            <button class="close-btn" onclick="closeModal('modalPC')">‚úï</button>
        </div>
        <div class="modal-body" style="display:flex; flex-direction:column; gap:15px;">
            <div>
                <div style="font-size:0.8rem; color:#888; margin-bottom:8px; display:flex; justify-content:space-between;">
                    <span>BOX 01</span> <span>Arraste para mover</span>
                </div>
                <div class="pc-grid" id="pcStorageArea" ondrop="handleDrop(event, 'pc')" ondragover="handleDragOver(event)"></div>
            </div>
            <div style="border-top:1px solid var(--border-glass); padding-top:15px;">
                <div style="font-size:0.8rem; color:#22c55e; margin-bottom:8px;">EQUIPE ATUAL</div>
                <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;" id="pcTeamArea" ondrop="handleDrop(event, 'team')" ondragover="handleDragOver(event)"></div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL: MOCHILA -->
<div class="modal-overlay" id="modalBag">
    <div class="modal-content" style="height:60vh;">
        <div class="modal-header">
            <h2><span style="color:#fbbf24;">‚óè</span> Mochila</h2>
            <button class="close-btn" onclick="closeModal('modalBag')">‚úï</button>
        </div>
        <div class="modal-body">
            <div id="bagItemsContent">Carregando...</div>
        </div>
    </div>
</div>

<script>
    const USER_ID = '<%= user._id %>';
    let isSelectingMode = false;
    let currentMonId = null;
    let GLOBAL_MOVES_LIB = {};
    
    // DADOS INICIAIS
    const RAW_ENTITIES = <%- JSON.stringify(entities || []) %>;
    const RAW_TEAM = <%- JSON.stringify(user.pokemonTeam || []) %>;
    const RAW_PC = <%- JSON.stringify(user.pc || []) %>;
    
    // LISTA DE IDs J√Å CAPTURADOS (Para saber quem mostrar colorido)
    const UNLOCKED_IDS = new Set([
        ...RAW_TEAM.map(p => String(p.baseId||p.id)), 
        ...RAW_PC.map(p => String(p.baseId||p.id))
    ]);

    const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;

    /* --- FUN√á√ïES GERAIS --- */
    function toggleFloatMenu() { document.getElementById('menuItems').classList.toggle('show'); }
    
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none';
        if (id === 'modalPokemon') isSelectingMode = false; 
    }

    /* --- SISTEMA DE MONSTROS E XP CORRIGIDO --- */
    async function openPokemon() { 
        document.getElementById('modalPokemon').style.display='flex'; 
        try { 
            const r = await fetch(`/api/me?userId=${USER_ID}`); 
            const d = await r.json(); 
            if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; 
            renderPokemonList(d.team); 
        } catch(e) { 
            document.getElementById('pokemonListContent').innerHTML = '<div style="color:#aaa; text-align:center;">Erro ao carregar time.</div>'; 
        } 
    }

    function renderPokemonList(team) {
        const content = document.getElementById('pokemonListContent');
        if(!team || team.length === 0) { content.innerHTML='<div style="text-align:center; margin-top:50px; color:#555;">Nenhuma criatura na equipe.</div>'; return; }
        
        let html = '';
        if(isSelectingMode) html += `<div style="background:rgba(251,191,36,0.2); color:#fbbf24; padding:12px; text-align:center; border-radius:8px; font-weight:bold; margin-bottom:15px; border:1px solid #fbbf24;">SELECIONE PARA USAR O ITEM</div>`;
        
        team.forEach((p, idx) => {
            // C√ÅLCULOS DE BARRA
            const hpPct = Math.min(100, (p.hp/p.maxHp)*100);
            
            // CORRE√á√ÉO: C√°lculo e exibi√ß√£o do XP
            // Se xpToNext n√£o vier, assume 100 para evitar erro de divis√£o
            const xpMax = p.xpToNext || 100;
            const xpPct = Math.min(100, (p.xp / xpMax) * 100);

            const cardClass = isSelectingMode ? 'mon-card leader' : `mon-card ${idx===0?'leader':''}`;
            const clickAction = isSelectingMode ? `onclick="applyRareCandy('${p.instanceId}')"` : '';
            const actionStyle = isSelectingMode ? 'visibility:hidden;' : '';

            // STRINGS SEGURAS
            const mStr = JSON.stringify(p.moves||[]).replace(/"/g, '&quot;');
            const lStr = JSON.stringify(p.learnedMoves||[]).replace(/"/g, '&quot;');

            html += `
            <div class="${cardClass}" ${clickAction}>
                <div class="mon-avatar">
                    <img src="${_resImg(p.sprite)}" class="pixel-art" style="width:48px;">
                </div>
                
                <div class="mon-stats">
                    <div style="display:flex; align-items:center;">
                        <span class="mon-name">${p.name}</span>
                        <span class="mon-lvl">Lv.${p.level}</span>
                    </div>
                    
                    <!-- BARRA DE HP -->
                    <div class="bar-wrapper">
                        <span style="width:20px;">HP</span>
                        <div class="bar-track">
                            <div class="bar-fill hp-fill" style="width:${hpPct}%;"></div>
                        </div>
                    </div>
                    
                    <!-- CORRE√á√ÉO: BARRA DE XP VIS√çVEL -->
                    <div class="bar-wrapper">
                        <span style="width:20px;">XP</span>
                        <div class="bar-track">
                            <div class="bar-fill xp-fill" style="width:${xpPct}%;"></div>
                        </div>
                    </div>
                </div>

                <div class="mon-actions" style="${actionStyle}">
                    <div class="icon-btn" onclick="showMoveEditor('${p.instanceId}','${p.name}',${mStr},${lStr})">‚öîÔ∏è</div>
                    ${idx!==0 ? `<div class="icon-btn" onclick="setLead('${p.instanceId}')">‚≠ê</div>` : ''}
                    <div class="icon-btn" onclick="abandonPokemon('${p.instanceId}')" style="color:#ef4444; border-color:rgba(239,68,68,0.3);">‚úï</div>
                </div>
            </div>`;
        });

        if(isSelectingMode) html += `<button onclick="cancelSelection()" class="btn-block btn-cancel">CANCELAR</button>`;
        content.innerHTML = html;
    }

    /* --- SISTEMA DE POKEDEX (DEX) MELHORADO --- */
    async function openPokedex() {
        document.getElementById('modalPokedex').style.display='flex';
        // Carrega golpes se n√£o tiver
        if(Object.keys(GLOBAL_MOVES_LIB).length === 0) { 
            try { 
                const r = await fetch(`/api/me?userId=${USER_ID}`); 
                const d = await r.json(); 
                if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; 
            } catch(e){} 
        }
        renderDexGrid();
    }

    function renderDexGrid() {
        const grid = document.getElementById('dexGrid'); 
        grid.innerHTML = '';
        
        RAW_ENTITIES.forEach((p, index) => {
            const id = String(p.id||p._id);
            // CORRE√á√ÉO: N√£o esconde mais se n√£o tiver capturado. Apenas muda o estilo visual.
            const isUnlocked = UNLOCKED_IDS.has(id);
            
            grid.innerHTML += `
            <div class="dex-entry ${isUnlocked ? 'unlocked' : 'locked'}" 
                 onclick="selectDexMonster('${id}')" 
                 data-name="${(p.name||'').toLowerCase()}">
                <span class="dex-num">#${(index+1).toString().padStart(3,'0')}</span>
                <img src="${_resImg(p.sprite)}" class="pixel-art" style="width:40px; height:40px;">
            </div>`;
        });
    }

    function selectDexMonster(idStr) {
        const m = RAW_ENTITIES.find(x => String(x.id||x._id) === idStr);
        if(!m) return;
        
        const isUnlocked = UNLOCKED_IDS.has(idStr);
        const container = document.getElementById('dexContentInner');
        
        // GERA TABELA DE GOLPES
        let movesHtml = '';
        const pool = (m.movePool || m.learnset || []).sort((a,b)=>a.level-b.level);
        if(pool.length > 0) {
            movesHtml = '<div style="margin-top:20px;"><h4 style="color:#aaa; border-bottom:1px solid #333; padding-bottom:5px;">MOVE POOL</h4><div style="display:grid; gap:8px; margin-top:10px;">';
            pool.forEach(mv => {
                const d = GLOBAL_MOVES_LIB[mv.moveId||mv.move] || {name:mv.moveId||mv.move, element:'normal'};
                movesHtml += `<div style="display:flex; justify-content:space-between; font-size:0.8rem; background:rgba(255,255,255,0.03); padding:8px; border-radius:6px;">
                    <span style="color:var(--accent-gold);">Lv.${mv.level}</span>
                    <span>${d.name}</span>
                    <span style="color:#888; text-transform:uppercase; font-size:0.7rem;">${d.element}</span>
                </div>`;
            });
            movesHtml += '</div></div>';
        }

        // MONTA O HTML DETALHADO
        let html = `
            <div class="dex-header-img" style="${!isUnlocked ? 'filter:grayscale(1); opacity:0.8;' : ''}">
                <img src="${_resImg(m.sprite)}" class="pixel-art">
            </div>
            <div class="dex-info-scroll">
                <div style="text-align:center;">
                    <h1 style="margin:0; font-size:1.8rem; letter-spacing:1px; text-transform:uppercase;">${m.name}</h1>
                    <span class="type-badge" style="background:var(--accent-primary);">${m.type}</span>
                    <div style="margin-top:10px; font-size:0.8rem; color:${isUnlocked ? '#10b981' : '#64748b'}; font-weight:bold; letter-spacing:1px;">
                        ${isUnlocked ? '‚óè REGISTRADO' : '‚óè N√ÉO CAPTURADO'}
                    </div>
                </div>

                <div style="margin-top:25px; background:rgba(255,255,255,0.03); padding:15px; border-radius:12px;">
                    <h4 style="margin:0 0 10px 0; color:#aaa;">STATS BASE</h4>
                    ${renderDexStat('HP', m.baseStats.hp, '#10b981')}
                    ${renderDexStat('ATK', m.baseStats.attack, '#ef4444')}
                    ${renderDexStat('DEF', m.baseStats.defense, '#fbbf24')}
                    ${renderDexStat('SPD', m.baseStats.speed, '#3b82f6')}
                </div>
                
                ${movesHtml}
                <div style="height:50px;"></div> <!-- Spacer -->
            </div>
        `;

        container.innerHTML = html;
        document.getElementById('dexDetailsView').classList.add('active');
    }

    function renderDexStat(label, val, color) {
        const pct = Math.min(100, (val/150)*100);
        return `
        <div class="stat-row-dex">
            <div class="stat-label">${label}</div>
            <div class="bar-track" style="background:rgba(255,255,255,0.1);">
                <div class="bar-fill" style="width:${pct}%; background:${color};"></div>
            </div>
            <div class="stat-val">${val}</div>
        </div>`;
    }

    function filterDex() { 
        const v = document.getElementById('dexSearch').value.toLowerCase(); 
        document.querySelectorAll('.dex-entry').forEach(e => {
            e.style.display = e.getAttribute('data-name').includes(v) ? 'flex' : 'none';
        }); 
    }
    
    function closeDexDetails() { document.getElementById('dexDetailsView').classList.remove('active'); }

    /* --- PC SYSTEM --- */
    async function openPC() { document.getElementById('modalPC').style.display='flex'; loadPCData(); }
    async function loadPCData() { try { const r = await fetch(`/api/pc?userId=${USER_ID}`); const d = await r.json(); renderDragPC(d.team, d.pc); } catch(e){} }
    function renderDragPC(team, pc) {
        const createSlot = (p, from) => `
            <div class="pc-slot" draggable="true" ondragstart="handleDragStart(event, '${p.instanceId}', '${from}')">
                <img src="${_resImg(p.sprite)}" class="pixel-art">
                <div style="position:absolute; bottom:0; right:0; background:#000; color:#fbbf24; font-size:0.6rem; padding:1px 3px; border-radius:4px;">Lv.${p.level}</div>
            </div>`;
        
        document.getElementById('pcTeamArea').innerHTML = team.map(p => createSlot(p, 'team')).join('') 
            + (team.length < 6 ? '<div class="pc-slot" style="opacity:0.3; border:1px dashed #555;"></div>' : '');
            
        document.getElementById('pcStorageArea').innerHTML = pc.map(p => createSlot(p, 'pc')).join('')
            + Array(10).fill('<div class="pc-slot" style="border:1px dashed rgba(255,255,255,0.05); background:transparent;"></div>').join('');
    }
    
    /* DRAG AND DROP LOGIC */
    function handleDragStart(ev, pokeId, source) { ev.dataTransfer.setData("text/plain", JSON.stringify({ pokeId, source })); ev.currentTarget.style.opacity = '0.5'; }
    function handleDragOver(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    document.querySelectorAll('.pc-grid, #pcTeamArea').forEach(el => el.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over')));
    
    async function handleDrop(ev, targetContainer) {
        ev.preventDefault(); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        const dataRaw = ev.dataTransfer.getData("text/plain"); if(!dataRaw) return;
        const { pokeId, source } = JSON.parse(dataRaw); if (source === targetContainer) return; 
        await fetch('/api/pc/move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId: USER_ID, pokemonId: pokeId, from: source, to: targetContainer }) });
        loadPCData();
    }

    /* --- EDITAR GOLPES --- */
    function showMoveEditor(id, name, equipped, learned) {
        currentMonId = id;
        const pool = (learned && learned.length>0) ? learned : equipped;
        
        let html = `
            <h3 style="color:#fff; margin-bottom:15px; text-align:center;">${name} <span style="color:#666; font-size:0.8rem;">(Escolha at√© 4)</span></h3>
            <div class="skill-grid">`;
            
        pool.forEach(mid => {
            const eq = equipped.includes(mid);
            const d = GLOBAL_MOVES_LIB[mid] || {name:mid, element:'normal'};
            html += `<div onclick="toggleMove(this)" class="skill-item ${eq?'active':''}" data-id="${mid}">
                <div style="font-weight:700; color:#fff;">${d.name}</div>
                <div style="font-size:0.7rem; color:#aaa; text-transform:uppercase; margin-top:4px;">${d.element}</div>
            </div>`;
        });
        
        html += `</div>
            <button onclick="saveMoves()" class="btn-block btn-save">SALVAR MUDAN√áAS</button>
            <button onclick="openPokemon()" class="btn-block btn-cancel">VOLTAR</button>`;
        
        document.getElementById('pokemonListContent').innerHTML = html;
    }

    function toggleMove(el) {
        if(el.classList.contains('active')) { 
            if(document.querySelectorAll('.skill-item.active').length <= 1) return alert('√â necess√°rio ter pelo menos 1 golpe.'); 
            el.classList.remove('active'); 
        } else { 
            if(document.querySelectorAll('.skill-item.active').length >= 4) return alert('M√°ximo de 4 golpes permitidos.'); 
            el.classList.add('active'); 
        }
    }

    async function saveMoves() {
        const moves = Array.from(document.querySelectorAll('.skill-item.active')).map(c => c.getAttribute('data-id'));
        await fetch('/api/equip-move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:currentMonId, moves }) }); 
        openPokemon();
    }

    /* --- OUTRAS A√á√ïES --- */
    async function setLead(id) { await fetch('/api/set-lead', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); }
    async function abandonPokemon(id) { if(confirm('Tem certeza que deseja libertar essa criatura?')) { await fetch('/api/abandon-pokemon', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); } }

    /* --- MOCHILA --- */
    async function openBag() { 
        document.getElementById('modalBag').style.display='flex'; 
        const r = await fetch(`/api/me?userId=${USER_ID}`); 
        const d = await r.json(); 
        
        const itemRow = (icon, nome, qtd, action) => `
        <div style="display:flex; align-items:center; background:rgba(255,255,255,0.03); padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid var(--border-glass);">
            <div style="font-size:1.8rem; margin-right:15px;">${icon}</div>
            <div style="flex:1;">
                <div style="font-weight:700; color:#fff; font-size:1.1rem;">${nome}</div>
                <div style="font-size:0.8rem; color:#aaa;">Quantidade: ${qtd}</div>
            </div>
            ${action ? action : ''}
        </div>`;
        
        let html = itemRow('üì¶', 'CatchCubes', d.pokeballs||0);
        
        const candyBtn = `<button onclick="startRareCandySelection()" style="background:var(--accent-primary); border:none; color:#fff; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer;">USAR</button>`;
        if(d.rareCandy > 0) html += itemRow('üç¨', 'Rare Candy', d.rareCandy, candyBtn);
        else html += itemRow('üç¨', 'Rare Candy', 0);
        
        document.getElementById('bagItemsContent').innerHTML = html;
    }

    function startRareCandySelection() { closeModal('modalBag'); isSelectingMode = true; openPokemon(); }
    function cancelSelection() { isSelectingMode = false; openPokemon(); }
    
    async function applyRareCandy(pokeId) {
        if(!confirm('Usar Rare Candy nesta criatura?')) return;
        try {
            const res = await fetch('/api/use-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: USER_ID, itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) });
            const data = await res.json();
            if(data.success) { alert(data.evolved ? '‚ú® Criatura Evoluiu! ‚ú®' : 'üÜô Subiu de N√≠vel!'); isSelectingMode = false; openPokemon(); } 
            else { alert(data.error || 'Erro ao usar item.'); isSelectingMode = false; openPokemon(); }
        } catch(e) { alert("Erro de conex√£o."); isSelectingMode = false; openPokemon(); }
    }
</script>
