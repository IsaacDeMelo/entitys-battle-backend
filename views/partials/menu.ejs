<!-- POLYFILL PARA DRAG AND DROP NO CELULAR -->
<script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

<!-- ESTILOS GERAIS -->
<style>
    /* RESET E BASES */
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    /* SCROLLBAR CUSTOMIZADA */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    ::-webkit-scrollbar-thumb { background: #3498db; border-radius: 3px; }
    
    /* MODAL BASE */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); 
        z-index: 11000; display: none; justify-content: center; align-items: center; 
        animation: fadeIn 0.2s ease-out; font-family: 'Rajdhani', sans-serif;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content { 
        background: #0f172a; width: 95%; max-width: 500px; 
        border-radius: 12px; border: 1px solid rgba(255,255,255,0.15); 
        box-shadow: 0 20px 50px rgba(0,0,0,0.9); color: #e2e8f0; 
        display: flex; flex-direction: column; 
        max-height: 90vh; overflow: hidden;
    }

    .modal-header {
        padding: 15px 20px; background: rgba(15, 23, 42, 0.95);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex; justify-content: space-between; align-items: center;
        flex-shrink: 0;
    }
    .modal-header h2 { margin: 0; font-family: 'Press Start 2P'; font-size: 0.8rem; color: #f1c40f; letter-spacing: 1px; }
    .close-btn { background: none; border: none; color: #94a3b8; font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .close-btn:hover { color: #e74c3c; transform: scale(1.1); }

    .modal-body { 
        padding: 20px; overflow-y: auto; flex: 1; 
        background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); 
        position: relative;
    }

    /* BOT√ïES FLUTUANTES */
    .float-container { position: fixed; right: 20px; bottom: 100px; z-index: 9999; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
    .float-btn { 
        width: 55px; height: 55px; border-radius: 50%; 
        background: #1e293b; border: 2px solid rgba(255,255,255,0.1); 
        color: #f1c40f; font-size: 1.4rem; cursor: pointer; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; 
        display: flex; align-items: center; justify-content: center;
    }
    .float-btn:hover { transform: scale(1.1); border-color: #f1c40f; }
    .float-menu-items { display: none; flex-direction: column-reverse; gap: 12px; }
    .float-menu-items.show { display: flex; animation: slideUp 0.3s; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* UTILIT√ÅRIOS */
    .pixel-icon { width: 17px !important; height: 17px !important; min-width: 17px; image-rendering: pixelated; object-fit: contain; }
    .btn-success { background: #2ecc71; color: #000; border:none; padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer; }
    
    /* --- PC SYSTEM (MOBILE FIX) --- */
    #modalPC .modal-content { max-width: 650px; background: #080808; border: 1px solid #333; height: 85vh; }
    
    .pc-layout { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
    
    .pc-container-top { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 10px; min-height: 0; }
    .pc-container-bottom { flex-shrink: 0; padding: 10px; background: #0a0a0a; border-top: 1px solid #222; }

    .pc-box-header { 
        font-family: 'Rajdhani'; font-weight: 700; font-size: 1rem; color: #fff; 
        margin-bottom: 5px; display: flex; justify-content: space-between; align-items: flex-end;
        background: linear-gradient(90deg, #1e293b, transparent); padding: 5px 10px; border-left: 4px solid #3498db;
    }
    
    .pc-storage-area {
        background: #0f1115; border: 2px solid #222; border-radius: 4px; padding: 10px;
        display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); 
        gap: 8px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; align-content: flex-start;
    }
    .pc-storage-area.drag-over { border-color: #f1c40f; background: #131313; }

    .pc-team-area {
        height: 80px; background: #0f1510; border: 2px solid #1a2e1a; border-radius: 4px; padding: 5px;
        display: flex; align-items: center; gap: 10px; overflow-x: auto;
    }
    .pc-team-area.drag-over { border-color: #f1c40f; background: #131313; }

    .pc-slot {
        aspect-ratio: 1/1; width: 100%; max-width: 50px;
        background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08);
        border-radius: 4px; display: flex; flex-direction: column; align-items: center; justify-content: center;
        cursor: grab; position: relative; touch-action: pan-y; 
    }
    .pc-slot:active { cursor: grabbing; }
    .pc-slot img { width: 32px; height: 32px; image-rendering: pixelated; pointer-events: none; }
    .pc-slot .lvl-badge { position: absolute; bottom: 1px; right: 1px; font-size: 0.5rem; background: rgba(0,0,0,0.8); color: #fff; padding: 0 2px; border-radius: 2px; pointer-events: none; }
    .pc-slot.dragging { opacity: 0.3; border: 1px dashed #f1c40f; }

    /* --- MONSTER CARDS --- */
    .poke-card { 
        background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.1); 
        border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; align-items: center; gap: 15px; transition: 0.3s;
    }
    .poke-card.leader { border: 1px solid #f1c40f; background: linear-gradient(135deg, #2c2005, #0f172a); }
    .poke-img-container { width: 54px; height: 54px; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.1); }
    .poke-img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    .poke-details { flex: 1; }
    .poke-name { font-weight: bold; color: #fff; font-size: 0.95rem; }
    .stat-bar-box { width: 100%; height: 6px; background: #000; border-radius: 3px; margin-top: 4px; overflow: hidden; }
    .stat-fill { height: 100%; border-radius: 3px; }
    .hp-fill { background: linear-gradient(90deg, #2ecc71, #27ae60); }
    .xp-fill { background: linear-gradient(90deg, #3498db, #2980b9); }
    .stat-label { font-size: 0.6rem; color: #aaa; display: flex; justify-content: space-between; margin-top: 2px; font-weight: bold; }
    .card-actions { display: flex; gap: 8px; flex-direction: column; }
    .icon-btn { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; font-size: 1.1rem; cursor: pointer; padding: 6px 10px; color: #ccc; }

    /* --- SKILL CARDS --- */
    .skills-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .skill-card { background: #111; border: 1px solid rgba(255,255,255,0.1); border-left-width: 4px; border-radius: 6px; padding: 10px; cursor: pointer; position: relative; }
    .skill-card.equipped { border-color: #fff; box-shadow: inset 0 0 10px rgba(255,255,255,0.1); }
    .skill-card.equipped::after { content: '‚úî'; position: absolute; top: 10px; right: 10px; color: #fff; font-size: 0.8rem; }
    .skill-name { color: #eee; font-weight: bold; font-size: 0.9rem; text-transform: uppercase; }
    .skill-type { color: #aaa; font-size: 0.6rem; margin-top: 2px; text-transform: uppercase; }

    /* Cores Tipos */
    .type-fire { border-left-color: #e74c3c; } .type-water { border-left-color: #3498db; } .type-grass { border-left-color: #2ecc71; } 
    .type-electric { border-left-color: #f1c40f; } .type-normal { border-left-color: #95a5a6; } .type-poison { border-left-color: #9b59b6; }

    /* --- POKEDEX REDESIGN --- */
    #modalPokedex .modal-content { max-width: 800px; height: 80vh; flex-direction: row; position: relative; }
    .dex-container { display: flex; width: 100%; height: 100%; overflow: hidden; position: relative; }
    
    /* Lista √† Esquerda */
    .dex-list { width: 35%; border-right: 1px solid #333; display: flex; flex-direction: column; background: #0b1120; }
    .dex-search-box { padding: 10px; border-bottom: 1px solid #333; }
    .dex-search-input { width: 100%; padding: 8px; background: #000; border: 1px solid #333; color: #fff; border-radius: 5px; }
    .dex-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 5px; align-content: flex-start; }

    /* Detalhes √† Direita */
    .dex-details-view { flex: 1; padding: 20px; overflow-y: auto; background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); display: flex; flex-direction: column; }
    
    .dex-icon { cursor: pointer; background: rgba(255,255,255,0.05); border: 1px solid #333; border-radius: 8px; padding: 5px; display: flex; flex-direction: column; align-items: center; transition: 0.2s; }
    .dex-icon.locked { border-color: #222 !important; background: rgba(0,0,0,0.2) !important; }
    .dex-icon.selected { border-color: #f1c40f; background: rgba(241, 196, 15, 0.15); }
    .locked-sprite { filter: brightness(0) contrast(100%); opacity: 0.3; }

    /* TABELA DE MOVES NA POKEDEX */
    .dex-moves-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; }
    .dex-moves-table th { text-align: left; color: #94a3b8; padding: 8px; background: rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.1); font-family: monospace; text-transform: uppercase; }
    .dex-moves-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd; vertical-align: middle; }
    .dex-moves-table tr:last-child td { border-bottom: none; }
    .dex-moves-table tr:hover { background: rgba(255,255,255,0.03); }
    
    .type-badge { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; background: #333; color: #fff; border: 1px solid rgba(255,255,255,0.2); }
    .type-badge.fire { background: rgba(231, 76, 60, 0.2); color: #e74c3c; border-color: #e74c3c; }
    .type-water { background: rgba(52, 152, 219, 0.2); color: #3498db; border-color: #3498db; }
    .type-grass { background: rgba(46, 204, 113, 0.2); color: #2ecc71; border-color: #2ecc71; }
    /* Adicione outros tipos conforme necess√°rio */

    /* RESPONSIVIDADE POKEDEX */
    .dex-back-btn { display: none; margin-bottom: 10px; background: #333; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; align-self: flex-start; }
    @media (max-width: 768px) {
        #modalPokedex .modal-content { flex-direction: column; }
        .dex-list { width: 100%; height: 100%; }
        .dex-details-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: #0f172a; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .dex-details-view.active { transform: translateX(0); }
        .dex-back-btn { display: block; }
        .dex-grid { grid-template-columns: repeat(4, 1fr); gap: 10px; }
    }
</style>

<!-- MENU FLUTUANTE -->
<div class="float-container" id="floatMenu">
    <div id="menuItems" class="float-menu-items">
        <button class="float-btn" onclick="openBag()" title="Mochila" style="color:#e67e22; border-color:#e67e22;">üéí</button>
        <button class="float-btn" onclick="openPokemon()" title="Monstros" style="color:#fff; border-color:#aaa;">
            <img src="/uploads/catchcube.gif" class="pixel-icon" style="width:24px; height:24px;">
        </button>
        <button class="float-btn" onclick="openPC()" title="PC" style="color:#33ff33; border-color:#33ff33;">üíª</button>
        <button class="float-btn" onclick="openPokedex()" title="Dex" style="color:#00d2ff; border-color:#00d2ff;">üìö</button>
    </div>
    <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
</div>

<!-- MODAL PC -->
<div class="modal-overlay" id="modalPC">
    <div class="modal-content">
        <div class="modal-header">
            <h2>PC STORAGE</h2>
            <button class="close-btn" onclick="closeModal('modalPC')">‚úï</button>
        </div>
        <div class="modal-body" style="padding: 0; display: flex; flex-direction: column;">
            <div class="pc-layout">
                <div class="pc-container-top">
                    <div class="pc-box-header"><span>üì¶ BOX 01</span> <span style="color:#aaa; font-size:0.6rem;">Arrastar para mover</span></div>
                    <div class="pc-storage-area" id="pcStorageArea" ondrop="handleDrop(event, 'pc')" ondragover="handleDragOver(event)"></div>
                </div>
                <div class="pc-container-bottom">
                    <div class="pc-box-header" style="border-left-color: #2ecc71;"><span style="color:#2ecc71;">‚ö° EQUIPE ATIVA</span></div>
                    <div class="pc-team-area" id="pcTeamArea" ondrop="handleDrop(event, 'team')" ondragover="handleDragOver(event)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DEX -->
<div class="modal-overlay" id="modalPokedex">
    <div class="modal-content">
        <div class="dex-container">
            <button class="close-btn" onclick="closeModal('modalPokedex')" style="position: absolute; top: 10px; right: 10px; z-index: 50; background:rgba(0,0,0,0.5); width:30px; height:30px; border-radius:50%;">‚úï</button>
            <div class="dex-list">
                <div class="dex-search-box"><input type="text" id="dexSearch" class="dex-search-input" placeholder="Buscar..." onkeyup="filterDex()"></div>
                <div id="dexGrid" class="dex-grid"></div>
            </div>
            <div id="dexDetailsView" class="dex-details-view">
                <button class="dex-back-btn" onclick="closeDexDetails()">‚¨Ö Voltar</button>
                <div id="dexContentInner" style="height:100%; display:flex; align-items:center; justify-content:center; color:#555;">Selecione um Pok√©mon.</div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL MONSTROS -->
<div class="modal-overlay" id="modalPokemon">
    <div class="modal-content">
        <div class="modal-header"><h2>MEUS MONSTROS</h2><button class="close-btn" onclick="closeModal('modalPokemon')">‚úï</button></div>
        <div class="modal-body"><div id="pokemonListContent">Carregando...</div></div>
    </div>
</div>

<!-- MODAL MOCHILA -->
<div class="modal-overlay" id="modalBag">
    <div class="modal-content">
        <div class="modal-header"><h2>MOCHILA</h2><button class="close-btn" onclick="closeModal('modalBag')">‚úï</button></div>
        <div class="modal-body"><div id="bagItemsContent">Carregando...</div></div>
    </div>
</div>

<script>
    // --- DADOS E VARI√ÅVEIS ---
    const USER_ID = '<%= user._id %>';
    let currentMonId = null;
    let GLOBAL_MOVES_LIB = {}; // Ser√° preenchido ao carregar a Dex ou o Time
    
    // Dados injetados pelo Servidor
    const RAW_ENTITIES = <%- JSON.stringify(entities || []) %>;
    const RAW_TEAM = <%- JSON.stringify(user.pokemonTeam || []) %>;
    const RAW_PC = <%- JSON.stringify(user.pc || []) %>;
    
    // IDs Desbloqueados
    const UNLOCKED_IDS = new Set([
        ...RAW_TEAM.map(p => String(p.baseId || p.id)),
        ...RAW_PC.map(p => String(p.baseId || p.id))
    ]);

    const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;

    // --- UTILS ---
    function toggleFloatMenu() { document.getElementById('menuItems').classList.toggle('show'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // --- PC SYSTEM ---
    async function openPC() { document.getElementById('modalPC').style.display='flex'; loadPCData(); }
    
    async function loadPCData() {
        const storageDiv = document.getElementById('pcStorageArea'); 
        storageDiv.innerHTML = '<span style="color:#555; text-align:center; padding:10px;">Carregando...</span>'; 
        try {
            const res = await fetch(`/api/pc?userId=${USER_ID}`); 
            const data = await res.json(); 
            renderDragPC(data.team, data.pc);
        } catch(e) { storageDiv.innerHTML = 'Erro.'; }
    }

    function renderDragPC(team, pc) {
        const createSlot = (p, from) => `
            <div class="pc-slot" draggable="true" ondragstart="handleDragStart(event, '${p.instanceId}', '${from}')">
                <img src="${_resImg(p.sprite)}"><div class="lvl-badge">Lv.${p.level}</div>
            </div>`;
        const emptySlot = `<div class="pc-slot" style="opacity:0.1; border-style:dashed;"></div>`;

        document.getElementById('pcTeamArea').innerHTML = team.map(p => createSlot(p, 'team')).join('') + (team.length < 6 ? emptySlot : '');
        document.getElementById('pcStorageArea').innerHTML = pc.map(p => createSlot(p, 'pc')).join('');
    }

    function handleDragStart(ev, pokeId, source) { ev.dataTransfer.setData("text/plain", JSON.stringify({ pokeId, source })); ev.currentTarget.classList.add('dragging'); }
    function handleDragOver(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    
    document.getElementById('pcStorageArea').addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));
    document.getElementById('pcTeamArea').addEventListener('dragleave', (e) => e.currentTarget.classList.remove('drag-over'));

    async function handleDrop(ev, targetContainer) {
        ev.preventDefault(); ev.currentTarget.classList.remove('drag-over');
        const dataRaw = ev.dataTransfer.getData("text/plain"); if(!dataRaw) return;
        const { pokeId, source } = JSON.parse(dataRaw); if (source === targetContainer) return; 

        try {
            const res = await fetch('/api/pc/move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId: USER_ID, pokemonId: pokeId, from: source, to: targetContainer }) });
            const data = await res.json(); if(data.success) loadPCData(); else alert(data.error);
        } catch(e) {}
    }

    // --- POKEDEX SYSTEM (CORRIGIDO PARA LER movePool DO BACKEND) ---
    async function openPokedex() {
        document.getElementById('modalPokedex').style.display = 'flex';
        
        // Carregar biblioteca de moves se estiver vazia
        if (Object.keys(GLOBAL_MOVES_LIB).length === 0) {
            try {
                const res = await fetch(`/api/me?userId=${USER_ID}`);
                const data = await res.json();
                if(data.allMoves) GLOBAL_MOVES_LIB = data.allMoves;
            } catch(e) { console.log('Erro ao carregar moves lib'); }
        }

        renderDexGrid();
    }

    function renderDexGrid() {
        const grid = document.getElementById('dexGrid'); grid.innerHTML = '';
        RAW_ENTITIES.forEach((p, index) => {
            const idString = String(p.id || p._id);
            const isUnlocked = UNLOCKED_IDS.has(idString);
            const sprite = _resImg(p.sprite);
            const name = isUnlocked ? p.name : '???';
            const displayId = (index + 1).toString().padStart(3, '0');
            
            grid.innerHTML += `
                <div class="dex-icon ${!isUnlocked ? 'locked' : ''}" onclick="selectDexMonster('${idString}', this)" data-name="${(p.name||'').toLowerCase()}">
                    <span style="font-size:0.5rem; color:#555; align-self:flex-start;">#${displayId}</span>
                    <img src="${sprite}" class="${!isUnlocked ? 'locked-sprite' : ''}" style="width:36px; height:36px; image-rendering:pixelated;">
                    <span style="font-size:0.6rem; color:#aaa; overflow:hidden; text-overflow:ellipsis; width:100%; text-align:center;">${name}</span>
                </div>`;
        });
    }

    function selectDexMonster(idString, el) {
        document.querySelectorAll('.dex-icon').forEach(e => e.classList.remove('selected'));
        if(el) el.classList.add('selected');
        document.getElementById('dexDetailsView').classList.add('active');

        const m = RAW_ENTITIES.find(x => String(x.id || x._id) === idString);
        const contentDiv = document.getElementById('dexContentInner');

        if(!m || !UNLOCKED_IDS.has(idString)) {
            contentDiv.innerHTML = `<div style="text-align:center; color:#777;"><div style="width:100px; height:100px; background:#000; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; border:2px dashed #333; margin-bottom:15px;"><img src="${_resImg(m?.sprite)}" class="locked-sprite" style="width:60px; opacity:0.2;"></div><h2>???</h2><p>Criatura n√£o registrada.</p></div>`;
            return;
        }

        // Stats
        const s = m.baseStats || { hp:0, attack:0, defense:0, speed:0 };
        
        // CORRE√á√ÉO AQUI: Backend manda 'movePool', n√£o 'learnset'
        const movesList = m.movePool || m.learnset || [];
        
        let movesHtml = '';
        if (movesList.length > 0) {
            // Ordena por n√≠vel
            const sortedMoves = movesList.sort((a,b) => a.level - b.level);
            
            movesHtml = `
            <div style="margin-top:20px; width:100%; max-width:400px;">
                <h3 style="color:#aaa; font-size:0.8rem; border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">MOVESET</h3>
                <table class="dex-moves-table">
                    <thead><tr><th width="15%">LVL</th><th>ATAQUE</th><th width="20%" style="text-align:right;">TIPO</th></tr></thead>
                    <tbody>`;
            
            sortedMoves.forEach(moveItem => {
                const moveId = moveItem.moveId || moveItem.move;
                const level = moveItem.level;
                
                const moveData = GLOBAL_MOVES_LIB[moveId] || { name: moveId, element: 'normal' };
                const moveName = moveData.name || moveId;
                const moveType = (moveData.element || 'normal').toLowerCase();
                
                movesHtml += `
                    <tr>
                        <td><span style="color:#f1c40f; font-weight:bold;">${level}</span></td>
                        <td>${moveName}</td>
                        <td style="text-align:right;"><span class="type-badge type-${moveType}">${moveType}</span></td>
                    </tr>`;
            });
            movesHtml += `</tbody></table></div>`;
        } else {
            movesHtml = `<div style="margin-top:20px; color:#555; font-size:0.8rem;">Nenhum ataque registrado no banco de dados.</div>`;
        }

        contentDiv.innerHTML = `
            <div style="width:100%; max-width:400px; display:flex; flex-direction:column; align-items:center; padding-bottom:40px;">
                <div style="width:120px; height:120px; background:rgba(0,0,0,0.3); border-radius:50%; display:flex; align-items:center; justify-content:center; border:3px solid rgba(255,255,255,0.1); margin-bottom:15px;">
                    <img src="${_resImg(m.sprite)}" style="width:90px; height:90px; image-rendering:pixelated;">
                </div>
                <h1 style="margin:0; font-size:1.8rem; font-family:'Rajdhani'; text-transform:uppercase;">${m.name}</h1>
                <div style="margin:10px 0 20px;">
                    <span class="type-badge type-${(m.type||'normal').toLowerCase()}" style="font-size:0.8rem; padding:4px 10px;">${m.type}</span>
                </div>

                <div style="width:100%; background:rgba(0,0,0,0.2); padding:15px; border-radius:10px; border:1px solid rgba(255,255,255,0.05);">
                    <h3 style="color:#aaa; font-size:0.8rem; margin-bottom:10px; border-bottom:1px solid #333;">STATS BASE</h3>
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        ${renderStat('HP', s.hp, '#2ecc71')}
                        ${renderStat('ATK', s.attack, '#e74c3c')}
                        ${renderStat('DEF', s.defense, '#f1c40f')}
                        ${renderStat('SPD', s.speed, '#3498db')}
                    </div>
                </div>
                ${movesHtml}
            </div>`;
    }

    function renderStat(label, val, color) {
        const pct = Math.min(100, (val/150)*100);
        return `<div style="display:flex; align-items:center; gap:10px; font-size:0.8rem;">
            <span style="width:30px; font-weight:bold; color:#777;">${label}</span>
            <div style="flex:1; height:6px; background:#111; border-radius:3px; overflow:hidden;"><div style="width:${pct}%; height:100%; background:${color};"></div></div>
            <span style="width:25px; text-align:right; color:#fff;">${val}</span></div>`;
    }

    function filterDex() {
        const v = document.getElementById('dexSearch').value.toLowerCase();
        document.querySelectorAll('.dex-icon').forEach(el => el.style.display = el.getAttribute('data-name').includes(v) ? 'flex' : 'none');
    }
    function closeDexDetails() { document.getElementById('dexDetailsView').classList.remove('active'); document.querySelectorAll('.dex-icon').forEach(e => e.classList.remove('selected')); }

    // --- MONSTER MANAGEMENT ---
    async function openPokemon() { 
        document.getElementById('modalPokemon').style.display='flex'; 
        const content = document.getElementById('pokemonListContent'); content.innerHTML = 'Carregando...'; 
        try { 
            const res = await fetch(`/api/me?userId=${USER_ID}`); 
            const data = await res.json(); 
            if(data.allMoves) GLOBAL_MOVES_LIB = data.allMoves;
            renderPokemonList(data.team); 
        } catch(e) { content.innerHTML = 'Erro.'; } 
    }

    function renderPokemonList(team) {
        const content = document.getElementById('pokemonListContent'); 
        if (!team || team.length === 0) { content.innerHTML = '<p style="text-align:center; color:#777;">Vazio.</p>'; return; }
        
        let html = '';
        team.forEach((p, index) => {
            const hpPct = Math.min(100, (p.hp / p.maxHp) * 100);
            const xpPct = (p.xp && p.xpToNext) ? Math.min(100, (p.xp / p.xpToNext) * 100) : 0;
            const movesStr = JSON.stringify(p.moves || []).replace(/"/g, '&quot;');
            const learnedStr = JSON.stringify(p.learnedMoves || []).replace(/"/g, '&quot;');

            html += `
            <div class="poke-card ${index === 0 ? 'leader' : ''}">
                <div class="poke-img-container"><img src="${_resImg(p.sprite)}" class="poke-img"></div>
                <div class="poke-details">
                    <div class="poke-name">${p.name} <span style="font-size:0.7rem; color:#f1c40f;">Lv.${p.level}</span></div>
                    <div class="stat-label"><span>HP</span> <span>${p.hp}/${p.maxHp}</span></div>
                    <div class="stat-bar-box"><div class="stat-fill hp-fill" style="width:${hpPct}%"></div></div>
                    <div class="stat-label"><span>XP</span> <span>${p.xp}/${p.xpToNext}</span></div>
                    <div class="stat-bar-box" style="height:4px; background:#111;"><div class="stat-fill xp-fill" style="width:${xpPct}%"></div></div>
                </div>
                <div class="card-actions">
                    ${index !== 0 ? `<button onclick="setLead('${p.instanceId}')" class="icon-btn" title="L√≠der">‚≠ê</button>` : ''}
                    <button onclick="showMoveEditor('${p.instanceId}', '${p.name}', ${movesStr}, ${learnedStr})" class="icon-btn" title="Skills">‚öîÔ∏è</button>
                    <button onclick="abandonPokemon('${p.instanceId}')" class="icon-btn" style="color:#e74c3c">üóëÔ∏è</button>
                </div>
            </div>`;
        });
        content.innerHTML = html;
    }

    // --- ACTIONS ---
    async function setLead(id) { await fetch('/api/set-lead', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); }
    async function abandonPokemon(id) { if(confirm('Certeza?')) { await fetch('/api/abandon-pokemon', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); } }
    
    function showMoveEditor(id, name, equipped, learned) {
        currentMonId = id;
        const pool = (learned && learned.length > 0) ? learned : equipped;
        let html = `<h3 style="color:#3498db; margin-bottom:10px;">${name} - Skills</h3><div class="skills-grid">`; 
        pool.forEach(moveId => { 
            const isEquipped = equipped.includes(moveId); 
            const moveData = GLOBAL_MOVES_LIB[moveId] || { name: moveId, element: 'normal' };
            html += `<div onclick="toggleMove(this)" class="skill-card type-${(moveData.element||'normal').toLowerCase()} ${isEquipped ? 'equipped' : ''}" data-id="${moveId}">
                    <div class="skill-name">${moveData.name}</div><div class="skill-type">${moveData.element}</div></div>`; 
        }); 
        html += `</div><div style="margin-top:20px; display:flex; gap:10px;"><button onclick="saveMoves()" class="btn-success" style="flex:1;">Salvar</button><button onclick="openPokemon()" style="flex:1; background:#333; border:none; color:#fff; border-radius:6px;">Voltar</button></div>`;
        document.getElementById('pokemonListContent').innerHTML = html; 
    }
    
    function toggleMove(el) {
        if(el.classList.contains('equipped')) { if(document.querySelectorAll('.skill-card.equipped').length <= 1) return alert('Min 1'); el.classList.remove('equipped'); }
        else { if(document.querySelectorAll('.skill-card.equipped').length >= 4) return alert('Max 4'); el.classList.add('equipped'); }
    }
    async function saveMoves() {
        const moves = Array.from(document.querySelectorAll('.skill-card.equipped')).map(c => c.getAttribute('data-id'));
        await fetch('/api/equip-move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:currentMonId, moves }) }); openPokemon();
    }

    // --- MOCHILA E RARE CANDY (CORRIGIDO) ---
    async function openBag() { 
        document.getElementById('modalBag').style.display='flex'; 
        const res = await fetch(`/api/me?userId=${USER_ID}`); 
        const data = await res.json(); 
        
        let candyBtn = '';
        if (data.rareCandy > 0) {
            candyBtn = `<button onclick="startRareCandySelection()" class="btn-success" style="padding:4px 8px; font-size:0.7rem;">USAR</button>`;
        }

        document.getElementById('bagItemsContent').innerHTML = `
            <div class="poke-card" style="display:block;">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:10px;">
                    <span style="display:flex; align-items:center; gap:10px;"><img src="/uploads/catchcube.gif" class="pixel-icon"> CatchCubes</span> 
                    <strong style="color:#fff; font-size:1.1rem;">${data.pokeballs || 0}</strong>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="display:flex; align-items:center; gap:10px;"><span style="font-size:1.4rem; line-height:1;">üç¨</span> Rare Candy</span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong style="color:#fff; font-size:1.1rem;">${data.rareCandy || 0}</strong>
                        ${candyBtn}
                    </div>
                </div>
            </div>`; 
    }

    async function startRareCandySelection() {
        closeModal('modalBag');
        openPokemon(); 
        setTimeout(() => {
            alert("Selecione um Pok√©mon para dar o doce.");
            const cards = document.querySelectorAll('#pokemonListContent .poke-card');
            cards.forEach(card => {
                card.style.border = '2px dashed #f1c40f';
                card.style.cursor = 'pointer';
                const actions = card.querySelector('.card-actions');
                if(actions) actions.style.display = 'none';
                
                // Encontrar ID no HTML (Meio gambiarra mas funcional pro layout atual)
                // O HTML renderizado tem chamadas de fun√ß√£o com o ID
                const html = card.innerHTML;
                const match = html.match(/setLead\('([^']+)'\)/) || html.match(/abandonPokemon\('([^']+)'\)/) || html.match(/showMoveEditor\('([^']+)'/);
                
                if(match) {
                    const pokeId = match[1];
                    card.onclick = () => applyRareCandy(pokeId);
                }
            });
        }, 500);
    }

    async function applyRareCandy(pokeId) {
        try {
            const res = await fetch('/api/use-item', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ userId: USER_ID, itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) 
            });
            const data = await res.json();
            if(data.success) {
                alert(data.evolved ? 'Sua criatura evoluiu!' : 'N√≠vel subiu!');
                openPokemon(); 
            } else { alert(data.error); }
        } catch(e) { alert("Erro ao usar item."); }
    }
</script>
