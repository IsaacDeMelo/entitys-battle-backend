<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Lobby</title>
    
    <!-- FONTES -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- ESTILOS OTIMIZADOS -->
    <style>
        :root {
            --bg-core: #0f172a;
            --bg-glass: rgba(30, 41, 59, 0.95); /* Mais escuro para leitura */
            --border-glass: rgba(255, 255, 255, 0.1);
            --accent-primary: #3b82f6;
            --accent-gold: #fbbf24;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --radius-lg: 20px;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Rajdhani', sans-serif; background: #000; color: var(--text-main); margin: 0; overflow: hidden; }
        
        /* UTILS */
        .pixel-art { image-rendering: pixelated; }
        
        /* TOAST NOTIFICATION (FEEDBACK) */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20000; pointer-events: none; width: 90%; max-width: 300px; text-align: center; }
        .toast { background: rgba(16, 185, 129, 0.95); color: #fff; padding: 12px 20px; border-radius: 50px; margin-bottom: 10px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: toastPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(4px); font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        @keyframes toastPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* --- MODAIS (Estilo App Nativo) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); 
            z-index: 11000; display: none; justify-content: center; align-items: flex-end; /* Mobile: Bottom Sheet */
            animation: fadeIn 0.2s ease-out;
        }
        @media(min-width: 768px) { .modal-overlay { align-items: center; } }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-content { 
            background: #111827; 
            width: 100%; max-width: 600px; height: 90vh; /* Ocupa quase toda tela no mobile */
            border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
            border-top: 1px solid var(--border-glass);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media(min-width: 768px) { 
            .modal-content { height: auto; max-height: 85vh; border-radius: var(--radius-lg); border: 1px solid var(--border-glass); animation: fadeIn 0.2s; } 
        }

        .modal-header {
            padding: 18px 24px; background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border-glass);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .modal-header h2 { 
            margin: 0; font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.4rem; 
            color: var(--text-main); letter-spacing: 0.5px; text-transform: uppercase;
            display: flex; align-items: center; gap: 10px;
        }
        .close-icon-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; padding: 0 10px; }

        .modal-body { 
            padding: 20px; overflow-y: auto; flex: 1; 
            background: linear-gradient(to bottom, #111827, #030712);
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        /* Footer com bot√£o fechar grande */
        .modal-footer-close {
            padding: 15px 20px;
            background: #0f172a;
            border-top: 1px solid var(--border-glass);
            flex-shrink: 0;
        }
        .btn-big-close {
            width: 100%; background: #334155; color: #fff; border: none;
            padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
        }
        .btn-big-close:active { background: #475569; transform: scale(0.98); }

        /* --- CARDS DOS MONSTROS --- */
        .mon-card { 
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-glass);
            border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: grid; grid-template-columns: 65px 1fr auto; gap: 15px;
            align-items: center; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .mon-card:active { transform: scale(0.98); background: rgba(59, 130, 246, 0.1); }
        .mon-card.leader { border-color: var(--accent-gold); box-shadow: inset 0 0 15px rgba(251, 191, 36, 0.1); }
        
        .mon-avatar { 
            width: 65px; height: 65px; background: rgba(0,0,0,0.4); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-glass);
        }
        .mon-avatar img { width: 50px; height: 50px; }
        
        .mon-stats { display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        .mon-name { font-weight: 800; font-size: 1.1rem; color: #fff; }
        .mon-lvl { font-size: 0.75rem; color: var(--accent-gold); background: rgba(251,191,36,0.15); padding: 2px 8px; border-radius: 6px; margin-left: 6px; }
        
        .bar-wrapper { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--text-muted); font-weight: 700; }
        .bar-track { flex: 1; height: 8px; background: rgba(0,0,0,0.6); border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .hp-fill { background: linear-gradient(90deg, #22c55e, #10b981); }
        .xp-fill { background: linear-gradient(90deg, #06b6d4, #3b82f6); }
        
        .mon-actions { display: flex; flex-direction: column; gap: 8px; }
        .icon-btn { 
            width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-glass);
            background: rgba(255,255,255,0.08); color: #fff; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* --- PC SYSTEM (Redesenhado para Toque) --- */
        .pc-layout { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        
        .pc-box-container {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); border-radius: 12px;
            padding: 10px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;
        }
        .pc-header { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 700; display:flex; justify-content:space-between; }
        
        /* Grid maior para dedos gordos */
        .pc-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
            gap: 10px; padding-bottom: 20px; 
        }
        .pc-slot { 
            aspect-ratio: 1; background: rgba(255,255,255,0.05); 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center; 
            position: relative; cursor: pointer; transition: 0.1s;
        }
        .pc-slot:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
        .pc-slot img { width: 50px; height: 50px; }
        .pc-slot .lvl-badge { position: absolute; bottom: 2px; right: 2px; background: #000; color: #fbbf24; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; font-weight: bold; }

        .pc-team-strip {
            background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px; padding: 12px; display: flex; gap: 10px; overflow-x: auto;
            flex-shrink: 0; min-height: 90px; align-items: center;
        }

        /* --- ACTION MENU DO PC (Popup) --- */
        #pcActionMenu {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #1e293b; border-top: 2px solid var(--accent-primary);
            border-radius: 20px 20px 0 0; padding: 20px; z-index: 12000;
            display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
            animation: slideUp 0.2s;
        }
        #pcActionMenu.active { display: flex; }
        .pc-action-title { color: #fff; text-align: center; margin-bottom: 10px; font-size: 1.1rem; }
        .btn-pc-action {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            font-weight: 700; font-size: 1rem; text-transform: uppercase; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-move-team { background: var(--success); color: #fff; }
        .btn-move-box { background: var(--accent-primary); color: #fff; }
        .btn-release { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .btn-cancel-action { background: #334155; color: #fff; }

        /* --- POKEDEX GRID --- */
        .dex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; overflow-y: auto; padding: 10px; }
        .dex-entry { aspect-ratio: 1; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .dex-entry.unlocked { background: rgba(59, 130, 246, 0.15); border-color: var(--accent-primary); }
        .dex-entry.locked img { filter: grayscale(1); opacity: 0.3; }
        
        /* MENU FLUTUANTE */
        .float-container { position: fixed; right: 20px; bottom: 100px; z-index: 9999; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
        .float-btn { width: 60px; height: 60px; border-radius: 25px; background: #1f2937; border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 1.6rem; cursor: pointer; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .float-btn:active { transform: scale(0.9); }
        .float-menu-items { display: none; flex-direction: column-reverse; gap: 15px; }
        .float-menu-items.show { display: flex; animation: slideUp 0.3s; }

        /* Outros */
        .dex-details { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111827; z-index: 20; transform: translateX(110%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .dex-details.active { transform: translateX(0); }
        .back-btn-dex { padding: 15px; background: rgba(0,0,0,0.3); color: #fff; border:none; text-align:left; font-size:1rem; font-weight:bold; cursor:pointer; }

        /* BAG ROW */
        .bag-item-row { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border-glass); }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- MENU FLUTUANTE -->
    <div class="float-container" id="floatMenu">
        <div id="menuItems" class="float-menu-items">
            <button class="float-btn" onclick="openBag()" style="color:#fbbf24;">üéí</button>
            <button class="float-btn" onclick="openPokemon()" style="color:#ef4444;">
                <img src="/uploads/catchcube.gif" class="pixel-art" style="width:30px;">
            </button>
            <button class="float-btn" onclick="openPC()" style="color:#22c55e;">üíª</button>
            <button class="float-btn" onclick="openPokedex()" style="color:#3b82f6;">üì±</button>
        </div>
        <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
    </div>

    <!-- MODAL: MEU TIME -->
    <div class="modal-overlay" id="modalPokemon">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span style="color:#ef4444;">‚óè</span> Equipe</h2>
                <button class="close-icon-btn" onclick="closeModal('modalPokemon')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="pokemonListContent">Carregando...</div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalPokemon')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: POKEDEX -->
    <div class="modal-overlay" id="modalPokedex">
        <div class="modal-content" style="max-width:800px; height:90vh;">
            <div class="dex-container" style="display:flex; height:100%; position:relative; overflow:hidden;">
                <div style="flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden;">
                    <div style="padding-bottom:15px;">
                        <input type="text" id="dexSearch" style="width:100%; padding:15px; background:rgba(0,0,0,0.4); border:1px solid #333; border-radius:12px; color:#fff;" placeholder="üîç Buscar na Dex..." onkeyup="filterDex()">
                    </div>
                    <div id="dexGrid" class="dex-grid"></div>
                </div>
                
                <!-- DEX DETAILS OVERLAY -->
                <div id="dexDetailsView" class="dex-details">
                    <button class="back-btn-dex" onclick="closeDexDetails()">‚¨Ö VOLTAR PARA LISTA</button>
                    <div id="dexContentInner" style="flex:1; overflow-y:auto; padding:20px;"></div>
                </div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalPokedex')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: PC STORAGE (Otimizado Mobile) -->
    <div class="modal-overlay" id="modalPC">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span style="color:#22c55e;">‚óè</span> PC Storage</h2>
                <button class="close-icon-btn" onclick="closeModal('modalPC')">√ó</button>
            </div>
            <div class="modal-body" style="padding:15px;">
                <div class="pc-layout">
                    <!-- BOX AREA -->
                    <div class="pc-box-container">
                        <div class="pc-header"><span>BOX 01</span> <span>Toque para mover</span></div>
                        <div class="pc-grid" id="pcStorageArea">Carregando...</div>
                    </div>
                    
                    <!-- TEAM AREA -->
                    <div style="flex-shrink:0;">
                        <div class="pc-header" style="color:#22c55e;"><span>TIME ATUAL (Max 6)</span></div>
                        <div class="pc-team-strip" id="pcTeamArea"></div>
                    </div>
                </div>
                
                <!-- POPUP DE A√á√ÉO DO PC -->
                <div id="pcActionMenu">
                    <div id="pcActionTitle" class="pc-action-title">Selecionado: ???</div>
                    <div id="pcActionButtons" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <button class="btn-pc-action btn-cancel-action" onclick="closePCAction()">Cancelar</button>
                </div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalPC')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: MOCHILA -->
    <div class="modal-overlay" id="modalBag">
        <div class="modal-content" style="height:70vh;">
            <div class="modal-header">
                <h2><span style="color:#fbbf24;">‚óè</span> Mochila</h2>
                <button class="close-icon-btn" onclick="closeModal('modalBag')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="bagItemsContent">Carregando...</div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalBag')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <script>
        const USER_ID = '<%= user._id %>';
        let isSelectingMode = false;
        let currentMonId = null;
        let GLOBAL_MOVES_LIB = {};
        let CACHED_PC_DATA = null;
        
        // DADOS E HIST√ìRICO
        const RAW_ENTITIES = <%- JSON.stringify(entities || []) %>;
        const RAW_TEAM = <%- JSON.stringify(user.pokemonTeam || []) %>;
        const RAW_PC = <%- JSON.stringify(user.pc || []) %>;
        const REGISTERED_DEX_HISTORY = <%- JSON.stringify(user.dex || []) %>;
        
        const UNLOCKED_IDS = new Set([
            ...REGISTERED_DEX_HISTORY,
            ...RAW_TEAM.map(p => String(p.baseId||p.id)), 
            ...RAW_PC.map(p => String(p.baseId||p.id))
        ]);

        const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;

        // UTILS
        function showToast(msg) {
            const div = document.createElement('div'); div.className = 'toast'; div.innerText = msg;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 2500);
        }
        function toggleFloatMenu() { document.getElementById('menuItems').classList.toggle('show'); }
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none';
            if (id === 'modalPokemon') isSelectingMode = false; 
            if (id === 'modalPC') closePCAction();
        }

        /* --- EQUIPE / MONSTROS --- */
        async function openPokemon() { 
            document.getElementById('modalPokemon').style.display='flex'; 
            try { 
                const r = await fetch(`/api/me?userId=${USER_ID}`); 
                const d = await r.json(); 
                if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; 
                renderPokemonList(d.team); 
            } catch(e) { document.getElementById('pokemonListContent').innerHTML = 'Erro de conex√£o.'; } 
        }

        function renderPokemonList(team) {
            const content = document.getElementById('pokemonListContent');
            if(!team || team.length === 0) { content.innerHTML='<div style="text-align:center; margin-top:50px; color:#555;">Nenhuma criatura.</div>'; return; }
            let html = '';
            if(isSelectingMode) html += `<div style="background:rgba(251,191,36,0.2); color:#fbbf24; padding:12px; text-align:center; border-radius:12px; font-weight:bold; margin-bottom:15px; border:1px solid #fbbf24;">SELECIONE PARA USAR O ITEM</div>`;
            
            team.forEach((p, idx) => {
                const hpPct = Math.min(100, (p.hp/p.maxHp)*100);
                const xpMax = p.xpToNext || 100;
                const xpPct = Math.min(100, (p.xp / xpMax) * 100);
                const mStr = JSON.stringify(p.moves||[]).replace(/"/g, '&quot;');
                const lStr = JSON.stringify(p.learnedMoves||[]).replace(/"/g, '&quot;');
                
                const clickAttr = isSelectingMode ? `onclick="applyRareCandy('${p.instanceId}')"` : '';
                const cardClass = isSelectingMode ? 'mon-card leader' : `mon-card ${idx===0?'leader':''}`;

                html += `
                <div class="${cardClass}" ${clickAttr}>
                    <div class="mon-avatar"><img src="${_resImg(p.sprite)}" class="pixel-art"></div>
                    <div class="mon-stats">
                        <div style="display:flex; align-items:center;">
                            <span class="mon-name">${p.name}</span>
                            <span class="mon-lvl">Lv.${p.level}</span>
                        </div>
                        <div class="bar-wrapper"><span style="width:20px;">HP</span><div class="bar-track"><div class="bar-fill hp-fill" style="width:${hpPct}%;"></div></div></div>
                        <div class="bar-wrapper"><span style="width:20px;">XP</span><div class="bar-track"><div class="bar-fill xp-fill" style="width:${xpPct}%;"></div></div></div>
                    </div>
                    ${!isSelectingMode ? `
                    <div class="mon-actions">
                        <div class="icon-btn" onclick="showMoveEditor('${p.instanceId}','${p.name}',${mStr},${lStr})">‚öîÔ∏è</div>
                        ${idx!==0 ? `<div class="icon-btn" onclick="setLead('${p.instanceId}')">‚≠ê</div>` : ''}
                        <div class="icon-btn" onclick="abandonPokemon('${p.instanceId}')" style="color:#ef4444; border-color:rgba(239,68,68,0.3);">‚úï</div>
                    </div>` : ''}
                </div>`;
            });
            if(isSelectingMode) html += `<button onclick="cancelSelection()" class="btn-big-close" style="background:#333;">CANCELAR USO</button>`;
            content.innerHTML = html;
        }

        /* --- POKEDEX --- */
        async function openPokedex() {
            document.getElementById('modalPokedex').style.display='flex';
            if(Object.keys(GLOBAL_MOVES_LIB).length === 0) { try { const r = await fetch(`/api/me?userId=${USER_ID}`); const d = await r.json(); if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; } catch(e){} }
            renderDexGrid();
        }
        function renderDexGrid() {
            const grid = document.getElementById('dexGrid'); grid.innerHTML = '';
            RAW_ENTITIES.forEach((p, index) => {
                const id = String(p.id||p._id);
                const isUnlocked = UNLOCKED_IDS.has(id);
                grid.innerHTML += `<div class="dex-entry ${isUnlocked ? 'unlocked' : 'locked'}" onclick="selectDexMonster('${id}')" data-name="${(p.name||'').toLowerCase()}">
                    <span class="dex-num">#${(index+1).toString().padStart(3,'0')}</span>
                    <img src="${_resImg(p.sprite)}" loading="lazy" class="pixel-art" style="width:40px; height:40px;">
                </div>`;
            });
        }
        function selectDexMonster(idStr) {
            const m = RAW_ENTITIES.find(x => String(x.id||x._id) === idStr); if(!m) return;
            const isUnlocked = UNLOCKED_IDS.has(idStr);
            let movesHtml = '';
            const pool = (m.movePool || m.learnset || []).sort((a,b)=>a.level-b.level);
            if(pool.length > 0) {
                movesHtml = '<div style="margin-top:20px; padding:10px; background:rgba(255,255,255,0.03); border-radius:12px;"><h4 style="margin:0 0 10px 0; color:#888;">GOLPES</h4>';
                pool.forEach(mv => {
                    const d = GLOBAL_MOVES_LIB[mv.moveId||mv.move] || {name:mv.moveId||mv.move, element:'normal'};
                    movesHtml += `<div style="display:flex; justify-content:space-between; font-size:0.8rem; border-bottom:1px solid rgba(255,255,255,0.05); padding:6px 0;">
                        <span style="color:var(--accent-gold);">Lv.${mv.level}</span><span>${d.name}</span><span style="color:#aaa; font-size:0.7rem;">${d.element}</span></div>`;
                });
                movesHtml += '</div>';
            }
            const pct = (v) => Math.min(100, (v/150)*100);
            const statBar = (l,v,c) => `<div style="display:flex; align-items:center; margin-bottom:5px; font-size:0.8rem;"><span style="width:30px; font-weight:bold; color:#777;">${l}</span><div style="flex:1; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; margin:0 8px;"><div style="width:${pct(v)}%; height:100%; background:${c}; border-radius:3px;"></div></div><span style="width:25px; text-align:right;">${v}</span></div>`;
            
            document.getElementById('dexContentInner').innerHTML = `
                <div style="text-align:center; padding-bottom:20px;">
                    <div style="width:100px; height:100px; margin:0 auto 15px; background:rgba(0,0,0,0.3); border-radius:20px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1);"><img src="${_resImg(m.sprite)}" class="pixel-art" style="transform:scale(1.5); filter:${!isUnlocked?'grayscale(1) brightness(0.5)':''}"></div>
                    <h1 style="margin:0; font-size:1.6rem; text-transform:uppercase;">${m.name}</h1>
                    <span style="display:inline-block; margin-top:5px; padding:4px 12px; background:#333; border-radius:20px; font-size:0.7rem; font-weight:bold; text-transform:uppercase;">${m.type}</span>
                    <div style="margin-top:10px; font-size:0.8rem; color:${isUnlocked?'#10b981':'#64748b'}; font-weight:bold;">${isUnlocked?'‚óè REGISTRADO':'‚óè N√ÉO CAPTURADO'}</div>
                </div>
                <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px;">
                    <h4 style="margin:0 0 10px 0; color:#888;">STATS BASE</h4>
                    ${statBar('HP', m.baseStats.hp, '#10b981')} ${statBar('ATK', m.baseStats.attack, '#ef4444')}
                    ${statBar('DEF', m.baseStats.defense, '#fbbf24')} ${statBar('SPD', m.baseStats.speed, '#3b82f6')}
                </div>
                ${movesHtml}
                <div style="height:50px;"></div>
            `;
            document.getElementById('dexDetailsView').classList.add('active');
        }
        function closeDexDetails() { document.getElementById('dexDetailsView').classList.remove('active'); }
        function filterDex() { const v = document.getElementById('dexSearch').value.toLowerCase(); document.querySelectorAll('.dex-entry').forEach(e => e.style.display = e.getAttribute('data-name').includes(v) ? 'flex' : 'none'); }

        /* --- PC SYSTEM (TAP TO MOVE) --- */
        async function openPC(forceRefresh = false) { 
            document.getElementById('modalPC').style.display = 'flex'; 
            closePCAction();
            if (CACHED_PC_DATA && !forceRefresh) { renderPCLayout(CACHED_PC_DATA.team, CACHED_PC_DATA.pc); return; }
            try { 
                document.getElementById('pcStorageArea').innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">Carregando...</div>';
                const r = await fetch(`/api/pc?userId=${USER_ID}`); 
                const d = await r.json(); 
                CACHED_PC_DATA = d; renderPCLayout(d.team, d.pc); 
            } catch(e) { console.error(e); }
        }

        function renderPCLayout(team, pc) {
            // RENDER BOX
            const boxHtml = pc.map(p => `
                <div class="pc-slot" onclick="openPCAction('${p.instanceId}', '${p.name}', 'pc')">
                    <img src="${_resImg(p.sprite)}" class="pixel-art">
                    <div class="lvl-badge">Lv.${p.level}</div>
                </div>`).join('') + Array(10).fill('<div class="pc-slot" style="opacity:0.2; cursor:default;"></div>').join('');
            document.getElementById('pcStorageArea').innerHTML = boxHtml;

            // RENDER TEAM
            const teamHtml = team.map(p => `
                <div class="pc-slot" style="min-width:60px; border-color:#10b981;" onclick="openPCAction('${p.instanceId}', '${p.name}', 'team')">
                    <img src="${_resImg(p.sprite)}" class="pixel-art">
                    <div class="lvl-badge">Lv.${p.level}</div>
                </div>`).join('') + (team.length < 6 ? '<div class="pc-slot" style="min-width:60px; border:1px dashed #555; opacity:0.5;"></div>' : '');
            document.getElementById('pcTeamArea').innerHTML = teamHtml;
        }

        // A√á√ÉO DO CLIQUE NO PC
        let selectedPCData = null;
        function openPCAction(pokeId, name, source) {
            selectedPCData = { pokeId, source };
            document.getElementById('pcActionTitle').innerText = name;
            const btnContainer = document.getElementById('pcActionButtons');
            
            if (source === 'pc') {
                btnContainer.innerHTML = `<button class="btn-pc-action btn-move-team" onclick="confirmPCMove('team')">üì• MOVER PARA O TIME</button>`;
            } else {
                btnContainer.innerHTML = `<button class="btn-pc-action btn-move-box" onclick="confirmPCMove('pc')">üì§ MOVER PARA O BOX</button>`;
            }
            document.getElementById('pcActionMenu').classList.add('active');
        }

        function closePCAction() { document.getElementById('pcActionMenu').classList.remove('active'); selectedPCData = null; }

        async function confirmPCMove(targetContainer) {
            if (!selectedPCData) return;
            const { pokeId, source } = selectedPCData;
            closePCAction();
            
            // Feedback otimista
            showToast("Movendo...");
            
            try {
                const res = await fetch('/api/pc/move', { 
                    method: 'POST', headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({ userId: USER_ID, pokemonId: pokeId, from: source, to: targetContainer }) 
                });
                const data = await res.json();
                
                if(data.success) {
                    showToast("Sucesso!");
                    openPC(true); // Recarrega
                } else {
                    alert(data.error || "Erro ao mover.");
                }
            } catch(e) { alert("Erro de conex√£o"); }
        }

        /* --- MOCHILA --- */
        async function openBag() { 
            document.getElementById('modalBag').style.display='flex'; 
            const r = await fetch(`/api/me?userId=${USER_ID}`); 
            const d = await r.json(); 
            const itemRow = (icon, nome, qtd, action) => `<div class="bag-item-row"><div style="font-size:1.8rem; margin-right:15px;">${icon}</div><div style="flex:1;"><div style="font-weight:700; font-size:1.1rem; color:#fff;">${nome}</div><div style="color:#aaa; font-size:0.8rem;">Qtd: ${qtd}</div></div>${action?action:''}</div>`;
            let html = itemRow('üì¶', 'CatchCubes', d.pokeballs||0);
            const btn = `<button onclick="startRareCandySelection()" style="background:var(--accent-primary); border:none; padding:8px 16px; border-radius:8px; color:white; font-weight:bold;">USAR</button>`;
            html += itemRow('üç¨', 'Rare Candy', d.rareCandy||0, (d.rareCandy>0 ? btn : ''));
            document.getElementById('bagItemsContent').innerHTML = html;
        }
        function startRareCandySelection() { closeModal('modalBag'); isSelectingMode = true; openPokemon(); }
        function cancelSelection() { isSelectingMode = false; openPokemon(); }

        /* --- SKILLS & OUTROS --- */
        function showMoveEditor(id, name, equipped, learned) {
            currentMonId = id;
            const pool = (learned && learned.length>0) ? learned : equipped;
            let html = `<div style="text-align:center; margin-bottom:15px;"><h3 style="margin:0; color:#fff;">${name}</h3><small style="color:#aaa;">Selecione at√© 4 golpes</small></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
            pool.forEach(mid => {
                const eq = equipped.includes(mid);
                const d = GLOBAL_MOVES_LIB[mid] || {name:mid, element:'normal'};
                html += `<div onclick="toggleMove(this)" class="skill-item ${eq?'active':''}" data-id="${mid}" style="background:#1f2937; padding:12px; border-radius:8px; border:1px solid ${eq?'#10b981':'transparent'}; cursor:pointer;"><div style="font-weight:bold; color:#fff;">${d.name}</div><div style="font-size:0.7rem; color:#888; text-transform:uppercase;">${d.element}</div></div>`;
            });
            html += `</div><button onclick="saveMoves()" class="btn-big-close" style="background:#10b981; margin-top:15px;">SALVAR GOLPES</button>`;
            document.getElementById('pokemonListContent').innerHTML = html;
        }
        function toggleMove(el) {
            if(el.classList.contains('active')) { if(document.querySelectorAll('.skill-item.active').length <= 1) return alert('M√≠nimo 1'); el.classList.remove('active'); }
            else { if(document.querySelectorAll('.skill-item.active').length >= 4) return alert('M√°ximo 4'); el.classList.add('active'); }
        }
        async function saveMoves() {
            const moves = Array.from(document.querySelectorAll('.skill-item.active')).map(c => c.getAttribute('data-id'));
            await fetch('/api/equip-move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:currentMonId, moves }) });
            openPokemon();
        }
        async function setLead(id) { await fetch('/api/set-lead', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); }
        async function abandonPokemon(id) { if(confirm('Tem certeza?')) { await fetch('/api/abandon-pokemon', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); } }
        async function applyRareCandy(pokeId) {
            if(!confirm('Usar Rare Candy?')) return;
            try {
                const res = await fetch('/api/use-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: USER_ID, itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) });
                const data = await res.json();
                if(data.success) { showToast(data.evolved ? '‚ú® Evoluiu! ‚ú®' : 'üÜô Subiu de N√≠vel!'); isSelectingMode = false; openPokemon(); } 
                else { alert(data.error); }
            } catch(e) { alert("Erro."); isSelectingMode = false; openPokemon(); }
        }
    </script>
</body>
</html>
