<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Game Lobby</title>
    
    <!-- FONTES -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;600;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">

    <!-- ESTILOS OTIMIZADOS -->
    <style>
        :root {
            --bg-core: #0f172a;
            --bg-glass: rgba(30, 41, 59, 0.95);
            --border-glass: rgba(255, 255, 255, 0.1);
            --accent-primary: #3b82f6;
            --accent-gold: #fbbf24;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --success: #10b981;
            --radius-lg: 20px;
        }

        /* RESET & BASE */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { font-family: 'Rajdhani', sans-serif; background: #000; color: var(--text-main); margin: 0; overflow: hidden; }
        
        /* UTILS */
        .pixel-art { image-rendering: pixelated; }
        
        /* TOAST NOTIFICATION */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 20000; pointer-events: none; width: 90%; max-width: 300px; text-align: center; }
        .toast { background: rgba(16, 185, 129, 0.95); color: #fff; padding: 12px 20px; border-radius: 50px; margin-bottom: 10px; font-weight: 600; box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: toastPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); backdrop-filter: blur(4px); font-family: 'Inter', sans-serif; font-size: 0.9rem; }
        @keyframes toastPop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* MODAIS */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); 
            z-index: 11000; display: none; justify-content: center; align-items: flex-end;
            animation: fadeIn 0.2s ease-out;
        }
        @media(min-width: 768px) { .modal-overlay { align-items: center; } }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-content { 
            background: #111827; 
            width: 100%; max-width: 600px; height: 90vh;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0; 
            border-top: 1px solid var(--border-glass);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5); 
            display: flex; flex-direction: column; overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media(min-width: 768px) { 
            .modal-content { height: auto; max-height: 85vh; border-radius: var(--radius-lg); border: 1px solid var(--border-glass); animation: fadeIn 0.2s; } 
        }

        .modal-header {
            padding: 18px 24px; background: rgba(255,255,255,0.03);
            border-bottom: 1px solid var(--border-glass);
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .modal-header h2 { 
            margin: 0; font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.4rem; 
            color: var(--text-main); letter-spacing: 0.5px; text-transform: uppercase;
            display: flex; align-items: center; gap: 10px;
        }
        .close-icon-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1.8rem; cursor: pointer; padding: 0 10px; }

        .modal-body { 
            padding: 20px; overflow-y: auto; flex: 1; 
            background: linear-gradient(to bottom, #111827, #030712);
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .modal-footer-close {
            padding: 15px 20px;
            background: #0f172a;
            border-top: 1px solid var(--border-glass);
            flex-shrink: 0;
        }
        .btn-big-close {
            width: 100%; background: #334155; color: #fff; border: none;
            padding: 16px; border-radius: 12px; font-size: 1rem; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
        }
        .btn-big-close:active { background: #475569; transform: scale(0.98); }

        /* CARDS */
        .mon-card { 
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-glass);
            border-radius: 16px; padding: 12px; margin-bottom: 12px;
            display: grid; grid-template-columns: 65px 1fr auto; gap: 15px;
            align-items: center; position: relative; overflow: hidden;
            transition: transform 0.2s;
        }
        .mon-card:active { transform: scale(0.98); background: rgba(59, 130, 246, 0.1); }
        .mon-card.leader { border-color: var(--accent-gold); box-shadow: inset 0 0 15px rgba(251, 191, 36, 0.1); }
        
        .mon-avatar { 
            width: 65px; height: 65px; background: rgba(0,0,0,0.4); 
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            border: 1px solid var(--border-glass);
        }
        .mon-avatar img { width: 50px; height: 50px; }
        
        .mon-stats { display: flex; flex-direction: column; justify-content: center; gap: 6px; }
        .mon-name { font-weight: 800; font-size: 1.1rem; color: #fff; }
        .mon-lvl { font-size: 0.75rem; color: var(--accent-gold); background: rgba(251,191,36,0.15); padding: 2px 8px; border-radius: 6px; margin-left: 6px; }
        
        .bar-wrapper { display: flex; align-items: center; gap: 8px; font-size: 0.7rem; color: var(--text-muted); font-weight: 700; }
        .bar-track { flex: 1; height: 8px; background: rgba(0,0,0,0.6); border-radius: 4px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
        .hp-fill { background: linear-gradient(90deg, #22c55e, #10b981); }
        .xp-fill { background: linear-gradient(90deg, #06b6d4, #3b82f6); }
        
        .mon-actions { display: flex; flex-direction: column; gap: 8px; }
        .icon-btn { 
            width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-glass);
            background: rgba(255,255,255,0.08); color: #fff; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }

        /* PC SYSTEM */
        .pc-layout { display: flex; flex-direction: column; gap: 15px; height: 100%; }
        .pc-box-container {
            background: rgba(0,0,0,0.3); border: 1px solid var(--border-glass); border-radius: 12px;
            padding: 10px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;
        }
        .pc-header { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 10px; font-weight: 700; display:flex; justify-content:space-between; }
        .pc-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); 
            gap: 10px; padding-bottom: 20px; 
        }
        .pc-slot { 
            aspect-ratio: 1; background: rgba(255,255,255,0.05); 
            border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; justify-content: center; 
            position: relative; cursor: pointer; transition: 0.1s;
        }
        .pc-slot:active { background: rgba(255,255,255,0.15); transform: scale(0.95); }
        .pc-slot img { width: 50px; height: 50px; }
        .pc-slot .lvl-badge { position: absolute; bottom: 2px; right: 2px; background: #000; color: #fbbf24; font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; font-weight: bold; }

        .pc-team-strip {
            background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 12px; padding: 12px; display: flex; gap: 10px; overflow-x: auto;
            flex-shrink: 0; min-height: 90px; align-items: center;
        }

        /* ACTION MENU PC */
        #pcActionMenu {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: #1e293b; border-top: 2px solid var(--accent-primary);
            border-radius: 20px 20px 0 0; padding: 20px; z-index: 12000;
            display: none; flex-direction: column; gap: 10px;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
            animation: slideUp 0.2s;
        }
        #pcActionMenu.active { display: flex; }
        .pc-action-title { color: #fff; text-align: center; margin-bottom: 10px; font-size: 1.1rem; }
        .btn-pc-action {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            font-weight: 700; font-size: 1rem; text-transform: uppercase; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-move-team { background: var(--success); color: #fff; }
        .btn-move-box { background: var(--accent-primary); color: #fff; }
        .btn-cancel-action { background: #334155; color: #fff; }

        /* POKEDEX */
        .dex-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; overflow-y: auto; padding: 10px; }
        .dex-entry { aspect-ratio: 1; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; }
        .dex-entry.unlocked { background: rgba(59, 130, 246, 0.15); border-color: var(--accent-primary); }
        .dex-entry.locked img { filter: grayscale(1); opacity: 0.3; }
        
        /* MENU FLUTUANTE */
        .float-container { position: fixed; right: 20px; bottom: 100px; z-index: 9999; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
        .float-btn { width: 60px; height: 60px; border-radius: 25px; background: #1f2937; border: 1px solid rgba(255,255,255,0.1); color: #fff; font-size: 1.6rem; cursor: pointer; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .float-btn:active { transform: scale(0.9); }
        .float-menu-items { display: none; flex-direction: column-reverse; gap: 15px; }
        .float-menu-items.show { display: flex; animation: slideUp 0.3s; }

        /* DEX DETAILS */
        .dex-details { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #111827; z-index: 20; transform: translateX(110%); transition: transform 0.3s; display: flex; flex-direction: column; }
        .dex-details.active { transform: translateX(0); }
        .back-btn-dex { padding: 15px; background: rgba(0,0,0,0.3); color: #fff; border:none; text-align:left; font-size:1rem; font-weight:bold; cursor:pointer; }

        /* BAG */
        .bag-header-money { text-align:center; padding:15px; font-size:1.2rem; color:#fbbf24; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:15px; background: rgba(0,0,0,0.2); border-radius: 12px; }
        .bag-item-row { display: flex; align-items: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid var(--border-glass); }
        .bag-tabs { display:flex; gap:10px; margin: 10px 0 15px 0; }
        .bag-tab { flex:1; padding: 12px; border-radius: 12px; border: 1px solid var(--border-glass); background: rgba(255,255,255,0.03); color:#fff; font-weight: 800; cursor:pointer; text-transform: uppercase; }
        .bag-tab.active { background: rgba(251, 191, 36, 0.18); border-color: rgba(251, 191, 36, 0.35); color:#fbbf24; }
        .bag-item-icon { width: 42px; height: 42px; margin-right: 15px; image-rendering: pixelated; object-fit: contain; }
        .bag-empty { padding: 20px; text-align:center; color:#aaa; background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.15); border-radius: 12px; }
        
        /* SKILL EDITOR */
        .skill-item { background:#1f2937; padding:12px; border-radius:8px; border:1px solid transparent; cursor:pointer; transition: 0.2s; }
        .skill-item.active { border-color: #10b981; background: rgba(16, 185, 129, 0.1); }
    </style>
</head>
<body>
    <div id="toast-container"></div>

    <!-- MENU FLUTUANTE -->
    <div class="float-container" id="floatMenu">
        <div id="menuItems" class="float-menu-items">
            <button class="float-btn" onclick="openBag()" style="color:#fbbf24;">üéí</button>
            <button class="float-btn" onclick="openPokemon()" style="color:#ef4444;">
                <img src="/uploads/catchcube.gif" class="pixel-art" style="width:30px;">
            </button>
            <button class="float-btn" onclick="openPC()" style="color:#22c55e;">üíª</button>
            <button class="float-btn" onclick="openPokedex()" style="color:#3b82f6;">üì±</button>
        </div>
        <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
    </div>

    <!-- MODAL: MEU TIME -->
    <div class="modal-overlay" id="modalPokemon">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span style="color:#ef4444;">‚óè</span> Equipe</h2>
                <button class="close-icon-btn" onclick="closeModal('modalPokemon')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="pokemonListContent">Carregando...</div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalPokemon')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: POKEDEX -->
    <div class="modal-overlay" id="modalPokedex">
        <div class="modal-content" style="max-width:800px; height:90vh;">
            <div class="dex-container" style="display:flex; height:100%; position:relative; overflow:hidden;">
                <div style="flex:1; display:flex; flex-direction:column; padding:20px; overflow:hidden;">
                    <div style="padding-bottom:15px;">
                        <input type="text" id="dexSearch" style="width:100%; padding:15px; background:rgba(0,0,0,0.4); border:1px solid #333; border-radius:12px; color:#fff;" placeholder="üîç Buscar na Dex..." onkeyup="filterDex()">
                    </div>
                    <div id="dexGrid" class="dex-grid"></div>
                </div>
                
                <!-- DEX DETAILS OVERLAY -->
                <div id="dexDetailsView" class="dex-details">
                    <button class="back-btn-dex" onclick="closeDexDetails()">‚¨Ö VOLTAR PARA LISTA</button>
                    <div id="dexContentInner" style="flex:1; overflow-y:auto; padding:20px;"></div>
                </div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalPokedex')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: PC STORAGE -->
    <div class="modal-overlay" id="modalPC">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span style="color:#22c55e;">‚óè</span> PC Storage</h2>
                <button class="close-icon-btn" onclick="closeModal('modalPC')">√ó</button>
            </div>
            <div class="modal-body" style="padding:15px;">
                <div class="pc-layout">
                    <!-- BOX AREA -->
                    <div class="pc-box-container">
                        <div class="pc-header"><span>BOX 01</span> <span>Toque para mover</span></div>
                        <div class="pc-grid" id="pcStorageArea">Carregando...</div>
                    </div>
                    
                    <!-- TEAM AREA -->
                    <div style="flex-shrink:0;">
                        <div class="pc-header" style="color:#22c55e;"><span>TIME ATUAL (Max 6)</span></div>
                        <div class="pc-team-strip" id="pcTeamArea"></div>
                    </div>
                </div>
                
                <!-- POPUP DE A√á√ÉO DO PC -->
                <div id="pcActionMenu">
                    <div id="pcActionTitle" class="pc-action-title">Selecionado: ???</div>
                    <div id="pcActionButtons" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <button class="btn-pc-action btn-cancel-action" onclick="closePCAction()">Cancelar</button>
                </div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalPC')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <!-- MODAL: MOCHILA -->
    <div class="modal-overlay" id="modalBag">
        <div class="modal-content" style="height:70vh;">
            <div class="modal-header">
                <h2><span style="color:#fbbf24;">‚óè</span> Mochila</h2>
                <button class="close-icon-btn" onclick="closeModal('modalBag')">√ó</button>
            </div>
            <div class="modal-body">
                <div id="bagItemsContent">Carregando...</div>
            </div>
            <div class="modal-footer-close">
                <button class="btn-big-close" onclick="closeModal('modalBag')">FECHAR JANELA</button>
            </div>
        </div>
    </div>

    <datalist id="itemCatalogDatalist"></datalist>

    <script>
        const USER_ID = '<%= user._id %>';
        const IS_ADMIN = <%= user.isAdmin ? 'true' : 'false' %>;
        let isSelectingMode = false;
        let currentMonId = null;
        let GLOBAL_MOVES_LIB = {};
        let CURRENT_TEAM_DATA = []; // Cache do time para acesso seguro
        let CACHED_PC_DATA = null;
        
        // DADOS E HIST√ìRICO
        const RAW_ENTITIES = <%- JSON.stringify(entities || []) %>;
        const RAW_TEAM = <%- JSON.stringify(user.pokemonTeam || []) %>;
        const RAW_PC = <%- JSON.stringify(user.pc || []) %>;
        const REGISTERED_DEX_HISTORY = <%- JSON.stringify(user.dex || []) %>;
        
        const UNLOCKED_IDS = new Set([
            ...REGISTERED_DEX_HISTORY,
            ...RAW_TEAM.map(p => String(p.baseId||p.id)), 
            ...RAW_PC.map(p => String(p.baseId||p.id))
        ]);

        function resolveImg(s) {
            return s ? s : '/uploads/placeholder.png'; // Fallback se imagem faltar
        }

        // UTILS
        function showToast(msg) {
            const div = document.createElement('div'); div.className = 'toast'; div.innerText = msg;
            document.getElementById('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 2500);
        }
        function toggleFloatMenu() { document.getElementById('menuItems').classList.toggle('show'); }
        function closeModal(id) { 
            document.getElementById(id).style.display = 'none';
            if (id === 'modalPokemon') isSelectingMode = false; 
            if (id === 'modalPC') closePCAction();
        }

        // Cat√°logo de itens (DB)
        window.ITEM_CATALOG = [];
        window.ITEM_CATALOG_MAP = new Map();

        async function loadItemCatalog(force = false) {
            try {
                if (!force && Array.isArray(window.ITEM_CATALOG) && window.ITEM_CATALOG.length) return window.ITEM_CATALOG;
                const rc = await fetch('/api/items/catalog');
                const dc = await rc.json().catch(() => ({}));
                const list = (dc && dc.success && Array.isArray(dc.items)) ? dc.items : [];
                window.ITEM_CATALOG = list;
                window.ITEM_CATALOG_MAP = new Map(list.map(it => [String(it.id), it]));

                // Preenche datalist global (usado no editor de NPCs)
                try {
                    const dl = document.getElementById('itemCatalogDatalist');
                    if (dl) {
                        dl.innerHTML = '';
                        list.forEach(it => {
                            const opt = document.createElement('option');
                            opt.value = String(it.id || '');
                            opt.label = String(it.name || it.id || '');
                            dl.appendChild(opt);
                        });
                    }
                } catch (_) {}

                return list;
            } catch (_) {
                window.ITEM_CATALOG = [];
                window.ITEM_CATALOG_MAP = new Map();
                return [];
            }
        }

        function getItemMeta(id) {
            const key = String(id || '');
            return (window.ITEM_CATALOG_MAP && window.ITEM_CATALOG_MAP.get(key)) || null;
        }

        function getItemIconUrl(id) {
            const meta = getItemMeta(id);
            if (meta && meta.hasIcon) return `/api/items/icon/${encodeURIComponent(String(id))}.png`;
            return '';
        }

        // Carrega cat√°logo uma vez ao abrir a p√°gina (melhora dev editor)
        setTimeout(() => { loadItemCatalog(false); }, 0);

        /* --- EQUIPE / MONSTROS --- */
        async function openPokemon() { 
            document.getElementById('modalPokemon').style.display='flex'; 
            try { 
                const r = await fetch(`/api/me?userId=${USER_ID}`); 
                const d = await r.json(); 
                if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; 
                CURRENT_TEAM_DATA = d.team; // Salvar time no cache global
                renderPokemonList(d.team); 
            } catch(e) { document.getElementById('pokemonListContent').innerHTML = 'Erro de conex√£o.'; } 
        }

        function renderPokemonList(team) {
            const content = document.getElementById('pokemonListContent');
            if(!team || team.length === 0) { content.innerHTML='<div style="text-align:center; margin-top:50px; color:#555;">Nenhuma criatura.</div>'; return; }
            let html = '';
            if(isSelectingMode) html += `<div style="background:rgba(251,191,36,0.2); color:#fbbf24; padding:12px; text-align:center; border-radius:12px; font-weight:bold; margin-bottom:15px; border:1px solid #fbbf24;">SELECIONE PARA USAR O ITEM</div>`;
            
            team.forEach((p, idx) => {
                const hpPct = Math.min(100, (p.hp/p.maxHp)*100);
                const xpMax = p.xpToNext || 100;
                const xpPct = Math.min(100, (p.xp / xpMax) * 100);
                
                const clickAttr = isSelectingMode ? `onclick="applyRareCandy('${p.instanceId}')"` : '';
                const cardClass = isSelectingMode ? 'mon-card leader' : `mon-card ${idx===0?'leader':''}`;

                html += `
                <div class="${cardClass}" ${clickAttr}>
                    <div class="mon-avatar"><img src="${resolveImg(p.sprite)}" class="pixel-art"></div>
                    <div class="mon-stats">
                        <div style="display:flex; align-items:center;">
                            <span class="mon-name">${p.name}</span>
                            <span class="mon-lvl">Lv.${p.level}</span>
                        </div>
                        <div class="bar-wrapper"><span style="width:20px;">HP</span><div class="bar-track"><div class="bar-fill hp-fill" style="width:${hpPct}%;"></div></div></div>
                        <div class="bar-wrapper"><span style="width:20px;">XP</span><div class="bar-track"><div class="bar-fill xp-fill" style="width:${xpPct}%;"></div></div></div>
                    </div>
                    ${!isSelectingMode ? `
                    <div class="mon-actions">
                        <div class="icon-btn" onclick="prepareMoveEditor('${p.instanceId}')">‚öîÔ∏è</div>
                        ${idx!==0 ? `<div class="icon-btn" onclick="setLead('${p.instanceId}')">‚≠ê</div>` : ''}
                        <div class="icon-btn" onclick="abandonPokemon('${p.instanceId}')" style="color:#ef4444; border-color:rgba(239,68,68,0.3);">‚úï</div>
                    </div>` : ''}
                </div>`;
            });
            if(isSelectingMode) html += `<button onclick="cancelSelection()" class="btn-big-close" style="background:#333;">CANCELAR USO</button>`;
            content.innerHTML = html;
        }

        /* --- POKEDEX --- */
        async function openPokedex() {
            document.getElementById('modalPokedex').style.display='flex';
            if(Object.keys(GLOBAL_MOVES_LIB).length === 0) { try { const r = await fetch(`/api/me?userId=${USER_ID}`); const d = await r.json(); if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; } catch(e){} }
            renderDexGrid();
        }
        function renderDexGrid() {
            const grid = document.getElementById('dexGrid'); grid.innerHTML = '';
            RAW_ENTITIES.forEach((p, index) => {
                const id = String(p.id||p._id);
                const isUnlocked = UNLOCKED_IDS.has(id);
                grid.innerHTML += `<div class="dex-entry ${isUnlocked ? 'unlocked' : 'locked'}" onclick="selectDexMonster('${id}')" data-name="${(p.name||'').toLowerCase()}">
                    <span class="dex-num">#${(index+1).toString().padStart(3,'0')}</span>
                    <img src="${resolveImg(p.sprite)}" loading="lazy" class="pixel-art" style="width:40px; height:40px;">
                </div>`;
            });
        }
        function selectDexMonster(idStr) {
            const m = RAW_ENTITIES.find(x => String(x.id||x._id) === idStr); if(!m) return;
            const isUnlocked = UNLOCKED_IDS.has(idStr);
            let movesHtml = '';
            const pool = (m.movePool || m.learnset || []).sort((a,b)=>a.level-b.level);
            if(pool.length > 0) {
                movesHtml = '<div style="margin-top:20px; padding:10px; background:rgba(255,255,255,0.03); border-radius:12px;"><h4 style="margin:0 0 10px 0; color:#888;">GOLPES</h4>';
                pool.forEach(mv => {
                    const d = GLOBAL_MOVES_LIB[mv.moveId||mv.move] || {name:mv.moveId||mv.move, element:'normal'};
                    movesHtml += `<div style="display:flex; justify-content:space-between; font-size:0.8rem; border-bottom:1px solid rgba(255,255,255,0.05); padding:6px 0;">
                        <span style="color:var(--accent-gold);">Lv.${mv.level}</span><span>${d.name}</span><span style="color:#aaa; font-size:0.7rem;">${d.element}</span></div>`;
                });
                movesHtml += '</div>';
            }
            const pct = (v) => Math.min(100, (v/150)*100);
            const statBar = (l,v,c) => `<div style="display:flex; align-items:center; margin-bottom:5px; font-size:0.8rem;"><span style="width:30px; font-weight:bold; color:#777;">${l}</span><div style="flex:1; height:6px; background:rgba(255,255,255,0.1); border-radius:3px; margin:0 8px;"><div style="width:${pct(v)}%; height:100%; background:${c}; border-radius:3px;"></div></div><span style="width:25px; text-align:right;">${v}</span></div>`;
            
            document.getElementById('dexContentInner').innerHTML = `
                <div style="text-align:center; padding-bottom:20px;">
                    <div style="width:100px; height:100px; margin:0 auto 15px; background:rgba(0,0,0,0.3); border-radius:20px; display:flex; align-items:center; justify-content:center; border:1px solid rgba(255,255,255,0.1);"><img src="${resolveImg(m.sprite)}" class="pixel-art" style="transform:scale(1.5); filter:${!isUnlocked?'grayscale(1) brightness(0.5)':''}"></div>
                    <h1 style="margin:0; font-size:1.6rem; text-transform:uppercase;">${m.name}</h1>
                    <span style="display:inline-block; margin-top:5px; padding:4px 12px; background:#333; border-radius:20px; font-size:0.7rem; font-weight:bold; text-transform:uppercase;">${m.type}</span>
                    <div style="margin-top:10px; font-size:0.8rem; color:${isUnlocked?'#10b981':'#64748b'}; font-weight:bold;">${isUnlocked?'‚óè REGISTRADO':'‚óè N√ÉO CAPTURADO'}</div>
                </div>
                <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:12px;">
                    <h4 style="margin:0 0 10px 0; color:#888;">STATS BASE</h4>
                    ${statBar('HP', m.baseStats.hp, '#10b981')} ${statBar('ATK', m.baseStats.attack, '#ef4444')}
                    ${statBar('DEF', m.baseStats.defense, '#fbbf24')} ${statBar('SPD', m.baseStats.speed, '#3b82f6')}
                </div>
                ${movesHtml}
                <div style="height:50px;"></div>
            `;
            document.getElementById('dexDetailsView').classList.add('active');
        }
        function closeDexDetails() { document.getElementById('dexDetailsView').classList.remove('active'); }
        function filterDex() { const v = document.getElementById('dexSearch').value.toLowerCase(); document.querySelectorAll('.dex-entry').forEach(e => e.style.display = e.getAttribute('data-name').includes(v) ? 'flex' : 'none'); }

        /* --- PC SYSTEM --- */
        async function openPC(forceRefresh = false) { 
            document.getElementById('modalPC').style.display = 'flex'; 
            closePCAction();
            if (CACHED_PC_DATA && !forceRefresh) { renderPCLayout(CACHED_PC_DATA.team, CACHED_PC_DATA.pc); return; }
            try { 
                document.getElementById('pcStorageArea').innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">Carregando...</div>';
                const r = await fetch(`/api/pc?userId=${USER_ID}`); 
                const d = await r.json(); 
                CACHED_PC_DATA = d; renderPCLayout(d.team, d.pc); 
            } catch(e) { console.error(e); }
        }

        function renderPCLayout(team, pc) {
            const boxHtml = pc.map(p => `
                <div class="pc-slot" onclick="openPCAction('${p.instanceId}', '${p.name}', 'pc')">
                    <img src="${resolveImg(p.sprite)}" class="pixel-art">
                    <div class="lvl-badge">Lv.${p.level}</div>
                </div>`).join('') + Array(10).fill('<div class="pc-slot" style="opacity:0.2; cursor:default;"></div>').join('');
            document.getElementById('pcStorageArea').innerHTML = boxHtml;

            const teamHtml = team.map(p => `
                <div class="pc-slot" style="min-width:60px; border-color:#10b981;" onclick="openPCAction('${p.instanceId}', '${p.name}', 'team')">
                    <img src="${resolveImg(p.sprite)}" class="pixel-art">
                    <div class="lvl-badge">Lv.${p.level}</div>
                </div>`).join('') + (team.length < 6 ? '<div class="pc-slot" style="min-width:60px; border:1px dashed #555; opacity:0.5;"></div>' : '');
            document.getElementById('pcTeamArea').innerHTML = teamHtml;
        }

        let selectedPCData = null;
        function openPCAction(pokeId, name, source) {
            selectedPCData = { pokeId, source };
            document.getElementById('pcActionTitle').innerText = name;
            const btnContainer = document.getElementById('pcActionButtons');
            if (source === 'pc') {
                btnContainer.innerHTML = `<button class="btn-pc-action btn-move-team" onclick="confirmPCMove('team')">üì• MOVER PARA O TIME</button>`;
            } else {
                btnContainer.innerHTML = `<button class="btn-pc-action btn-move-box" onclick="confirmPCMove('pc')">üì§ MOVER PARA O BOX</button>`;
            }
            document.getElementById('pcActionMenu').classList.add('active');
        }

        function closePCAction() { document.getElementById('pcActionMenu').classList.remove('active'); selectedPCData = null; }

        async function confirmPCMove(targetContainer) {
            if (!selectedPCData) return;
            const { pokeId, source } = selectedPCData;
            closePCAction();
            showToast("Movendo...");
            try {
                const res = await fetch('/api/pc/move', { 
                    method: 'POST', headers: {'Content-Type':'application/json'}, 
                    body: JSON.stringify({ userId: USER_ID, pokemonId: pokeId, from: source, to: targetContainer }) 
                });
                const data = await res.json();
                if(data.success) { showToast("Sucesso!"); openPC(true); } 
                else { alert(data.error || "Erro ao mover."); }
            } catch(e) { alert("Erro de conex√£o"); }
        }

        /* --- MOCHILA (AGORA COM DINHEIRO) --- */
        async function openBag() { 
            document.getElementById('modalBag').style.display='flex'; 
            try {
                const r = await fetch(`/api/me?userId=${USER_ID}`); 
                const d = await r.json(); 

                await loadItemCatalog(true);
                
                // HEADER COM DINHEIRO
                let html = `<div class="bag-header-money">üí∞ Dinheiro: <b>$${d.money || 0}</b></div>`;

                html += `
                    <div class="bag-tabs">
                        <button id="bagTabItems" class="bag-tab active" type="button">ITENS</button>
                        <button id="bagTabKeys" class="bag-tab" type="button">KEY ITENS</button>
                    </div>
                    <div id="bagTabBody"></div>
                `;

                document.getElementById('bagItemsContent').innerHTML = html;

                const tabItems = document.getElementById('bagTabItems');
                const tabKeys = document.getElementById('bagTabKeys');
                const body = document.getElementById('bagTabBody');

                const itemRow = (meta, nome, qtd, actionHtml) => {
                    const iconUrl = meta && meta.id ? getItemIconUrl(meta.id) : '';
                    const iconHtml = iconUrl
                        ? `<img class="bag-item-icon" src="${iconUrl}" alt="${nome}">`
                        : `<div style="font-size:1.8rem; margin-right:15px;">üì¶</div>`;
                    const qtyHtml = (qtd !== null && qtd !== undefined)
                        ? `<div style="color:#aaa; font-size:0.8rem;">Qtd: ${qtd}</div>`
                        : `<div style="color:#aaa; font-size:0.8rem;">Item-chave</div>`;
                    return `
                        <div class="bag-item-row">
                            ${iconHtml}
                            <div style="flex:1;">
                                <div style="font-weight:700; font-size:1.1rem; color:#fff;">${nome}</div>
                                ${qtyHtml}
                            </div>
                            ${actionHtml || ''}
                        </div>
                    `;
                };

                function getMeta(id) {
                    return getItemMeta(id);
                }

                function renderItemsTab() {
                    if (!body) return;
                    const parts = [];

                    // Itens "legados" (pokeballs/rareCandy)
                    const metaBall = getMeta('pokeball');
                    parts.push(itemRow(metaBall, (metaBall && metaBall.name) ? metaBall.name : 'CatchCube', d.pokeballs || 0));

                    const metaCandy = getMeta('rareCandy');
                    const btn = `<button onclick="startRareCandySelection()" style="background:var(--accent-primary); border:none; padding:8px 16px; border-radius:8px; color:white; font-weight:bold;">USAR</button>`;
                    parts.push(itemRow(metaCandy, (metaCandy && metaCandy.name) ? metaCandy.name : 'Rare Candy', d.rareCandy || 0, ((d.rareCandy || 0) > 0 ? btn : '')));

                    // Invent√°rio gen√©rico
                    const inv = (d && d.inventory && typeof d.inventory === 'object') ? d.inventory : {};
                    const keys = Object.keys(inv);
                    keys.sort((a, b) => a.localeCompare(b));
                    keys.forEach(id => {
                        const qty = parseInt(inv[id], 10);
                        if (!Number.isFinite(qty) || qty <= 0) return;
                        const meta = getMeta(id);
                        const name = (meta && meta.name) ? meta.name : id;
                        parts.push(itemRow(meta, name, qty));
                    });

                    body.innerHTML = parts.length ? parts.join('') : `<div class="bag-empty">Sem itens.</div>`;
                }

                function renderKeysTab() {
                    if (!body) return;
                    const keys = Array.isArray(d && d.keyItems) ? d.keyItems.slice() : [];
                    keys.sort((a, b) => String(a).localeCompare(String(b)));
                    if (!keys.length) {
                        body.innerHTML = `<div class="bag-empty">Sem key itens.</div>`;
                        return;
                    }
                    const parts = keys.map(id => {
                        const meta = getMeta(id);
                        const name = (meta && meta.name) ? meta.name : String(id);
                        return itemRow(meta, name, null);
                    });
                    body.innerHTML = parts.join('');
                }

                function renderAdminPanel() {
                    if (!IS_ADMIN) return '';
                    return `
                        <div style="margin-top:16px; padding-top:14px; border-top:1px solid rgba(255,255,255,0.08);">
                            <div style="color:#fbbf24; font-weight:900; margin-bottom:8px;">DEV MODE ‚Äî ITENS</div>

                            <div style="display:grid; grid-template-columns: 1fr 100px; gap:10px; margin-bottom:10px;">
                                <input id="devItemId" list="itemCatalogDatalist" placeholder="itemId (ex: pokeball, key_porta1)" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" />
                                <input id="devItemQty" type="number" min="1" step="1" value="1" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" />
                            </div>
                            <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                <button id="devGrantBtn" class="btn-pc-action" style="background: var(--success); color:#fff; width:auto; padding:12px 14px;">+ DAR</button>
                                <button id="devRevokeBtn" class="btn-pc-action" style="background: #ef4444; color:#fff; width:auto; padding:12px 14px;">- TIRAR</button>
                            </div>

                            <div style="margin-top:14px; padding-top:14px; border-top:1px solid rgba(255,255,255,0.08);">
                                <div style="color:#fff; font-weight:900; margin-bottom:8px;">CAT√ÅLOGO (DB) ‚Äî CRIAR/EDITAR</div>
                                <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px;">
                                    <button id="catNewConsumableBtn" class="btn-pc-action" style="background:#1f2937; color:#fff; width:auto; padding:10px 12px;">NOVO CONSUM√çVEL</button>
                                    <button id="catNewKeyBtn" class="btn-pc-action" style="background:#1f2937; color:#fff; width:auto; padding:10px 12px;">NOVO KEY ITEM</button>
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                                    <input id="catItemId" list="itemCatalogDatalist" placeholder="id (ex: key_porta1)" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" />
                                    <input id="catItemName" placeholder="nome" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" />
                                </div>
                                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                                    <select id="catItemType" style="padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;">
                                        <option value="consumable">consum√≠vel</option>
                                        <option value="key">key item</option>
                                    </select>
                                    <input id="catItemIcon" type="file" accept="image/png" style="padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,0.12); background:rgba(0,0,0,0.25); color:#fff;" />
                                </div>
                                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                                    <button id="catSaveBtn" class="btn-pc-action" style="background: var(--accent-primary); color:#fff; width:auto; padding:12px 14px;">SALVAR/CRIAR</button>
                                    <button id="catDeleteBtn" class="btn-pc-action" style="background: #334155; color:#fff; width:auto; padding:12px 14px;">DELETAR</button>
                                </div>
                                <div style="margin-top:8px; color:#aaa; font-size:0.8rem;">√çcone precisa ser PNG 32x32.</div>
                            </div>
                        </div>
                    `;
                }

                function setActive(which) {
                    if (!tabItems || !tabKeys) return;
                    tabItems.classList.toggle('active', which === 'items');
                    tabKeys.classList.toggle('active', which === 'keys');
                    if (which === 'keys') renderKeysTab(); else renderItemsTab();
                }

                if (tabItems) tabItems.onclick = () => setActive('items');
                if (tabKeys) tabKeys.onclick = () => setActive('keys');
                setActive('items');

                // Admin tools
                if (IS_ADMIN && body) {
                    const adminHtml = renderAdminPanel();
                    if (adminHtml) {
                        // injeta abaixo das abas
                        const bagRoot = document.getElementById('bagItemsContent');
                        if (bagRoot && !bagRoot.querySelector('#devGrantBtn')) {
                            bagRoot.insertAdjacentHTML('beforeend', adminHtml);

                            const grantBtn = document.getElementById('devGrantBtn');
                            const revokeBtn = document.getElementById('devRevokeBtn');
                            const devId = document.getElementById('devItemId');
                            const devQty = document.getElementById('devItemQty');

                            async function doGrant(isGrant) {
                                const itemId = devId ? String(devId.value || '').trim() : '';
                                const qty = devQty ? Math.max(1, parseInt(devQty.value, 10) || 1) : 1;
                                if (!itemId) return alert('Informe o itemId.');
                                const url = isGrant ? '/api/dev/inventory/grant' : '/api/dev/inventory/revoke';
                                const resp = await fetch(url, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId: USER_ID, itemId, qty })
                                });
                                const data = await resp.json().catch(() => ({}));
                                if (!data || !data.success) return alert(data.error || 'Falha.');
                                // reabre mochila pra atualizar visual
                                openBag();
                            }

                            if (grantBtn) grantBtn.onclick = () => doGrant(true);
                            if (revokeBtn) revokeBtn.onclick = () => doGrant(false);

                            const catSaveBtn = document.getElementById('catSaveBtn');
                            const catDeleteBtn = document.getElementById('catDeleteBtn');
                            const catNewConsumableBtn = document.getElementById('catNewConsumableBtn');
                            const catNewKeyBtn = document.getElementById('catNewKeyBtn');
                            const catId = document.getElementById('catItemId');
                            const catName = document.getElementById('catItemName');
                            const catType = document.getElementById('catItemType');
                            const catIcon = document.getElementById('catItemIcon');

                            function startNewCatalogItem(type) {
                                if (catId) catId.value = '';
                                if (catName) catName.value = '';
                                if (catType) catType.value = type || 'consumable';
                                if (catIcon) catIcon.value = '';
                                try { if (catId) catId.focus(); } catch (_) {}
                            }

                            async function saveCatalog() {
                                const id = catId ? String(catId.value || '').trim() : '';
                                const name = catName ? String(catName.value || '').trim() : '';
                                const type = catType ? String(catType.value || 'consumable') : 'consumable';
                                if (!id) return alert('Informe o id do item.');

                                const r1 = await fetch('/api/items/upsert', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId: USER_ID, item: { id, name, type } })
                                });
                                const d1 = await r1.json().catch(() => ({}));
                                if (!d1 || !d1.success) return alert(d1.error || 'Falha ao salvar item.');

                                // √≠cone (opcional)
                                if (catIcon && catIcon.files && catIcon.files[0]) {
                                    const f = catIcon.files[0];
                                    if (f.type !== 'image/png') return alert('√çcone precisa ser PNG.');
                                    const reader = new FileReader();
                                    const b64 = await new Promise((resolve, reject) => {
                                        reader.onload = () => resolve(String(reader.result || ''));
                                        reader.onerror = reject;
                                        reader.readAsDataURL(f);
                                    });
                                    const stripped = b64.replace(/^data:image\/png;base64,/, '');
                                    const r2 = await fetch('/api/items/icon/set', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ userId: USER_ID, itemId: id, pngBase64: stripped })
                                    });
                                    const d2 = await r2.json().catch(() => ({}));
                                    if (!d2 || !d2.success) return alert(d2.error || 'Falha ao salvar √≠cone.');
                                }

                                await loadItemCatalog(true);
                                openBag();
                            }

                            async function deleteCatalog() {
                                const id = catId ? String(catId.value || '').trim() : '';
                                if (!id) return alert('Informe o id do item.');
                                const r1 = await fetch('/api/items/delete', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ userId: USER_ID, itemId: id })
                                });
                                const d1 = await r1.json().catch(() => ({}));
                                if (!d1 || !d1.success) return alert(d1.error || 'Falha ao deletar.');
                                await loadItemCatalog(true);
                                openBag();
                            }

                            if (catSaveBtn) catSaveBtn.onclick = saveCatalog;
                            if (catDeleteBtn) catDeleteBtn.onclick = deleteCatalog;
                            if (catNewConsumableBtn) catNewConsumableBtn.onclick = () => startNewCatalogItem('consumable');
                            if (catNewKeyBtn) catNewKeyBtn.onclick = () => startNewCatalogItem('key');
                        }
                    }
                }
            } catch(e) {
                document.getElementById('bagItemsContent').innerHTML = "Erro ao carregar mochila.";
            }
        }
        function startRareCandySelection() { closeModal('modalBag'); isSelectingMode = true; openPokemon(); }
        function cancelSelection() { isSelectingMode = false; openPokemon(); }

        /* --- SKILLS & EDITOR --- */
        // Nova fun√ß√£o segura para preparar o editor
        function prepareMoveEditor(instanceId) {
            // Busca o Pok√©mon nos dados carregados
            const pokemon = CURRENT_TEAM_DATA.find(p => p.instanceId === instanceId);
            if (!pokemon) return alert("Erro ao carregar Pok√©mon.");
            
            showMoveEditor(pokemon);
        }

        function showMoveEditor(p) {
            currentMonId = p.instanceId;
            // Se learnedMoves estiver vazio (legado), usa moves como base
            const pool = (p.learnedMoves && p.learnedMoves.length > 0) ? p.learnedMoves : p.moves;
            const equipped = p.moves;

            let html = `<div style="text-align:center; margin-bottom:15px;">
                <h3 style="margin:0; color:#fff;">${p.name}</h3>
                <small style="color:#aaa;">Selecione de 1 a 4 golpes</small>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">`;
            
            pool.forEach(mid => {
                const isEquipped = equipped.includes(mid);
                const d = GLOBAL_MOVES_LIB[mid] || {name: mid, element: 'normal'};
                html += `
                <div onclick="toggleMove(this)" class="skill-item ${isEquipped?'active':''}" data-id="${mid}">
                    <div style="font-weight:bold; color:#fff;">${d.name}</div>
                    <div style="font-size:0.7rem; color:#888; text-transform:uppercase;">${d.element}</div>
                </div>`;
            });
            
            html += `</div><button onclick="saveMoves()" class="btn-big-close" style="background:#10b981; margin-top:15px;">SALVAR GOLPES</button>`;
            document.getElementById('pokemonListContent').innerHTML = html;
        }

        function toggleMove(el) {
            if(el.classList.contains('active')) { 
                if(document.querySelectorAll('.skill-item.active').length <= 1) return alert('M√≠nimo 1 golpe!'); 
                el.classList.remove('active'); 
            } else { 
                if(document.querySelectorAll('.skill-item.active').length >= 4) return alert('M√°ximo 4 golpes!'); 
                el.classList.add('active'); 
            }
        }

        async function saveMoves() {
            const moves = Array.from(document.querySelectorAll('.skill-item.active')).map(c => c.getAttribute('data-id'));
            showToast("Salvando...");
            await fetch('/api/equip-move', { 
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({ userId:USER_ID, pokemonId:currentMonId, moves }) 
            });
            showToast("Salvo!");
            openPokemon(); // Recarrega a lista
        }

        async function setLead(id) { 
            await fetch('/api/set-lead', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); 
            openPokemon(); 
        }
        async function abandonPokemon(id) { 
            if(confirm('Tem certeza? Isso √© permanente.')) { 
                await fetch('/api/abandon-pokemon', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); 
                openPokemon(); 
            } 
        }
        async function applyRareCandy(pokeId) {
            if(!confirm('Usar Rare Candy?')) return;
            try {
                const res = await fetch('/api/use-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: USER_ID, itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) });
                const data = await res.json();
                if(data.success) { showToast(data.evolved ? '‚ú® Evoluiu! ‚ú®' : 'üÜô Subiu de N√≠vel!'); isSelectingMode = false; openPokemon(); } 
                else { alert(data.error); }
            } catch(e) { alert("Erro."); isSelectingMode = false; openPokemon(); }
        }
    </script>
</body>
</html>
