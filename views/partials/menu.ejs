<!-- FONTES -->
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@500;600;700&display=swap" rel="stylesheet">

<!-- POLYFILL PARA DRAG AND DROP MOBILE -->
<script src="https://bernardo-castilho.github.io/DragDropTouch/DragDropTouch.js"></script>

<!-- ESTILOS -->
<style>
    :root {
        --bg-dark: #0f172a;
        --bg-card: #1e293b;
        --border-color: rgba(255, 255, 255, 0.1);
        --accent-color: #38bdf8;
        --accent-gold: #fbbf24;
        --danger: #ef4444;
        --success: #22c55e;
        --radius: 12px;
    }

    /* RESET */
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { font-family: 'Rajdhani', sans-serif; background: #000; color: #fff; margin: 0; }
    
    /* SCROLLBAR GLOBAL (Sutil) */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

    /* --- MODAIS --- */
    /* Z-INDEX: 11000 (Maior que o menu 9999) */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); 
        z-index: 11000; display: none; justify-content: center; align-items: center; 
        animation: fadeIn 0.2s ease-out; 
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content { 
        background: var(--bg-dark); 
        width: 95%; max-width: 600px; max-height: 92vh; 
        border-radius: var(--radius); border: 1px solid var(--border-color); 
        box-shadow: 0 25px 50px -12px rgba(0,0,0,1); 
        display: flex; flex-direction: column; overflow: hidden;
    }

    .modal-header {
        padding: 16px; background: rgba(255,255,255,0.03);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
    }
    .modal-header h2 { 
        margin: 0; font-family: 'Press Start 2P'; font-size: 0.75rem; 
        color: var(--accent-gold); letter-spacing: 1px; text-transform: uppercase;
    }
    .close-btn { 
        background: rgba(255,255,255,0.05); border: 1px solid var(--border-color); color: #fff; 
        width: 36px; height: 36px; border-radius: 8px; font-size: 1rem; cursor: pointer; 
        display:flex; align-items:center; justify-content:center;
    }

    .modal-body { 
        padding: 16px; overflow-y: auto; flex: 1; 
        background: radial-gradient(circle at top, #1e293b 0%, #0f172a 100%); 
        position: relative; -webkit-overflow-scrolling: touch;
    }

    /* --- MENU FLUTUANTE ORIGINAL RESTAURADO --- */
    .float-container { 
        position: fixed; right: 20px; bottom: 100px; z-index: 9999; 
        display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; 
    }
    .float-btn { 
        width: 55px; height: 55px; border-radius: 50%; 
        background: #1e293b; border: 2px solid rgba(255,255,255,0.1); 
        color: #f1c40f; font-size: 1.4rem; cursor: pointer; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.4); transition: 0.3s; 
        display: flex; align-items: center; justify-content: center;
    }
    .float-btn:hover { transform: scale(1.1); border-color: #f1c40f; }
    
    .float-menu-items { display: none; flex-direction: column-reverse; gap: 12px; }
    .float-menu-items.show { display: flex; animation: slideUp 0.3s; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* --- ESTILOS DO PC E SCROLLBAR NOVO --- */
    .pc-layout { display: flex; flex-direction: column; height: 100%; gap: 10px; }
    
    .pc-grid-box {
        background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); border-radius: 8px;
        padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(52px, 1fr)); 
        gap: 8px; flex: 1; 
        
        /* SCROLLBAR V√çSIVEL E OTIMIZADO */
        overflow-y: auto; 
        align-content: flex-start;
        -webkit-overflow-scrolling: touch; /* Rolagem suave nativa */
        scroll-behavior: smooth;
    }

    /* CUSTOMIZA√á√ÉO ESPEC√çFICA DO SCROLLBAR DO BOX 1 */
    .pc-grid-box::-webkit-scrollbar { width: 8px; display: block; }
    .pc-grid-box::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
    .pc-grid-box::-webkit-scrollbar-thumb { 
        background: var(--accent-color); /* Azul brilhante para destaque */
        border-radius: 4px; 
        border: 2px solid rgba(0,0,0,0.3); /* Borda para contraste */
    }

    .pc-team-row {
        background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px;
        height: 75px; padding: 8px; display: flex; gap: 8px; overflow-x: auto; flex-shrink: 0;
    }
    .pc-slot {
        aspect-ratio: 1/1; width: 55px; height: 55px; background: rgba(255,255,255,0.05); 
        border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; 
        display: flex; justify-content: center; align-items: center; position: relative;
    }
    .pc-slot img { width: 38px; height: 38px; image-rendering: pixelated; pointer-events: none; }
    .pc-slot .lvl-badge { position: absolute; bottom: -2px; right: -2px; font-size: 0.55rem; background: #000; color: #fbbf24; padding: 1px 3px; border-radius: 4px; }
    .pc-slot.dragging { opacity: 0.3; } .drag-over { border-color: var(--accent-gold) !important; background: rgba(251, 191, 36, 0.1) !important; }

    /* UTILS & OUTROS CARDS */
    .pixel-icon { width: 17px !important; height: 17px !important; min-width: 17px; image-rendering: pixelated; object-fit: contain; }
    .btn-success { background: var(--success); color: #fff; border:none; padding:10px 18px; border-radius:8px; font-weight:700; cursor:pointer; font-family: 'Rajdhani'; text-transform: uppercase; }
    .btn-cancel { background: #333; color: #ccc; border:none; padding:10px 18px; border-radius:8px; font-weight:700; cursor:pointer; font-family: 'Rajdhani'; text-transform: uppercase; width: 100%; margin-top: 10px; }
    
    .type-badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; font-weight: bold; border: 1px solid rgba(255,255,255,0.2); background: #222; }
    .type-fire { color:#ef4444; border-color:#ef4444; background:rgba(239,68,68,0.15); }
    .type-water { color:#3b82f6; border-color:#3b82f6; background:rgba(59,130,246,0.15); }
    .type-grass { color:#22c55e; border-color:#22c55e; background:rgba(34,197,94,0.15); }
    .type-normal { color:#94a3b8; border-color:#94a3b8; background:rgba(148,163,184,0.15); }

    /* CARDS POKEMON */
    .poke-card { 
        background: linear-gradient(135deg, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
        border: 1px solid rgba(255,255,255,0.1); border-radius: 10px;
        padding: 12px; margin-bottom: 12px; display: flex; align-items: stretch; gap: 15px;
        position: relative; overflow: hidden; transition: transform 0.2s, border-color 0.2s;
    }
    .poke-card.leader { border: 1px solid rgba(251, 191, 36, 0.5); box-shadow: inset 0 0 20px rgba(251, 191, 36, 0.05); }
    .poke-img-container { width: 60px; min-width: 60px; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.05); }
    .poke-info-main { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .poke-name { font-weight: 700; color: #fff; font-size: 1rem; margin-bottom: 4px; display: flex; justify-content: space-between; }
    .stat-row { display: flex; align-items: center; gap: 8px; margin-bottom: 3px; }
    .stat-icon { font-size: 0.6rem; color: #64748b; width: 15px; font-weight: bold; }
    .progress-track { flex:1; height:6px; background:rgba(0,0,0,0.5); border-radius:3px; overflow:hidden; }
    .progress-fill { height:100%; border-radius:3px; }
    .action-row { display: flex; gap: 8px; margin-top: 8px; }
    .action-btn { flex: 1; padding: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); border-radius: 6px; cursor: pointer; color: #ccc; }
    
    .poke-card.selection-mode { border: 2px dashed var(--accent-gold); background: rgba(251, 191, 36, 0.05); cursor: pointer; }

    /* POKEDEX */
    #modalPokedex .modal-content { max-width: 800px; height: 90vh; }
    .dex-layout { display: flex; width: 100%; height: 100%; position: relative; }
    .dex-sidebar { width: 100%; max-width: 320px; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); background: #0b1120; }
    .dex-grid { flex: 1; overflow-y: auto; padding: 10px; display: grid; grid-template-columns: repeat(auto-fill, minmax(64px, 1fr)); gap: 8px; align-content: flex-start; }
    .dex-item { aspect-ratio: 1; cursor: pointer; background: rgba(255,255,255,0.03); border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; border: 1px solid transparent; }
    .dex-item.selected { border-color: var(--accent-gold); background: rgba(251, 191, 36, 0.1); }
    .dex-item.locked { opacity: 0.4; filter: grayscale(1); }
    .dex-main-view { flex: 1; background: #131c2e; position: relative; display: flex; flex-direction: column; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
    @media (max-width: 768px) {
        .dex-sidebar { width: 100%; max-width: 100%; }
        .dex-main-view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; transform: translateX(105%); background: #0f172a; }
        .dex-main-view.active { transform: translateX(0); }
    }
    .back-btn-dex { padding: 10px; background: rgba(0,0,0,0.2); color: #fff; border: none; width: 100%; text-align: left; cursor: pointer; display: none; }
    @media (max-width: 768px) { .back-btn-dex { display: block; } }

    /* SKILLS */
    .skills-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .skill-card { background: #0f1218; padding: 10px; border-radius: 8px; border: 1px solid #333; cursor: pointer; }
    .skill-card.equipped { border-color: var(--success); background: rgba(34, 197, 94, 0.05); }

</style>

<!-- MENU FLUTUANTE (ESTRUTURA ORIGINAL) -->
<div class="float-container" id="floatMenu">
    <div id="menuItems" class="float-menu-items">
        <button class="float-btn" onclick="openBag()" title="Mochila" style="color:#e67e22; border-color:#e67e22;">üéí</button>
        <button class="float-btn" onclick="openPokemon()" title="Monstros" style="color:#fff; border-color:#aaa;">
            <img src="/uploads/catchcube.gif" class="pixel-icon" style="width:24px; height:24px;">
        </button>
        <button class="float-btn" onclick="openPC()" title="PC" style="color:#33ff33; border-color:#33ff33;">üíª</button>
        <button class="float-btn" onclick="openPokedex()" title="Dex" style="color:#00d2ff; border-color:#00d2ff;">üìö</button>
    </div>
    <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
</div>

<!-- Modal PC (Com BOX 01 scrollavel) -->
<div class="modal-overlay" id="modalPC">
    <div class="modal-content">
        <div class="modal-header"><h2>Storage System</h2><button class="close-btn" onclick="closeModal('modalPC')">‚úï</button></div>
        <div class="modal-body" style="padding:0; display:flex; flex-direction:column;">
            <div class="pc-layout">
                <div style="flex:1; padding:10px; overflow:hidden; display:flex; flex-direction:column;">
                    <div style="font-size:0.8rem; color:#888; margin-bottom:5px;">BOX 01</div>
                    <!-- AQUI √â O BOX QUE AGORA TEM SCROLLBAR -->
                    <div class="pc-grid-box" id="pcStorageArea" ondrop="handleDrop(event, 'pc')" ondragover="handleDragOver(event)"></div>
                </div>
                <div style="padding:10px; background:rgba(0,0,0,0.3); border-top:1px solid #333;">
                    <div style="font-size:0.8rem; color:#22c55e; margin-bottom:5px;">PARTY</div>
                    <div class="pc-team-row" id="pcTeamArea" ondrop="handleDrop(event, 'team')" ondragover="handleDragOver(event)"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dex -->
<div class="modal-overlay" id="modalPokedex">
    <div class="modal-content">
        <div class="dex-layout">
            <button class="close-btn" onclick="closeModal('modalPokedex')" style="position:absolute; top:10px; right:10px; z-index:50;">‚úï</button>
            <div class="dex-sidebar">
                <div style="padding:10px; border-bottom:1px solid #333;"><input type="text" id="dexSearch" placeholder="üîç Buscar..." onkeyup="filterDex()" style="width:100%; padding:10px; border-radius:6px; border:1px solid #333; background:#000; color:#fff;"></div>
                <div id="dexGrid" class="dex-grid"></div>
            </div>
            <div id="dexDetailsView" class="dex-main-view">
                <button class="back-btn-dex" onclick="closeDexDetails()">‚¨Ö Voltar</button>
                <div id="dexContentInner" style="padding:20px; text-align:center; flex:1; overflow-y:auto;">Selecione um Pok√©mon</div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Pokemon -->
<div class="modal-overlay" id="modalPokemon">
    <div class="modal-content">
        <div class="modal-header"><h2>Meus Monstros</h2><button class="close-btn" onclick="closeModal('modalPokemon')">‚úï</button></div>
        <div class="modal-body">
            <div id="pokemonListContent">Carregando...</div>
        </div>
    </div>
</div>

<!-- Modal Mochila -->
<div class="modal-overlay" id="modalBag">
    <div class="modal-content" style="max-height:60vh;">
        <div class="modal-header"><h2>Invent√°rio</h2><button class="close-btn" onclick="closeModal('modalBag')">‚úï</button></div>
        <div class="modal-body"><div id="bagItemsContent">Carregando...</div></div>
    </div>
</div>


<!-- L√ìGICA (MANTIDA IGUAL) -->
<script>
    const USER_ID = '<%= user._id %>';
    let isSelectingMode = false;
    let currentMonId = null;
    let GLOBAL_MOVES_LIB = {};
    const RAW_ENTITIES = <%- JSON.stringify(entities || []) %>;
    const RAW_TEAM = <%- JSON.stringify(user.pokemonTeam || []) %>;
    const RAW_PC = <%- JSON.stringify(user.pc || []) %>;
    const UNLOCKED_IDS = new Set([...RAW_TEAM.map(p => String(p.baseId||p.id)), ...RAW_PC.map(p => String(p.baseId||p.id))]);
    const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;

    // MENU RESTAURADO
    function toggleFloatMenu() { document.getElementById('menuItems').classList.toggle('show'); }
    
    function closeModal(id) { 
        document.getElementById(id).style.display = 'none';
        if (id === 'modalPokemon') isSelectingMode = false; 
    }

    // PC SYSTEM
    async function openPC() { document.getElementById('modalPC').style.display='flex'; loadPCData(); }
    async function loadPCData() {
        try { const r = await fetch(`/api/pc?userId=${USER_ID}`); const d = await r.json(); renderDragPC(d.team, d.pc); } catch(e){}
    }
    function renderDragPC(team, pc) {
        const createSlot = (p, from) => `
            <div class="pc-slot" draggable="true" ondragstart="handleDragStart(event, '${p.instanceId}', '${from}')">
                <img src="${_resImg(p.sprite)}"><div class="lvl-badge">Lv.${p.level}</div>
            </div>`;
        document.getElementById('pcTeamArea').innerHTML = team.map(p => createSlot(p, 'team')).join('') 
            + (team.length < 6 ? '<div class="pc-slot" style="opacity:0.2; border:1px dashed #777;"></div>' : '');
        document.getElementById('pcStorageArea').innerHTML = pc.map(p => createSlot(p, 'pc')).join('')
            + Array(5).fill('<div class="pc-slot" style="border:none;"></div>').join('');
    }
    function handleDragStart(ev, pokeId, source) { ev.dataTransfer.setData("text/plain", JSON.stringify({ pokeId, source })); ev.currentTarget.classList.add('dragging'); }
    function handleDragOver(ev) { ev.preventDefault(); ev.currentTarget.classList.add('drag-over'); }
    document.querySelectorAll('.pc-grid-box, .pc-team-row').forEach(el => el.addEventListener('dragleave', e => e.currentTarget.classList.remove('drag-over')));
    async function handleDrop(ev, targetContainer) {
        ev.preventDefault(); document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        const dataRaw = ev.dataTransfer.getData("text/plain"); if(!dataRaw) return;
        const { pokeId, source } = JSON.parse(dataRaw); if (source === targetContainer) return; 
        await fetch('/api/pc/move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId: USER_ID, pokemonId: pokeId, from: source, to: targetContainer }) });
        loadPCData();
    }

    // POKEDEX
    async function openPokedex() {
        document.getElementById('modalPokedex').style.display='flex';
        if(Object.keys(GLOBAL_MOVES_LIB).length === 0) { try { const r = await fetch(`/api/me?userId=${USER_ID}`); const d = await r.json(); if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; } catch(e){} }
        renderDexGrid();
    }
    function renderDexGrid() {
        const grid = document.getElementById('dexGrid'); grid.innerHTML = '';
        RAW_ENTITIES.forEach((p, index) => {
            const id = String(p.id||p._id);
            const unlocked = UNLOCKED_IDS.has(id);
            grid.innerHTML += `<div class="dex-item ${!unlocked?'locked':''}" onclick="selectDexMonster('${id}', this)" data-name="${(p.name||'').toLowerCase()}">
                <span style="font-size:0.6rem; color:#555; position:absolute; top:2px; left:4px;">#${(index+1).toString().padStart(3,'0')}</span>
                <img src="${_resImg(p.sprite)}" style="width:36px; height:36px; image-rendering:pixelated; margin-top:5px;">
            </div>`;
        });
    }
    function selectDexMonster(idStr, el) {
        document.querySelectorAll('.dex-item').forEach(e=>e.classList.remove('selected'));
        if(el) el.classList.add('selected');
        document.getElementById('dexDetailsView').classList.add('active');
        const m = RAW_ENTITIES.find(x => String(x.id||x._id) === idStr);
        const div = document.getElementById('dexContentInner');
        if(!m || !UNLOCKED_IDS.has(idStr)) { div.innerHTML = '<br><br><h1>üîí</h1><p>N√£o descoberto.</p>'; return; }
        let movesHtml = '<table style="width:100%; text-align:left; margin-top:15px; border-collapse:collapse;">';
        const pool = (m.movePool || m.learnset || []).sort((a,b)=>a.level-b.level);
        pool.forEach(mv => {
            const d = GLOBAL_MOVES_LIB[mv.moveId||mv.move] || {name:mv.moveId||mv.move, element:'normal'};
            movesHtml += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);"><td style="padding:6px; color:#fbbf24;">Lv.${mv.level}</td><td style="padding:6px;">${d.name}</td><td><span class="type-badge type-${(d.element||'normal').toLowerCase()}">${d.element}</span></td></tr>`;
        });
        movesHtml += '</table>';
        div.innerHTML = `<div style="width:100px; height:100px; margin:0 auto; background:radial-gradient(circle, #333, transparent); border-radius:50%; display:flex; align-items:center; justify-content:center; border:2px solid #444;"><img src="${_resImg(m.sprite)}" style="width:80px; image-rendering:pixelated; transform:scale(1.3);"></div>
            <h1 style="margin:10px 0 0; font-family:'Press Start 2P'; font-size:1rem;">${m.name}</h1>
            <span class="type-badge type-${(m.type||'normal').toLowerCase()}" style="margin-bottom:15px; display:inline-block; margin-top:5px;">${m.type}</span>
            <div style="background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-top:10px; text-align:left;">
                ${renderDexStat('HP', m.baseStats.hp, '#22c55e')}
                ${renderDexStat('ATK', m.baseStats.attack, '#ef4444')}
                ${renderDexStat('DEF', m.baseStats.defense, '#fbbf24')}
                ${renderDexStat('SPD', m.baseStats.speed, '#3b82f6')}
            </div>
            <div style="text-align:left; margin-top:20px; font-size:0.8rem; color:#888; border-bottom:1px solid #333;">MOVE POOL</div>
            ${movesHtml}`;
    }
    function renderDexStat(l, v, c) {
        return `<div style="display:flex; align-items:center; margin-bottom:4px; font-size:0.8rem;"><span style="width:30px; font-weight:bold; color:#777;">${l}</span><div style="flex:1; height:6px; background:#111; border-radius:3px; overflow:hidden; margin:0 8px;"><div style="width:${Math.min(100, (v/150)*100)}%; height:100%; background:${c};"></div></div><span style="width:25px; text-align:right;">${v}</span></div>`;
    }
    function filterDex() { const v = document.getElementById('dexSearch').value.toLowerCase(); document.querySelectorAll('.dex-item').forEach(e => e.style.display = e.getAttribute('data-name').includes(v) ? 'flex' : 'none'); }
    function closeDexDetails() { document.getElementById('dexDetailsView').classList.remove('active'); }

    // MONSTROS E RARE CANDY
    async function openPokemon() { 
        document.getElementById('modalPokemon').style.display='flex'; 
        try { const r = await fetch(`/api/me?userId=${USER_ID}`); const d = await r.json(); if(d.allMoves) GLOBAL_MOVES_LIB = d.allMoves; renderPokemonList(d.team); } catch(e) { document.getElementById('pokemonListContent').innerHTML = 'Erro de conex√£o.'; } 
    }
    function renderPokemonList(team) {
        const content = document.getElementById('pokemonListContent');
        if(document.getElementById('modalPokemon').style.display === 'none') isSelectingMode = false;
        if(!team || team.length === 0) { content.innerHTML='Vazio'; return; }
        let html = '';
        if(isSelectingMode) html += `<div style="background:#fbbf24; color:#000; padding:10px; text-align:center; border-radius:8px; font-weight:bold; margin-bottom:15px; animation:fadeIn 0.3s;">SELECIONE UM MONSTRO PARA USAR O ITEM</div>`;
        team.forEach((p, idx) => {
            const hp = Math.min(100, (p.hp/p.maxHp)*100);
            let cardClass = isSelectingMode ? 'poke-card selection-mode' : `poke-card ${idx===0?'leader':''}`;
            let clickAction = isSelectingMode ? `onclick="applyRareCandy('${p.instanceId}')"` : '';
            let actionButtonsStyle = isSelectingMode ? 'display:none;' : 'display:flex;';
            const mStr = JSON.stringify(p.moves||[]).replace(/"/g, '&quot;');
            const lStr = JSON.stringify(p.learnedMoves||[]).replace(/"/g, '&quot;');
            html += `<div class="${cardClass}" ${clickAction}><div class="poke-img-container"><img src="${_resImg(p.sprite)}" class="pixel-icon" style="width:48px;"></div><div class="poke-info-main"><div class="poke-name">${p.name} <span style="font-size:0.8rem; color:${isSelectingMode?'#fbbf24':'var(--accent-gold)'};">Lv.${p.level}</span></div><div class="stat-row"><span class="stat-icon">HP</span><div class="progress-track"><div class="progress-fill" style="width:${hp}%; background:#22c55e;"></div></div></div><div class="action-row" style="${actionButtonsStyle}">${idx!==0 ? `<button onclick="setLead('${p.instanceId}')" class="action-btn">‚≠ê</button>` : ''}<button onclick="showMoveEditor('${p.instanceId}','${p.name}',${mStr},${lStr})" class="action-btn">‚öîÔ∏è</button><button onclick="abandonPokemon('${p.instanceId}')" class="action-btn" style="color:#ef4444;">üóëÔ∏è</button></div></div></div>`;
        });
        if(isSelectingMode) html += `<button onclick="cancelSelection()" class="btn-cancel">CANCELAR</button>`;
        content.innerHTML = html;
    }
    async function setLead(id) { await fetch('/api/set-lead', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); }
    async function abandonPokemon(id) { if(confirm('Libertar?')) { await fetch('/api/abandon-pokemon', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:id }) }); openPokemon(); } }
    
    function showMoveEditor(id, name, equipped, learned) {
        currentMonId = id;
        const pool = (learned && learned.length>0) ? learned : equipped;
        let html = `<h3 style="color:#38bdf8; margin-bottom:10px;">${name} (Max 4)</h3><div class="skills-grid">`;
        pool.forEach(mid => {
            const eq = equipped.includes(mid);
            const d = GLOBAL_MOVES_LIB[mid] || {name:mid, element:'normal'};
            html += `<div onclick="toggleMove(this)" class="skill-card ${eq?'equipped':''}" data-id="${mid}"><div style="font-weight:bold; color:#fff;">${d.name}</div><div style="font-size:0.6rem; color:#888;">${d.element}</div></div>`;
        });
        html += `</div><div style="display:flex; gap:10px; margin-top:15px;"><button onclick="openPokemon()" class="btn-cancel" style="margin:0;">Voltar</button><button onclick="saveMoves()" class="btn-success" style="flex:1;">Salvar</button></div>`;
        document.getElementById('pokemonListContent').innerHTML = html;
    }
    function toggleMove(el) {
        if(el.classList.contains('equipped')) { if(document.querySelectorAll('.skill-card.equipped').length <= 1) return alert('M√≠nimo 1'); el.classList.remove('equipped'); }
        else { if(document.querySelectorAll('.skill-card.equipped').length >= 4) return alert('M√°ximo 4'); el.classList.add('equipped'); }
    }
    async function saveMoves() {
        const moves = Array.from(document.querySelectorAll('.skill-card.equipped')).map(c => c.getAttribute('data-id'));
        await fetch('/api/equip-move', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ userId:USER_ID, pokemonId:currentMonId, moves }) }); openPokemon();
    }

    async function openBag() { 
        document.getElementById('modalBag').style.display='flex'; 
        const r = await fetch(`/api/me?userId=${USER_ID}`); 
        const d = await r.json(); 
        const itemRow = (icon, nome, qtd, action) => `<div style="display:flex; align-items:center; background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.1);"><div style="font-size:1.5rem; margin-right:15px;">${icon}</div><div style="flex:1;"><div style="font-weight:bold;">${nome}</div><div style="font-size:0.8rem; color:#aaa;">Qtd: ${qtd}</div></div>${action ? action : ''}</div>`;
        let html = itemRow('üì¶', 'CatchCubes', d.pokeballs||0);
        if(d.rareCandy > 0) html += itemRow('üç¨', 'Rare Candy', d.rareCandy, `<button onclick="startRareCandySelection()" class="btn-success" style="padding:6px 12px; font-size:0.75rem;">USAR</button>`);
        else html += itemRow('üç¨', 'Rare Candy', 0);
        document.getElementById('bagItemsContent').innerHTML = html;
    }

    function startRareCandySelection() { closeModal('modalBag'); isSelectingMode = true; openPokemon(); }
    function cancelSelection() { isSelectingMode = false; openPokemon(); }
    async function applyRareCandy(pokeId) {
        if(!confirm('Dar Rare Candy para este monstro?')) return;
        try {
            document.getElementById('pokemonListContent').innerHTML = '<div style="text-align:center; padding:20px;">Aplicando item...</div>';
            const res = await fetch('/api/use-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: USER_ID, itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) });
            const data = await res.json();
            if(data.success) { alert(data.evolved ? '‚ú® O Pok√©mon Evoluiu! ‚ú®' : 'üÜô Subiu de N√≠vel!'); isSelectingMode = false; openPokemon(); } 
            else { alert(data.error || 'Erro ao usar item.'); isSelectingMode = false; openPokemon(); }
        } catch(e) { alert("Erro de conex√£o."); isSelectingMode = false; openPokemon(); }
    }
</script>
