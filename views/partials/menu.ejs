<!-- ESTILOS (DESIGN NOVO - CATCHCUBE UPDATE) -->
<style>
    @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap');

    :root {
        --bg-dark: #0f172a;
        --bg-panel: #1e293b;
        --accent: #f1c40f;
        --primary: #3498db;
        --success: #2ecc71;
        --danger: #e74c3c;
        --text-main: #e2e8f0;
        --text-muted: #94a3b8;
        --border-color: rgba(255,255,255,0.1);
        --pc-green: #33ff33;
        --pc-bg: #001100;
    }

    /* SCROLLBAR CUSTOMIZADA */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
    
    /* GERAIS */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); 
        z-index: 11000; display: none; justify-content: center; align-items: center; 
        animation: fadeIn 0.2s ease-out;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    .modal-content { 
        background: var(--bg-dark); 
        width: 95%; max-width: 450px; 
        border-radius: 16px; 
        border: 1px solid var(--border-color); 
        box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        color: var(--text-main); 
        overflow: hidden; 
        display: flex; flex-direction: column;
        max-height: 85vh;
        font-family: 'Rajdhani', sans-serif;
    }

    .modal-header {
        padding: 15px 20px;
        background: rgba(0,0,0,0.2);
        border-bottom: 1px solid var(--border-color);
        display: flex; justify-content: space-between; align-items: center;
    }
    .modal-header h2 { margin: 0; font-family: 'Press Start 2P'; font-size: 0.8rem; color: var(--accent); }
    .close-btn { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
    .close-btn:hover { color: var(--danger); transform: scale(1.1); }

    .modal-body { padding: 20px; overflow-y: auto; flex: 1; }

    /* BOT√ïES GERAIS */
    .btn { border: none; border-radius: 8px; padding: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; font-family: 'Rajdhani', sans-serif; text-transform: uppercase; letter-spacing: 1px; }
    .btn:active { transform: scale(0.96); }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 0 #217dbb; }
    .btn-success { background: var(--success); color: #000; box-shadow: 0 4px 0 #25a25a; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-muted); }
    .btn-outline:hover { border-color: var(--text-main); color: var(--text-main); }

    /* MENU FLUTUANTE */
    .float-container { position: fixed; right: 20px; bottom: 100px; z-index: 9999; display: flex; flex-direction: column-reverse; align-items: center; gap: 15px; }
    .float-btn { 
        width: 55px; height: 55px; border-radius: 50%; 
        background: var(--bg-panel); border: 2px solid var(--border-color); 
        color: var(--accent); font-size: 1.4rem; cursor: pointer; 
        box-shadow: 0 8px 20px rgba(0,0,0,0.4); 
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        display: flex; align-items: center; justify-content: center;
    }
    .float-btn:hover { transform: scale(1.1); border-color: var(--accent); }
    .float-btn.main-toggle { background: var(--accent); color: #000; border: none; font-size: 1.8rem; }
    .float-menu-items { display: none; flex-direction: column-reverse; gap: 12px; }
    .float-menu-items.show { display: flex; animation: slideUp 0.3s; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* --- PC SYSTEM (Retro CRT Look) --- */
    #modalPC .modal-content { 
        max-width: 800px; background: var(--pc-bg); 
        border: 2px solid var(--pc-green); 
        box-shadow: 0 0 20px rgba(51, 255, 51, 0.2);
        font-family: 'Press Start 2P', monospace;
    }
    #modalPC .modal-header { border-bottom: 1px dashed var(--pc-green); }
    #modalPC h2 { color: var(--pc-green); text-shadow: 0 0 5px var(--pc-green); }
    #modalPC .close-btn { color: var(--pc-green); }
    
    .pc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; height: 450px; }
    .pc-column { 
        border: 1px solid rgba(51, 255, 51, 0.3); background: rgba(0, 20, 0, 0.5); 
        padding: 10px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; 
    }
    .pc-column h3 { color: var(--pc-green); font-size: 0.6rem; text-align: center; margin-bottom: 10px; opacity: 0.8; }
    
    .pc-slot { 
        display: flex; align-items: center; gap: 10px; padding: 8px; 
        border: 1px solid rgba(51, 255, 51, 0.1); cursor: pointer; transition: 0.1s; 
    }
    .pc-slot:hover { background: rgba(51, 255, 51, 0.1); border-color: var(--pc-green); }
    .pc-slot img { width: 32px; height: 32px; filter: grayscale(1) sepia(1) hue-rotate(70deg) saturate(3); image-rendering: pixelated; }
    .pc-info div { font-size: 0.6rem; color: #aaffaa; line-height: 1.4; }

    /* --- BAG & TEAM CARDS --- */
    .bag-tabs { display: flex; gap: 10px; margin-bottom: 15px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 10px; }
    .bag-tab { flex: 1; background: transparent; border: none; color: var(--text-muted); padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
    .bag-tab.active { background: var(--bg-panel); color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    .poke-card { 
        background: var(--bg-panel); border: 1px solid var(--border-color); 
        border-radius: 10px; padding: 12px; margin-bottom: 10px; 
        display: flex; align-items: center; gap: 15px; transition: 0.2s; position: relative; overflow: hidden;
    }
    .poke-card:active { transform: scale(0.98); }
    .poke-card.leader { border: 1px solid var(--accent); box-shadow: 0 0 10px rgba(241, 196, 15, 0.1); }
    
    .poke-img-container { 
        width: 50px; height: 50px; background: rgba(0,0,0,0.3); 
        border-radius: 50%; display: flex; align-items: center; justify-content: center; 
        border: 2px solid var(--border-color);
    }
    .poke-img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
    
    .poke-details { flex: 1; }
    .poke-name { font-weight: bold; color: var(--text-main); font-size: 1rem; }
    .poke-lvl { font-size: 0.75rem; color: var(--accent); margin-left: 5px; }
    
    .stat-bar-box { width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; margin-top: 6px; overflow: hidden; position: relative; }
    .stat-fill { height: 100%; border-radius: 3px; }
    .hp-fill { background: var(--success); }
    .xp-fill { background: linear-gradient(90deg, var(--accent), #e67e22); height: 4px; margin-top: 4px; }

    .card-actions { display: flex; flex-direction: column; gap: 5px; margin-left: 10px; }
    .icon-btn { background: none; border: none; font-size: 1.1rem; cursor: pointer; padding: 5px; opacity: 0.6; transition: 0.2s; }
    .icon-btn:hover { opacity: 1; transform: scale(1.1); }

    /* --- SHOP --- */
    .shop-item { 
        background: var(--bg-panel); border-radius: 10px; padding: 12px; margin-bottom: 10px; 
        display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color);
    }
    .shop-info h4 { margin: 0 0 4px 0; color: var(--text-main); }
    .shop-info span { font-size: 0.8rem; color: var(--text-muted); }
    .shop-controls { display: flex; align-items: center; gap: 10px; }
    .qty-input { width: 50px; background: #000; border: 1px solid #444; color: white; padding: 5px; border-radius: 5px; text-align: center; }

    /* --- POKEDEX (Modernizada) --- */
    #modalPokedex .modal-content { max-width: 900px; height: 650px; border-color: #00d2ff; background: #050a14; }
    #modalPokedex .modal-header h2 { color: #00d2ff; }
    .dex-layout { display: flex; height: 100%; }
    .dex-list { width: 35%; border-right: 1px solid #222; display: flex; flex-direction: column; background: rgba(255,255,255,0.02); }
    .dex-search { padding: 15px; border-bottom: 1px solid #222; }
    .dex-search input { width: 100%; background: #111; border: 1px solid #333; color: #00d2ff; padding: 10px; border-radius: 6px; outline: none; }
    .dex-grid { padding: 10px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
    .dex-icon { 
        aspect-ratio: 1; background: #111; border: 1px solid #333; border-radius: 8px; 
        display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; position: relative;
    }
    .dex-icon.active { border-color: #00d2ff; background: #0a1525; box-shadow: 0 0 10px rgba(0, 210, 255, 0.2); }
    .dex-icon img { width: 40px; height: 40px; image-rendering: pixelated; }
    
    .dex-viewer { flex: 1; padding: 30px; display: flex; flex-direction: column; overflow-y: auto; background: radial-gradient(circle at top, #0f1c2e 0%, #000 100%); }
    .dex-featured { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; }
    .dex-big-sprite { width: 140px; height: 140px; background: rgba(0, 210, 255, 0.05); border-radius: 20px; border: 1px solid rgba(0, 210, 255, 0.2); display: flex; align-items: center; justify-content: center; }
    .dex-big-sprite img { width: 100px; height: 100px; image-rendering: pixelated; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5)); }
    .dex-info h1 { margin: 0; color: #fff; font-size: 2rem; font-family: 'Rajdhani'; text-transform: uppercase; }
    .dex-tag { display: inline-block; padding: 4px 12px; background: #222; border: 1px solid #444; border-radius: 20px; font-size: 0.8rem; margin-top: 5px; color: #ccc; }
    .dex-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; background: rgba(255,255,255,0.03); padding: 20px; border-radius: 10px; }
    .stat-row { display: flex; align-items: center; font-size: 0.9rem; color: #aaa; }
    .stat-val { margin-left: auto; color: #fff; font-weight: bold; font-family: monospace; }
    .stat-bar { width: 60px; height: 6px; background: #333; margin-left: 10px; border-radius: 3px; overflow: hidden; }
    .stat-bar div { height: 100%; border-radius: 3px; }

    @media (max-width: 700px) {
        .dex-layout { flex-direction: column; }
        .dex-list { width: 100%; height: 180px; order: 2; border-top: 1px solid #333; border-right: none; }
        .dex-viewer { height: calc(100% - 180px); order: 1; padding: 15px; }
    }
</style>

<!-- MENU FLUTUANTE -->
<div class="float-container" id="floatMenu">
    <div id="menuItems" class="float-menu-items">
        <button class="float-btn" onclick="openBag()" title="Mochila">üéí</button>
        <button class="float-btn" onclick="openPC()" title="PC" style="color:var(--pc-green); border-color:var(--pc-green);">üíª</button>
        <button class="float-btn" onclick="openPokedex()" title="Pok√©dex" style="color:#00d2ff; border-color:#00d2ff;">üìö</button>
    </div>
    <button class="float-btn main-toggle" onclick="toggleFloatMenu()">‚ò∞</button>
</div>

<!-- MODAL PC (Retro Theme) -->
<div class="modal-overlay" id="modalPC">
    <div class="modal-content">
        <div class="modal-header">
            <h2>PC STORAGE SYSTEM_</h2>
            <button class="close-btn" onclick="closeModal('modalPC')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="pc-grid">
                <div class="pc-column">
                    <h3>PARTY [ACTIVE]</h3>
                    <div id="pcTeamList">Carregando...</div>
                </div>
                <div class="pc-column">
                    <h3>BOX 01 [STORAGE]</h3>
                    <div id="pcStorageList">Carregando...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL MOCHILA/EQUIPE -->
<div class="modal-overlay" id="modalTeam">
    <div class="modal-content">
        <div class="modal-header">
            <h2>GERENCIAR</h2>
            <button class="close-btn" onclick="closeModal('modalTeam')">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="bag-tabs">
                <button id="bagTabPoke" class="bag-tab active" onclick="switchBagTab('poke')">Pok√©mons</button>
                <button id="bagTabItems" class="bag-tab" onclick="switchBagTab('items')">Itens</button>
            </div>
            <div id="teamListContent">Carregando...</div>
            <div id="bagContentItems" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- MODAL LOJA -->
<div class="modal-overlay" id="modalShop">
    <div class="modal-content">
        <div class="modal-header">
            <h2 style="color:var(--accent)">SHOP</h2>
            <button class="close-btn" onclick="closeModal('modalShop')">‚úï</button>
        </div>
        <div class="modal-body">
            <!-- Saldo -->
            <div style="text-align:center; margin-bottom:20px; padding:10px; background:rgba(241,196,15,0.1); border-radius:8px; border:1px solid var(--accent); color:var(--accent);">
                Saldo Atual: <strong>$ <span id="shopBalance">0</span></strong>
            </div>
            <!-- Itens -->
            <div class="shop-item">
                <div class="shop-info">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <img src="/uploads/catchcube.gif" style="width:36px; height:36px; image-rendering:pixelated;">
                        <div>
                            <h4 style="margin:0;">CatchCube</h4>
                            <span style="font-size:0.75rem;">Captura monstros selvagens</span>
                        </div>
                    </div>
                </div>
                <div class="shop-controls">
                    <input id="buyPokeballQty" type="number" class="qty-input" value="1" min="1">
                    <button onclick="buyItem('pokeball')" class="btn btn-success">$50</button>
                </div>
            </div>
            <div class="shop-item">
                <div class="shop-info">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div style="font-size:1.8rem;">üç¨</div>
                        <div>
                            <h4 style="margin:0;">Rare Candy</h4>
                            <span style="font-size:0.75rem;">Sobe 1 n√≠vel instantaneamente</span>
                        </div>
                    </div>
                </div>
                <div class="shop-controls">
                    <input id="buyRareQty" type="number" class="qty-input" value="1" min="1">
                    <button onclick="buyItem('rareCandy')" class="btn btn-primary">$2000</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL POKEDEX -->
<div class="modal-overlay" id="modalPokedex">
    <div class="modal-content">
        <div class="modal-header" style="border-bottom-color:#00d2ff">
            <h2>POK√âDEX DATABASE</h2>
            <button class="close-btn" onclick="closeModal('modalPokedex')">‚úï</button>
        </div>
        <div class="dex-layout">
            <div class="dex-list">
                <div class="dex-search">
                    <input type="text" id="dexSearch" placeholder="Buscar dados..." onkeyup="filterDex()">
                </div>
                <div class="dex-grid" id="dexGrid">
                    <% if(typeof entities !== 'undefined') { entities.forEach((e, index) => { %>
                        <div class="dex-icon" onclick="selectDexMonster(<%= index %>, this)" data-name="<%= e.name.toLowerCase() %>">
                            <% if(e.sprite) { %> <img src="<%= e.sprite %>"> <% } else { %> ? <% } %>
                        </div>
                    <% }) } %>
                </div>
            </div>
            <div class="dex-viewer" id="dexDetailsView">
                <div style="color:#555; text-align:center; margin-top:50px;">Selecione um registro.</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DE INTERFACE ---
    
    function toggleFloatMenu() {
        const menu = document.getElementById('menuItems');
        menu.classList.toggle('show');
    }

    function closeModal(id) {
        document.getElementById(id).style.display = 'none';
    }

    // --- PC SYSTEM LOGIC ---
    async function openPC() { document.getElementById('modalPC').style.display='flex'; loadPCData(); }
    
    async function loadPCData() {
        const tDiv = document.getElementById('pcTeamList'); const pDiv = document.getElementById('pcStorageList');
        tDiv.innerHTML = '<span style="color:#0f0;font-size:0.6rem;">LOADING...</span>'; 
        pDiv.innerHTML = '<span style="color:#0f0;font-size:0.6rem;">LOADING...</span>';
        try {
            const res = await fetch('/api/pc?userId=<%= user._id %>'); const data = await res.json(); renderPC(data.team, data.pc);
        } catch(e) { tDiv.innerText='ERROR'; pDiv.innerText='ERROR'; }
    }
    
    function renderPC(team, pc) {
        const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;
        // HTML LIMPO USANDO CLASSES
        const createSlot = (p, from) => `
            <div class="pc-slot" onclick="movePokemon('${p.instanceId}', '${from}')">
                <img src="${_resImg(p.sprite)}">
                <div class="pc-info">
                    <div>${p.name}</div>
                    <div style="color:#00aa00">Lv.${p.level}</div>
                </div>
            </div>`;
            
        document.getElementById('pcTeamList').innerHTML = team.length ? team.map(p => createSlot(p, 'team')).join('') : '<div style="font-size:0.6rem;color:#004400;text-align:center;">[ EMPTY ]</div>';
        document.getElementById('pcStorageList').innerHTML = pc.length ? pc.map(p => createSlot(p, 'pc')).join('') : '<div style="font-size:0.6rem;color:#004400;text-align:center;">[ EMPTY ]</div>';
    }

    async function movePokemon(pokemonId, currentLoc) {
        const target = currentLoc === 'team' ? 'pc' : 'team';
        try {
            if(target === 'team') { 
                const count = document.getElementById('pcTeamList').children.length; 
                if(count >= 6) { alert('Equipe cheia (6).'); return; } 
            }
            const res = await fetch('/api/pc/move', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId, from: currentLoc, to: target }) });
            const data = await res.json();
            if(data.success) loadPCData(); else alert(data.error);
        } catch(e) { alert("Erro ao mover."); }
    }

    // --- BAG & TEAM LOGIC ---
    let currentPokeId = null;

    async function openBag() { 
        document.getElementById('modalTeam').style.display='flex'; 
        const content = document.getElementById('teamListContent'); 
        content.innerHTML = 'Carregando...'; 
        try { 
            const res = await fetch('/api/me?userId=<%= user._id %>'); 
            const data = await res.json(); 
            renderTeamBag(data);
        } catch(e) { content.innerHTML = 'Erro de conex√£o.'; } 
    }

    function renderTeamBag(data) {
    const content = document.getElementById('teamListContent'); 
    const pokemons = data.team || [];
    const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;
    
    let html = '';
    if (pokemons.length === 0) html = '<p style="text-align:center; color:#777;">Voc√™ n√£o tem Pok√©mons.</p>';
    else {
        pokemons.forEach((p, index) => {
            const hpPct = Math.min(100, (p.hp / p.maxHp) * 100);
            
            // Tratamento de seguran√ßa para XP
            const currentXp = p.xp || 0;
            const nextXp = p.xpToNext || 100;
            const xpPct = Math.min(100, (currentXp / nextXp) * 100);
            
            html += `
            <div class="poke-card ${index === 0 ? 'leader' : ''}">
                <div class="poke-img-container">
                    <img src="${_resImg(p.sprite)}" class="poke-img">
                </div>
                <div class="poke-details">
                    <div class="poke-name">${p.name} <span class="poke-lvl">Lv.${p.level}</span></div>
                    
                    <!-- HP -->
                    <div class="stat-bar-box"><div class="stat-fill hp-fill" style="width:${hpPct}%"></div></div>
                    <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">HP: ${p.hp}/${p.maxHp}</div>
                    
                    <!-- XP (Agora com texto) -->
                    <div class="stat-bar-box" style="height:4px; margin-top:6px; background:rgba(255,255,255,0.1);">
                        <div class="stat-fill xp-fill" style="width:${xpPct}%"></div>
                    </div>
                    <div style="font-size:0.65rem; color:#666; margin-top:1px; text-align:right;">XP: ${currentXp}/${nextXp}</div>
                </div>
                
                <div class="card-actions">
                    ${index !== 0 ? `<button onclick="setLead('${p.instanceId}')" class="icon-btn" title="Tornar L√≠der">‚≠ê</button>` : `<span title="L√≠der" style="text-align:center; font-size:1.2rem;">üëë</span>`}
                    <button onclick="showMoveEditor('${p.instanceId}', '${p.name}', ${JSON.stringify(p.moves).replace(/"/g, '&quot;')}, ${JSON.stringify(p.learnedMoves).replace(/"/g, '&quot;')})" class="icon-btn" title="Ataques">‚öîÔ∏è</button>
                    <button onclick="abandonPokemon('${p.instanceId}')" class="icon-btn" title="Libertar" style="color:var(--danger)">üóëÔ∏è</button>
                </div>
            </div>`;
        });
    }
    content.innerHTML = html;

    // Renderiza itens na aba oculta
    const itemsDiv = document.getElementById('bagContentItems');
    if(itemsDiv) {
        itemsDiv.innerHTML = `
            <div class="poke-card" style="display:block;">
                <h3 style="color:var(--text-main); margin-bottom:15px;">Invent√°rio</h3>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; color:var(--text-muted); border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
                    <span style="display:flex; align-items:center; gap:10px;">
                        <img src="/uploads/catchcube.gif" style="width:24px; vertical-align:middle;"> CatchCubes
                    </span> 
                    <strong style="color:var(--text-main); font-size:1.1rem;">${data.pokeballs || 0}</strong>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; color:var(--text-muted);">
                    <span style="display:flex; align-items:center; gap:10px;">
                        <span style="font-size:1.4rem; line-height:1;">üç¨</span> Rare Candy
                    </span>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <strong style="color:var(--text-main); font-size:1.1rem;">${data.rareCandy || 0}</strong>
                        ${(data.rareCandy > 0) ? `<button onclick="startRareCandySelection()" class="btn btn-primary" style="padding:5px 10px; font-size:0.7rem;">USAR</button>` : ''}
                    </div>
                </div>
            </div>
        `;
    }
    switchBagTab('poke');
}

    // --- LOJA ---
    async function openShop() {
        document.getElementById('modalShop').style.display = 'flex';
        try {
            const res = await fetch('/api/me?userId=<%= user._id %>');
            const data = await res.json();
            document.getElementById('shopBalance').innerText = data.money || 0;
        } catch(e){}
    }

    async function buyItem(item) {
        const inputId = item === 'pokeball' ? 'buyPokeballQty' : 'buyRareQty';
        const qty = document.getElementById(inputId).value;
        try {
            const res = await fetch('/api/buy-item', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', itemId: item, qty }) });
            const data = await res.json();
            if(data.success) {
                alert('Compra realizada!');
                document.getElementById('shopBalance').innerText = data.money;
                const openBagCheck = document.getElementById('modalTeam');
                if(openBagCheck.style.display === 'flex') openBag();
            } else {
                alert(data.error);
            }
        } catch(e){ alert('Erro de conex√£o'); }
    }

    // --- POKEDEX MODERNIZADA ---
    async function openPokedex() {
        document.getElementById('modalPokedex').style.display = 'flex';
        const first = document.querySelector('.dex-icon');
        if(first) selectDexMonster(0, first);
        try { await fetch(`/api/pokedex?userId=<%= user._id %>`); } catch(e) {}
    }

    function filterDex() {
        const v = document.getElementById('dexSearch').value.toLowerCase();
        document.querySelectorAll('.dex-icon').forEach(el => {
            el.style.display = el.getAttribute('data-name').includes(v) ? 'flex' : 'none';
        });
    }

    function selectDexMonster(i, el) {
        document.querySelectorAll('.dex-icon').forEach(e => e.classList.remove('active'));
        if(el) el.classList.add('active');
        
        const m = allMonsters[i];
        const s = m.baseStats;
        const sprite = (typeof resolveImg === 'function') ? resolveImg(m.sprite) : m.sprite;
        
        let evoHtml = '';
        if(m.evolution && m.evolution.targetId) {
            const target = allMonsters.find(x => x.id === m.evolution.targetId);
            evoHtml = `<div style="margin-top:15px; color:#555; font-size:0.8rem;">Evolution: <strong>${target ? target.name : '???'}</strong> (Lv.${m.evolution.level})</div>`;
        }

        const html = `
            <div class="dex-featured">
                <div class="dex-big-sprite"><img src="${sprite}"></div>
                <div class="dex-info">
                    <h1>${m.name}</h1>
                    <span class="dex-tag">${m.type}</span>
                    <span class="dex-tag" style="border-color:#3498db; color:#3498db">Catch Rate: ${m.catchRate}</span>
                    ${evoHtml}
                </div>
            </div>
            <div class="dex-stats">
                <div class="stat-row">HP <div class="stat-bar"><div style="width:${s.hp}%; background:#2ecc71"></div></div> <span class="stat-val">${s.hp}</span></div>
                <div class="stat-row">ATK <div class="stat-bar"><div style="width:${s.attack}%; background:#e74c3c"></div></div> <span class="stat-val">${s.attack}</span></div>
                <div class="stat-row">DEF <div class="stat-bar"><div style="width:${s.defense}%; background:#f1c40f"></div></div> <span class="stat-val">${s.defense}</span></div>
                <div class="stat-row">SPD <div class="stat-bar"><div style="width:${s.speed}%; background:#3498db"></div></div> <span class="stat-val">${s.speed}</span></div>
            </div>
            <div style="margin-top:20px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.1);">
                <strong style="color:#fff">Moveset</strong>
                <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;">
                    ${m.movePool.map(mv => `<span style="font-size:0.7rem; padding:4px; background:#111; color:#777; border-radius:4px;">Lv.${mv.level} ${mv.moveId}</span>`).join('')}
                </div>
            </div>
        `;
        document.getElementById('dexDetailsView').innerHTML = html;
    }

    // Helpers
    function switchBagTab(tab) {
        const teamContent = document.getElementById('teamListContent');
        const itemsContent = document.getElementById('bagContentItems');
        const tabP = document.getElementById('bagTabPoke');
        const tabI = document.getElementById('bagTabItems');
        
        if(tab === 'poke') {
            teamContent.style.display = 'block';
            itemsContent.style.display = 'none';
            tabP.classList.add('active'); tabI.classList.remove('active');
        } else {
            teamContent.style.display = 'none';
            itemsContent.style.display = 'block';
            tabP.classList.remove('active'); tabI.classList.add('active');
        }
    }

    async function setLead(pokeId) {
        const res = await fetch('/api/set-lead', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: pokeId }) });
        const data = await res.json();
        if(data.success) openBag();
    }

    async function abandonPokemon(instanceId) { 
        if(!confirm('Libertar este pok√©mon?')) return; 
        try { 
            const res = await fetch('/api/abandon-pokemon', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: instanceId }) }); 
            const data = await res.json(); 
            if(data.success) openBag(); else alert(data.error);
        } catch(e) { alert('Erro.'); } 
    }

    function showMoveEditor(id, name, equipped, learned) {
        currentPokeId = id;
        const pool = (learned && learned.length > 0) ? learned : equipped;
        let html = `<h3 style="text-align:center; color:var(--primary);">${name} - Golpes</h3><div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">`; 
        pool.forEach(moveId => { 
            const isEquipped = equipped.includes(moveId); 
            const style = isEquipped ? "background:var(--success); color:#000;" : "background:#222; color:#777;"; 
            html += `<div onclick="toggleMove('${moveId}', this)" class="move-chip" style="padding:8px; border-radius:5px; cursor:pointer; flex:1; text-align:center; font-size:0.8rem; font-weight:bold; border:1px solid #444; ${style}" data-id="${moveId}">${moveId}</div>`; 
        }); 
        html += `</div><div style="display:flex; gap:10px; margin-top:20px;"><button onclick="saveMoves()" class="btn btn-primary" style="flex:1">SALVAR</button><button onclick="openBag()" class="btn btn-outline" style="flex:1">VOLTAR</button></div>`; 
        document.getElementById('teamListContent').innerHTML = html; 
    }

    function toggleMove(moveId, el) {
        const isSelected = el.style.background.includes('var(--success)');
        const selectedCount = document.querySelectorAll('.move-chip[style*="var(--success)"]').length;
        
        if (isSelected) {
            if (selectedCount <= 1) return alert('M√≠nimo 1 ataque!');
            el.style.background = '#222'; el.style.color = '#777';
        } else {
            if (selectedCount >= 4) return alert('M√°ximo 4 ataques!');
            el.style.background = 'var(--success)'; el.style.color = '#000';
        }
    }

    async function saveMoves() {
        const chips = document.querySelectorAll('.move-chip');
        let finalMoves = [];
        chips.forEach(c => { if(c.style.background.includes('var(--success)')) finalMoves.push(c.getAttribute('data-id')); });
        const res = await fetch('/api/equip-move', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', pokemonId: currentPokeId, moves: finalMoves }) }); 
        const data = await res.json();
        if(data.success) openBag(); else alert(data.error);
    }

    async function startRareCandySelection() {
        const content = document.getElementById('teamListContent');
        content.innerHTML = '<div style="text-align:center; color:var(--accent);">Selecione o Pok√©mon para evoluir</div><div id="candyList"></div>';
        const listDiv = document.getElementById('candyList');
        
        try {
            const res = await fetch('/api/me?userId=<%= user._id %>');
            const data = await res.json();
            const _resImg = (typeof resolveImg === 'function') ? resolveImg : (s) => s;
            
            data.team.forEach(p => {
                listDiv.innerHTML += `
                    <div class="poke-card" style="cursor:pointer; border-color:var(--accent);" onclick="applyRareCandy('${p.instanceId}')">
                        <div class="poke-img-container"><img src="${_resImg(p.sprite)}" class="poke-img"></div>
                        <div class="poke-details"><div class="poke-name">${p.name} <span class="poke-lvl">Lv.${p.level}</span></div></div>
                        <div style="font-size:1.2rem;">üç¨</div>
                    </div>`;
            });
            content.innerHTML += `<button onclick="openBag()" class="btn btn-outline" style="width:100%; margin-top:10px;">CANCELAR</button>`;
        } catch(e) {}
    }

    async function applyRareCandy(pokeId) {
        try {
            const res = await fetch('/api/use-item', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userId: '<%= user._id %>', itemId: 'rareCandy', pokemonId: pokeId, qty: 1 }) });
            const data = await res.json();
            if(data.success) {
                alert(data.evolved ? 'Evoluiu!' : 'Subiu de n√≠vel!');
                openBag(); // Recarrega bag
            } else { alert(data.error); }
        } catch(e) {}
    }
</script>
