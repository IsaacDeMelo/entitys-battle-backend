<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Batalha</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; background: #222; font-family: 'Roboto', sans-serif; overflow: hidden; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        #battleArea { 
            position: relative; 
            width: 100%; 
            max-width: 500px; 
            height: 100%; 
            max-height: 900px; 
            background-image: url('/uploads/<%= bgImage %>'); 
            background-size: cover; 
            background-position: center bottom;
            overflow: hidden; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- UI SUPERIOR (HUD INIMIGO) --- */
        .hud-opponent { position: absolute; top: 40px; left: 20px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; color: white; border-left: 4px solid #e74c3c; z-index: 20; min-width: 140px; }
        
        /* --- UI INFERIOR (HUD JOGADOR) --- */
        .hud-player { position: absolute; bottom: 190px; right: 20px; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; color: white; border-right: 4px solid #3498db; z-index: 20; min-width: 140px; text-align: right; }

        .hp-bar-bg { width: 100%; height: 8px; background: #555; margin-top: 5px; border-radius: 4px; overflow: hidden; }
        .hp-bar-fill { height: 100%; background: #2ecc71; transition: width 0.5s ease-out, background 0.3s; }
        .energy-bar-bg { width: 100%; height: 4px; background: #444; margin-top: 3px; border-radius: 2px; overflow: hidden; }
        .energy-bar-fill { height: 100%; background: #f1c40f; transition: width 0.5s ease-out; }
        
        /* --- SPRITES --- */
        /* Ajuste de altura para ficarem mais para cima */
        .sprite-container { position: absolute; width: 140px; height: 140px; display: flex; justify-content: center; align-items: flex-end; }
        
        #p2-sprite-box { top: 15%; right: 10%; z-index: 5; } /* Inimigo */
        #p1-sprite-box { bottom: 35%; left: 10%; z-index: 10; } /* Jogador (Mais alto que antes) */

        .pokemon-sprite { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            image-rendering: pixelated; 
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.5));
            transition: opacity 0.2s, transform 0.3s;
        }

        /* --- ANIMA√á√ïES DE ENTRADA --- */
        /* Oculto inicialmente */
        .hidden-start { opacity: 0; }

        /* Selvagem: Desliza da direita */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .anim-slide-in { animation: slideInRight 1s ease-out forwards; }

        /* Pok√©bola sendo jogada e abrindo */
        @keyframes popOut {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; filter: brightness(100); }
            100% { transform: scale(1); opacity: 1; filter: brightness(1); }
        }
        .anim-pop-out { animation: popOut 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Efeito de flash branco ao sair da bola */
        .flash-white { animation: flash 0.5s linear; }
        @keyframes flash { 0% { filter: brightness(10); } 100% { filter: brightness(1); } }

        /* --- CONTROLES --- */
        #controls { position: absolute; bottom: 0; width: 100%; height: 160px; background: #1a1a2e; border-top: 4px solid #34495e; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; z-index: 100; }
        
        .move-btn { background: #2c3e50; color: white; border: 2px solid #34495e; border-radius: 8px; padding: 10px; font-family: 'Press Start 2P'; font-size: 0.6rem; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; height: 100%; position: relative; }
        .move-btn:active { background: #34495e; transform: translateY(2px); }
        .move-type { font-size: 0.5rem; color: #aaa; margin-top: 4px; text-transform: uppercase; }
        .move-energy { position: absolute; top: 2px; right: 4px; font-size: 0.5rem; color: #f1c40f; }

        /* BOT√ïES DE A√á√ÉO EXTRA */
        .action-row { grid-column: 1 / -1; display: flex; gap: 10px; height: 35px; }
        .act-btn { flex: 1; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; font-family: 'Roboto'; font-size: 0.9rem; }
        .btn-run { background: #e74c3c; }
        .btn-bag { background: #f39c12; }
        .btn-switch { background: #3498db; }
        .btn-catch { background: #27ae60; }

        /* --- MODAL DE TROCA (Z-INDEX CORRIGIDO) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); 
            z-index: 2000; /* BEM ALTO PARA FICAR EM CIMA DE TUDO */
            display: none; justify-content: center; align-items: center; 
        }
        .switch-card { background: #222; border: 2px solid #555; padding: 10px; margin-bottom: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .switch-card:hover { border-color: #3498db; background: #333; }
        .switch-img { width: 40px; height: 40px; image-rendering: pixelated; }

        /* LOG DE BATALHA */
        #battleLog { position: absolute; top: 120px; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; pointer-events: none; z-index: 50; display: flex; flex-direction: column; gap: 5px; }
        .log-msg { background: rgba(0,0,0,0.7); color: #fff; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; animation: fadeUp 2s forwards; }
        @keyframes fadeUp { 0% { opacity: 0; transform: translateY(10px); } 10% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; } 100% { opacity: 0; } }

        /* ANIMA√á√ÉO DE DANO */
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translate(0, 0); filter: hue-rotate(0deg); } 20% { transform: translate(-10px, 0); filter: hue-rotate(90deg) saturate(5); } 40% { transform: translate(10px, 0); } 60% { transform: translate(-10px, 0); } 80% { transform: translate(10px, 0); } 100% { transform: translate(0, 0); filter: none; } }
        .attack-anim { position: absolute; font-size: 3rem; z-index: 100; animation: popFade 0.5s forwards; pointer-events: none; }
        @keyframes popFade { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(2); opacity: 0; } }
    </style>
</head>
<body>

    <div id="battleArea">
        <div id="battleLog"></div>

        <!-- HUD INIMIGO -->
        <div class="hud-opponent">
            <div id="p2Name" style="font-weight:bold; font-size:0.9rem;"><%= p2.name %></div>
            <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">Lv. <span id="p2Level"><%= p2.level %></span></div>
            <div class="hp-bar-bg"><div id="p2HpBar" class="hp-bar-fill" style="width: 100%;"></div></div>
        </div>

        <!-- SPRITE INIMIGO -->
        <div id="p2-sprite-box" class="sprite-container">
            <img id="p2Sprite" src="<%= p2.sprite %>" class="pokemon-sprite hidden-start">
        </div>

        <!-- SPRITE JOGADOR -->
        <div id="p1-sprite-box" class="sprite-container">
            <img id="p1Sprite" src="<%= p1.sprite %>" class="pokemon-sprite hidden-start">
        </div>

        <!-- HUD JOGADOR -->
        <div class="hud-player">
            <div id="p1Name" style="font-weight:bold; font-size:0.9rem;"><%= p1.name %></div>
            <div style="font-size:0.7rem; color:#aaa; margin-top:2px;">Lv. <span id="p1Level"><%= p1.level %></span></div>
            <div class="hp-bar-bg"><div id="p1HpBar" class="hp-bar-fill" style="width: <%= (p1.hp / p1.maxHp)*100 %>%;"></div></div>
            <div style="font-size:0.6rem; margin-top:2px; color:#ddd;"><span id="p1HpText"><%= p1.hp %></span>/<span id="p1MaxHp"><%= p1.maxHp %></span></div>
            <div class="energy-bar-bg"><div id="p1EnergyBar" class="energy-bar-fill" style="width: <%= (p1.energy / p1.maxEnergy)*100 %>%;"></div></div>
        </div>

        <!-- CONTROLES -->
        <div id="controls">
            <% if(!isSpectator) { %>
                <div class="action-row">
                    <% if(battleMode === 'manual' || battleMode === 'wild') { %>
                        <button class="act-btn btn-run" onclick="sendAction('run')">FUGIR</button>
                        <button class="act-btn btn-catch" onclick="sendAction('catch')" <%= battleMode==='wild'?'':'disabled' %> style="<%= battleMode==='wild'?'':'opacity:0.5;' %>">CAPTURAR</button>
                    <% } %>
                    <button class="act-btn btn-switch" onclick="openSwitchModal()">TROCAR</button>
                </div>
                <!-- MOVES -->
                <% for(let i=0; i<4; i++) { 
                    const move = p1.moves[i]; 
                    if(move) { %>
                        <button class="move-btn" onclick="sendAction('move', '<%= move.id %>')">
                            <span><%= move.name %></span>
                            <span class="move-type" style="color:<%= move.color || '#aaa' %>"><%= move.element %></span>
                            <span class="move-energy"><%= move.cost %> EN</span>
                        </button>
                    <% } else { %>
                        <button class="move-btn" style="opacity:0.3; cursor:default;">‚Äî</button>
                    <% } 
                } %>
            <% } else { %>
                <div style="grid-column:1/-1; color:white; text-align:center; padding-top:40px;">VOC√ä EST√Å ASSISTINDO</div>
            <% } %>
        </div>
    </div>

    <!-- MODAL TROCA (Z-INDEX 2000) -->
    <div id="switchModal" class="modal-overlay">
        <div style="background:#1a1a2e; padding:20px; border-radius:10px; width:90%; max-width:350px; border:2px solid #3498db;">
            <h3 style="color:#f1c40f; text-align:center; margin-top:0; font-family:'Press Start 2P'; font-size:0.8rem;">TROCAR POK√âMON</h3>
            <div id="switchList" style="max-height:300px; overflow-y:auto; margin-bottom:10px;">
                <% switchable.forEach(p => { %>
                    <div class="switch-card" onclick="sendAction('switch', '<%= p.instanceId %>')">
                        <img src="<%= p.sprite %>" class="switch-img">
                        <div style="color:white; font-family:monospace;">
                            <div style="font-weight:bold"><%= p.name %> <span style="color:#aaa">Lv.<%= p.level %></span></div>
                            <div style="font-size:0.8rem; color:#2ecc71;">HP: <%= p.hp %>/<%= p.maxHp %></div>
                        </div>
                    </div>
                <% }) %>
            </div>
            <button onclick="document.getElementById('switchModal').style.display='none'" style="width:100%; padding:10px; background:#e74c3c; border:none; border-radius:5px; color:white; font-weight:bold;">CANCELAR</button>
        </div>
    </div>

    <script>
        const socket = io();
        const battleId = "<%= battleId %>";
        const battleMode = "<%= battleMode %>";
        const myRoleId = "<%= myRoleId %>"; // P1 instance ID
        let p1MaxHp = <%= p1.maxHp %>;
        let p2MaxHp = <%= p2.maxHp %>;
        
        // --- ANIMA√á√ïES DE ENTRADA ---
        window.onload = () => {
            const p1El = document.getElementById('p1Sprite');
            const p2El = document.getElementById('p2Sprite');

            if (battleMode === 'wild') {
                // Selvagem: Oponente desliza, Player joga bola
                p2El.classList.remove('hidden-start');
                p2El.classList.add('anim-slide-in');
                
                setTimeout(() => {
                    p1El.classList.remove('hidden-start');
                    p1El.classList.add('anim-pop-out');
                    p1El.classList.add('flash-white');
                }, 500); // Player sai depois
            } else {
                // Treinador: Os dois saem da bola
                setTimeout(() => {
                    p1El.classList.remove('hidden-start');
                    p2El.classList.remove('hidden-start');
                    p1El.classList.add('anim-pop-out');
                    p2El.classList.add('anim-pop-out');
                    p1El.classList.add('flash-white');
                    p2El.classList.add('flash-white');
                }, 300);
            }
        };

        function addLog(msg) {
            const div = document.createElement('div');
            div.className = 'log-msg';
            div.innerText = msg;
            document.getElementById('battleLog').appendChild(div);
            setTimeout(() => div.remove(), 2500);
        }

        function openSwitchModal() {
            document.getElementById('switchModal').style.display = 'flex';
        }

        function updateHp(who, current, max) {
            const pct = Math.max(0, Math.min(100, (current / max) * 100));
            const bar = document.getElementById(who + 'HpBar');
            bar.style.width = pct + '%';
            if (pct < 20) bar.style.background = '#e74c3c';
            else if (pct < 50) bar.style.background = '#f1c40f';
            else bar.style.background = '#2ecc71';
            
            if (who === 'p1') {
                document.getElementById('p1HpText').innerText = Math.floor(current);
                document.getElementById('p1MaxHp').innerText = Math.floor(max);
            }
        }

        // --- A√á√ïES ---
        async function sendAction(act, val) {
            if (document.getElementById('switchModal').style.display === 'flex') {
                document.getElementById('switchModal').style.display = 'none';
            }

            if (battleMode === 'online') {
                // SOCKET MODE
                addLog("Aguardando oponente...");
                socket.emit('online_move', { roomId: battleId, moveId: (act==='move' ? val : 'rest'), playerId: myRoleId }); // Simplificado para move/rest por enquanto no online, switch precisa de ajuste no backend online
            } else {
                // LOCAL/WILD FETCH MODE
                try {
                    const res = await fetch('/api/turn', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ battleId, action: act, moveId: val })
                    });
                    const data = await res.json();
                    if (data.finished) {
                        handleTurnResult(data);
                        setTimeout(() => {
                            if (data.win) { alert("VIT√ìRIA!"); window.location.href = '/lobby?userId=<%= realUserId %>'; }
                            else if (data.captured) { alert("Capturado!"); window.location.href = '/lobby?userId=<%= realUserId %>'; }
                            else if (data.fled) { window.location.href = '/forest?userId=<%= realUserId %>'; }
                            else { alert("DERROTA!"); window.location.href = '/lobby?userId=<%= realUserId %>'; }
                        }, 2000);
                    } else {
                        handleTurnResult(data);
                    }
                } catch (e) { console.error(e); }
            }
        }

        // --- PROCESSA O TURNO ---
        function handleTurnResult(data) {
            // 1. SE HOUVE TROCA, ATUALIZA O P1 IMEDIATAMENTE (CORRE√á√ÉO DO BUG)
            if (data.switched && data.p1State) {
                const s = data.p1State;
                // Atualiza vari√°veis globais vitais
                p1MaxHp = s.maxHp; 
                
                // Atualiza visual
                document.getElementById('p1Name').innerText = s.name;
                document.getElementById('p1Level').innerText = s.level;
                
                // Atualiza sprite com anima√ß√£o
                const img = document.getElementById('p1Sprite');
                img.src = s.sprite;
                img.classList.remove('anim-pop-out');
                void img.offsetWidth; // Trigger reflow
                img.classList.add('anim-pop-out');

                // Atualiza bot√µes
                const container = document.getElementById('controls');
                if(s.moves) {
                    // Reconstruir bot√µes de ataque (simplificado: recarrega pag ou manipula DOM. Aqui vamos s√≥ atualizar HP por enquanto)
                    // Num app completo, reconstruiria os bot√µes.
                    location.reload(); // Maneira mais segura de atualizar os bot√µes de golpe do novo pokemon
                    return; 
                }
            }

            // 2. PROCESSA EVENTOS (Dano, Mensagens)
            if (data.events) {
                let delay = 0;
                data.events.forEach(ev => {
                    setTimeout(() => {
                        if (ev.type === 'MSG') addLog(ev.text);
                        if (ev.type === 'ATTACK_HIT') {
                            const target = (ev.targetId === myRoleId || (data.newP1Id && ev.targetId === data.newP1Id)) ? 'p1' : 'p2';
                            const sprite = document.getElementById(target + 'Sprite');
                            sprite.classList.add('shake');
                            setTimeout(() => sprite.classList.remove('shake'), 500);
                            
                            // Cria efeito visual de hit
                            const hit = document.createElement('div');
                            hit.innerText = 'üí•';
                            hit.className = 'attack-anim';
                            hit.style.top = target === 'p1' ? '60%' : '20%';
                            hit.style.left = target === 'p1' ? '20%' : '70%';
                            document.getElementById('battleArea').appendChild(hit);
                            setTimeout(() => hit.remove(), 600);
                        }
                    }, delay);
                    delay += 1000;
                });
            }

            // 3. ATUALIZA BARRAS DE VIDA (No final, para refletir o dano)
            if (data.p1State) {
                // Se trocou, p1MaxHp j√° foi atualizado no passo 1. Se n√£o, usa o antigo.
                if(data.p1State.maxHp) p1MaxHp = data.p1State.maxHp;
                updateHp('p1', data.p1State.hp, p1MaxHp);
                document.getElementById('p1EnergyBar').style.width = (data.p1State.energy / (data.p1State.maxEnergy || 100) * 100) + '%';
            }
            if (data.p2State) {
                updateHp('p2', data.p2State.hp, p2MaxHp);
            }

            // 4. SWITCH FOR√áADO (MORTE)
            if (data.forceSwitch) {
                setTimeout(() => {
                    document.getElementById('switchList').innerHTML = data.switchable.map(p => 
                        `<div class="switch-card" onclick="sendAction('switch', '${p.instanceId}', true)">
                            <img src="${p.sprite}" class="switch-img">
                            <div>${p.name} (Lv.${p.level})</div>
                         </div>`
                    ).join('');
                    openSwitchModal();
                }, 1500);
            }
        }

        // Online Socket Listeners
        socket.on('opponent_ready', () => { addLog("Oponente escolheu!"); });
        socket.on('turn_result', (data) => {
            handleTurnResult(data);
            if (data.winnerId) {
                setTimeout(() => {
                    if (data.winnerId === myRoleId) alert("VENCEU!");
                    else alert("PERDEU!");
                    window.location.href = '/lobby?userId=<%= realUserId %>';
                }, 3000);
            }
        });
        
        if (battleMode === 'online') {
            socket.emit('join_room', battleId);
        }
    </script>
</body>
</html>