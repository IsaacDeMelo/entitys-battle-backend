<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Batalha</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        /* (CSS MANTIDO IGUAL AO ANTERIOR - PODE MANTER O SEU) */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: #000; color: white; font-family: 'Roboto', sans-serif; overflow: hidden; height: 100vh; width: 100vw; display: flex; flex-direction: column; }
        .arena { flex: 1; background: radial-gradient(circle at center, #2c3e50 0%, #000000 90%); display: flex; flex-direction: column; justify-content: center; position: relative; padding: 10px; }
        .arena::before { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 35%; background: linear-gradient(to top, rgba(30, 144, 255, 0.05), transparent); pointer-events: none; }
        .fighter { position: relative; width: 100%; height: auto; display: flex; z-index: 5; align-items: center; }
        .fighter.p2-side { flex-direction: row-reverse; justify-content: flex-start; padding-top: 20px; align-items: flex-start; margin-bottom: 20px; }
        .fighter.p1-side { flex-direction: row; justify-content: flex-start; padding-bottom: 26vh; align-items: flex-end; }
        .sprite { width: 140px; height: 140px; position: relative; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .sprite img { width: 100%; height: 100%; object-fit: contain; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8)); image-rendering: pixelated; }
        .emoji-fallback { font-size: 100px; line-height: 1; filter: drop-shadow(0 0 10px white); text-align: center; }
        .fighter.p1-side .sprite img { transform: scaleX(-1); }
        .stats { width: 180px; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 4px 15px rgba(0,0,0,0.6); z-index: 10; margin: 0; transition: 0.3s; }
        .p2-side .stats { border-right: 4px solid #e74c3c; text-align: right; margin-right: 20px; }
        .p1-side .stats { border-left: 4px solid #3498db; text-align: left; margin-left: 20px; }
        .name { font-size: 1rem; font-weight: 900; color: #fff; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; display: block; text-shadow: 2px 2px 0 #000; }
        .bar-wrapper { margin-bottom: 5px; }
        .bar-container { width: 100%; height: 12px; background: #222; border-radius: 4px; overflow: hidden; border: 1px solid #000; }
        .hp-fill { height: 100%; background: #2ecc71; width: 100%; transition: width 0.3s; }
        .en-fill { height: 100%; background: #f1c40f; width: 100%; transition: width 0.3s; }
        .hp-danger { background: #e74c3c !important; }
        .stat-text { font-size: 0.7rem; color: #bbb; font-family: monospace; font-weight: bold; margin-top: 2px; display: flex; justify-content: space-between; }
        .bottom-panel { width: 100%; height: 25vh; background: #111; border-top: 2px solid #333; z-index: 50; display: none; }
        .battle-log { padding: 10px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; }
        .log-entry { margin-bottom: 5px; animation: fadeIn 0.3s forwards; line-height: 1.4; border-bottom: 1px solid #222; padding-bottom: 2px; }
        .controls-panel { grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; border-top-color: #3498db; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .controls-panel.active { display: grid; }
        .battle-log.active { display: block; }
        .move-btn { background: #2a2a3a; border: 1px solid #444; color: white; border-radius: 8px; font-family: 'Roboto', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .move-btn:active { transform: scale(0.96); }
        .move-btn:disabled { opacity: 0.4; pointer-events: none; }
        .move-btn strong { font-size: 0.9rem; margin-bottom: 2px; }
        .move-btn small { font-size: 0.7rem; color: #f1c40f; }
        .rest-btn { grid-column: span 2; background: #2c3e50; border-color: #3498db; }
        .anim-p1-attack { animation: lungeP1 0.2s alternate 2; } @keyframes lungeP1 { to { transform: translate(40px, -40px); } }
        .anim-p2-attack { animation: lungeP2 0.2s alternate 2; } @keyframes lungeP2 { to { transform: translate(-40px, 40px); } }
        .anim-shake { animation: shake 0.4s; } @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px) rotate(-5deg);} 75% {transform: translateX(10px) rotate(5deg);} }
        .floating-text { font-family: 'Press Start 2P', cursive; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; text-shadow: 3px 3px 0 #000; animation: popUp 0.8s forwards; z-index: 100; pointer-events: none; white-space: nowrap; }
        @keyframes popUp { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 50% { transform: translate(-50%, -100%) scale(1.5); opacity: 1; } 100% { transform: translate(-50%, -150%) scale(1); opacity: 0; } }
        .damage-text { color: #ff4757; -webkit-text-stroke: 1px #500; } .heal-text { color: #2ed573; -webkit-text-stroke: 1px #050; } .resist-text { color: #bdc3c7; -webkit-text-stroke: 1px #2c3e50; font-size: 1.5rem !important; }
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #overlay h1 { color: #f1c40f; font-family: 'Press Start 2P'; font-size: 2rem; text-align: center; margin-bottom: 30px; }
        .btn-restart { background: #3498db; color: white; padding: 20px 40px; text-decoration: none; font-size: 1.2rem; font-weight: bold; border-radius: 50px; }
        .status-msg { position: absolute; top: 10px; width: 100%; text-align: center; color: #f1c40f; font-weight: bold; text-shadow: 1px 1px 0 #000; z-index: 100; pointer-events: none; }
    </style>
</head>
<body>
    <div class="status-msg" id="statusMsg"></div>

    <div class="arena">
        <!-- P2 (Oponente) em Cima -->
        <div class="fighter p2-side" id="fighter-<%= p2.id %>">
            <div class="sprite"><% if (p2.sprite) { %> <img src="/uploads/<%= p2.sprite %>"> <% } else { %> <div class="emoji-fallback">üëø</div> <% } %></div>
            <div class="stats">
                <div class="name"><%= p2.name %></div>
                <div class="bar-wrapper"><div class="bar-container"><div class="hp-fill" id="hp-bar-<%= p2.id %>"></div></div><div class="stat-text"><span>HP</span><span><span id="hp-val-<%= p2.id %>"><%= p2.hp %></span>/<%= p2.maxHp %></span></div></div>
                <div class="bar-wrapper"><div class="bar-container" style="height: 6px;"><div class="en-fill" id="en-bar-<%= p2.id %>"></div></div></div>
            </div>
        </div>
        <!-- P1 (Voc√™) em Baixo -->
        <div class="fighter p1-side" id="fighter-<%= p1.id %>">
            <div class="sprite"><% if (p1.sprite) { %> <img src="/uploads/<%= p1.sprite %>"> <% } else { %> <div class="emoji-fallback">ü¶∏</div> <% } %></div>
            <div class="stats">
                <div class="name"><%= p1.name %></div>
                <div class="bar-wrapper"><div class="bar-container"><div class="hp-fill" id="hp-bar-<%= p1.id %>"></div></div><div class="stat-text"><span>HP</span><span id="hp-val-<%= p1.id %>"><%= p1.hp %></span></div></div>
                <div class="bar-wrapper"><div class="bar-container" style="height: 8px;"><div class="en-fill" id="en-bar-<%= p1.id %>"></div></div><div class="stat-text" style="font-size: 0.6rem; color: #f1c40f;">ENERGIA: <span id="en-val-<%= p1.id %>"><%= p1.energy %></span></div></div>
            </div>
        </div>
        <div id="overlay"><h1 id="winnerText">VENCEDOR</h1><a href="/" class="btn-restart">MENU</a></div>
    </div>

    <div class="battle-log bottom-panel" id="logBox"></div>

    <div class="controls-panel bottom-panel" id="controlsPanel">
        <% p1.moves.forEach(move => { %>
            <button class="move-btn" onclick="sendMove('<%= move.id %>')" id="btn-<%= move.id %>">
                <strong><%= move.icon %> <%= move.name %></strong><small><%= move.cost %> Energia</small>
            </button>
        <% }) %>
        <button class="move-btn rest-btn" onclick="sendMove('rest')">üí§ Descansar (+5 EN)</button>
    </div>

    <script>
        const socket = io(); // Inicia Socket
        const battleMode = "<%= battleMode %>"; 
        const battleId = "<%= battleId %>";
        const initialData = <%- battleData %>;
        // ID do meu monstro (que veio da tela de home)
        const myRoleId = "<%= typeof myRoleId !== 'undefined' ? myRoleId : '' %>";
        
        const p1Id = "<%= p1.id %>"; 
        const p2Id = "<%= p2.id %>";
        let currentEnergy = parseInt("<%= p1.energy %>");
        
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function log(msg, color='#fff') {
            const box = document.getElementById('logBox');
            if(battleMode === 'manual') return; // Logs manuais aparecem s√≥ como texto flutuante ou se o painel sumir
            const entry = document.createElement('div');
            entry.className = 'log-entry'; entry.innerHTML = msg; entry.style.color = color;
            box.insertBefore(entry, box.firstChild);
        }

        // --- INICIALIZA√á√ÉO DO ONLINE ---
        if (battleMode === 'online') {
            // ESSENCIAL: Diz ao servidor "Entrei na sala!"
            socket.emit('join_room', battleId);

            // Escuta resultado do turno
            socket.on('turn_result', async (data) => {
                document.getElementById('statusMsg').innerText = "";
                document.getElementById('controlsPanel').classList.remove('active');
                document.getElementById('logBox').classList.add('active'); // Mostra log enquanto anima
                
                await playEvents(data.events);

                if(data.winnerId) {
                    endGame(data.winnerId);
                } else {
                    document.getElementById('logBox').classList.remove('active');
                    document.getElementById('controlsPanel').classList.add('active');
                    updateButtons();
                }
            });

            socket.on('opponent_ready', () => {
                document.getElementById('statusMsg').innerText = "Oponente escolheu! Sua vez...";
            });
        }

        function updateBar(id, current, max, type) {
            const pct = Math.max(0, (current / max) * 100);
            const el = document.getElementById(`${type}-bar-${id}`);
            if(el) { el.style.width = `${pct}%`; if(type === 'hp') { document.getElementById(`hp-val-${id}`).innerText = Math.max(0, current); if(pct < 30) el.classList.add('hp-danger'); } if(type === 'en' && id === p1Id) { currentEnergy = current; document.getElementById(`en-val-${id}`).innerText = current; updateButtons(); } }
        }

        function updateButtons() {
            const btns = document.querySelectorAll('.move-btn:not(.rest-btn)');
            btns.forEach(btn => { const txt = btn.querySelector('small').innerText; const cost = parseInt(txt); btn.disabled = currentEnergy < cost; });
        }

        function showFloatingText(targetId, text, className) {
            const fighter = document.getElementById(`fighter-${targetId}`);
            const el = document.createElement('div');
            el.className = `floating-text ${className}`; el.innerText = text;
            fighter.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        async function playEvents(events) {
            for (let evt of events) {
                if (evt.type === 'INIT') continue;
                if (evt.type === 'USE_MOVE') {
                    const isP1 = (evt.actorId == p1Id);
                    const fighterEl = document.getElementById(`fighter-${evt.actorId}`);
                    if (evt.moveType === 'attack') {
                        fighterEl.classList.add(isP1 ? 'anim-p1-attack' : 'anim-p2-attack');
                        setTimeout(() => fighterEl.classList.remove('anim-p1-attack', 'anim-p2-attack'), 400);
                    }
                    const initialMax = (evt.actorId == p1Id) ? <%= p1.maxEnergy %> : <%= p2.maxEnergy %>;
                    updateBar(evt.actorId, evt.newEnergy, initialMax, 'en');
                    log(`<b>${isP1 ? '<%= p1.name %>' : '<%= p2.name %>'}</b> usou ${evt.moveName}!`, "#3498db");
                    await wait(500);
                }
                else if (evt.type === 'ATTACK_HIT') {
                    const targetEl = document.getElementById(`fighter-${evt.targetId}`);
                    targetEl.classList.add('anim-shake');
                    setTimeout(() => targetEl.classList.remove('anim-shake'), 400);
                    let extra = ""; let style = "damage-text";
                    if(evt.isEffective) extra = "CRIT!"; 
                    if(evt.isNotEffective) { extra = "Resist..."; style = "resist-text"; }
                    if(evt.isBlocked) extra = "üõ°Ô∏è";
                    showFloatingText(evt.targetId, `-${evt.damage} ${extra}`, style);
                    const maxHp = (evt.targetId == p1Id) ? <%= p1.maxHp %> : <%= p2.maxHp %>;
                    updateBar(evt.targetId, evt.newHp, maxHp, 'hp');
                    await wait(700);
                }
                else if (evt.type === 'HEAL') {
                    showFloatingText(evt.actorId, `+${evt.amount}`, 'heal-text');
                    const maxHp = (evt.actorId == p1Id) ? <%= p1.maxHp %> : <%= p2.maxHp %>;
                    updateBar(evt.actorId, evt.newHp, maxHp, 'hp');
                    log("Curou HP!", "#2ecc71");
                    await wait(700);
                }
                else if (evt.type === 'EFFECT_TICK') {
                    const targetEl = document.getElementById(`fighter-${evt.targetId}`);
                    targetEl.classList.add('anim-shake');
                    setTimeout(() => targetEl.classList.remove('anim-shake'), 400);
                    showFloatingText(evt.targetId, `-${evt.damage}`, 'damage-text');
                    const maxHp = (evt.targetId == p1Id) ? <%= p1.maxHp %> : <%= p2.maxHp %>;
                    updateBar(evt.targetId, evt.newHp, maxHp, 'hp');
                    await wait(500);
                }
                else if (evt.type === 'REST') {
                    const initialMax = (evt.actorId == p1Id) ? <%= p1.maxEnergy %> : <%= p2.maxEnergy %>;
                    updateBar(evt.actorId, evt.newEnergy, initialMax, 'en');
                    log("Descansando...", "#95a5a6");
                    await wait(500);
                }
            }
        }

        async function sendMove(moveId) {
            document.getElementById('controlsPanel').classList.remove('active');
            
            if (battleMode === 'online') {
                document.getElementById('statusMsg').innerText = "Aguardando oponente...";
                // Envia o ID original do monstro para o servidor saber quem √© quem
                socket.emit('online_move', { roomId: battleId, moveId, playerId: myRoleId });
            } 
            else if (battleMode === 'manual') {
                document.getElementById('logBox').classList.add('active');
                const res = await fetch('/api/turn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ battleId, moveId }) });
                const data = await res.json();
                if(data.error) { alert("Erro"); return; }
                await playEvents(data.events);
                if(data.winnerId) endGame(data.winnerId);
                else {
                    document.getElementById('logBox').classList.remove('active');
                    document.getElementById('controlsPanel').classList.add('active');
                    updateButtons();
                }
            }
        }

        function endGame(winnerId) {
            document.getElementById('overlay').style.display = 'flex';
            let wName = "EMPATE"; 
            if(winnerId == p1Id) wName = "<%= p1.name %>"; 
            else if(winnerId == p2Id) wName = "<%= p2.name %>";
            
            let msg = "VENCEDOR";
            if (battleMode === 'online') {
                if (winnerId == p1Id) { msg = "VOC√ä VENCEU!"; document.getElementById('winnerText').style.color = "#2ecc71"; }
                else { msg = "DERROTA..."; document.getElementById('winnerText').style.color = "#e74c3c"; }
                document.getElementById('winnerText').innerHTML = `${msg}<br><span style="color:white; font-size:1rem">${wName}</span>`;
            } else {
                document.getElementById('winnerText').innerHTML = `VENCEDOR<br><span style="color:white; font-size:1.5rem">${wName}</span>`;
            }
        }

        async function start() {
            if(battleMode === 'auto') {
                document.getElementById('logBox').classList.add('active');
                await wait(1000);
                log("BATALHA AUTO INICIADA!", "#f1c40f");
                await playEvents(initialData.log);
                await wait(1000);
                endGame(initialData.winnerId);
            } else {
                // Online e Manual
                document.getElementById('controlsPanel').classList.add('active');
                updateButtons();
            }
        }
        start();
    </script>
</body>
</html>