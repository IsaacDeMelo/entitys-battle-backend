<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Batalha</title>
    <link rel="preload" as="image" href="/uploads/catchcube.gif">
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="/scripts/common.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
   <style>
    :root { --bg-color: #202020; --hp-high: #4fd05c; --hp-mid: #f6b93b; --hp-low: #e55039; }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
    body { margin: 0; padding: 0; background: var(--bg-color); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }
    
    #global-loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
    .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.1); border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
    .loading-text { font-family: 'Press Start 2P', cursive; font-size: 0.8rem; color: #f1c40f; animation: pulse 1.5s infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* --- CORRE√á√ÉO DO BACKGROUND AQUI --- */
    .arena { 
        flex: 1; 
        /* Verifica se √© base64/url ou arquivo local */
        background: url('<%= (bgImage.startsWith("http") || bgImage.startsWith("data:")) ? bgImage : "/uploads/" + bgImage %>') no-repeat center center; 
        background-size: cover; 
        position: relative; 
        overflow: hidden; 
        z-index: 10; 
        image-rendering: pixelated; 
    }
    
    .hud-panel { position: absolute; background: rgba(15, 15, 20, 0.95); padding: 6px 10px; border-radius: 8px; border: 2px solid #555; z-index: 30; width: 150px; font-family: 'Press Start 2P', cursive; bottom: 20px; top: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .hud-p1 { left: 10px; border-left: 5px solid #3498db; text-align: left; }
    .hud-p2 { right: 10px; border-right: 5px solid #e74c3c; text-align: right; }
    .poke-name { font-size: 0.55rem; margin-bottom: 5px; color: #fff; text-shadow: 1px 1px 0 #000; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .poke-lv { font-size: 0.45rem; color: #f1c40f; margin-left: 4px; }
    .trainer-sub { font-size: 0.45rem; color: #bbb; margin-bottom: 5px; text-transform: uppercase; font-family: sans-serif; font-weight: bold; letter-spacing: 1px; }
    .bar-container { width: 100%; height: 8px; background: #333; border-radius: 5px; overflow: hidden; border: 1px solid #000; margin-bottom: 4px; position: relative; }
    .hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.5s ease-out; }
    .en-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); transition: width 0.5s ease-out; }
    .stat-text { font-size: 0.5rem; color: #ddd; text-shadow: 1px 1px 0 #000; display: block; margin-top: 2px; }
    
    .fighter { 
        position: absolute; 
        width: 240px; 
        height: 120px; 
        display: flex; 
        align-items: flex-end; 
        z-index: 20; 
        pointer-events: none; 
        top: calc(50% - 10px); 
        transform: translateY(-50%); 
        transition: opacity 0.5s; 
    }
    
    .fighter.p2-position { right: 2%; justify-content: flex-end; }
    .fighter.p2-position .trainer { order: 2; margin-left: -20px; z-index: 23; background-position-y: 33.33%; } 
    .fighter.p2-position .sprite { order: 1; z-index: 22; }
    .fighter.p1-position { left: 2%; justify-content: flex-start; }
    .fighter.p1-position .trainer { order: 1; margin-right: -20px; z-index: 23; background-position-y: 66.66%; }
    .fighter.p1-position .sprite { order: 2; z-index: 22; transform: scaleX(-1); }

    .sprite { 
        position: relative; 
        width: 110px; 
        height: 110px; 
        transition: transform 0.2s; 
        margin-bottom: 5px; 
    }
    .sprite img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); animation: breathe 3s infinite ease-in-out; opacity: 0; transition: opacity 0.2s ease-out; }
    .sprite img.attack { animation: attackBump 0.3s ease-in-out; }
    @keyframes attackBump {
        0% { transform: translateX(0); }
        25% { transform: translateX(20px); }
        50% { transform: translateX(-10px); }
        100% { transform: translateX(0); }
    }
    @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.03); } }
    .sprite img.hurt { filter: brightness(2) saturate(0) sepia(1) hue-rotate(-50deg); animation: shake 0.4s; }
    .sprite img.status-dmg { filter: brightness(0.8) sepia(1) hue-rotate(240deg) saturate(3); }
    
    .trainer { 
        position: relative; 
        width: 50px; 
        height: 50px; 
        background-size: 400% auto; 
        image-rendering: pixelated; 
        margin-bottom: 15px; 
        top: 5px; 
        transition: transform 0.2s; 
    }

    <% for(let i = 1; i <= 20; i++) { %> .trainer[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); } <% } %>
    .trainer[data-skin="char1"] { background-image: url('/uploads/char1.png'); }
    .trainer.frame-1 { background-position-x: -100%; }
    .atk-particle { position: absolute; pointer-events: none; z-index: 2000; animation: particleFly 0.5s forwards; width: 30px; height: 30px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); }
    @keyframes particleFly { 0% { transform: translate(0,0) scale(0.2); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(2); opacity: 0; } }
    .impact-effect { position: absolute; width: 100px; height: 100px; z-index: 2000; pointer-events: none; border-radius: 50%; opacity: 0; }
    .impact-pop { animation: impactPop 0.4s forwards; }
    @keyframes impactPop { 0% { transform: scale(0.2); opacity: 1; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(1.5); opacity: 0; } }
    
    .effect-fire { background: radial-gradient(circle, #f1c40f, #e74c3c); box-shadow: 0 0 20px #e67e22; }
    .effect-water { background: radial-gradient(circle, #3498db, #2980b9); box-shadow: 0 0 20px #3498db; }
    .effect-plant { background: radial-gradient(circle, #2ecc71, #27ae60); box-shadow: 0 0 20px #2ecc71; }
    .effect-normal { background: radial-gradient(circle, #fff, #bbb); box-shadow: 0 0 10px #fff; }
    .effect-electric { background: radial-gradient(circle, #f1c40f, #fff); box-shadow: 0 0 20px #f1c40f; }
    .effect-ice { background: radial-gradient(circle, #74b9ff, #fff); box-shadow: 0 0 20px #74b9ff; }
    .effect-poison { background: radial-gradient(circle, #8e44ad, #9b59b6); box-shadow: 0 0 15px #8e44ad; }
    .effect-ground { background: radial-gradient(circle, #d35400, #e67e22); box-shadow: 0 0 15px #d35400; }
    .effect-flying { background: radial-gradient(circle, #ecf0f1, #95a5a6); box-shadow: 0 0 15px #fff; }
    .effect-psychic { background: radial-gradient(circle, #e056fd, #be2edd); box-shadow: 0 0 15px #e056fd; }
    .effect-bug { background: radial-gradient(circle, #badc58, #6ab04c); box-shadow: 0 0 15px #badc58; }
    .effect-rock { background: radial-gradient(circle, #95a5a6, #7f8c8d); box-shadow: 0 0 15px #95a5a6; }
    .effect-ghost { background: radial-gradient(circle, #4834d4, #686de0); box-shadow: 0 0 15px #4834d4; }
    .effect-dragon { background: radial-gradient(circle, #30336b, #130f40); box-shadow: 0 0 15px #30336b; }
    .effect-dark { background: radial-gradient(circle, #2d3436, #000); box-shadow: 0 0 15px #000; }
    .effect-steel { background: radial-gradient(circle, #bdc3c7, #95a5a6); box-shadow: 0 0 15px #bdc3c7; }
    .effect-fairy { background: radial-gradient(circle, #ff9ff3, #f368e0); box-shadow: 0 0 15px #ff9ff3; }
    .effect-fighter { background: radial-gradient(circle, #e67e22, #d35400); box-shadow: 0 0 15px #d35400; }
    
    .command-bubble { position: absolute; top: -50px; left: 50%; transform: translateX(-50%) scale(0); background: #fff; color: #000; padding: 10px 15px; border-radius: 20px; border: 2px solid #000; font-family: 'Press Start 2P'; font-size: 0.6rem; white-space: nowrap; z-index: 100; opacity: 0; transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: none; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
    .command-bubble.show { opacity: 1; transform: translateX(-50%) scale(1); top: -70px; }
    .floating-text { font-family: 'Press Start 2P'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.5rem; text-shadow: 3px 3px 0 #000; animation: popUp 1.2s forwards; z-index: 100; pointer-events: none; width: 300px; text-align: center; }
    @keyframes popUp { 0% { opacity: 0; margin-top: 0; transform: translate(-50%, -50%) scale(0.5); } 20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); } 100% { opacity: 0; margin-top: -150px; transform: translate(-50%, -50%) scale(1); } }
    .damage-text { color: #ff4757; -webkit-text-stroke: 1px #800; } 
    .heal-text { color: #2ed573; -webkit-text-stroke: 1px #050; } 
    .resist-text { color: #bdc3c7; font-size: 0.9rem; margin-top: -30px !important; }
    .super-text { color: #f1c40f; font-size: 1rem; margin-top: -30px !important; text-shadow: 2px 2px 0 #c0392b; }
    .status-text { color: #9b59b6; font-size: 1rem; margin-top: -50px !important; text-shadow: 2px 2px 0 #000; }
    .bottom-panel { width: 100%; height: auto; background: #1a1a2e; border-top: 4px solid #3498db; z-index: 50; padding-bottom: env(safe-area-inset-bottom); position: relative; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
    .controls-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
    .battle-log { padding: 15px; overflow-y: auto; font-family: monospace; font-size: 14px; color: #ecf0f1; height: 180px; background: #111; line-height: 1.5; }
    .log-entry { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 4px; }
    .move-btn { background: linear-gradient(180deg, #2c3e50, #1a252f); border: 2px solid #34495e; color: white; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; padding: 12px; position: relative; overflow: hidden; }
    .move-btn strong { font-size: 0.9rem; margin-bottom: 2px; text-transform: uppercase; }
    .move-btn small { font-size: 0.7rem; color: #f1c40f; font-weight: bold; }
    .move-btn:active { transform: scale(0.96); border-color: #f1c40f; background: #1a252f; }
    .move-btn:disabled { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
    .rest-btn { grid-column: span 2; background: linear-gradient(180deg, #27ae60, #1e8449); border-color: #2ecc71; }
    #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; animation: fadeIn 0.5s; }
    #overlay h1 { font-family: 'Press Start 2P'; text-align: center; color: #f1c40f; text-shadow: 0 4px 0 #c27c0e; margin-bottom: 40px; font-size: 1.8rem; }
    .podium { display: flex; align-items: flex-end; gap: 40px; margin-bottom: 40px; }
    .winner-box { display: flex; flex-direction: column; align-items: center; transform: scale(1.3); z-index: 2; position: relative; }
    .loser-box { display: flex; flex-direction: column; align-items: center; opacity: 0.6; filter: grayscale(1) contrast(1.2); transform: scale(0.9); }
    .podium-avatar-group { position: relative; width: 140px; height: 140px; }
    .podium-trainer { width: 64px; height: 64px; background-size: 400% auto; background-position: 0 0; image-rendering: pixelated; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
    .podium-monster { width: 120px; height: 120px; object-fit: contain; image-rendering: pixelated; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1; opacity: 0.9; }
    .crown { font-size: 2.5rem; position: absolute; top: -20px; left: 50%; transform: translateX(-50%); z-index: 3; text-shadow: 0 0 15px gold; animation: float 2s infinite ease-in-out; }
    @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-8px); } }
    .podium-base { height: 15px; width: 120%; border-radius: 50%; margin-top: -10px; z-index: 0; }
    .winner-box .podium-base { background: radial-gradient(#f1c40f, transparent); box-shadow: 0 0 30px #f1c40f; }
    .loser-box .podium-base { background: radial-gradient(#555, transparent); }
    .name-tag { font-family: 'Press Start 2P'; font-size: 0.7rem; margin-top: 20px; color: white; text-align: center; background: #333; padding: 8px 12px; border-radius: 6px; border: 1px solid #777; width: 100%; white-space: nowrap; }
    .btn-restart { background: linear-gradient(135deg, #3498db, #2980b9); color: white; padding: 18px 40px; border-radius: 40px; border: none; font-family: 'Press Start 2P'; font-size: 0.9rem; cursor: pointer; transition: 0.2s; box-shadow: 0 6px 0 #1c5980; text-transform: uppercase; }
    .btn-restart:active { transform: translateY(4px); box-shadow: none; }
    .spectator-banner { position: absolute; bottom: 0; width: 100%; text-align: center; background: rgba(0,0,0,0.8); color: #f1c40f; padding: 10px; font-family: 'Press Start 2P'; font-size: 0.8rem; pointer-events: none; z-index: 50; letter-spacing: 2px; }
    .catchball { position: absolute; width: 24px; height: 24px; background-image: url('/uploads/catchcube.gif'); background-size: contain; background-repeat: no-repeat; z-index: 2000; pointer-events: none; transform-origin: center center; }
    .flash-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; opacity: 0; pointer-events: none; z-index: 500; transition: opacity 0.15s; }
    .flash-overlay.active { opacity: 0.9; }
    .absorbed-state { filter: brightness(10) sepia(1) hue-rotate(-50deg) saturate(5) !important; transform: scale(0) !important; transition: transform 0.4s ease-in, filter 0.1s !important; }
    .catchball.captured-lock { filter: brightness(0.6); }
    .capture-star { position: absolute; font-size: 30px; color: gold; text-shadow: 0 0 5px orange; animation: star-pop 0.6s ease-out forwards; z-index: 2200; }
    @keyframes star-pop { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(1) translateY(-30px); opacity: 0; } }
    #switchModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
    .switch-box { background: #2c3e50; border: 2px solid #e74c3c; padding: 25px; border-radius: 15px; width: 90%; max-width: 450px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
    .switch-title { font-family: 'Press Start 2P'; color: #f1c40f; margin-bottom: 25px; font-size: 0.9rem; line-height: 1.6; text-shadow: 2px 2px 0 #000; }
    .switch-item { display: flex; align-items: center; gap: 15px; padding: 12px; border: 1px solid #444; background: #222; margin-bottom: 10px; cursor: pointer; border-radius: 8px; transition: 0.2s; text-align: left; }
    .switch-item:hover { background: #333; border-color: #3498db; transform: translateX(5px); }
    .switch-sprite { width: 50px; height: 50px; image-rendering: pixelated; object-fit: contain; }
    #floatingBagPanel { position: fixed; right: 15px; bottom: 220px; width: 280px; background: rgba(15, 20, 30, 0.98); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; z-index: 80; box-shadow: 0 10px 40px rgba(0,0,0,0.8); display: none; color: #ddd; backdrop-filter: blur(10px); }
    #floatingBagPanel h4 { margin: 0 0 12px 0; font-size: 0.8rem; color: #f1c40f; font-family: 'Press Start 2P'; border-bottom: 1px solid #333; padding-bottom: 8px; }
    #floatingBagPanel .bag-row { display:flex; gap:10px; align-items:center; margin-bottom: 10px; }
    #floatingBagPanel .bag-item { flex:1; background: rgba(255,255,255,0.05); padding:10px; border-radius: 8px; font-size:0.9rem; text-align:center; border: 1px solid #333; }
    #floatingBagPanel .bag-actions { display:flex; gap:8px; margin-top:8px; }
    #floatingBagPanel .btn-small { flex:1; padding:10px; border-radius:8px; border:none; cursor:pointer; font-weight:800; font-size: 0.8rem; text-transform: uppercase; }
    #floatingBagPanel .btn-small.use { background:#e67e22; color:#fff; box-shadow: 0 3px 0 #d35400; }
    #floatingBagPanel .btn-small.item { background:#f1c40f; color:#111; }
    #floatingBagPanel .close-x { position:absolute; right:10px; top:10px; background:transparent; border:none; color:#e74c3c; font-weight:900; cursor:pointer; font-size: 1.2rem; }
    .floating-bag-button { position: fixed; right: 20px; bottom: 100px; z-index: 75; width:55px; height:55px; border-radius:50%; background: linear-gradient(135deg, #f39c12, #e67e22); border: 2px solid #fff; display:flex; align-items:center; justify-content:center; font-size: 24px; box-shadow:0 8px 25px rgba(0,0,0,0.6); cursor:pointer; transition: transform 0.2s; }
    .floating-bag-button:active { transform: scale(0.9); }
    .floating-hud-money { position: fixed; right: 20px; bottom: 165px; z-index: 75; color:#f1c40f; font-family:'Press Start 2P'; font-size:12px; text-align:center; text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; }
    .deploy-ball { position: absolute; width: 24px; height: 24px; background-image: url('/uploads/catchcube.gif'); background-size: contain; background-repeat: no-repeat; z-index: 100; pointer-events: none; }
</style>
</head>
<body>
    <div id="global-loader">
        <div class="spinner"></div>
        <div class="loading-text">PREPARANDO ARENA...</div>
    </div>

    <div class="arena">
        <div class="flash-overlay" id="flashOverlay"></div>
        <div class="status-msg" id="statusMsg" style="display:none; position:absolute; top:50%; width:100%; text-align:center; color:#fff; font-family:'Press Start 2P'; font-size:0.8rem; text-shadow:2px 2px 0 #000; z-index:500;">Aguardando...</div>
        <% if(isSpectator) { %> <div class="spectator-banner">MODO ESPECTADOR - APENAS OBSERVANDO</div> <% } %>

        <div class="hud-panel hud-p1">
            <div class="poke-name"><span id="p1-name"><%= p1.name %></span> <span class="poke-lv">Lv.<span id="p1-lv"><%= p1.level %></span></span></div>
            <div class="trainer-sub"><%= p1.playerName || 'Voc√™' %></div>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-p1"></div></div>
            <div class="stat-text"><span id="hp-val-p1"><%= p1.hp %></span>/<span id="max-hp-p1"><%= p1.maxHp %></span></div>
            <% if(!isSpectator) { %>
                <div class="bar-container" style="height:5px; margin-top:4px; border-color:#555;"><div class="en-fill" id="en-bar-p1"></div></div>
                <div class="stat-text" style="color:#f1c40f; font-size:0.5rem;">EN: <span id="en-val-p1"><%= p1.energy %></span></div>
            <% } %>
        </div>

        <div class="hud-panel hud-p2">
            <div class="poke-name"><span id="p2-name"><%= p2.name %></span> <span class="poke-lv">Lv.<span id="p2-lv"><%= p2.level %></span></span></div>
            <% if(battleMode !== 'wild') { %> <div class="trainer-sub"><%= p2.playerName || 'Oponente' %></div>
            <% } else { %> <div class="trainer-sub">Selvagem</div> <% } %>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-p2"></div></div>
            <div class="stat-text" style="text-align:right"><span id="hp-val-p2"><%= p2.hp %></span>/<span id="max-hp-p2"><%= p2.maxHp %></span></div>
        </div>

        <div class="fighter p2-position" id="fighter-p2">
            <div class="command-bubble" id="bubble-p2"></div>
            <div class="trainer" id="trainer-p2" 
                 data-skin="<%= p2.skin || 'char1' %>" 
                 style="<%= (p2.isCustomSkin || (p2.skin && (p2.skin.startsWith('http') || p2.skin.startsWith('data:')))) ? 'background-image: url(\'' + p2.skin + '\')' : '' %><%= battleMode === 'wild' ? ';opacity:0;' : '' %>">
            </div>
            <div class="sprite" id="sprite-p2">
                <img src="<%= (p2.sprite.startsWith('http') || p2.sprite.startsWith('data:')) ? p2.sprite : '/uploads/' + p2.sprite %>">
            </div>
        </div>

        <div class="fighter p1-position" id="fighter-p1">
            <div class="command-bubble" id="bubble-p1"></div>
            <div class="trainer" id="trainer-p1" data-skin="<%= p1.skin %>"></div>
            <div class="sprite" id="sprite-p1">
                <img src="<%= (p1.sprite.startsWith('http') || p1.sprite.startsWith('data:')) ? p1.sprite : '/uploads/' + p1.sprite %>">
            </div>
        </div>

        <% if(battleMode === 'wild') { %>
            <div id="floatingBagBtn">
                <div id="floatingBagIcon" class="floating-bag-button" onclick="openBattleBag()">üéí</div>
                <div id="hud-money" class="floating-hud-money">0</div>
            </div>
        <% } %>

        <div id="overlay">
            <div id="result-content">
                <h1 id="result-title">RESULTADO</h1>
                <div class="podium">
                    <div class="winner-box">
                        <div class="crown">üëë</div>
                        <div class="podium-avatar-group">
                            <img id="win-mon-img" class="podium-monster" src="">
                            <div id="win-trainer-div" class="podium-trainer"></div>
                        </div>
                        <div class="podium-base"></div>
                        <div class="name-tag" id="win-name"></div>
                    </div>
                    <div class="loser-box">
                        <div class="podium-avatar-group">
                            <img id="lose-mon-img" class="podium-monster" src="">
                            <div id="lose-trainer-div" class="podium-trainer"></div>
                        </div>
                        <div class="podium-base"></div>
                        <div class="name-tag" id="lose-name"></div>
                    </div>
                </div>
                <button type="button" class="btn-restart" onclick="window.location.href='<%= returnUrl %>'">VOLTAR AO JOGO</button>
            </div>
        </div>
    </div>

    <% if(isSpectator) { %>
        <div id="bleachers"></div>
        <div id="chat-container">
            <input type="text" id="chatInput" placeholder="Chat..." style="width:80%; padding:10px;">
            <button id="chatSend">OK</button>
        </div>
    <% } else { %>
        <div class="bottom-panel">
            <% if (battleMode === 'online' || battleMode === 'manual' || battleMode === 'wild') { %>
                <div class="controls-panel" id="controlsPanel">
                    <% if (battleMode === 'wild') { %>
                        <button class="move-btn" style="background:linear-gradient(180deg, #e67e22, #d35400); border-color:#a04000" onclick="sendAction('catch')">
                            <strong><img src="/uploads/catchcube.gif" style="width:20px; height:20px; vertical-align:middle; margin-right:5px;"> Capturar</strong>
                        </button>
                        <button class="move-btn" style="background:linear-gradient(180deg, #95a5a6, #7f8c8d); border-color:#505a5b" onclick="sendAction('run')"><strong>üèÉ Fugir</strong></button>
                    <% } %>
                    <div id="moves-container" style="display:contents;">
                        <% p1.moves.forEach(move => { %>
                            <button class="move-btn" onclick="sendAction('move', '<%= move.id %>')" id="btn-<%= move.id %>">
                                <strong><%= move.icon %> <%= move.name %></strong>
                                <small><%= move.cost %> EN</small>
                            </button>
                        <% }) %>
                    </div>
                    <button class="move-btn rest-btn" onclick="sendAction('move', 'rest')">üí§ Descansar (+5 EN)</button>
                </div>
            <% } else { %>
                <div class="battle-log" id="logBox"></div>
            <% } %>
        </div>
    <% } %>

    <div id="switchModal">
        <div class="switch-box">
            <div class="switch-title" id="switchTitle">SEU POK√âMON DESMAIOU!<br>Escolha outro ou desista.</div>
            <div id="switchList" style="text-align:left;"></div>
            <button class="btn-restart" style="background:linear-gradient(180deg, #e74c3c, #c0392b); margin-top:20px; width:100%; box-shadow:none; border:2px solid #900;" onclick="forfeitBattle()">DESISTIR DA BATALHA</button>
        </div>
    </div>

    <div id="floatingBagPanel" aria-hidden="true">
        <button class="close-x" aria-label="Fechar" onclick="closeBattleBag()">‚úï</button>
        <h4>MOCHILA</h4>
        <div id="battleBagContent">Carregando...</div>
    </div>

    <script>
        history.pushState(null, null, location.href); window.onpopstate = function () { history.go(1); }; window.onpageshow = function(event) { if (event.persisted) { window.location.reload(); } };
        
        const socket = io();
        const battleMode = "<%= battleMode %>";
        const battleId = "<%= battleId %>";
        const initialData = <%- battleData %>;
        const myRoleId = "<%= myRoleId %>"; 
        const realUserId = "<%= realUserId %>"; 
        const isSpectator = <%= isSpectator ? 'true' : 'false' %>;
        const returnUrl = "<%- returnUrl %>"; 
        
        let p1RawId = "<%= p1.instanceId %>"; 
        let p2RawId = "<%= p2.instanceId %>";
        let p1Mon = "<%= p1.name %>"; 
        let p2Mon = "<%= p2.name %>";
        
        let p1CurHp = Number(<%= p1.hp %>); 
        let p2CurHp = Number(<%= p2.hp %>);
        let p1MaxHp = Number(<%= p1.maxHp %>);
        let p2MaxHp = Number(<%= p2.maxHp %>);

        let currentEnergy = parseInt("<%= p1.energy %>");
        let canAct = true; 
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        function resolveImg(src) { return (src.startsWith('http') || src.startsWith('data:')) ? src : '/uploads/' + src; }

        let p1Data = { name: "<%= p1.playerName %>", skin: "<%= p1.skin %>", sprite: resolveImg("<%= p1.sprite %>"), mon: "<%= p1.name %>" };
        let p2Data = { name: "<%= p2.playerName %>", skin: "<%= p2.skin %>", sprite: resolveImg("<%= p2.sprite %>"), mon: "<%= p2.name %>", isCustom: <%= p2.isCustomSkin ? 'true' : 'false' %> };

        if (isSpectator) { socket.emit('join_spectator', { roomId: battleId }); }
        if(battleMode === 'online' && !isSpectator) { socket.emit('join_room', battleId); }

        function getSide(actorId) {
            const aid = String(actorId || '');
            if (aid === String(p1RawId)) return 'p1';
            if (aid === String(p2RawId)) return 'p2';
            if (aid.startsWith('wild_') || aid.startsWith('npc_')) return 'p2';
            return 'p1';
        }

        async function speak(actorId, moveName) {
            const side = getSide(actorId);
            const bubble = document.getElementById(`bubble-${side}`);
            const trainer = document.getElementById(`trainer-${side}`);
            const monName = (side === 'p1') ? p1Mon : p2Mon;
            if(bubble) {
                bubble.innerText = (moveName === 'rest') ? `${monName}, volte!` : `${monName}, ${moveName}!`;
                bubble.classList.add('show');
            }
            if(trainer) { animateTrainerCommand(trainer).catch(()=>{}); }
            await wait(1000); 
            if(bubble) bubble.classList.remove('show');
        }

        async function animateTrainerCommand(trainerEl) {
            try {
                trainerEl.classList.add('frame-1'); await wait(180);
                trainerEl.classList.remove('frame-1'); await wait(120);
                trainerEl.classList.add('frame-1'); await wait(180);
                trainerEl.classList.remove('frame-1');
            } catch (e) {}
        }
        
        async function animateThrow(trainerEl) {
            if (!trainerEl) return;
            trainerEl.classList.add('frame-1');
            await wait(250); 
            trainerEl.classList.remove('frame-1'); 
        }

        async function returnPokemon(side) {
            const fighterDiv = document.getElementById(`fighter-${side}`);
            const spriteImg = document.querySelector(`#sprite-${side} img`);
            const trainer = document.getElementById(`trainer-${side}`);
            const sprite = document.getElementById(`sprite-${side}`);
            
            if(!spriteImg || !fighterDiv || !trainer || !sprite) return;

            if (side === 'p2' && battleMode === 'wild') {
                spriteImg.classList.add('anim-faint-wild');
                await wait(1000);
                return;
            }

            spriteImg.style.opacity = ''; spriteImg.style.transform = '';
            void spriteImg.offsetWidth;
            spriteImg.classList.add('anim-recall'); 
            
            await wait(600);

            const ball = document.createElement('div'); ball.className = 'deploy-ball';
            fighterDiv.appendChild(ball);

            const tRect = trainer.getBoundingClientRect(); const mRect = sprite.getBoundingClientRect(); const fRect = fighterDiv.getBoundingClientRect();
            const startX = (mRect.left - fRect.left) + (mRect.width / 2) - 10;
            const startY = (mRect.top - fRect.top) + (mRect.height / 2) + 20;
            const handOffsetX = (side === 'p1') ? (tRect.width * 0.8) : (tRect.width * 0.2);
            const endX = (tRect.left - fRect.left) + handOffsetX;
            const endY = (tRect.top - fRect.top) + (tRect.height * 0.5);

            ball.style.left = startX + 'px'; ball.style.top = startY + 'px';

            const deltaX = endX - startX; const deltaY = endY - startY;
            await ball.animate([{ transform: 'translate(0,0) scale(0.6)', opacity: 1 }, { transform: `translate(${deltaX * 0.5}px, ${deltaY - 30}px) scale(0.6)`, offset: 0.5 }, { transform: `translate(${deltaX}px, ${deltaY}px) scale(0)`, opacity: 0 }], { duration: 550, easing: 'ease-in-out', fill: 'forwards' }).finished;
            ball.remove();
        }

        // --- FUN√á√ÉO DE DEPLOY ROBUSTA ---
        async function deployPokemon(side, isWild = false) {
            const fighterDiv = document.getElementById(`fighter-${side}`);
            const spriteDiv = document.getElementById(`sprite-${side}`);
            const spriteImg = spriteDiv ? spriteDiv.querySelector('img') : null;
            const trainerDiv = document.getElementById(`trainer-${side}`);

            if (!spriteImg || !fighterDiv) return;

            try {
                // Limpa estados anteriores
                spriteImg.classList.remove('anim-pop-out', 'anim-wild-appear', 'anim-recall', 'anim-faint-wild');
                spriteImg.style.opacity = '0'; 
                spriteImg.style.filter = ''; spriteImg.style.transform = '';

                if (isWild) {
                    await wait(300);
                    spriteImg.classList.add('anim-wild-appear');
                    // Garante visibilidade no pr√≥ximo frame
                    requestAnimationFrame(() => spriteImg.style.opacity = '1'); 
                    return;
                }

                if (trainerDiv) animateThrow(trainerDiv);
                await wait(200);

                const ball = document.createElement('div'); ball.className = 'deploy-ball';
                fighterDiv.appendChild(ball);

                const tRect = trainerDiv.getBoundingClientRect(); const mRect = spriteDiv.getBoundingClientRect(); const fRect = fighterDiv.getBoundingClientRect();
                const handOffsetX = (side === 'p1') ? (tRect.width * 0.8) : (tRect.width * 0.2);
                let startX = (tRect.left - fRect.left) + handOffsetX; 
                let startY = (tRect.top - fRect.top) + (tRect.height * 0.5);
                let endX = (mRect.left - fRect.left) + (mRect.width / 2) - 10;
                let endY = (mRect.top - fRect.top) + (mRect.height / 2) + 20;

                ball.style.left = startX + 'px'; ball.style.top = startY + 'px';
                await wait(50);

                const deltaX = endX - startX; const deltaY = endY - startY;
                
                // Anima√ß√£o da pokebola com tratamento de erro (caso falhe, n√£o para o script)
                try {
                    await ball.animate([{ transform: 'translate(0, 0) scale(0.5)' }, { transform: `translate(${deltaX * 0.5}px, ${deltaY - 80}px) scale(0.8)`, offset: 0.5 }, { transform: `translate(${deltaX}px, ${deltaY}px) scale(0.6)` }], { duration: 450, easing: 'linear', fill: 'forwards' }).finished;
                } catch(e) {}
                
                ball.remove();
                
                createImpact(side, 'effect-normal', endX + 40, endY + 40); 
                spriteImg.classList.add('anim-pop-out');
            
            } catch(e) {
                console.error("Erro na anima√ß√£o deploy", e);
            } finally {
                // GARANTIA FINAL: Se algo der errado, torna o pokemon vis√≠vel
                setTimeout(() => { 
                    if(spriteImg) spriteImg.style.opacity = '1'; 
                }, 50);
            }
        }

        function createProjectile(fromSide, toSide, cssClass) {
            const fromEl = document.getElementById(`sprite-${fromSide}`);
            const toEl = document.getElementById(`sprite-${toSide}`);
            if(!fromEl || !toEl) return;
            const rf = fromEl.getBoundingClientRect(); const rt = toEl.getBoundingClientRect();
            const sX = rf.left + rf.width / 2, sY = rf.top + rf.height / 2;
            const eX = rt.left + rt.width / 2, eY = rt.top + rt.height / 2;
            const part = document.createElement('div'); part.className = `atk-particle ${cssClass}`;
            part.style.left = sX + 'px'; part.style.top = sY + 'px';
            part.style.setProperty('--tx', (eX - sX) + 'px'); part.style.setProperty('--ty', (eY - sY) + 'px');
            document.body.appendChild(part); setTimeout(() => part.remove(), 500);
        }

        function createImpact(targetSide, cssClass, customX = null, customY = null) {
            const toEl = document.getElementById(`sprite-${targetSide}`);
            const fighterDiv = document.getElementById(`fighter-${targetSide}`);
            if(!toEl && !fighterDiv) return;

            const impact = document.createElement('div'); impact.className = `impact-effect impact-pop ${cssClass}`;
            
            if (customX !== null && customY !== null && fighterDiv) {
                impact.style.left = (customX - 40) + 'px'; impact.style.top = (customY - 40) + 'px'; fighterDiv.appendChild(impact);
            } else {
                const r = toEl.getBoundingClientRect();
                impact.style.left = (r.left + r.width/2 - 40) + 'px'; impact.style.top = (r.top + r.height/2 - 40) + 'px';
                document.body.appendChild(impact);
            }
            setTimeout(() => impact.remove(), 400);
        }

        function playMoveAnimation(attackerSide, defenderSide, type, category, moveType) {
            try { console.debug('[Anim]', { attackerSide, defenderSide, type }); } catch(e) {}
            const atkSprite = document.getElementById(`sprite-${attackerSide}`);
            const defSprite = document.getElementById(`sprite-${defenderSide}`);
            if(!atkSprite) return;
            const atkImg = atkSprite.querySelector('img');
            const defImg = defSprite ? defSprite.querySelector('img') : null;
            if(atkImg) {
                atkImg.classList.remove('attack','hurt','shake');
                atkImg.classList.add('attack');
                setTimeout(() => { try { if(atkImg) atkImg.classList.remove('attack'); } catch(e){} }, 360);
            }
            if (category === 'special') {
                const elemClass = `effect-${(type || 'normal').toLowerCase()}`;
                setTimeout(() => { createProjectile(attackerSide, defenderSide, elemClass); }, 100);
            }
            if(defImg) {
                setTimeout(() => {
                    try {
                        if(!defImg) return;
                        defImg.classList.remove('hurt','shake');
                        defImg.classList.add('shake'); 
                        setTimeout(() => { try { if(defImg) { defImg.classList.remove('shake'); } } catch(e){} }, 420);
                    } catch(e) {}
                }, 220);
            }
        }

        function updateBar(actorId, cur, max, type) { 
            const side = getSide(actorId);
            const pct = Math.max(0, (cur / max) * 100); 
            const fill = document.getElementById(`${type}-bar-${side}`); 
            if(fill) {
                fill.style.width = pct + '%'; 
                if(type === 'hp') {
                    const txt = document.getElementById(`hp-val-${side}`);
                    const maxTxt = document.getElementById(`max-hp-${side}`); 
                    if(txt) txt.innerText = Math.max(0, cur);
                    if(maxTxt) maxTxt.innerText = max;
                }
            }
            if(type === 'hp') { if(side === 'p1') p1CurHp = Number(cur); else p2CurHp = Number(cur); }
            if(type === 'en' && side === 'p1' && !isSpectator) { currentEnergy = cur; document.getElementById('en-val-p1').innerText = cur; updateButtons(); } 
        }

        function updateButtons() { 
            if(isSpectator) return; 
            document.querySelectorAll('.move-btn:not(.rest-btn)').forEach(btn => { 
                const small = btn.querySelector('small');
                if(small) { const cost = parseInt(small.innerText); btn.disabled = (currentEnergy < cost); }
            }); 
        }
        
        function setControlsState(enabled) { 
            if(isSpectator) return; 
            const panel = document.getElementById('controlsPanel'); if(!panel) return; 
            panel.style.opacity = enabled ? "1" : "0.5"; 
            const btns = panel.querySelectorAll('button'); btns.forEach(b => b.disabled = !enabled); 
            canAct = !!enabled;
            if(enabled) updateButtons(); 
        }
        
        async function playEvents(events) { 
            let lastMoveElement = 'normal';
            for (let evt of events) { 
                if (evt.type === 'INIT') continue; 
                const actorIdRaw = evt.actorId || evt.attackerId || evt.attacker || evt.actor || null;
                const targetIdRaw = evt.targetId || evt.target || evt.defenderId || evt.defender || null;

                if (evt.type === 'MSG') {
                    try { if(evt.text) showToast(evt.text); } catch(e) {}
                    const lb = document.getElementById('logBox'); if(lb) { const div = document.createElement('div'); div.className = 'log-entry'; div.innerText = evt.text; lb.appendChild(div); lb.scrollTop = lb.scrollHeight; }
                    await wait(200); continue;
                }
                const actorSide = getSide(actorIdRaw); const targetSide = getSide(targetIdRaw);

                if (evt.type === 'USE_MOVE') { 
                    lastMoveElement = evt.moveElement || 'normal';
                    if (battleMode === 'wild' && actorSide === 'p2') { await wait(500); } 
                    else { await speak(actorIdRaw, evt.moveName); }
                    playMoveAnimation(actorSide, targetSide, evt.moveElement || 'normal', evt.moveCategory, evt.moveType);
                    if(!isSpectator && actorSide === 'p1') updateBar(actorIdRaw, evt.newEnergy, <%= p1.maxEnergy %>, 'en'); 
                    await wait(300); 
                } else if (evt.type === 'ATTACK_HIT') { 
                    createImpact(targetSide, `effect-${lastMoveElement.toLowerCase()}`);
                    const damageTxt = document.createElement('div'); damageTxt.className = 'floating-text damage-text'; damageTxt.innerText = evt.isBlocked ? 'üõ°Ô∏è' : `-${evt.damage}`;
                    const rX = (Math.random() * 40 - 20) + '%', rY = (Math.random() * 20 - 10) + '%';
                    damageTxt.style.transform = `translate(calc(-50% + ${rX}), calc(-50% + ${rY}))`;
                    document.getElementById(`fighter-${targetSide}`).appendChild(damageTxt);
                    if(evt.isEffective) { const t = document.createElement('div'); t.className = 'floating-text super-text'; t.innerText = "SUPER!"; t.style.marginTop = "30px"; document.getElementById(`fighter-${targetSide}`).appendChild(t); setTimeout(() => t.remove(), 1200); } 
                    await wait(500); damageTxt.remove();
                    const maxHp = (targetSide === 'p1') ? p1MaxHp : p2MaxHp; 
                    updateBar(targetIdRaw, evt.newHp, maxHp, 'hp'); 
                    if (evt.newHp <= 0) { await wait(200); await returnPokemon(targetSide); } await wait(500);
                } else if (evt.type === 'HEAL') { 
                    await speak(actorIdRaw, 'Cura'); updateBar(actorIdRaw, evt.newHp, (actorSide === 'p1' ? p1MaxHp : p2MaxHp), 'hp'); 
                    const txt = document.createElement('div'); txt.className = 'floating-text heal-text'; txt.innerText = `+${evt.amount}`; 
                    document.getElementById(`fighter-${actorSide}`).appendChild(txt); setTimeout(() => txt.remove(), 1000); await wait(500); 
                } 
                else if (evt.type === 'STATUS_DAMAGE') {
                    const fd = document.getElementById(`fighter-${targetSide}`);
                    const t = document.createElement('div'); t.className = 'floating-text status-text'; t.innerText = `-${evt.damage}`; fd.appendChild(t); setTimeout(() => t.remove(), 1000);
                    const maxHp = (targetSide === 'p1') ? p1MaxHp : p2MaxHp; 
                    updateBar(targetIdRaw, evt.newHp, maxHp, 'hp');
                    if (evt.newHp <= 0) { await wait(200); await returnPokemon(targetSide); } await wait(800);
                }
                else if (evt.type === 'REST') {
                    await speak(actorIdRaw, 'rest');
                    if(actorSide === 'p1' && !isSpectator) updateBar(actorIdRaw, evt.newEnergy, <%= p1.maxEnergy %>, 'en');
                    const txt = document.createElement('div'); txt.className = 'floating-text heal-text'; txt.innerText = `+5 EN`; txt.style.color = "#f1c40f";
                    document.getElementById(`fighter-${actorSide}`).appendChild(txt); setTimeout(() => txt.remove(), 1000); await wait(500);
                }
                else if (evt.type === 'SWITCH_ANIM') {
                    const side = (evt.side === 'p1') ? 'p1' : 'p2';
                    const bubble = document.getElementById(`bubble-${side}`);
                    if(bubble) {
                        bubble.innerText = `Volte! Vai ${evt.newName}!`;
                        bubble.classList.add('show');
                        setTimeout(() => bubble.classList.remove('show'), 1500);
                    }
                    await returnPokemon(side);
                    await wait(500);
                }
            } 
        }

        function playCaptureAnimation(targetId, isSuccessful) {
            return new Promise(async (resolve) => {
                try {
                    const side = getSide(targetId); const targetSprite = document.getElementById(`sprite-${side}`); const trainerEl = document.getElementById('trainer-p1');
                    if(!targetSprite || !trainerEl) { resolve(); return; }
                    const tRect = trainerEl.getBoundingClientRect(); const startX = tRect.left + (tRect.width * 0.8), startY = tRect.top + (tRect.height * 0.4);
                    const mRect = targetSprite.getBoundingClientRect(); const targetX = mRect.left + (mRect.width / 2) - 10, targetY = mRect.top + (mRect.height / 2) - 10;
                    animateThrow(trainerEl); await wait(150);
                    const ball = document.createElement('div'); ball.className = 'catchball'; ball.style.left = startX + 'px'; ball.style.top = startY + 'px'; document.body.appendChild(ball);
                    const deltaX = targetX - startX, deltaY = targetY - startY;
                    
                    await ball.animate([
                        { transform: `translate(0, 0) rotate(0deg) scale(0.6)` }, 
                        { transform: `translate(${deltaX * 0.6}px, ${deltaY - 150}px) rotate(360deg) scale(0.7)`, offset: 0.6 }, 
                        { transform: `translate(${deltaX}px, ${deltaY}px) rotate(720deg) scale(0.6)` }
                    ], { duration: 600, easing: 'cubic-bezier(0.2, 0.6, 0.4, 1)', fill: 'forwards' }).finished;

                    if (!isSuccessful) {
                        const bounceAnim = ball.animate([{ transform: `translate(${deltaX}px, ${deltaY}px) rotate(720deg) scale(0.6)`, opacity: 1 }, { transform: `translate(${deltaX - 80}px, ${deltaY - 100}px) rotate(600deg) scale(0.6)`, opacity: 0 }], { duration: 450, easing: 'ease-out', fill: 'forwards' });
                        targetSprite.style.filter = "brightness(2) sepia(1) hue-rotate(-50deg) saturate(5)"; setTimeout(() => targetSprite.style.filter = "", 150);
                        await bounceAnim.finished; ball.remove(); resolve(); return;
                    }

                    const flash = document.getElementById('flashOverlay'); if(flash) flash.classList.add('active'); setTimeout(() => flash && flash.classList.remove('active'), 150);
                    targetSprite.classList.add('absorbed-state'); await wait(200);
                    const groundY = mRect.bottom - 50; const dropDistY = groundY - targetY; 
                    
                    await ball.animate([
                        { transform: `translate(${deltaX}px, ${deltaY}px) rotate(720deg) scale(0.6)` }, 
                        { transform: `translate(${deltaX}px, ${deltaY + dropDistY}px) rotate(720deg) scale(0.6)` }
                    ], { duration: 350, easing: 'ease-in', fill: 'forwards' }).finished;
                    
                    const finalTX = deltaX;
                    const finalTY = deltaY + dropDistY;

                    const sf = [
                        { transform: `translate(${finalTX}px, ${finalTY}px) scale(0.6) rotate(0deg)` }, 
                        { transform: `translate(${finalTX}px, ${finalTY}px) scale(0.6) rotate(-25deg)`, offset: 0.25 }, 
                        { transform: `translate(${finalTX}px, ${finalTY}px) scale(0.6) rotate(25deg)`, offset: 0.75 }, 
                        { transform: `translate(${finalTX}px, ${finalTY}px) scale(0.6) rotate(0deg)` }
                    ];
                    
                    await ball.animate(sf, { duration: 400 }).finished; await wait(500); 
                    await ball.animate(sf, { duration: 400 }).finished; await wait(500); 
                    await ball.animate(sf, { duration: 400 }).finished; await wait(500); 
                    
                    ball.classList.add('captured-lock');
                    
                    const ballVisualX = startX + finalTX;
                    const ballVisualY = startY + finalTY;

                    for(let i=0; i<3; i++) { 
                        const s = document.createElement('div'); 
                        s.className = 'capture-star'; 
                        s.innerText = '‚òÖ'; 
                        s.style.left = (ballVisualX + 10 + (i*15 - 15)) + 'px'; 
                        s.style.top = (ballVisualY - 20) + 'px'; 
                        document.body.appendChild(s); 
                        setTimeout(() => s.remove(), 700); 
                        await wait(100); 
                    }
                    await wait(800); resolve();

                } catch (e) { console.error(e); resolve(); }
            });
        }

        async function sendAction(type, moveId) { 
            if (!canAct) return; 
            setControlsState(false); 
            if (battleMode === 'online') { 
                if (type === 'move') { 
                    document.getElementById('statusMsg').innerText = "Aguardando oponente..."; 
                    document.getElementById('statusMsg').style.display = "block"; 
                    socket.emit('online_action', { roomId: battleId, action: 'move', value: moveId, playerId: realUserId }); 
                } 
            } else { 
                const res = await fetch('/api/turn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ battleId, action: type, moveId }) }); 
                const data = await res.json(); 
                
                if (data.switched) {
                    if (data.p2Switched) {
                        if (data.events) await playEvents(data.events);
                        await wait(500);
                        p2RawId = data.p2State.instanceId;
                        p2Mon = data.p2State.name;
                        p2CurHp = data.p2State.hp;
                        p2MaxHp = data.p2State.maxHp;
                        p2Data.name = data.p2State.playerName;
                        p2Data.sprite = resolveImg(data.p2State.sprite);
                        p2Data.mon = data.p2State.name;
                        p2Data.skin = data.p2State.skin;
                        document.getElementById('p2-name').innerText = p2Mon;
                        document.getElementById('p2-lv').innerText = data.p2State.level;
                        document.getElementById('max-hp-p2').innerText = p2MaxHp;
                        const s2 = document.querySelector('#sprite-p2 img');
                        s2.src = resolveImg(data.p2State.sprite);
                        deployPokemon('p2', false);
                        updateBar(p2RawId, p2CurHp, p2MaxHp, 'hp');
                    } else {
                        await wait(500);
                        p1RawId = data.newP1Id; 
                        p1Mon = data.p1State.name; 
                        p1CurHp = data.p1State.hp; 
                        p1MaxHp = data.p1State.maxHp; 
                        currentEnergy = data.p1State.energy;
                        document.getElementById('p1-name').innerText = p1Mon; 
                        document.getElementById('p1-lv').innerText = data.p1State.level; 
                        document.getElementById('max-hp-p1').innerText = data.p1State.maxHp;
                        document.querySelector('#sprite-p1 img').src = resolveImg(data.p1State.sprite); 
                        deployPokemon('p1', false); 
                        updateBar(p1RawId, p1CurHp, data.p1State.maxHp, 'hp'); 
                        updateBar(p1RawId, currentEnergy, 100, 'en'); 
                        const mc = document.getElementById('moves-container'); mc.innerHTML = ''; 
                        data.p1State.moves.forEach(move => { 
                            const btn = document.createElement('button'); btn.className = 'move-btn'; 
                            btn.onclick = () => sendAction('move', move.id); 
                            btn.innerHTML = `<strong>${move.icon} ${move.name}</strong><small>${move.cost} EN</small>`; 
                            mc.appendChild(btn); 
                        });
                        if (data.events) await playEvents(data.events); 
                    }
                    setControlsState(true); 
                    return; 
                }

                if (type === 'catch' && data && data.threw) await playCaptureAnimation(p2RawId, data.captured);
                if (data.events) await playEvents(data.events); 
                if (data.forceSwitch) { showSwitchModal(data.switchable); return; }
                if(data.captured) { showToast('Capturado!'); setTimeout(() => { window.location.href = returnUrl; }, 1000); return; }
                else if (data.fled) { showToast("Fugiu!"); window.location.href = returnUrl; } 
                else if(data.finished) { endGame(data.winnerId); } 
                else { 
                    if (data.p1State) {
                        updateBar(p1RawId, data.p1State.hp, p1MaxHp, 'hp'); 
                        if(data.p1State.energy !== undefined) {
                            updateBar(p1RawId, data.p1State.energy, <%= p1.maxEnergy %>, 'en');
                        }
                    }
                    if (data.p2State) updateBar(p2RawId, data.p2State.hp, p2MaxHp, 'hp'); 
                    setControlsState(true); 
                } 
            } 
        }

        function showSwitchModal(list) {
            const modal = document.getElementById('switchModal');
            const listDiv = document.getElementById('switchList');
            listDiv.innerHTML = '';
            
            list.forEach(p => {
                const item = document.createElement('div');
                item.className = 'switch-item';
                item.innerHTML = `<img src="${resolveImg(p.sprite)}" class="switch-sprite"> <div><div style="color:#f1c40f;font-weight:bold;">${p.name} <span style="font-size:0.7rem;color:#ccc">Lv.${p.level}</span></div><div style="font-size:0.7rem;">HP: ${p.hp}/${p.maxHp}</div></div>`;
                item.onclick = () => performSwitch(p.instanceId, true);
                listDiv.appendChild(item);
            });
            modal.style.display = 'flex';
        }

        async function performSwitch(newPokeId, isForced = false) {
            document.getElementById('switchModal').style.display = 'none';
            
            if (battleMode === 'online') {
                socket.emit('online_action', { 
                    roomId: battleId, 
                    action: 'switch', 
                    value: newPokeId, 
                    playerId: realUserId 
                });
                document.getElementById('statusMsg').innerText = "Trocando..."; 
                document.getElementById('statusMsg').style.display = "block";
            } else {
                const res = await fetch('/api/turn', { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ battleId, action: 'switch', moveId: newPokeId, isForced }) 
                }); 
                const data = await res.json();
                
                if (data.switched) {
                    await wait(500);
                    p1RawId = data.newP1Id; p1Mon = data.p1State.name; p1CurHp = data.p1State.hp; p1MaxHp = data.p1State.maxHp; currentEnergy = data.p1State.energy;
                    document.getElementById('p1-name').innerText = p1Mon; document.getElementById('p1-lv').innerText = data.p1State.level; document.getElementById('max-hp-p1').innerText = data.p1State.maxHp;
                    document.querySelector('#sprite-p1 img').src = resolveImg(data.p1State.sprite); 
                    deployPokemon('p1', false); 
                    updateBar(p1RawId, p1CurHp, data.p1State.maxHp, 'hp'); updateBar(p1RawId, currentEnergy, 100, 'en'); 
                    const mc = document.getElementById('moves-container'); mc.innerHTML = ''; 
                    data.p1State.moves.forEach(move => { 
                        const btn = document.createElement('button'); btn.className = 'move-btn'; 
                        btn.onclick = () => sendAction('move', move.id); 
                        btn.innerHTML = `<strong>${move.icon} ${move.name}</strong><small>${move.cost} EN</small>`; 
                        mc.appendChild(btn); 
                    });
                    if (data.events) await playEvents(data.events); 
                    setControlsState(true);
                }
            }
        }

        function forfeitBattle() {
            document.getElementById('switchModal').style.display = 'none';
            if (battleMode === 'online') {
                socket.emit('online_action', { 
                    roomId: battleId, 
                    action: 'forfeit', 
                    playerId: realUserId 
                });
            } else {
                endGame(p2RawId); 
            }
        }

        let __battleEnded = false;
        function endGame(winnerId) { 
            if (__battleEnded) return;
            __battleEnded = true;
            if (battleMode === 'wild') { showToast("Batalha finalizada!"); window.location.href = returnUrl; return; }

            const bottomPanel = document.querySelector('.bottom-panel'); if(bottomPanel) bottomPanel.style.display = 'none'; 
            const overlay = document.getElementById('overlay'); 
            const title = document.getElementById('result-title'); 
            const winName = document.getElementById('win-name'); const loseName = document.getElementById('lose-name'); 
            const winTrainer = document.getElementById('win-trainer-div'); const loseTrainer = document.getElementById('lose-trainer-div');
            const winMon = document.getElementById('win-mon-img'); const loseMon = document.getElementById('lose-mon-img'); 
            
            let isP1Win = false;
            if (battleMode === 'online') { isP1Win = (String(winnerId) === String(realUserId)); } 
            else { isP1Win = (String(winnerId) === String(p1RawId)); }

            const winner = isP1Win ? p1Data : p2Data; const loser = isP1Win ? p2Data : p1Data; 
            winName.innerText = winner.name; loseName.innerText = loser.name; 
            winMon.src = winner.sprite; loseMon.src = loser.sprite; 
            
            if(winner.isCustom || (winner.skin && winner.skin.startsWith('data:'))) winTrainer.style.backgroundImage = `url('${winner.skin}')`; else winTrainer.style.backgroundImage = `url('/uploads/${winner.skin}.png')`;
            if(loser.isCustom || (loser.skin && loser.skin.startsWith('data:'))) loseTrainer.style.backgroundImage = `url('${loser.skin}')`; else loseTrainer.style.backgroundImage = `url('/uploads/${loser.skin}.png')`;
            
            if (isSpectator) { title.innerText = `VENCEDOR: ${winner.name}`; title.style.color = "#f1c40f"; } 
            else { 
                if (winnerId === 'draw') { title.innerText = "EMPATE!"; title.style.color = "#fff"; } 
                else if (isP1Win) { title.innerText = "VIT√ìRIA!"; title.style.color = "#2ecc71"; } 
                else { title.innerText = "DERROTA..."; title.style.color = "#e74c3c"; } 
            } 
            overlay.style.display = 'flex'; 
        }

        socket.on('turn_result', async (data) => { 
            document.getElementById('statusMsg').style.display = "none"; 
            await playEvents(data.events); 
            
            if (data.switched) { 
                let newState = data.p1State || data.p2State; 
                if (data.p2Switched) newState = data.p2State; 
                else if (data.p1State) newState = data.p1State; 

                const switchedUserId = newState.userId || ''; 
                const iAmSwitching = (String(switchedUserId) === String(realUserId));

                if (!iAmSwitching) {
                    if (data.events) await playEvents(data.events);
                    await wait(500);
                    
                    p2RawId = newState.instanceId;
                    p2Mon = newState.name;
                    p2CurHp = newState.hp;
                    p2MaxHp = newState.maxHp;
                    p2Data.name = newState.playerName;
                    p2Data.sprite = resolveImg(newState.sprite);
                    p2Data.mon = newState.name;
                    p2Data.skin = newState.skin;
                    
                    document.getElementById('p2-name').innerText = p2Mon;
                    document.getElementById('p2-lv').innerText = newState.level;
                    document.getElementById('max-hp-p2').innerText = p2MaxHp;
                    
                    const s2 = document.querySelector('#sprite-p2 img');
                    s2.src = resolveImg(newState.sprite);
                    
                    setTimeout(() => deployPokemon('p2', false), 50);
                    updateBar(p2RawId, p2CurHp, p2MaxHp, 'hp');
                } else {
                    await wait(500);
                    
                    p1RawId = newState.instanceId; 
                    p1Mon = newState.name; 
                    p1CurHp = newState.hp; 
                    p1MaxHp = newState.maxHp; 
                    currentEnergy = newState.energy;
                    
                    document.getElementById('p1-name').innerText = p1Mon; 
                    document.getElementById('p1-lv').innerText = newState.level; 
                    document.getElementById('max-hp-p1').innerText = newState.maxHp;
                    document.querySelector('#sprite-p1 img').src = resolveImg(newState.sprite); 
                    
                    setTimeout(() => deployPokemon('p1', false), 50);
                    updateBar(p1RawId, p1CurHp, newState.maxHp, 'hp'); 
                    updateBar(p1RawId, currentEnergy, 100, 'en'); 
                    
                    const mc = document.getElementById('moves-container'); mc.innerHTML = ''; 
                    newState.moves.forEach(move => { 
                        const btn = document.createElement('button'); btn.className = 'move-btn'; 
                        btn.onclick = () => sendAction('move', move.id); 
                        btn.innerHTML = `<strong>${move.icon} ${move.name}</strong><small>${move.cost} EN</small>`; 
                        mc.appendChild(btn); 
                    });
                    if (data.events) await playEvents(data.events); 
                }
                setControlsState(true); 
                return; 
            }

            if (data.forceSwitch) {
                if (data.forceSwitch.target === realUserId) {
                     const res = await fetch('/api/me?userId=' + realUserId);
                     const meData = await res.json();
                     const switchables = meData.team.filter(p => p.hp > 0 && p.instanceId !== p1RawId); 
                     showSwitchModal(switchables);
                     document.getElementById('switchTitle').innerText = "SEU POK√âMON DESMAIOU!";
                } else {
                    document.getElementById('statusMsg').innerText = "Oponente trocando...";
                    document.getElementById('statusMsg').style.display = "block";
                }
                return; 
            }

            if(data.winnerId) endGame(data.winnerId); 
            else if(!isSpectator) setControlsState(true); 
        });
        
        socket.on('opponent_ready', () => { if(!isSpectator) { document.getElementById('statusMsg').style.display = "block"; document.getElementById('statusMsg').innerText = "Oponente pronto!"; } });
        
        window.onload = async () => { 
            const loader = document.getElementById('global-loader');
            loader.style.opacity = '0';
            
            if(battleMode === 'online') { if(!isSpectator) socket.emit('join_room', battleId); } 
            
            updateBar(p1RawId, <%= p1.hp %>, <%= p1.maxHp %>, 'hp'); 
            updateBar(p2RawId, <%= p2.hp %>, <%= p2.maxHp %>, 'hp'); 
            if(!isSpectator) updateBar(p1RawId, <%= p1.energy %>, <%= p1.maxEnergy %>, 'en'); 
            
            await wait(100); 
            
            deployPokemon('p1', false);
            deployPokemon('p2', battleMode === 'wild');

            await wait(400);
            loader.style.display = 'none';

            if(battleMode === 'auto') { playEvents(initialData.log).then(() => endGame(initialData.winnerId)); } 
            else if (!isSpectator) { setControlsState(true); } 

            setTimeout(discoverSpriteAlts, 300);
        };

        (async function fetchInitialHud() { try { const res = await fetch('/api/me?userId=<%= realUserId %>'); const data = await res.json(); const hudMoneyEl = document.getElementById('hud-money'); if(hudMoneyEl) hudMoneyEl.innerText = data.money || 0; } catch(e) {} })();

        async function probeAlternate(src) {
            try {
                const url = new URL(src, window.location.origin);
                const path = url.pathname;
                const m = path.match(/(.+)\.(png|gif|jpg|jpeg)$/i);
                if(!m) return null;
                const base = m[1]; const ext = m[2];
                const candidates = [`${base}_atk.${ext}`, `${base}-atk.${ext}`, `${base}_1.${ext}`, `${base}-1.${ext}`];
                for (let c of candidates) {
                    try {
                        const res = await fetch(c, { method: 'HEAD' });
                        if (res && res.ok) return c;
                    } catch(e) {}
                }
            } catch(e) {}
            return null;
        }

        async function discoverSpriteAlts() {
            try {
                console.log("Tudo em ordem.")
            } catch(e){}
        }
        
        let __battleBagOutsideListener = null;
        function closeBattleBag() { const panel = document.getElementById('floatingBagPanel'); if(panel) panel.style.display = 'none'; if(__battleBagOutsideListener) { document.removeEventListener('click', __battleBagOutsideListener); __battleBagOutsideListener = null; } }
        async function openBattleBag() {
            const panel = document.getElementById('floatingBagPanel'); if(!panel) return;
            if(panel.style.display === 'block') { closeBattleBag(); return; }
            panel.style.display = 'block';
            const cont = document.getElementById('battleBagContent'); cont.innerHTML = 'Carregando...';
            try { const res = await fetch('/api/me?userId=<%= realUserId %>'); const data = await res.json(); const money = data.money || 0; const pokeballs = data.pokeballs || 0; const rareCandy = data.rareCandy || 0; const hudMoneyEl = document.getElementById('hud-money'); if(hudMoneyEl) hudMoneyEl.innerText = money; let html = `<div class="bag-row"><div class="bag-item">Catchballs<br><strong>${pokeballs}</strong></div><div class="bag-item">RareCandy<br><strong>${rareCandy}</strong></div></div>`; html += `<div class="bag-actions"><button class="btn-small use" onclick="useCatchballFromBag()">Usar Catchball</button></div>`; cont.innerHTML = html; } catch(e) { cont.innerHTML = 'Erro.'; }
            setTimeout(() => document.addEventListener('click', (ev) => { const p = document.getElementById('floatingBagPanel'); const b = document.getElementById('floatingBagIcon'); if(p && !p.contains(ev.target) && b && !b.contains(ev.target)) closeBattleBag(); }), 50);
        }
        async function useCatchballFromBag() {
            if (battleMode !== 'wild') { showToast('Apenas em batalhas selvagens.'); return; }
            if(!confirm('Usar uma Catchball agora?')) return; 
            try { 
                const res = await fetch('/api/turn', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ battleId, action: 'catch' }) }); 
                const data = await res.json(); 
                
                if (data && data.threw) await playCaptureAnimation(p2RawId, data.captured);

                if(data.events) await playEvents(data.events); 
                
                if(data.captured) { 
                    if(data.sentToPC) showToast('Enviado para o PC!');
                    else showToast('Capturado!');
                    setTimeout(()=>{ window.location.href = returnUrl; }, 1000); 
                    return; 
                } 
                closeBattleBag(); 
            } catch(e) { showToast('Erro.'); }
        }
    </script>
</body>
</html>
