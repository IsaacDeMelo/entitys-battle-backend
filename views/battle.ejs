<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Batalha</title>
    <!-- PRELOAD DA BOLA -->
    <link rel="preload" as="image" href="/uploads/catchcube.gif">
    
    <script src="/socket.io/socket.io.js"></script>
    <script src="/scripts/common.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #202020; --hp-high: #4fd05c; --hp-mid: #f6b93b; --hp-low: #e55039; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }
        
        /* LOADER */
        #global-loader { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255, 255, 255, 0.1); border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        .loading-text { font-family: 'Press Start 2P', cursive; font-size: 0.8rem; color: #f1c40f; animation: pulse 1.5s infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .arena { flex: 1; background: url('/uploads/<%= bgImage %>') no-repeat center center; background-size: cover; position: relative; overflow: hidden; z-index: 10; image-rendering: pixelated; }
        
        /* HUD */
        .hud-panel { position: absolute; background: rgba(15, 15, 20, 0.95); padding: 6px 10px; border-radius: 6px; border: 2px solid #555; z-index: 30; width: 160px; font-family: 'Press Start 2P', cursive; bottom: 10px; top: auto; }
        .hud-p1 { left: 10px; border-left: 5px solid #3498db; text-align: left; }
        .hud-p2 { right: 10px; border-right: 5px solid #e74c3c; text-align: right; }
        .poke-name { font-size: 0.55rem; margin-bottom: 4px; color: #fff; text-shadow: 1px 1px 0 #000; text-transform: uppercase; letter-spacing: 0.5px; }
        .poke-lv { font-size: 0.45rem; color: #f1c40f; margin-left: 4px; }
        .trainer-sub { font-size: 0.45rem; color: #bbb; margin-bottom: 4px; text-transform: uppercase; font-family: sans-serif; font-weight: bold; }
        .bar-container { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; border: 1px solid #000; margin-bottom: 2px; position: relative; }
        .hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.5s ease-out; }
        .stat-text { font-size: 0.5rem; color: #ddd; text-shadow: 1px 1px 0 #000; display: block; }

        /* FIGHTERS */
        .fighter { position: absolute; width: 300px; height: 150px; display: flex; align-items: flex-end; z-index: 20; pointer-events: none; top: 42%; transform: translateY(-50%); transition: opacity 0.5s; }
        
        /* Z-INDEX FIX: Trainer (23) > Sprite (22) */
        .fighter.p2-position { right: 5%; justify-content: flex-end; }
        .fighter.p2-position .trainer { order: 2; margin-left: -30px; z-index: 23; background-position-y: 33.33%; } 
        .fighter.p2-position .sprite { order: 1; z-index: 22; }
        
        .fighter.p1-position { left: 5%; justify-content: flex-start; }
        .fighter.p1-position .trainer { order: 1; margin-right: -30px; z-index: 23; background-position-y: 66.66%; }
        .fighter.p1-position .sprite { order: 2; z-index: 22; transform: scaleX(-1); }

        /* SPRITES */
        .sprite { position: relative; width: 120px; height: 120px; transition: transform 0.2s; }
        .sprite img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); animation: breathe 3s infinite ease-in-out; opacity: 0; }
        
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }
        .sprite img.hurt { filter: brightness(1.6) saturate(1.1) sepia(0.15) hue-rotate(-10deg); }
        .sprite img.status-dmg { filter: brightness(0.8) sepia(1) hue-rotate(240deg) saturate(3); }

        /* TRAINER */
        .trainer { position: relative; width: 64px; height: 64px; background-size: 400% auto; image-rendering: pixelated; margin-bottom: 20px; top: 20px; }
        <% for(let i = 1; i <= 20; i++) { %> .trainer[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); } <% } %>
        .trainer[data-skin="char1"] { background-image: url('/uploads/char1.png'); }
        .trainer.frame-1 { background-position-x: -100%; }

        /* EFFECTS */
        .atk-particle { position: absolute; pointer-events: none; z-index: 2000; animation: particleFly 0.5s forwards; width: 20px; height: 20px; border-radius: 50%; }
        @keyframes particleFly { 0% { transform: translate(0,0) scale(0.5); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(1.5); opacity: 0; } }
        
        .impact-effect { position: absolute; width: 80px; height: 80px; z-index: 2000; pointer-events: none; border-radius: 50%; opacity: 0; }
        .impact-pop { animation: impactPop 0.4s forwards; }
        @keyframes impactPop { 0% { transform: scale(0.2); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.8; } 100% { transform: scale(1.8); opacity: 0; } }

        /* ELEMENTAL COLORS */
        .effect-fire { background: radial-gradient(circle, #f1c40f, #e74c3c); box-shadow: 0 0 10px #e67e22; }
        .effect-water { background: radial-gradient(circle, #3498db, #2980b9); box-shadow: 0 0 10px #3498db; }
        .effect-plant { background: radial-gradient(circle, #2ecc71, #27ae60); box-shadow: 0 0 10px #2ecc71; }
        .effect-normal { background: radial-gradient(circle, #fff, #bbb); box-shadow: 0 0 5px #fff; }
        .effect-electric { background: radial-gradient(circle, #f1c40f, #fff); box-shadow: 0 0 15px #f1c40f; }
        .effect-ice { background: radial-gradient(circle, #74b9ff, #fff); box-shadow: 0 0 15px #74b9ff; }
        .effect-poison { background: radial-gradient(circle, #8e44ad, #9b59b6); box-shadow: 0 0 10px #8e44ad; }
        .effect-ground { background: radial-gradient(circle, #d35400, #e67e22); box-shadow: 0 0 10px #d35400; }
        .effect-flying { background: radial-gradient(circle, #ecf0f1, #95a5a6); box-shadow: 0 0 10px #fff; }
        .effect-psychic { background: radial-gradient(circle, #e056fd, #be2edd); box-shadow: 0 0 10px #e056fd; }
        .effect-bug { background: radial-gradient(circle, #badc58, #6ab04c); box-shadow: 0 0 10px #badc58; }
        .effect-rock { background: radial-gradient(circle, #95a5a6, #7f8c8d); box-shadow: 0 0 10px #95a5a6; }
        .effect-ghost { background: radial-gradient(circle, #4834d4, #686de0); box-shadow: 0 0 10px #4834d4; }
        .effect-dragon { background: radial-gradient(circle, #30336b, #130f40); box-shadow: 0 0 10px #30336b; }
        .effect-dark { background: radial-gradient(circle, #2d3436, #000); box-shadow: 0 0 10px #000; }
        .effect-steel { background: radial-gradient(circle, #bdc3c7, #95a5a6); box-shadow: 0 0 10px #bdc3c7; }
        .effect-fairy { background: radial-gradient(circle, #ff9ff3, #f368e0); box-shadow: 0 0 10px #ff9ff3; }

        /* FLOATING TEXT */
        .command-bubble { position: absolute; top: -40px; left: 50%; transform: translateX(-50%) scale(0); background: #fff; color: #000; padding: 8px 12px; border-radius: 12px; border: 2px solid #000; font-family: 'Press Start 2P'; font-size: 0.5rem; white-space: nowrap; z-index: 100; opacity: 0; transition: all 0.2s; pointer-events: none; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
        .command-bubble.show { opacity: 1; transform: translateX(-50%) scale(1); top: -60px; }
        
        .floating-text { font-family: 'Press Start 2P'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; text-shadow: 2px 2px 0 #000; animation: popUp 1.2s forwards; z-index: 100; pointer-events: none; width: 300px; text-align: center; }
        @keyframes popUp { 0% { opacity: 0; margin-top: 0; } 10% { opacity: 1; } 100% { opacity: 0; margin-top: -100px; } }
        .damage-text { color: #ff4757; font-size: 1.5rem; } 
        .heal-text { color: #2ed573; } 
        .resist-text { color: #bdc3c7; font-size: 0.8rem; margin-top: -20px !important; }
        .super-text { color: #f1c40f; font-size: 0.8rem; margin-top: -20px !important; text-shadow: 2px 2px 0 #c0392b; }
        .status-text { color: #9b59b6; font-size: 0.9rem; margin-top: -40px !important; text-shadow: 2px 2px 0 #000; }

        /* BOTTOM UI */
        .bottom-panel { width: 100%; height: auto; background: #1a1a2e; border-top: 3px solid #3498db; z-index: 50; padding-bottom: env(safe-area-inset-bottom); position: relative; }
        .controls-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        .battle-log { padding: 15px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #ecf0f1; height: 150px; background: #111; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .move-btn { background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; padding: 10px; }
        .move-btn:active { transform: scale(0.96); border-color: #f1c40f; }
        .move-btn:disabled { opacity: 0.5; pointer-events: none; }
        .rest-btn { grid-column: span 2; background: #27ae60; border-color: #2ecc71; }

        /* MODALS */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #overlay h1 { font-family: 'Press Start 2P'; text-align: center; color: #f1c40f; text-shadow: 0 4px 0 #c27c0e; margin-bottom: 40px; font-size: 1.5rem; }
        .podium { display: flex; align-items: flex-end; gap: 30px; margin-bottom: 30px; }
        .winner-box { display: flex; flex-direction: column; align-items: center; transform: scale(1.2); z-index: 2; position: relative; }
        .loser-box { display: flex; flex-direction: column; align-items: center; opacity: 0.7; filter: grayscale(1); transform: scale(0.9); }
        .podium-avatar-group { position: relative; width: 120px; height: 120px; }
        .podium-trainer { width: 64px; height: 64px; background-size: 400% auto; background-position: 0 0; image-rendering: pixelated; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
        .podium-monster { width: 100px; height: 100px; object-fit: contain; image-rendering: pixelated; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1; opacity: 0.9; }
        .crown { font-size: 2rem; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); z-index: 3; text-shadow: 0 0 10px gold; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
        .podium-base { height: 10px; width: 100%; border-radius: 50%; margin-top: -10px; z-index: 0; }
        .winner-box .podium-base { background: #f1c40f; box-shadow: 0 0 20px #f1c40f; }
        .loser-box .podium-base { background: #555; }
        .name-tag { font-family: 'Press Start 2P'; font-size: 0.6rem; margin-top: 15px; color: white; text-align: center; background: #333; padding: 5px 10px; border-radius: 4px; border: 1px solid #777; }
        .btn-restart { background: #3498db; color: white; padding: 15px 30px; border-radius: 30px; border: none; font-family: 'Press Start 2P'; font-size: 0.8rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #2980b9; }
        .spectator-banner { position: absolute; bottom: 0; width: 100%; text-align: center; background: rgba(0,0,0,0.7); color: #f1c40f; padding: 5px; font-family: 'Press Start 2P'; font-size: 0.7rem; pointer-events: none; z-index: 50; }
        
        .catchball { position: absolute; width: 17px; height: 17px; background-image: url('/uploads/catchcube.gif'); background-size: contain; background-repeat: no-repeat; z-index: 2000; pointer-events: none; }
        .flash-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: white; opacity: 0; pointer-events: none; z-index: 500; transition: opacity 0.15s; }
        .flash-overlay.active { opacity: 0.8; }
        .absorbed-state { filter: brightness(10) sepia(1) hue-rotate(-50deg) saturate(5) !important; transform: scale(0) !important; transition: transform 0.4s ease-in, filter 0.1s !important; }
        .catchball.captured-lock { filter: brightness(0.6); }
        .capture-star { position: absolute; font-size: 24px; color: gold; text-shadow: 0 0 5px orange; animation: star-pop 0.6s ease-out forwards; z-index: 2200; }
        @keyframes star-pop { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.5); opacity: 1; } 100% { transform: scale(1) translateY(-20px); opacity: 0; } }

        #switchModal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .switch-box { background: #2c3e50; border: 2px solid #e74c3c; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center; }
        .switch-title { font-family: 'Press Start 2P'; color: #f1c40f; margin-bottom: 20px; font-size: 0.8rem; line-height: 1.5; }
        .switch-item { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid #444; background: #222; margin-bottom: 8px; cursor: pointer; border-radius: 5px; transition: 0.1s; }
        .switch-item:hover { background: #333; border-color: #3498db; }
        .switch-sprite { width: 40px; height: 40px; image-rendering: pixelated; }

        @keyframes returnAnim { 0% { transform: scale(1); filter: none; opacity: 1; } 100% { transform: scale(0); filter: sepia(1) hue-rotate(-50deg) saturate(5) brightness(2); opacity: 0; } }
        .anim-return { animation: returnAnim 0.5s forwards !important; transition: none !important; }

        @keyframes wildFaint { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(30px); opacity: 0; filter: grayscale(1); } }
        .anim-faint-wild { animation: wildFaint 1s forwards !important; transition: none !important; }
        
        @keyframes popOut { 0% { transform: scale(0); filter: brightness(10) sepia(1) hue-rotate(-50deg) saturate(5); opacity: 0; } 40% { transform: scale(1.2); filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5); opacity: 1; } 100% { transform: scale(1); filter: brightness(1); opacity: 1; } }
        .anim-pop-out { animation: popOut 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes wildSlideIn { 0% { transform: translateX(40px); opacity: 0; } 100% { transform: translateX(0); opacity: 1; } }
        .anim-wild-appear { animation: wildSlideIn 0.8s ease-out forwards; }
        
        @keyframes recallFlash { 0% { transform: scale(1); filter: brightness(1); opacity: 1; } 50% { transform: scale(1.1); filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5); opacity: 1; } 100% { transform: scale(0.1); filter: brightness(5) sepia(1) hue-rotate(-50deg) saturate(5); opacity: 0; } }
        .anim-recall { animation: recallFlash 0.6s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards !important; transition: none !important; }
        
        .deploy-ball { position: absolute; width: 20px; height: 20px; background-image: url('/uploads/catchcube.gif'); background-size: contain; background-repeat: no-repeat; z-index: 100; pointer-events: none; }
    </style>
</head>
<body>
    <div id="global-loader"><div class="spinner"></div><div class="loading-text">CARREGANDO...</div></div>

    <div class="arena">
        <div class="flash-overlay" id="flashOverlay"></div>
        <div class="status-msg" id="statusMsg" style="display:none; position:absolute; top:50%; width:100%; text-align:center; color:#fff;">Aguardando...</div>
        <% if(isSpectator) { %> <div class="spectator-banner">MODO ESPECTADOR</div> <% } %>

        <div class="hud-panel hud-p1">
            <div class="poke-name"><span id="p1-name"><%= p1.name %></span> <span class="poke-lv">Lv.<span id="p1-lv"><%= p1.level %></span></span></div>
            <div class="trainer-sub"><%= p1.playerName || 'Voc√™' %></div>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-p1"></div></div>
            <div class="stat-text"><span id="hp-val-p1"><%= p1.hp %></span>/<span id="max-hp-p1"><%= p1.maxHp %></span></div>
        </div>

        <div class="hud-panel hud-p2">
            <div class="poke-name"><span id="p2-name"><%= p2.name %></span> <span class="poke-lv">Lv.<span id="p2-lv"><%= p2.level %></span></span></div>
            <% if(battleMode !== 'wild') { %> <div class="trainer-sub"><%= p2.playerName || 'CPU' %></div> <% } else { %> <div class="trainer-sub">Selvagem</div> <% } %>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-p2"></div></div>
            <div class="stat-text" style="text-align:right"><span id="hp-val-p2"><%= p2.hp %></span>/<span id="max-hp-p2"><%= p2.maxHp %></span></div>
        </div>

        <div class="fighter p2-position" id="fighter-p2">
            <div class="command-bubble" id="bubble-p2"></div>
            <div class="trainer" id="trainer-p2" data-skin="<%= p2.skin || 'char1' %>" style="<%= battleMode === 'wild' ? 'opacity:0;' : '' %>"></div>
            <div class="sprite" id="sprite-p2">
                <img src="<%= (p2.sprite.startsWith('http') || p2.sprite.startsWith('data:')) ? p2.sprite : '/uploads/' + p2.sprite %>">
            </div>
        </div>

        <div class="fighter p1-position" id="fighter-p1">
            <div class="command-bubble" id="bubble-p1"></div>
            <div class="trainer" id="trainer-p1" data-skin="<%= p1.skin %>"></div>
            <div class="sprite" id="sprite-p1">
                <img src="<%= (p1.sprite.startsWith('http') || p1.sprite.startsWith('data:')) ? p1.sprite : '/uploads/' + p1.sprite %>">
            </div>
        </div>

        <% if(battleMode === 'wild') { %>
            <div id="floatingBagBtn" style="position:fixed; right:12px; bottom:90px; z-index:75;">
                <div onclick="openBattleBag()" style="width:44px; height:44px; border-radius:50%; background:#f39c12; border:2px solid #d35400; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.4);">üéí</div>
            </div>
        <% } %>

        <div id="overlay">
            <div id="result-content">
                <h1 id="result-title">RESULTADO</h1>
                <div class="podium">
                    <div class="winner-box">
                        <div class="crown">üëë</div>
                        <div class="podium-avatar-group">
                            <img id="win-mon-img" class="podium-monster" src="">
                            <div id="win-trainer-div" class="podium-trainer"></div>
                        </div>
                        <div class="podium-base"></div>
                        <div class="name-tag" id="win-name"></div>
                    </div>
                    <div class="loser-box">
                        <div class="podium-avatar-group">
                            <img id="lose-mon-img" class="podium-monster" src="">
                            <div id="lose-trainer-div" class="podium-trainer"></div>
                        </div>
                        <div class="podium-base"></div>
                        <div class="name-tag" id="lose-name"></div>
                    </div>
                </div>
                <form action="/lobby" method="GET" style="text-align:center;">
                    <input type="hidden" name="userId" value="<%= realUserId %>">
                    <button type="submit" class="btn-restart">VOLTAR AO LOBBY</button>
                </form>
            </div>
        </div>
    </div>

    <% if(isSpectator) { %>
        <div id="bleachers"></div>
        <div id="chat-container">
            <input type="text" id="chatInput" placeholder="Chat..." style="width:80%; padding:10px;">
            <button id="chatSend">OK</button>
        </div>
    <% } else { %>
        <div class="bottom-panel">
            <% if (battleMode === 'online' || battleMode === 'manual' || battleMode === 'wild') { %>
                <div class="controls-panel" id="controlsPanel">
                    <% if (battleMode === 'wild') { %>
                        <button class="move-btn" style="background:#e67e22; border-color:#d35400" onclick="sendAction('catch')">
                            <strong><img src="/uploads/catchcube.gif" style="width:17px; height:17px; vertical-align:middle; margin-right:5px;"> Capturar</strong>
                        </button>
                        <button class="move-btn" style="background:#95a5a6; border-color:#7f8c8d" onclick="sendAction('run')"><strong>üèÉ Fugir</strong></button>
                    <% } %>
                    <div id="moves-container" style="display:contents;">
                        <% p1.moves.forEach(move => { %>
                            <button class="move-btn" onclick="sendAction('move', '<%= move.id %>')" id="btn-<%= move.id %>">
                                <strong><%= move.icon %> <%= move.name %></strong>
                                <small style="color:<%= move.pp === 0 ? 'red' : '#aaa' %>">PP: <%= move.pp %>/<%= move.maxPp %></small>
                            </button>
                        <% }) %>
                    </div>
                    <button class="move-btn rest-btn" onclick="sendAction('move', 'rest')">üí§ Descansar</button>
                </div>
            <% } else { %>
                <div class="battle-log" id="logBox"></div>
            <% } %>
        </div>
    <% } %>

    <div id="switchModal">
        <div class="switch-box">
            <div class="switch-title" id="switchTitle">SUA CRIATURA DESMAIOU!<br>Escolha outro ou desista.</div>
            <div id="switchList" style="text-align:left;"></div>
            <button class="btn-restart" style="background:#e74c3c; margin-top:10px;" onclick="forfeitBattle()">DESISTIR</button>
        </div>
    </div>

    <div id="floatingBagPanel" aria-hidden="true">
        <button class="close-x" aria-label="Fechar" onclick="closeBattleBag()">‚úï</button>
        <h4>BAG</h4>
        <div id="battleBagContent">Carregando...</div>
    </div>

    <script>
        history.pushState(null, null, location.href); window.onpopstate = function () { history.go(1); }; window.onpageshow = function(event) { if (event.persisted) { window.location.reload(); } };
        const socket = io();
        const battleMode = "<%= battleMode %>";
        const battleId = "<%= battleId %>";
        const initialData = <%- battleData %>;
        const myRoleId = "<%= myRoleId %>"; 
        const isSpectator = <%= isSpectator ? 'true' : 'false' %>;
        
        let p1RawId = "<%= p1.instanceId %>"; let p2RawId = "<%= p2.instanceId %>";
        let p1Mon = "<%= p1.name %>"; let p2Mon = "<%= p2.name %>";
        let p1CurHp = Number(<%= p1.hp %>); let p2CurHp = Number(<%= p2.hp %>);
        let p1MaxHp = Number(<%= p1.maxHp %>); let p2MaxHp = Number(<%= p2.maxHp %>);

        let canAct = true; 
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        function resolveImg(src) { return (src.startsWith('http') || src.startsWith('data:')) ? src : '/uploads/' + src; }

        let p1Data = { name: "<%= p1.playerName %>", skin: "<%= p1.skin %>", sprite: resolveImg("<%= p1.sprite %>"), mon: "<%= p1.name %>" };
        let p2Data = { name: "<%= p2.playerName %>", skin: "<%= p2.skin %>", sprite: resolveImg("<%= p2.sprite %>"), mon: "<%= p2.name %>" };

        if (isSpectator) { socket.emit('join_spectator', { roomId: battleId }); }
        if(battleMode === 'online' && !isSpectator) { socket.emit('join_room', battleId); }

        function getSide(actorId) { if (String(actorId) === String(p1RawId)) return 'p1'; if (String(actorId) === String(p2RawId)) return 'p2'; if (String(actorId).startsWith('wild_')) return 'p2'; return 'p1'; }
        async function speak(actorId, moveName) { const side = getSide(actorId); const bubble = document.getElementById(`bubble-${side}`); const trainer = document.getElementById(`trainer-${side}`); const monName = (side === 'p1') ? p1Mon : p2Mon; if(bubble) { bubble.innerText = (moveName === 'rest') ? `${monName}, volte!` : `${monName}, ${moveName}!`; bubble.classList.add('show'); } if(trainer) animateTrainerCommand(trainer); await wait(1000); if(bubble) bubble.classList.remove('show'); }
        async function animateTrainerCommand(trainerEl) { try { trainerEl.classList.add('frame-1'); await wait(180); trainerEl.classList.remove('frame-1'); await wait(120); trainerEl.classList.add('frame-1'); await wait(180); trainerEl.classList.remove('frame-1'); } catch (e) {} }
        async function animateThrow(trainerEl) { if (!trainerEl) return; trainerEl.classList.add('frame-1'); await wait(250); trainerEl.classList.remove('frame-1'); }

        async function returnPokemon(side) {
            const fighterDiv = document.getElementById(`fighter-${side}`); const spriteImg = document.querySelector(`#sprite-${side} img`); const trainer = document.getElementById(`trainer-${side}`); const sprite = document.getElementById(`sprite-${side}`);
            if(!spriteImg || !fighterDiv || !trainer || !sprite) return;
            if (side === 'p2' && battleMode === 'wild') { spriteImg.classList.add('anim-faint-wild'); await wait(1000); return; }
            
            // 1. Recall
            spriteImg.style.opacity = ''; spriteImg.style.transform = ''; void spriteImg.offsetWidth; spriteImg.classList.add('anim-recall'); await wait(600);
            
            // 2. Ball Flyback
            const ball = document.createElement('div'); ball.className = 'deploy-ball'; fighterDiv.appendChild(ball);
            const tRect = trainer.getBoundingClientRect(); const mRect = sprite.getBoundingClientRect(); const fRect = fighterDiv.getBoundingClientRect();
            
            // Start: Center of Pokemon, Y=100 (Floor)
            const startX = (mRect.left - fRect.left) + (mRect.width / 2) - 10; 
            const startY = 100; 
            
            // End: Trainer Hand, Y=55
            const handOffsetX = (side === 'p1') ? (tRect.width * 0.8) : (tRect.width * 0.2); 
            const endX = (tRect.left - fRect.left) + handOffsetX; 
            const endY = 55;

            ball.style.left = startX + 'px'; ball.style.top = startY + 'px';
            const deltaX = endX - startX; const deltaY = endY - startY;
            
            const anim = ball.animate([ { transform: 'translate(0,0) scale(0.6)', opacity: 1 }, { transform: `translate(${deltaX * 0.5}px, ${deltaY - 30}px) scale(0.6)`, offset: 0.5 }, { transform: `translate(${deltaX}px, ${deltaY}px) scale(0)`, opacity: 0 } ], { duration: 550, easing: 'ease-in-out', fill: 'forwards' }); await anim.finished; ball.remove();
        }

        async function deployPokemon(side, isWild = false) {
            const fighterDiv = document.getElementById(`fighter-${side}`); const spriteDiv = document.getElementById(`sprite-${side}`); const spriteImg = spriteDiv ? spriteDiv.querySelector('img') : null; const trainerDiv = document.getElementById(`trainer-${side}`);
            if (!spriteImg || !fighterDiv) return;
            spriteImg.classList.remove('anim-pop-out', 'anim-wild-appear', 'anim-recall', 'anim-faint-wild'); spriteImg.style.opacity = '0'; spriteImg.style.filter = ''; spriteImg.style.transform = '';
            if (isWild) { await wait(300); spriteImg.classList.add('anim-wild-appear'); setTimeout(() => { spriteImg.style.opacity = '1'; }, 50); return; }
            if (trainerDiv) animateThrow(trainerDiv); await wait(200);
            
            const ball = document.createElement('div'); ball.className = 'deploy-ball'; fighterDiv.appendChild(ball);
            const tRect = trainerDiv.getBoundingClientRect(); const mRect = spriteDiv.getBoundingClientRect(); const fRect = fighterDiv.getBoundingClientRect();
            const handOffsetX = (side === 'p1') ? (tRect.width * 0.8) : (tRect.width * 0.2); 
            
            // Start: Trainer Hand (55px)
            let startX = (tRect.left - fRect.left) + handOffsetX; 
            let startY = 55;
            
            // End: Pokemon Center Floor (100px)
            let endX = (mRect.left - fRect.left) + (mRect.width / 2) - 10; 
            let endY = 100;

            ball.style.left = startX + 'px'; ball.style.top = startY + 'px'; await wait(50);
            const deltaX = endX - startX; const deltaY = endY - startY;
            const animation = ball.animate([ { transform: 'translate(0, 0) scale(0.5)' }, { transform: `translate(${deltaX * 0.5}px, ${deltaY - 80}px) scale(0.8)`, offset: 0.5 }, { transform: `translate(${deltaX}px, ${deltaY}px) scale(0.6)` } ], { duration: 450, easing: 'linear', fill: 'forwards' }); await animation.finished; ball.remove();
            createImpact(side, 'effect-normal', endX + 40, endY + 40); spriteImg.classList.add('anim-pop-out'); setTimeout(() => { spriteImg.style.opacity = '1'; }, 50);
        }

        function createProjectile(fromSide, toSide, cssClass) {
            const fromEl = document.getElementById(`sprite-${fromSide}`); const toEl = document.getElementById(`sprite-${toSide}`); if(!fromEl || !toEl) return;
            const rectFrom = fromEl.getBoundingClientRect(); const rectTo = toEl.getBoundingClientRect();
            const startX = rectFrom.left + rectFrom.width / 2; const startY = rectFrom.top + rectFrom.height / 2;
            const endX = rectTo.left + rectTo.width / 2; const endY = rectTo.top + rectTo.height / 2;
            const part = document.createElement('div'); part.className = `atk-particle ${cssClass}`;
            part.style.left = startX + 'px'; part.style.top = startY + 'px';
            part.style.setProperty('--tx', (endX - startX) + 'px'); part.style.setProperty('--ty', (endY - startY) + 'px');
            document.body.appendChild(part); setTimeout(() => part.remove(), 500);
        }

        function createImpact(targetSide, cssClass, customX = null, customY = null) {
            const toEl = document.getElementById(`sprite-${targetSide}`); const fighterDiv = document.getElementById(`fighter-${targetSide}`); if(!toEl && !fighterDiv) return;
            const impact = document.createElement('div'); impact.className = `impact-effect impact-pop ${cssClass}`;
            if (customX !== null && customY !== null && fighterDiv) { impact.style.left = (customX - 40) + 'px'; impact.style.top = (customY - 40) + 'px'; fighterDiv.appendChild(impact); } 
            else { const rect = toEl.getBoundingClientRect(); impact.style.left = (rect.left + rect.width/2 - 40) + 'px'; impact.style.top = (rect.top + rect.height/2 - 40) + 'px'; document.body.appendChild(impact); }
            setTimeout(() => impact.remove(), 400);
        }

        function playMoveAnimation(attackerSide, defenderSide, type, category, moveType) {
            try { console.debug('[playMoveAnimation]', { attackerSide, defenderSide, type, category }); } catch(e) {}
            const atkSprite = document.getElementById(`sprite-${attackerSide}`); const defSprite = document.getElementById(`sprite-${defenderSide}`); if(!atkSprite) return;
            const atkImg = atkSprite.querySelector('img'); const defImg = defSprite ? defSprite.querySelector('img') : null;
            if(atkImg) {
                const alt = atkImg.dataset.altSrc;
                if (alt) { if(!atkImg.dataset.origSrc) atkImg.dataset.origSrc = atkImg.src; atkImg.src = alt; setTimeout(() => { try { if(atkImg) atkImg.src = atkImg.dataset.origSrc; } catch(e){} }, 360); } 
                else { atkImg.classList.remove('attack','hurt','shake'); atkImg.classList.add('attack'); setTimeout(() => { try { if(atkImg) atkImg.classList.remove('attack'); } catch(e){} }, 360); }
            }
            if (category === 'special') { const elemClass = `effect-${(type || 'normal').toLowerCase()}`; setTimeout(() => { createProjectile(attackerSide, defenderSide, elemClass); }, 100); }
            if(defImg) { setTimeout(() => { try { if(!defImg) return; defImg.classList.remove('hurt','shake'); defImg.classList.add('shake'); setTimeout(() => { try { if(defImg) { defImg.classList.remove('shake'); } } catch(e){} }, 420); } catch(e) {} }, 220); }
        }

        function updateBar(actorId, cur, max, type) { 
            const side = getSide(actorId); const pct = Math.max(0, (cur / max) * 100); 
            const fill = document.getElementById(`${type}-bar-${side}`); if(fill) { fill.style.width = pct + '%'; 
            if(type === 'hp') { const txt = document.getElementById(`hp-val-${side}`); const maxTxt = document.getElementById(`max-hp-${side}`); if(txt) txt.innerText = Math.max(0, cur); if(maxTxt && side === 'p1') maxTxt.innerText = max; } }
            if(type === 'hp') { if(side === 'p1') p1CurHp = Number(cur); else p2CurHp = Number(cur); }
        }

        function updateMovesUI(moves) {
            if(!moves) return;
            moves.forEach(m => {
                const btn = document.getElementById('btn-' + m.id);
                if(btn) {
                    const ppTxt = btn.querySelector('small');
                    if(ppTxt) { ppTxt.innerText = `PP: ${m.pp}/${m.maxPp}`; ppTxt.style.color = m.pp === 0 ? 'red' : '#aaa'; }
                    if(m.pp === 0) btn.disabled = true;
                }
            });
        }
        
        function setControlsState(enabled) { 
            if(isSpectator) return; const panel = document.getElementById('controlsPanel'); if(!panel) return; panel.style.opacity = enabled ? "1" : "0.5"; const btns = panel.querySelectorAll('button'); btns.forEach(b => b.disabled = !enabled); canAct = !!enabled;
        }
        
        async function playEvents(events) { 
            let lastMoveElement = 'normal';
            for (let evt of events) { 
                if (evt.type === 'INIT') continue; 
                const actorIdRaw = evt.actorId || evt.attackerId || evt.attacker || evt.actor || null; const targetIdRaw = evt.targetId || evt.target || evt.defenderId || evt.defender || null;
                if (evt.type === 'MSG') { try { if(evt.text) showToast(evt.text); } catch(e) {} const lb = document.getElementById('logBox'); if(lb) { const div = document.createElement('div'); div.className = 'log-entry'; div.innerText = evt.text; lb.appendChild(div); lb.scrollTop = lb.scrollHeight; } await wait(200); continue; }
                const actorSide = getSide(actorIdRaw); const targetSide = getSide(targetIdRaw);

                if (evt.type === 'USE_MOVE') { 
                    lastMoveElement = evt.moveElement || 'normal';
                    if (battleMode === 'wild' && actorSide === 'p2') { await wait(500); } else { await speak(actorIdRaw, evt.moveName); }
                    playMoveAnimation(actorSide, targetSide, evt.moveElement || 'normal', evt.moveCategory, evt.moveType);
                    await wait(300); 

                } else if (evt.type === 'ATTACK_HIT') { 
                    const spriteImg = document.querySelector(`#sprite-${targetSide} img`); if(spriteImg) { spriteImg.classList.remove('hurt', 'shake'); void spriteImg.offsetWidth; spriteImg.classList.add('hurt', 'shake'); }
                    createImpact(targetSide, `effect-${lastMoveElement.toLowerCase()}`);
                    const damageTxt = document.createElement('div'); damageTxt.className = 'floating-text damage-text'; damageTxt.innerText = evt.isBlocked ? 'üõ°Ô∏è' : `-${evt.damage}`;
                    const rX = (Math.random() * 40 - 20) + '%'; const rY = (Math.random() * 20 - 10) + '%'; damageTxt.style.transform = `translate(calc(-50% + ${rX}), calc(-50% + ${rY}))`;
                    document.getElementById(`fighter-${targetSide}`).appendChild(damageTxt);
                    if(evt.isEffective) { const t = document.createElement('div'); t.className = 'floating-text super-text'; t.innerText = "SUPER EFETIVO!"; t.style.marginTop = "30px"; document.getElementById(`fighter-${targetSide}`).appendChild(t); setTimeout(() => t.remove(), 1200); } 
                    else if(evt.isNotEffective) { const t = document.createElement('div'); t.className = 'floating-text resist-text'; t.innerText = "POUCO EFETIVO..."; t.style.marginTop = "30px"; document.getElementById(`fighter-${targetSide}`).appendChild(t); setTimeout(() => t.remove(), 1200); }
                    await wait(500); if(spriteImg) { spriteImg.classList.remove('hurt', 'shake'); } damageTxt.remove();
                    const maxHp = (targetSide === 'p1') ? p1MaxHp : p2MaxHp; updateBar(targetIdRaw, evt.newHp, maxHp, 'hp'); 
                    if (evt.newHp <= 0) { await wait(200); await returnPokemon(targetSide); } await wait(500);

                } else if (evt.type === 'HEAL') { 
                    await speak(actorIdRaw, 'Cura'); updateBar(actorIdRaw, evt.newHp, (actorSide === 'p1' ? p1MaxHp : p2MaxHp), 'hp'); 
                    const txt = document.createElement('div'); txt.className = 'floating-text heal-text'; txt.innerText = `+${evt.amount}`; document.getElementById(`fighter-${actorSide}`).appendChild(txt); setTimeout(() => txt.remove(), 1000); await wait(500); 
                } 
                else if (evt.type === 'STATUS_APPLIED') { const fighterDiv = document.getElementById(`fighter-${targetSide}`); const t = document.createElement('div'); t.className = 'floating-text status-text'; t.innerText = "ENVENENADO!"; if(fighterDiv) fighterDiv.appendChild(t); setTimeout(() => t.remove(), 1500); await wait(500); }
                else if (evt.type === 'STATUS_DAMAGE') {
                    const spriteImg = document.querySelector(`#sprite-${targetSide} img`); if(spriteImg) { spriteImg.classList.remove('status-dmg'); void spriteImg.offsetWidth; spriteImg.classList.add('status-dmg'); setTimeout(() => spriteImg.classList.remove('status-dmg'), 600); }
                    const damageTxt = document.createElement('div'); damageTxt.className = 'floating-text damage-text'; damageTxt.innerText = `-${evt.damage}`; damageTxt.style.color = "#9b59b6"; document.getElementById(`fighter-${targetSide}`).appendChild(damageTxt); setTimeout(() => damageTxt.remove(), 1000);
                    const maxHp = (targetSide === 'p1') ? p1MaxHp : p2MaxHp; updateBar(targetIdRaw, evt.newHp, maxHp, 'hp');
                    if (evt.newHp <= 0) { await wait(200); await returnPokemon(targetSide); } await wait(800);
                }
                else if (evt.type === 'STATUS_END') { const fighterDiv = document.getElementById(`fighter-${targetSide}`); const t = document.createElement('div'); t.className = 'floating-text status-text'; t.innerText = "Curado!"; t.style.color="#fff"; if(fighterDiv) fighterDiv.appendChild(t); setTimeout(() => t.remove(), 1500); await wait(500); }
                else if (evt.type === 'SWITCH_ANIM') {
                     await wait(500); await returnPokemon(evt.side);
                     if (evt.side === 'p1' && myRoleId === evt.newId) {
                         p1RawId = evt.newId; p1MaxHp = evt.maxHp; updateBar(p1RawId, evt.newHp, evt.maxHp, 'hp'); document.getElementById('p1-name').innerText = evt.newName; document.querySelector('#sprite-p1 img').src = resolveImg(evt.newSprite);
                         if(evt.moves) updateMovesUI(evt.moves);
                     } else if (evt.side === 'p1') { document.querySelector('#sprite-p1 img').src = resolveImg(evt.newSprite); updateBar('p1', evt.newHp, evt.maxHp, 'hp'); }
                     else { document.querySelector('#sprite-p2 img').src = resolveImg(evt.newSprite); document.getElementById('p2-name').innerText = evt.newName; updateBar(evt.newId, evt.newHp, evt.maxHp, 'hp'); }
                     await deployPokemon(evt.side, false);
                }
            } 
        }

        async function sendAction(type, moveId) { 
            if (!canAct) return; setControlsState(false); 
            if (battleMode === 'online') { 
                if (type === 'move') { document.getElementById('statusMsg').innerText = "Aguardando..."; document.getElementById('statusMsg').style.display = "block"; socket.emit('online_action', { roomId: battleId, action: 'move', value: moveId, playerId: myRoleId }); } 
            } else { 
                const res = await fetch('/api/turn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ battleId, action: type, moveId }) }); const data = await res.json(); 
                if (data.switched) { await wait(500); p1RawId = data.newP1Id; p1Mon = data.p1State.name; p1CurHp = data.p1State.hp; p1MaxHp = data.p1State.maxHp; document.getElementById('p1-name').innerText = p1Mon; document.getElementById('p1-lv').innerText = data.p1State.level; const spriteImg = document.querySelector('#sprite-p1 img'); spriteImg.src = resolveImg(data.p1State.sprite); deployPokemon('p1', false); updateBar(p1RawId, p1CurHp, data.p1State.maxHp, 'hp'); const movesContainer = document.getElementById('moves-container'); movesContainer.innerHTML = ''; data.p1State.moves.forEach(move => { const btn = document.createElement('button'); btn.className = 'move-btn'; btn.id = 'btn-' + move.id; btn.onclick = () => sendAction('move', move.id); btn.innerHTML = `<strong>${move.icon} ${move.name}</strong><small style="color:${move.pp===0?'red':'#aaa'}">PP: ${move.pp}/${move.maxPp}</small>`; movesContainer.appendChild(btn); }); if (data.events) await playEvents(data.events); setControlsState(true); return; }
                if (type === 'catch' && data && data.threw) await playCaptureAnimation(p2RawId, data.captured); 
                if (data.p1State && data.p1State.moves) updateMovesUI(data.p1State.moves);
                if (data.events) await playEvents(data.events); 
                if (data.forceSwitch) { showSwitchModal(data.switchable); return; }
                if(data.captured) { if(data.sentToPC) showToast('Enviado para o PC!'); else showToast('Capturado!'); setTimeout(() => { window.location.href = '/forest?userId=<%= realUserId %>'; }, 1000); return; }
                else if (data.fled) { showToast("Fugiu!"); window.location.href = '/forest?userId=<%= realUserId %>'; } 
                else if(data.finished) { endGame(data.winnerId); } else { if (data.p1State) updateBar(p1RawId, data.p1State.hp, p1MaxHp, 'hp'); if (data.p2State) updateBar(p2RawId, data.p2State.hp, p2MaxHp, 'hp'); setControlsState(true); } 
            } 
        }

        function showSwitchModal(list) {
            const modal = document.getElementById('switchModal'); const listDiv = document.getElementById('switchList'); listDiv.innerHTML = '';
            list.forEach(p => { const item = document.createElement('div'); item.className = 'switch-item'; item.innerHTML = `<img src="${resolveImg(p.sprite)}" class="switch-sprite"> <div><div style="color:#f1c40f;font-weight:bold;">${p.name} <span style="font-size:0.7rem;color:#ccc">Lv.${p.level}</span></div><div style="font-size:0.7rem;">HP: ${p.hp}/${p.maxHp}</div></div>`; item.onclick = () => performSwitch(p.instanceId, true); listDiv.appendChild(item); }); modal.style.display = 'flex';
        }

        async function performSwitch(newPokeId, isForced = false) {
            document.getElementById('switchModal').style.display = 'none';
            if (battleMode === 'online') { document.getElementById('statusMsg').innerText = "Trocando..."; document.getElementById('statusMsg').style.display = "block"; setControlsState(false); socket.emit('online_action', { roomId: battleId, action: 'switch', value: newPokeId, playerId: myRoleId }); }
            else { const res = await fetch('/api/turn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ battleId, action: 'switch', moveId: newPokeId, isForced }) }); const data = await res.json(); if (data.switched) { await wait(500); p1RawId = data.newP1Id; p1Mon = data.p1State.name; p1CurHp = data.p1State.hp; p1MaxHp = data.p1State.maxHp; document.getElementById('p1-name').innerText = p1Mon; document.getElementById('p1-lv').innerText = data.p1State.level; const p1Img = document.querySelector('#sprite-p1 img'); p1Img.src = resolveImg(data.p1State.sprite); deployPokemon('p1', false); updateBar(p1RawId, p1CurHp, data.p1State.maxHp, 'hp'); const movesContainer = document.getElementById('moves-container'); movesContainer.innerHTML = ''; data.p1State.moves.forEach(move => { const btn = document.createElement('button'); btn.className = 'move-btn'; btn.id = 'btn-' + move.id; btn.onclick = () => sendAction('move', move.id); btn.innerHTML = `<strong>${move.icon} ${move.name}</strong><small style="color:${move.pp===0?'red':'#aaa'}">PP: ${move.pp}/${move.maxPp}</small>`; movesContainer.appendChild(btn); }); if (data.events) await playEvents(data.events); setControlsState(true); } }
        }

        function forfeitBattle() {
            document.getElementById('switchModal').style.display = 'none';
            if (battleMode === 'online') { if(!confirm("Desistir?")) return; socket.emit('online_action', { roomId: battleId, action: 'forfeit', playerId: myRoleId }); }
            else { endGame(p2RawId); }
        }

        socket.on('turn_result', async (data) => { document.getElementById('statusMsg').style.display = "none"; await playEvents(data.events); if(data.winnerId) endGame(data.winnerId); else if(!isSpectator) setControlsState(true); });
        socket.on('opponent_ready', () => { if(!isSpectator) { document.getElementById('statusMsg').style.display = "block"; document.getElementById('statusMsg').innerText = "Oponente pronto!"; } });
        
        window.onload = async () => { 
            const loader = document.getElementById('global-loader'); loader.style.opacity = '0';
            if(battleMode === 'online') { if(!isSpectator) socket.emit('join_room', battleId); } 
            updateBar(p1RawId, <%= p1.hp %>, <%= p1.maxHp %>, 'hp'); updateBar(p2RawId, <%= p2.hp %>, <%= p2.maxHp %>, 'hp'); 
            await wait(100); deployPokemon('p1', false); deployPokemon('p2', battleMode === 'wild'); await wait(400); loader.style.display = 'none';
            if(battleMode === 'auto') { playEvents(initialData.log).then(() => endGame(initialData.winnerId)); } else if (!isSpectator) { setControlsState(true); } setTimeout(discoverSpriteAlts, 300);
        };
        
        let __battleBagOutsideListener = null;
        function closeBattleBag() { const panel = document.getElementById('floatingBagPanel'); if(panel) panel.style.display = 'none'; if(__battleBagOutsideListener) { document.removeEventListener('click', __battleBagOutsideListener); __battleBagOutsideListener = null; } }
        async function openBattleBag() { const panel = document.getElementById('floatingBagPanel'); if(!panel) return; if(panel.style.display === 'block') { closeBattleBag(); return; } panel.style.display = 'block'; const cont = document.getElementById('battleBagContent'); cont.innerHTML = 'Carregando...'; try { const res = await fetch('/api/me?userId=<%= realUserId %>'); const data = await res.json(); const money = data.money || 0; const pokeballs = data.pokeballs || 0; const rareCandy = data.rareCandy || 0; const hudMoneyEl = document.getElementById('hud-money'); if(hudMoneyEl) hudMoneyEl.innerText = money; let html = `<div class="bag-row"><div class="bag-item">Catchballs<br><strong>${pokeballs}</strong></div><div class="bag-item">RareCandy<br><strong>${rareCandy}</strong></div></div>`; html += `<div class="bag-actions"><button class="btn-small use" onclick="useCatchballFromBag()">Usar Catchball</button></div>`; cont.innerHTML = html; } catch(e) { cont.innerHTML = 'Erro.'; } setTimeout(() => document.addEventListener('click', (ev) => { const p = document.getElementById('floatingBagPanel'); const b = document.getElementById('floatingBagIcon'); if(p && !p.contains(ev.target) && b && !b.contains(ev.target)) closeBattleBag(); }), 50); }
        async function useCatchballFromBag() { if (battleMode !== 'wild') { showToast('Apenas em batalhas selvagens.'); return; } if(!confirm('Usar uma Catchball agora?')) return; try { const res = await fetch('/api/turn', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ battleId, action: 'catch' }) }); const data = await res.json(); if (data && data.threw) await playCaptureAnimation(p2RawId, data.captured); if(data.events) await playEvents(data.events); if(data.captured) { if(data.sentToPC) showToast('Enviado para o PC!'); else showToast('Capturado!'); setTimeout(()=>{ window.location.href = '/forest?userId=<%= realUserId %>'; }, 1000); return; } closeBattleBag(); } catch(e) { showToast('Erro.'); } }
    </script>
</body>
</html>
