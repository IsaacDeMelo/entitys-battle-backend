<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Batalha</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #202020; --hp-high: #4fd05c; --hp-mid: #f6b93b; --hp-low: #e55039; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: white; font-family: 'Press Start 2P', cursive; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }
        
        .arena { flex: 1; background: url('/uploads/battle_bg.png') no-repeat center center; background-size: cover; position: relative; overflow: hidden; z-index: 10; image-rendering: pixelated; }
        
        /* HUDs (Barras de Vida) */
        .hud-panel { position: absolute; background: rgba(255, 255, 255, 0.9); border: 3px solid #333; border-radius: 8px 0 16px 0; padding: 10px; width: 180px; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); z-index: 50; }
        .hud-p2 { top: 30px; left: 10px; }
        .hud-p1 { bottom: 30%; right: 10px; }
        
        .poke-name { font-size: 0.65rem; margin-bottom: 5px; color: #000; text-transform: uppercase; text-shadow: none; }
        .poke-lv { font-size: 0.5rem; float: right; color: #555; }
        
        .bar-container { width: 100%; height: 8px; background: #555; border-radius: 4px; border: 1px solid #000; overflow: hidden; margin-bottom: 2px; }
        .hp-fill { height: 100%; width: 100%; background: var(--hp-high); transition: width 0.4s ease-out; }
        .en-fill { height: 100%; width: 100%; background: #3498db; transition: width 0.4s ease-out; }
        .stat-text { font-size: 0.5rem; text-align: right; color: #333; font-family: 'Press Start 2P'; margin-top: 2px; }

        /* Sprites e Anima√ß√µes */
        .fighter { position: absolute; width: 140px; height: 140px; display: flex; align-items: flex-end; justify-content: center; z-index: 20; }
        .fighter.p2-position { top: 80px; right: 40px; }
        .fighter.p1-position { bottom: 0; left: 40px; transform: scale(1.3); } /* Player maior pela perspectiva */
        
        .sprite img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); animation: idle 2s infinite ease-in-out; }
        .fighter.p1-position .sprite img { transform: scaleX(-1); --s: -1; }
        
        @keyframes idle { 0%, 100% { transform: translateY(0) scaleX(var(--s, 1)); } 50% { transform: translateY(-4px) scaleX(var(--s, 1)); } }
        
        /* Efeitos visuais */
        .hurt { animation: shakeHit 0.4s ease-in-out; }
        .hurt-effect { filter: sepia(1) hue-rotate(-50deg) saturate(5) drop-shadow(0 0 15px red) !important; }
        @keyframes shakeHit { 0%, 100% { transform: translate(0, 0); } 25% { transform: translate(-8px, 0); } 75% { transform: translate(8px, 0); } }
        
        .floating-text { font-family: 'Press Start 2P'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; text-shadow: 2px 2px 0 #000; animation: popUp 1s forwards; z-index: 100; pointer-events: none; }
        @keyframes popUp { 0% { opacity: 0; margin-top: 0; } 20% { opacity: 1; } 100% { opacity: 0; margin-top: -80px; } }
        .damage-text { color: #ff4757; } .heal-text { color: #2ed573; } .resist-text { color: #bdc3c7; font-size: 0.8rem; }

        /* Painel Inferior de Controle */
        .bottom-panel { height: auto; min-height: 35%; background: #2c3e50; border-top: 4px solid #f1c40f; display: flex; flex-direction: column; z-index: 100; padding: 10px; gap: 10px; }
        
        .battle-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; height: 100%; }
        
        .battle-log { background: #000; color: #ecf0f1; padding: 10px; font-family: monospace; font-size: 0.8rem; border: 2px solid #555; border-radius: 4px; overflow-y: auto; height: 120px; line-height: 1.4; }
        .log-entry { border-bottom: 1px solid #333; padding-bottom: 2px; margin-bottom: 2px; }

        .controls-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        
        .move-btn { background: #ecf0f1; border: 1px solid #bdc3c7; border-bottom: 4px solid #95a5a6; border-radius: 6px; padding: 8px; font-family: 'Press Start 2P'; font-size: 0.55rem; cursor: pointer; text-align: left; color: #2c3e50; transition: 0.1s; position: relative; }
        .move-btn:active { transform: translateY(2px); border-bottom-width: 1px; }
        .move-btn:disabled { opacity: 0.5; filter: grayscale(1); pointer-events: none; }
        .move-btn strong { display: block; margin-bottom: 4px; font-size: 0.65rem; }
        .move-btn small { float: right; color: #7f8c8d; }

        /* Overlay e Modais */
        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .podium { display: flex; gap: 20px; align-items: flex-end; margin-bottom: 20px; }
        .winner-box { transform: scale(1.2); text-align: center; } .loser-box { opacity: 0.6; transform: scale(0.9); text-align: center; filter: grayscale(1); }
        .btn-restart { background: #3498db; color: white; padding: 15px; border: none; font-family: 'Press Start 2P'; cursor: pointer; border-radius: 5px; }

        @media (max-width: 600px) {
            .battle-layout { grid-template-columns: 1fr; }
            .battle-log { height: 60px; }
            .hud-p1 { bottom: 42%; }
        }
    </style>
</head>
<body>
    <div class="arena">
        <div class="status-msg" id="statusMsg" style="display:none; position:absolute; top:50%; width:100%; text-align:center; color:#fff; text-shadow: 2px 2px 0 #000; z-index:200;">Aguardando...</div>
        <% if(isSpectator) { %> <div style="position:absolute; top:10px; width:100%; text-align:center; color:#f1c40f; font-size:0.7rem; z-index:200;">MODO ESPECTADOR</div> <% } %>

        <!-- HUD Player 2 (Inimigo) -->
        <div class="hud-panel hud-p2">
            <div class="poke-name"><%= p2.name %> <span class="poke-lv">Lv.<%= p2.level %></span></div>
            <div class="trainer-sub" style="font-size:0.5rem; color:#777;"><%= p2.playerName || 'CPU' %></div>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-<%= p2.id %>"></div></div>
            <div class="stat-text" style="display:none;"><span id="hp-val-<%= p2.id %>"><%= p2.hp %></span></div>
        </div>

        <!-- HUD Player 1 (Voc√™) -->
        <div class="hud-panel hud-p1">
            <div class="poke-name"><%= p1.name %> <span class="poke-lv">Lv.<%= p1.level %></span></div>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-<%= p1.id %>"></div></div>
            <div class="stat-text"><span id="hp-val-<%= p1.id %>"><%= p1.hp %></span>/<%= p1.maxHp %></div>
            <% if(!isSpectator) { %>
                <div class="bar-container" style="height:4px; margin-top:4px; border-color:#f39c12"><div class="en-fill" id="en-bar-<%= p1.id %>"></div></div>
                <div class="stat-text" style="color:#f39c12">EN: <span id="en-val-<%= p1.id %>"><%= p1.energy %></span></div>
            <% } %>
        </div>

        <!-- Lutadores -->
        <div class="fighter p2-position" id="fighter-<%= p2.id %>">
            <div class="sprite" id="sprite-<%= p2.id %>"><% if (p2.sprite) { %> <img src="<%= p2.sprite %>"> <% } else { %> üëø <% } %></div>
        </div>
        <div class="fighter p1-position" id="fighter-<%= p1.id %>">
            <div class="sprite" id="sprite-<%= p1.id %>"><% if (p1.sprite) { %> <img src="<%= p1.sprite %>"> <% } else { %> ü¶∏ <% } %></div>
        </div>

        <!-- Tela de Resultado -->
        <div id="overlay">
            <h1 id="result-title" style="color:#f1c40f; text-shadow: 2px 2px 0 #000;">RESULTADO</h1>
            <div class="podium">
                <div class="winner-box">
                    <div style="font-size:2rem;">üëë</div>
                    <img id="win-mon-img" style="width:80px; image-rendering:pixelated;">
                    <div id="win-name" style="color:white; margin-top:5px; font-size:0.7rem;"></div>
                </div>
                <div class="loser-box">
                    <img id="lose-mon-img" style="width:60px; image-rendering:pixelated;">
                    <div id="lose-name" style="color:white; margin-top:5px; font-size:0.6rem;"></div>
                </div>
            </div>
            <form action="/lobby" method="GET">
                <input type="hidden" name="userId" value="<%= isSpectator ? '' : myRoleId %>">
                <button type="submit" class="btn-restart">VOLTAR AO LOBBY</button>
            </form>
        </div>
    </div>

    <!-- Painel de Controle -->
    <div class="bottom-panel">
        <div class="battle-layout">
            <div class="battle-log" id="logBox">
                <div class="log-entry" style="color:#f1c40f">Batalha iniciada!</div>
            </div>

            <% if(!isSpectator) { %>
                <% if (battleMode === 'online' || battleMode === 'manual' || battleMode === 'wild') { %>
                    <div class="controls-panel" id="controlsPanel">
                        <% if (battleMode === 'wild') { %>
                            <button class="move-btn" style="background:#e74c3c; color:white; border-color:#c0392b;" onclick="sendAction('catch')"><strong>üî¥ CAPTURAR</strong></button>
                            <button class="move-btn" style="background:#95a5a6; color:white; border-color:#7f8c8d;" onclick="sendAction('run')"><strong>üèÉ FUGIR</strong></button>
                        <% } %>
                        <% p1.moves.forEach(move => { %>
                            <button class="move-btn" onclick="sendAction('move', '<%= move.id %>')" id="btn-<%= move.id %>">
                                <strong><%= move.name %> <%= move.icon %></strong> <small><%= move.cost %> EN</small>
                            </button>
                        <% }) %>
                        <button class="move-btn" style="background:#2ecc71; border-color:#27ae60;" onclick="sendAction('move', 'rest')"><strong>üí§ DESCANSAR</strong></button>
                    </div>
                <% } %>
            <% } %>
        </div>
        <!-- Spectator extra UI se precisar -->
        <% if(isSpectator) { %>
            <div style="display:flex; gap:10px;">
                <input type="text" id="chatInput" placeholder="Mensagem..." style="flex:1; padding:10px; border-radius:5px; border:none;">
                <button id="chatSend" style="padding:10px;">üí¨</button>
            </div>
        <% } %>
    </div>

    <script>
        history.pushState(null, null, location.href); window.onpopstate = function () { history.go(1); }; window.onpageshow = function(event) { if (event.persisted) { window.location.reload(); } };
        const socket = io();
        const battleMode = "<%= battleMode %>";
        const battleId = "<%= battleId %>";
        const initialData = <%- battleData %>;
        const myRoleId = "<%= myRoleId %>"; 
        const isSpectator = <%= isSpectator ? 'true' : 'false' %>;
        const myName = "<%= playerName || p1.playerName %>";
        const mySkin = "<%= playerSkin || p1.skin %>";
        const p1Id = "<%= p1.id %>"; const p2Id = "<%= p2.id %>";
        const p1Mon = "<%= p1.name %>"; const p2Mon = "<%= p2.name %>";
        let currentEnergy = parseInt("<%= p1.energy %>");
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        const p1Data = { name: "<%= p1.playerName %>", skin: "<%= p1.skin %>", sprite: "<%= p1.sprite %>", mon: "<%= p1.name %>" };
        const p2Data = { name: "<%= p2.playerName %>", skin: "<%= p2.skin %>", sprite: "<%= p2.sprite %>", mon: "<%= p2.name %>" };

        if (isSpectator) {
            socket.emit('join_spectator', { roomId: battleId, name: myName, skin: mySkin });
            const chatInput = document.getElementById('chatInput'); const chatBtn = document.getElementById('chatSend');
            const sendChat = () => { const msg = chatInput.value.trim(); if (msg) { socket.emit('send_chat', { msg, roomId: battleId }); chatInput.value = ''; chatInput.blur(); } };
            chatBtn.addEventListener('click', sendChat); chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
            socket.on('chat_message', (data) => addLog(`[CHAT] ${data.msg}`)); 
        }
        
        function updateBar(id, cur, max, type) { 
            const pct = Math.max(0, (cur / max) * 100); 
            const fill = document.getElementById(`${type}-bar-${id}`); 
            if(fill) {
                fill.style.width = pct + '%'; 
                if(type === 'hp') {
                    if(pct < 20) fill.style.background = '#e55039';
                    else if(pct < 50) fill.style.background = '#f6b93b';
                    else fill.style.background = '#4fd05c';
                    const valEl = document.getElementById(`hp-val-${id}`);
                    if(valEl) valEl.innerText = Math.max(0, cur);
                }
            }
            if(type === 'en' && id === p1Id && !isSpectator) { 
                currentEnergy = cur; 
                document.getElementById('en-val-' + id).innerText = cur; 
                updateButtons(); 
            } 
        }

        function updateButtons() { if(isSpectator) return; document.querySelectorAll('.move-btn:not([onclick*="rest"]):not([onclick*="catch"]):not([onclick*="run"])').forEach(btn => { const small = btn.querySelector('small'); if(small) { const cost = parseInt(small.innerText); btn.disabled = (currentEnergy < cost); } }); }
        
        function setControlsState(enabled) { if(isSpectator) return; const panel = document.getElementById('controlsPanel'); if(!panel) return; if (enabled) panel.style.opacity = "1"; else panel.style.opacity = "0.5"; const btns = panel.querySelectorAll('button'); btns.forEach(b => b.disabled = !enabled); if(enabled) updateButtons(); }
        
        function addLog(msg) { const box = document.getElementById('logBox'); if(!box) return; const entry = document.createElement('div'); entry.className = 'log-entry'; entry.innerText = msg; box.appendChild(entry); box.scrollTop = box.scrollHeight; }
        
        async function playEvents(events) { 
            for (let evt of events) { 
                if (evt.type === 'INIT') continue; 
                if (evt.type === 'USE_MOVE') { 
                    addLog(`${evt.actorId === p1Id ? p1Mon : p2Mon} usou ${evt.moveName}!`); 
                    const spriteContainer = document.getElementById(`sprite-${evt.actorId}`); 
                    const moveX = (evt.actorId === p1Id) ? '20px' : '-20px'; 
                    if(spriteContainer) { spriteContainer.style.transition = 'transform 0.1s'; spriteContainer.style.transform = `translateX(${moveX}) ${evt.actorId === p1Id ? 'scaleX(-1)' : ''}`; await wait(100); spriteContainer.style.transform = `${evt.actorId === p1Id ? 'scaleX(-1)' : ''}`; }
                    if(!isSpectator && evt.actorId == p1Id) updateBar(evt.actorId, evt.newEnergy, <%= p1.maxEnergy %>, 'en'); 
                    await wait(300); 
                } else if (evt.type === 'ATTACK_HIT') { 
                    const spriteImg = document.querySelector(`#sprite-${evt.targetId} img`); 
                    const container = document.getElementById(`fighter-${evt.targetId}`); 
                    if(spriteImg) spriteImg.classList.add('hurt-effect'); 
                    if(container) container.classList.add('hurt'); 
                    const txt = document.createElement('div'); 
                    txt.className = 'floating-text ' + (evt.isNotEffective ? 'resist-text' : 'damage-text'); 
                    txt.innerText = evt.isBlocked ? 'üõ°Ô∏è' : `-${evt.damage}`; 
                    if(container) container.appendChild(txt); 
                    await wait(400); 
                    if(spriteImg) spriteImg.classList.remove('hurt-effect'); 
                    if(container) container.classList.remove('hurt'); 
                    txt.remove(); 
                    const maxHp = (evt.targetId == p1Id) ? <%= p1.maxHp %> : <%= p2.maxHp %>; 
                    updateBar(evt.targetId, evt.newHp, maxHp, 'hp'); 
                    if(evt.isEffective) addLog("Foi super efetivo!");
                    if(evt.isNotEffective) addLog("N√£o foi muito efetivo...");
                    await wait(400); 
                } else if (evt.type === 'HEAL') { 
                    addLog(`${evt.actorId === p1Id ? p1Mon : p2Mon} se curou!`); 
                    updateBar(evt.actorId, evt.newHp, (evt.actorId === p1Id ? <%= p1.maxHp %> : <%= p2.maxHp %>), 'hp'); 
                    const txt = document.createElement('div'); txt.className = 'floating-text heal-text'; txt.innerText = `+${evt.amount}`; 
                    document.getElementById(`fighter-${evt.actorId}`).appendChild(txt); 
                    setTimeout(() => txt.remove(), 1000); await wait(500); 
                } else if (evt.type === 'REST') { 
                    addLog(`${evt.actorId === p1Id ? p1Mon : p2Mon} descansou.`); 
                    if(!isSpectator && evt.actorId == p1Id) updateBar(evt.actorId, evt.newEnergy, <%= p1.maxEnergy %>, 'en'); 
                    await wait(500); 
                } else if (evt.type === 'MSG') {
                    addLog(evt.text); await wait(500);
                }
            } 
        }

        async function sendAction(type, moveId) { 
            setControlsState(false); 
            if (battleMode === 'online') { 
                if (type === 'move') { 
                    document.getElementById('statusMsg').innerText = "Aguardando oponente..."; 
                    document.getElementById('statusMsg').style.display = "block"; 
                    socket.emit('online_move', { roomId: battleId, moveId, playerId: myRoleId }); 
                } 
            } else { 
                const res = await fetch('/api/turn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ battleId, action: type, moveId }) }); 
                const data = await res.json(); 
                if (data.events) await playEvents(data.events); 
                if(data.captured) { alert("Capturado com sucesso!"); window.location.href = '/lobby?userId=<%= myRoleId %>'; } 
                else if (data.fled) { alert("Voc√™ fugiu!"); window.location.href = '/lobby?userId=<%= myRoleId %>'; } 
                else if(data.finished) { endGame(data.winnerId); } 
                else { 
                    if (data.p1State) { updateBar(p1Id, data.p1State.hp, <%= p1.maxHp %>, 'hp'); if(data.p1State.energy) updateBar(p1Id, data.p1State.energy, <%= p1.maxEnergy %>, 'en'); }
                    if (data.p2State) updateBar(p2Id, data.p2State.hp, <%= p2.maxHp %>, 'hp'); 
                    setControlsState(true); 
                } 
            } 
        }

        function endGame(winnerId) { 
            const overlay = document.getElementById('overlay'); 
            const title = document.getElementById('result-title'); 
            const winName = document.getElementById('win-name'); 
            const loseName = document.getElementById('lose-name'); 
            const winMon = document.getElementById('win-mon-img'); 
            const loseMon = document.getElementById('lose-mon-img'); 
            const isP1Win = (winnerId === p1Id); 
            const winner = isP1Win ? p1Data : p2Data; 
            const loser = isP1Win ? p2Data : p1Data; 
            winName.innerText = winner.name; loseName.innerText = loser.name; 
            winMon.src = winner.sprite ? winner.sprite : ''; 
            loseMon.src = loser.sprite ? loser.sprite : ''; 
            if (isSpectator) { title.innerText = `VENCEDOR: ${winner.name}`; } 
            else { if (winnerId === 'draw') title.innerText = "EMPATE!"; else if (winnerId === p1Id) title.innerText = "VIT√ìRIA!"; else title.innerText = "DERROTA..."; } 
            overlay.style.display = 'flex'; 
        }

        socket.on('turn_result', async (data) => { 
            document.getElementById('statusMsg').style.display = "none"; 
            await playEvents(data.events); 
            if(data.winnerId) endGame(data.winnerId); else if(!isSpectator) setControlsState(true); 
        });
        socket.on('opponent_ready', () => { if(!isSpectator) { document.getElementById('statusMsg').style.display = "block"; document.getElementById('statusMsg').innerText = "Oponente pronto!"; } });
        
        window.onload = () => { 
            if(battleMode === 'online' && !isSpectator) socket.emit('join_room', battleId); 
            updateBar(p1Id, <%= p1.hp %>, <%= p1.maxHp %>, 'hp'); 
            updateBar(p2Id, <%= p2.hp %>, <%= p2.maxHp %>, 'hp'); 
            if(!isSpectator) updateBar(p1Id, <%= p1.energy %>, <%= p1.maxEnergy %>, 'en'); 
            if(battleMode === 'auto') playEvents(initialData.log).then(() => endGame(initialData.winnerId)); 
            else if (!isSpectator) setControlsState(true); 
        };
    </script>
</body>
</html>