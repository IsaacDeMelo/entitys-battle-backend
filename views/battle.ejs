<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Batalha</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/scripts/common.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@500;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-color: #202020; --hp-high: #4fd05c; --hp-mid: #f6b93b; --hp-low: #e55039; }
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: var(--bg-color); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }
        
        /* BACKGROUND DINAMICO */
        .arena { flex: 1; background: url('/uploads/<%= bgImage %>') no-repeat center center; background-size: cover; position: relative; overflow: hidden; z-index: 10; image-rendering: pixelated; }
        
        /* HUDs */
        .hud-panel { position: absolute; background: rgba(15, 15, 20, 0.95); padding: 6px 10px; border-radius: 6px; border: 2px solid #555; z-index: 30; width: 160px; font-family: 'Press Start 2P', cursive; bottom: 10px; top: auto; }
        .hud-p1 { left: 10px; border-left: 5px solid #3498db; text-align: left; }
        .hud-p2 { right: 10px; border-right: 5px solid #e74c3c; text-align: right; }
        
        .poke-name { font-size: 0.55rem; margin-bottom: 4px; color: #fff; text-shadow: 1px 1px 0 #000; text-transform: uppercase; letter-spacing: 0.5px; }
        .poke-lv { font-size: 0.45rem; color: #f1c40f; margin-left: 4px; }
        .trainer-sub { font-size: 0.45rem; color: #bbb; margin-bottom: 4px; text-transform: uppercase; font-family: sans-serif; font-weight: bold; }
        
        .bar-container { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; border: 1px solid #000; margin-bottom: 2px; position: relative; }
        .hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #2ecc71, #27ae60); transition: width 0.5s ease-out; }
        .en-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #f1c40f, #f39c12); transition: width 0.5s ease-out; }
        .stat-text { font-size: 0.5rem; color: #ddd; text-shadow: 1px 1px 0 #000; display: block; }

        /* LUTADORES */
        .fighter { position: absolute; width: 300px; height: 150px; display: flex; align-items: flex-end; z-index: 20; pointer-events: none; top: 45%; transform: translateY(-50%); }
        .fighter.p2-position { right: 5%; justify-content: flex-end; }
        .fighter.p2-position .trainer { order: 2; margin-left: -30px; z-index: 21; background-position-y: 33.33%; } 
        .fighter.p2-position .sprite { order: 1; z-index: 22; }

        .fighter.p1-position { left: 5%; justify-content: flex-start; }
        .fighter.p1-position .trainer { order: 1; margin-right: -30px; z-index: 21; background-position-y: 66.66%; }
        .fighter.p1-position .sprite { order: 2; z-index: 22; transform: scaleX(-1); }

        .sprite { position: relative; width: 120px; height: 120px; transition: transform 0.2s; }
        .sprite img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); animation: breathe 3s infinite ease-in-out; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.04); } }

        .trainer { position: relative; width: 64px; height: 64px; background-size: 400% auto; image-rendering: pixelated; margin-bottom: 20px; }
        <% for(let i = 1; i <= 20; i++) { %> .trainer[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); } <% } %>
        .trainer[data-skin="char1"] { background-image: url('/uploads/char1.png'); }

        /* replaced continuous commanding animation with single-frame flashes handled in JS */
        @keyframes command-walk { from { background-position-x: 0; } to { background-position-x: -400%; } }
        .trainer.frame-1 { background-position-x: -100%; }

        .hurt-effect { filter: sepia(1) hue-rotate(-50deg) saturate(5) drop-shadow(0 0 15px red) !important; }
        .hurt-p2 { animation: shakeHitP2 0.4s ease-in-out; }
        @keyframes shakeHitP2 { 0% { transform: translate(0, 0); } 25% { transform: translate(8px, 0); } 50% { transform: translate(-8px, 0); } 75% { transform: translate(8px, 0); } 100% { transform: translate(0, 0); } }
        .hurt-p1 { animation: shakeHitP1 0.4s ease-in-out; }
        @keyframes shakeHitP1 { 0% { transform: translate(0, 0) scaleX(-1); } 25% { transform: translate(-8px, 0) scaleX(-1); } 50% { transform: translate(8px, 0) scaleX(-1); } 75% { transform: translate(-8px, 0) scaleX(-1); } 100% { transform: translate(0, 0) scaleX(-1); } }

        .command-bubble { position: absolute; top: -40px; left: 50%; transform: translateX(-50%) scale(0); background: #fff; color: #000; padding: 8px 12px; border-radius: 12px; border: 2px solid #000; font-family: 'Press Start 2P'; font-size: 0.5rem; white-space: nowrap; z-index: 100; opacity: 0; transition: all 0.2s; pointer-events: none; box-shadow: 4px 4px 0 rgba(0,0,0,0.3); }
        .command-bubble.show { opacity: 1; transform: translateX(-50%) scale(1); top: -60px; }
        
        .floating-text { font-family: 'Press Start 2P'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 1.2rem; text-shadow: 2px 2px 0 #000; animation: popUp 1.2s forwards; z-index: 100; pointer-events: none; width: 300px; text-align: center; }
        @keyframes popUp { 0% { opacity: 0; margin-top: 0; } 10% { opacity: 1; } 100% { opacity: 0; margin-top: -100px; } }
        .damage-text { color: #ff4757; font-size: 1.5rem; } 
        .heal-text { color: #2ed573; } 
        .resist-text { color: #bdc3c7; font-size: 0.8rem; margin-top: -20px !important; }
        .super-text { color: #f1c40f; font-size: 0.8rem; margin-top: -20px !important; text-shadow: 2px 2px 0 #c0392b; }

        .bottom-panel { width: 100%; height: auto; background: #1a1a2e; border-top: 3px solid #3498db; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .controls-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px; }
        .battle-log { padding: 15px; overflow-y: auto; font-family: monospace; font-size: 13px; color: #ecf0f1; height: 150px; background: #111; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .move-btn { background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: 0.1s; padding: 10px; }
        .move-btn:active { transform: scale(0.96); border-color: #f1c40f; }
        .move-btn:disabled { opacity: 0.5; pointer-events: none; }
        .rest-btn { grid-column: span 2; background: #27ae60; border-color: #2ecc71; }

        #overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        #overlay h1 { font-family: 'Press Start 2P'; text-align: center; color: #f1c40f; text-shadow: 0 4px 0 #c27c0e; margin-bottom: 40px; font-size: 1.5rem; }
        .podium { display: flex; align-items: flex-end; gap: 30px; margin-bottom: 30px; }
        .winner-box { display: flex; flex-direction: column; align-items: center; transform: scale(1.2); z-index: 2; position: relative; }
        .loser-box { display: flex; flex-direction: column; align-items: center; opacity: 0.7; filter: grayscale(1); transform: scale(0.9); }
        .podium-avatar-group { position: relative; width: 120px; height: 120px; }
        .podium-trainer { width: 64px; height: 64px; background-size: 400% auto; background-position: 0 0; image-rendering: pixelated; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
        .podium-monster { width: 100px; height: 100px; object-fit: contain; image-rendering: pixelated; position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1; opacity: 0.9; }
        .crown { font-size: 2rem; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); z-index: 3; text-shadow: 0 0 10px gold; animation: float 2s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-5px); } }
        .podium-base { height: 10px; width: 100%; border-radius: 50%; margin-top: -10px; z-index: 0; }
        .winner-box .podium-base { background: #f1c40f; box-shadow: 0 0 20px #f1c40f; }
        .loser-box .podium-base { background: #555; }
        .name-tag { font-family: 'Press Start 2P'; font-size: 0.6rem; margin-top: 15px; color: white; text-align: center; background: #333; padding: 5px 10px; border-radius: 4px; border: 1px solid #777; }
        .btn-restart { background: #3498db; color: white; padding: 15px 30px; border-radius: 30px; border: none; font-family: 'Press Start 2P'; font-size: 0.8rem; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #2980b9; }
        .spectator-banner { position: absolute; bottom: 0; width: 100%; text-align: center; background: rgba(0,0,0,0.7); color: #f1c40f; padding: 5px; font-family: 'Press Start 2P'; font-size: 0.7rem; pointer-events: none; z-index: 50; }
        #bleachers { width: 100%; height: 200px; background: #2c3e50; border-top: 4px solid #111; position: relative; }
        #chat-container { width: 100%; height: 60px; background: #1a1a2e; border-top: 2px solid #3498db; display: flex; align-items: center; justify-content: center; }
        @media (max-width: 600px) { .battle-layout { grid-template-columns: 1fr; } .battle-log { height: 60px; } }
        /* Capture animation elements */
        .pokeball { position: absolute; width: 48px; height: 48px; background-image: url('/uploads/pokeball.png'); background-size: contain; background-repeat: no-repeat; z-index: 200; transform-origin: center; pointer-events: none; }
        .pokeball.shake { animation: shakePokeball 0.9s ease-in-out; }
        @keyframes shakePokeball { 0% { transform: translateY(0) rotate(0); } 25% { transform: translateY(-6px) rotate(-8deg); } 50% { transform: translateY(0) rotate(8deg); } 75% { transform: translateY(-4px) rotate(-6deg); } 100% { transform: translateY(0) rotate(0); } }

        /* Floating minimal bag panel */
        #floatingBagPanel { position: fixed; right: 12px; bottom: 200px; width: 260px; background: rgba(10,12,16,0.95); border: 1px solid rgba(255,255,255,0.04); border-radius: 10px; padding: 10px; z-index: 80; box-shadow: 0 8px 24px rgba(0,0,0,0.6); display: none; color: #ddd; }
        #floatingBagPanel h4 { margin: 0 0 8px 0; font-size: 0.7rem; color: #f1c40f; font-family: 'Press Start 2P'; }
        #floatingBagPanel .bag-row { display:flex; gap:8px; align-items:center; }
        #floatingBagPanel .bag-item { flex:1; background: rgba(255,255,255,0.02); padding:8px; border-radius:6px; font-size:0.8rem; text-align:center; }
        #floatingBagPanel .bag-actions { display:flex; gap:8px; margin-top:8px; }
        #floatingBagPanel .btn-small { flex:1; padding:8px; border-radius:6px; border:none; cursor:pointer; font-weight:700; }
        #floatingBagPanel .btn-small.use { background:#e67e22; color:#fff; }
        #floatingBagPanel .btn-small.item { background:#f1c40f; color:#111; }
        #floatingBagPanel .close-x { position:absolute; right:8px; top:6px; background:transparent; border:none; color:#999; font-weight:700; cursor:pointer; }
        .floating-bag-button { position: fixed; right: 12px; bottom: 90px; z-index: 75; width:44px; height:44px; border-radius:50%; background:#f39c12; border:2px solid #d35400; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 6px 18px rgba(0,0,0,0.4); cursor:pointer; }
        .floating-hud-money { position: fixed; right: 12px; bottom: 140px; z-index: 75; color:#f1c40f; font-family:'Press Start 2P'; font-size:11px; text-align:center; }
    </style>
</head>
<body>
    <div class="arena">
        <div class="status-msg" id="statusMsg" style="display:none; position:absolute; top:50%; width:100%; text-align:center; color:#fff;">Aguardando...</div>
        <% if(isSpectator) { %> <div class="spectator-banner">MODO ESPECTADOR</div> <% } %>

        <div class="hud-panel hud-p1">
            <div class="poke-name"><%= p1.name %> <span class="poke-lv">Lv.<%= p1.level %></span></div>
            <div class="trainer-sub"><%= p1.playerName || 'Voc√™' %></div>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-<%= p1.instanceId %>"></div></div>
            <div class="stat-text"><span id="hp-val-<%= p1.instanceId %>"><%= p1.hp %></span>/<%= p1.maxHp %></div>
            <% if(!isSpectator) { %>
                <div class="bar-container" style="height:5px; margin-top:3px;"><div class="en-fill" id="en-bar-<%= p1.instanceId %>"></div></div>
                <div class="stat-text" style="color:#f1c40f">EN: <span id="en-val-<%= p1.instanceId %>"><%= p1.energy %></span></div>
            <% } %>
        </div>

        <div class="hud-panel hud-p2">
            <div class="poke-name"><%= p2.name %> <span class="poke-lv">Lv.<%= p2.level %></span></div>
            <% if(battleMode !== 'wild') { %>
                <div class="trainer-sub"><%= p2.playerName || 'CPU' %></div>
            <% } else { %>
                <div class="trainer-sub">Selvagem</div>
            <% } %>
            <div class="bar-container"><div class="hp-fill" id="hp-bar-<%= p2.instanceId %>"></div></div>
            <div class="stat-text" style="text-align:right"><span id="hp-val-<%= p2.instanceId %>"><%= p2.hp %></span>/<%= p2.maxHp %></div>
        </div>

        <div class="fighter p2-position" id="fighter-<%= p2.instanceId %>">
            <div class="command-bubble" id="bubble-<%= p2.instanceId %>"></div>
            <% if(battleMode !== 'wild') { %>
                <div class="trainer" id="trainer-<%= p2.instanceId %>" data-skin="<%= p2.skin || 'char1' %>"></div>
            <% } %>
            <div class="sprite" id="sprite-<%= p2.instanceId %>">
                <!-- IMAGEM RESOLVIDA -->
                <img src="<%= (p2.sprite.startsWith('http') || p2.sprite.startsWith('data:')) ? p2.sprite : '/uploads/' + p2.sprite %>">
            </div>
        </div>

        <div class="fighter p1-position" id="fighter-<%= p1.instanceId %>">
            <div class="command-bubble" id="bubble-<%= p1.instanceId %>"></div>
            <div class="trainer" id="trainer-<%= p1.instanceId %>" data-skin="<%= p1.skin %>"></div>
            <div class="sprite" id="sprite-<%= p1.instanceId %>">
                <img src="<%= (p1.sprite.startsWith('http') || p1.sprite.startsWith('data:')) ? p1.sprite : '/uploads/' + p1.sprite %>">
            </div>
        </div>

        <!-- floating bag / money HUD -->
        <div id="floatingBagBtn">
            <div id="floatingBagIcon" class="floating-bag-button" onclick="openBattleBag()">üéí</div>
            <div id="hud-money" class="floating-hud-money">0</div>
        </div>

        <div id="overlay">
            <div id="result-content">
                <h1 id="result-title">RESULTADO</h1>
                <div class="podium">
                    <div class="winner-box">
                        <div class="crown">üëë</div>
                        <div class="podium-avatar-group">
                            <img id="win-mon-img" class="podium-monster" src="">
                            <div id="win-trainer-div" class="podium-trainer"></div>
                        </div>
                        <div class="podium-base"></div>
                        <div class="name-tag" id="win-name"></div>
                    </div>
                    <div class="loser-box">
                        <div class="podium-avatar-group">
                            <img id="lose-mon-img" class="podium-monster" src="">
                            <div id="lose-trainer-div" class="podium-trainer"></div>
                        </div>
                        <div class="podium-base"></div>
                        <div class="name-tag" id="lose-name"></div>
                    </div>
                </div>
                <form action="/lobby" method="GET" style="text-align:center;">
                    <input type="hidden" name="userId" value="<%= realUserId %>">
                    <button type="submit" class="btn-restart">VOLTAR AO LOBBY</button>
                </form>
            </div>
        </div>
    </div>

    <% if(isSpectator) { %>
        <div id="bleachers"></div>
        <div id="chat-container">
            <input type="text" id="chatInput" placeholder="Chat..." style="width:80%; padding:10px;">
            <button id="chatSend">OK</button>
        </div>
    <% } else { %>
        <div class="bottom-panel">
            <% if (battleMode === 'online' || battleMode === 'manual' || battleMode === 'wild') { %>
                <div class="controls-panel" id="controlsPanel">
                    <% if (battleMode === 'wild') { %>
                        <button class="move-btn" style="background:#e67e22; border-color:#d35400" onclick="sendAction('catch')"><strong>üî¥ Capturar</strong></button>
                        <button class="move-btn" style="background:#95a5a6; border-color:#7f8c8d" onclick="sendAction('run')"><strong>üèÉ Fugir</strong></button>
                    <% } %>
                    <% p1.moves.forEach(move => { %>
                        <button class="move-btn" onclick="sendAction('move', '<%= move.id %>')" id="btn-<%= move.id %>">
                            <strong><%= move.icon %> <%= move.name %></strong>
                            <small><%= move.cost %> EN</small>
                        </button>
                    <% }) %>
                    <button class="move-btn rest-btn" onclick="sendAction('move', 'rest')">üí§ Descansar</button>
                </div>
            <% } else { %>
                <div class="battle-log" id="logBox"></div>
            <% } %>
        </div>
    <% } %>

    <!-- Minimal floating BAG panel for battle -->
    <div id="floatingBagPanel" aria-hidden="true">
        <button class="close-x" aria-label="Fechar" onclick="closeBattleBag()">‚úï</button>
        <h4>BAG</h4>
        <div id="battleBagContent">Carregando...</div>
    </div>

    <script>
        history.pushState(null, null, location.href); window.onpopstate = function () { history.go(1); }; window.onpageshow = function(event) { if (event.persisted) { window.location.reload(); } };
        const socket = io();
        const battleMode = "<%= battleMode %>";
        const battleId = "<%= battleId %>";
        const initialData = <%- battleData %>;
        const myRoleId = "<%= myRoleId %>"; 
        const isSpectator = <%= isSpectator ? 'true' : 'false' %>;
        
        const p1Id = "<%= p1.instanceId %>"; const p2Id = "<%= p2.instanceId %>";
        const p1Mon = "<%= p1.name %>"; const p2Mon = "<%= p2.name %>";
        
        // current HP trackers (kept in sync with bars)
        let p1CurHp = Number(<%= p1.hp %>); let p2CurHp = Number(<%= p2.hp %>);
        let currentEnergy = parseInt("<%= p1.energy %>");
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        
        // Helper para imagens JS
        function resolveImg(src) { return (src.startsWith('http') || src.startsWith('data:')) ? src : '/uploads/' + src; }

        const p1Data = { name: "<%= p1.playerName %>", skin: "<%= p1.skin %>", sprite: resolveImg("<%= p1.sprite %>"), mon: "<%= p1.name %>" };
        const p2Data = { name: "<%= p2.playerName %>", skin: "<%= p2.skin %>", sprite: resolveImg("<%= p2.sprite %>"), mon: "<%= p2.name %>" };

        if (isSpectator) { socket.emit('join_spectator', { roomId: battleId }); }
        if(battleMode === 'online' && !isSpectator) { socket.emit('join_room', battleId); }

        async function speak(actorId, moveName) {
            const bubble = document.getElementById(`bubble-${actorId}`);
            const trainer = document.getElementById(`trainer-${actorId}`);
            const monName = (actorId === p1Id) ? p1Mon : p2Mon;
            if(bubble) {
                bubble.innerText = (moveName === 'rest') ? `${monName}, volte!` : `${monName}, ${moveName}!`;
                bubble.classList.add('show');
            }
            if(trainer) {
                animateTrainerCommand(trainer).catch(()=>{});
            }
            await wait(1000); 
            if(bubble) bubble.classList.remove('show');
        }

        // Play frame-1, back to idle, then repeat once (short flash sequence)
        async function animateTrainerCommand(trainerEl) {
            try {
                trainerEl.classList.add('frame-1');
                await wait(180);
                trainerEl.classList.remove('frame-1');
                await wait(120);
                trainerEl.classList.add('frame-1');
                await wait(180);
                trainerEl.classList.remove('frame-1');
            } catch (e) {}
        }

        function updateBar(id, cur, max, type) { 
            const pct = Math.max(0, (cur / max) * 100); 
            const fill = document.getElementById(`${type}-bar-${id}`); 
            if(fill) {
                fill.style.width = pct + '%'; 
                if(type === 'hp') {
                    const txt = document.getElementById(`hp-val-${id}`);
                    if(txt) txt.innerText = Math.max(0, cur);
                }
            }
            // keep local HP state for client-side checks
            if(type === 'hp') {
                if(id === p1Id) p1CurHp = Number(cur);
                else if(id === p2Id) p2CurHp = Number(cur);
            }
            if(type === 'en' && id === p1Id && !isSpectator) { 
                currentEnergy = cur; 
                const enTxt = document.getElementById('en-val-' + id);
                if(enTxt) enTxt.innerText = cur; 
                updateButtons(); 
            } 
        }

        function updateButtons() { 
            if(isSpectator) return; 
            document.querySelectorAll('.move-btn:not(.rest-btn)').forEach(btn => { 
                const small = btn.querySelector('small');
                // CORRE√á√ÉO: Evita erro se n√£o tiver small
                if(small) {
                    const cost = parseInt(small.innerText); 
                    btn.disabled = (currentEnergy < cost); 
                }
            }); 
        }
        
        function setControlsState(enabled) { if(isSpectator) return; const panel = document.getElementById('controlsPanel'); if(!panel) return; panel.style.opacity = enabled ? "1" : "0.5"; const btns = panel.querySelectorAll('button'); btns.forEach(b => b.disabled = !enabled); if(enabled) updateButtons(); }
        
        async function playEvents(events) { 
            for (let evt of events) { 
                if (evt.type === 'INIT') continue; 
                if (evt.type === 'MSG') {
                    // show simple toast and append to log if present
                    try { if(evt.text) showToast(evt.text); } catch(e) {}
                    const lb = document.getElementById('logBox'); if(lb) { const div = document.createElement('div'); div.className = 'log-entry'; div.innerText = evt.text; lb.appendChild(div); lb.scrollTop = lb.scrollHeight; }
                    await wait(200);
                    continue;
                }
                if (evt.type === 'USE_MOVE') { 
                    // CORRE√á√ÉO: Se for selvagem (p2) e wild mode, n√£o fala
                    if (battleMode === 'wild' && evt.actorId === p2Id) {
                        // Sil√™ncio (apenas delay)
                        await wait(500);
                    } else {
                        await speak(evt.actorId, evt.moveName);
                    }

                    const spriteContainer = document.getElementById(`sprite-${evt.actorId}`); 
                    const isP1Actor = (evt.actorId === p1Id); 
                    const moveX = isP1Actor ? '40px' : '-40px'; 
                    if(spriteContainer) { 
                        spriteContainer.style.transform = `translateX(${moveX}) ${isP1Actor ? 'scaleX(-1)' : ''}`; 
                        await wait(200); 
                        spriteContainer.style.transform = `${isP1Actor ? 'scaleX(-1)' : ''}`; 
                    } 
                    if(!isSpectator && isP1Actor) updateBar(evt.actorId, evt.newEnergy, <%= p1.maxEnergy %>, 'en'); 
                    await wait(300); 
                } else if (evt.type === 'ATTACK_HIT') { 
                    const spriteContainer = document.getElementById(`sprite-${evt.targetId}`);
                    const spriteImg = spriteContainer ? spriteContainer.querySelector('img') : null;
                    const fighterDiv = document.getElementById(`fighter-${evt.targetId}`);
                    if(spriteImg) spriteImg.classList.add('hurt-effect'); 
                    const hurtClass = (evt.targetId === p1Id) ? 'hurt-p1' : 'hurt-p2';
                    if(spriteContainer) spriteContainer.classList.add(hurtClass); 
                    const damageTxt = document.createElement('div'); damageTxt.className = 'floating-text damage-text'; damageTxt.innerText = evt.isBlocked ? 'üõ°Ô∏è' : `-${evt.damage}`; if(fighterDiv) fighterDiv.appendChild(damageTxt);
                    if(evt.isEffective) { const effectTxt = document.createElement('div'); effectTxt.className = 'floating-text super-text'; effectTxt.innerText = "SUPER EFETIVO!"; effectTxt.style.marginTop = "30px"; if(fighterDiv) fighterDiv.appendChild(effectTxt); setTimeout(() => effectTxt.remove(), 1200); } 
                    else if(evt.isNotEffective) { const effectTxt = document.createElement('div'); effectTxt.className = 'floating-text resist-text'; effectTxt.innerText = "POUCO EFETIVO..."; effectTxt.style.marginTop = "30px"; if(fighterDiv) fighterDiv.appendChild(effectTxt); setTimeout(() => effectTxt.remove(), 1200); }
                    await wait(500); 
                    if(spriteImg) spriteImg.classList.remove('hurt-effect'); if(spriteContainer) spriteContainer.classList.remove(hurtClass); damageTxt.remove(); 
                    const maxHp = (evt.targetId == p1Id) ? <%= p1.maxHp %> : <%= p2.maxHp %>; updateBar(evt.targetId, evt.newHp, maxHp, 'hp'); await wait(500); 
                } else if (evt.type === 'HEAL') { 
                    await speak(evt.actorId, 'Cura');
                    updateBar(evt.actorId, evt.newHp, (evt.actorId === p1Id ? <%= p1.maxHp %> : <%= p2.maxHp %>), 'hp'); 
                    const txt = document.createElement('div'); txt.className = 'floating-text heal-text'; txt.innerText = `+${evt.amount}`; 
                    document.getElementById(`fighter-${evt.actorId}`).appendChild(txt); 
                    setTimeout(() => txt.remove(), 1000); await wait(500); 
                } 
            } 
            // After processing events, if either HP reached zero but server didn't signal finished, end locally
            if(!isSpectator) {
                if (p1CurHp <= 0 && p2CurHp > 0) { endGame(p2Id); return; }
                if (p2CurHp <= 0 && p1CurHp > 0) { endGame(p1Id); return; }
                if (p1CurHp <= 0 && p2CurHp <= 0) { endGame('draw'); return; }
            }
        }

        // Capture animation: throw pokeball to target and shake
        function playCaptureAnimation(targetId) {
            return new Promise(async (resolve) => {
                try {
                    const targetSprite = document.getElementById(`sprite-${targetId}`);
                    if(!targetSprite) { resolve(); return; }
                    const rect = targetSprite.getBoundingClientRect();
                    // create pokeball element
                    const ball = document.createElement('div'); ball.className = 'pokeball';
                    // fallback emoji in case image asset is missing
                    ball.style.display = 'flex'; ball.style.alignItems = 'center'; ball.style.justifyContent = 'center'; ball.style.fontSize = '28px'; ball.style.color = '#000'; ball.innerText = 'üî¥';
                    document.body.appendChild(ball);
                    // start from bottom center (approx player area)
                    const startX = window.innerWidth * 0.5; const startY = window.innerHeight - 120;
                    ball.style.left = (startX - 24) + 'px'; ball.style.top = (startY - 24) + 'px';
                    // play sound if available
                    try { const s = new Audio('/uploads/pokeball.wav'); s.volume = 0.9; s.play().catch(()=>{}); } catch(e) {}
                    // target center
                    const tx = rect.left + rect.width/2 - 24; const ty = rect.top + rect.height/2 - 24;
                    // animate to target
                    ball.animate([
                        { transform: `translate(0px,0px) scale(1)` , opacity:1 },
                        { transform: `translate(${tx - startX + 24}px, ${ty - startY + 24}px) scale(0.9)` , opacity:1 }
                    ], { duration: 600, easing: 'cubic-bezier(.2,.8,.2,1)', fill: 'forwards' });
                    await wait(620);
                    // shake effect on pokeball a few times
                    ball.classList.add('shake');
                    await wait(900);
                    // success effect: small pop and remove
                    ball.animate([{ transform: 'scale(1)' }, { transform: 'scale(0.2)', opacity:0 }], { duration: 250, easing: 'ease-out', fill: 'forwards' });
                    setTimeout(() => { ball.remove(); resolve(); }, 260);
                } catch (e) { resolve(); }
            });
        }

        async function sendAction(type, moveId) { 
            setControlsState(false); 
            if (battleMode === 'online') { 
                if (type === 'move') { document.getElementById('statusMsg').innerText = "Aguardando oponente..."; document.getElementById('statusMsg').style.display = "block"; socket.emit('online_move', { roomId: battleId, moveId, playerId: myRoleId }); } 
            } else { 
                const res = await fetch('/api/turn', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ battleId, action: type, moveId }) }); 
                const data = await res.json(); 
                if (data.events) await playEvents(data.events); 
                if(data.captured) { 
                    await playCaptureAnimation('<%= p2.instanceId %>');
                    showToast('Capturado!');
                    setTimeout(() => { window.location.href = '/forest?userId=<%= realUserId %>'; }, 800);
                    return;
                }
                else if (data.fled) { showToast("Fugiu!"); window.location.href = '/forest?userId=<%= realUserId %>'; } 
                else if(data.finished) { endGame(data.winnerId); } 
                else { if (data.p1State) updateBar(p1Id, data.p1State.hp, <%= p1.maxHp %>, 'hp'); if (data.p2State) updateBar(p2Id, data.p2State.hp, <%= p2.maxHp %>, 'hp'); setControlsState(true); } 
            } 
        }

        let __battleEnded = false;

        function endGame(winnerId) { 
            if (__battleEnded) return;
            __battleEnded = true;
            if (battleMode === 'wild') {
                showToast("Batalha finalizada!");
                window.location.href = '/forest?userId=<%= realUserId %>';
                return;
            }

            const bottomPanel = document.querySelector('.bottom-panel'); if(bottomPanel) bottomPanel.style.display = 'none'; 
            const overlay = document.getElementById('overlay'); 
            const title = document.getElementById('result-title'); 
            const winName = document.getElementById('win-name'); const loseName = document.getElementById('lose-name'); 
            const winTrainer = document.getElementById('win-trainer-div'); const loseTrainer = document.getElementById('lose-trainer-div');
            const winMon = document.getElementById('win-mon-img'); const loseMon = document.getElementById('lose-mon-img'); 
            const isP1Win = (winnerId === myRoleId); 
            const winner = isP1Win ? p1Data : p2Data; const loser = isP1Win ? p2Data : p1Data; 
            winName.innerText = winner.name; loseName.innerText = loser.name; 
            winTrainer.style.backgroundImage = `url('/uploads/${winner.skin}.png')`; loseTrainer.style.backgroundImage = `url('/uploads/${loser.skin}.png')`;
            winMon.src = winner.sprite; loseMon.src = loser.sprite; 
            if (isSpectator) { title.innerText = `VENCEDOR: ${winner.name}`; title.style.color = "#f1c40f"; } else { if (winnerId === 'draw') { title.innerText = "EMPATE!"; title.style.color = "#fff"; } else if (isP1Win) { title.innerText = "VIT√ìRIA!"; title.style.color = "#2ecc71"; } else { title.innerText = "DERROTA..."; title.style.color = "#e74c3c"; } } overlay.style.display = 'flex'; 
        }

        socket.on('turn_result', async (data) => { document.getElementById('statusMsg').style.display = "none"; await playEvents(data.events); if(data.winnerId) endGame(data.winnerId); else if(!isSpectator) setControlsState(true); });
        socket.on('opponent_ready', () => { if(!isSpectator) { document.getElementById('statusMsg').style.display = "block"; document.getElementById('statusMsg').innerText = "Oponente pronto!"; } });
        
        window.onload = () => { 
            if(battleMode === 'online') { if(!isSpectator) socket.emit('join_room', battleId); } 
            updateBar(p1Id, <%= p1.hp %>, <%= p1.maxHp %>, 'hp'); updateBar(p2Id, <%= p2.hp %>, <%= p2.maxHp %>, 'hp'); 
            if(!isSpectator) updateBar(p1Id, <%= p1.energy %>, <%= p1.maxEnergy %>, 'en'); 
            if(battleMode === 'auto') { playEvents(initialData.log).then(() => endGame(initialData.winnerId)); } else if (!isSpectator) { setControlsState(true); } 
        };
        // fetch initial money for HUD so balance is shown immediately
        (async function fetchInitialHud() {
            try {
                const res = await fetch('/api/me?userId=<%= realUserId %>');
                const data = await res.json();
                const hudMoneyEl = document.getElementById('hud-money'); if(hudMoneyEl) hudMoneyEl.innerText = data.money || 0;
            } catch(e) {}
        })();

        // Battle bag functions
        let __battleBagOutsideListener = null;
        function closeBattleBag() {
            const panel = document.getElementById('floatingBagPanel');
            if(panel) panel.style.display = 'none';
            if(__battleBagOutsideListener) { document.removeEventListener('click', __battleBagOutsideListener); __battleBagOutsideListener = null; }
        }

        async function openBattleBag() {
            const panel = document.getElementById('floatingBagPanel');
            const btn = document.getElementById('floatingBagBtn');
            if(!panel) return;
            // toggle
            if(panel.style.display === 'block') { closeBattleBag(); return; }
            panel.style.display = 'block';
            const cont = document.getElementById('battleBagContent'); cont.innerHTML = 'Carregando...';
            try {
                const res = await fetch('/api/me?userId=<%= realUserId %>');
                const data = await res.json();
                const money = data.money || 0; const pokeballs = data.pokeballs || 0; const rareCandy = data.rareCandy || 0;
                // update floating HUD money
                const hudMoneyEl = document.getElementById('hud-money'); if(hudMoneyEl) hudMoneyEl.innerText = money;
                let html = `<div class="bag-row"><div class="bag-item">Pok√©bolas<br><strong>${pokeballs}</strong></div><div class="bag-item">RareCandy<br><strong>${rareCandy}</strong></div></div>`;
                html += `<div class="bag-actions"><button class="btn-small use" onclick="usePokeballFromBag()">Usar Pok√©bola</button><button class="btn-small item" onclick="openUseItemModal()">Usar RareCandy</button></div>`;
                cont.innerHTML = html;
            } catch(e) { cont.innerHTML = 'Erro.'; }

            // close when clicking outside (but not when clicking the bag button)
            __battleBagOutsideListener = function(ev) {
                const panelEl = document.getElementById('floatingBagPanel');
                const btnEl = document.getElementById('floatingBagBtn');
                if(!panelEl) return;
                if(panelEl.contains(ev.target) || (btnEl && btnEl.contains(ev.target))) return;
                closeBattleBag();
            };
            // delay attach to avoid immediate close from the click that opened
            setTimeout(() => document.addEventListener('click', __battleBagOutsideListener), 50);
        }

        async function usePokeballFromBag() {
            if (battleMode !== 'wild') { showToast('N√£o √© poss√≠vel usar Pok√©bolas nesta batalha.'); return; }
            if(!await showConfirm('Usar uma Pok√©bola agora?')) return;
            try {
                const res = await fetch('/api/turn', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ battleId, action: 'catch' }) });
                const data = await res.json();
                if(data.events) await playEvents(data.events);
                if(data.captured) { await playCaptureAnimation('<%= p2.instanceId %>'); showToast('Capturado!'); setTimeout(()=>{ window.location.href = '/forest?userId=<%= realUserId %>'; }, 800); return; }
                // refresh bag UI (close then reopen)
                closeBattleBag(); setTimeout(() => openBattleBag(), 220);
            } catch(e) { showToast('Erro ao usar Pok√©bola'); }
        }
    </script>
</body>
</html>