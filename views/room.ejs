<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centro Pok√©mon</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ESTILO DA SALA */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 0; background: #000; overflow: hidden; height: 100vh; width: 100vw; font-family: 'Roboto', sans-serif; user-select: none; }
        
        #gameArea {
            position: relative; width: 100vw; height: 100vh;
            background: #2c3e50;
            background-image: 
                linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            cursor: crosshair;
        }

        /* OBJETOS / M√ÅQUINAS */
        .machine {
            position: absolute; width: 120px; height: 100px;
            background: #34495e; border: 4px solid #7f8c8d;
            border-radius: 10px; box-shadow: 0 10px 0 #1a252f;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: white; font-family: 'Press Start 2P'; font-size: 0.6rem; text-align: center;
            cursor: pointer; z-index: 5; transition: transform 0.1s;
        }
        .machine:active { transform: scale(0.95); }
        .machine::after { content: '‚ñº'; position: absolute; top: -20px; color: #f1c40f; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Posicionamento das M√°quinas (Em %) */
        #pc-pokedex { top: 10%; left: 10%; background: #27ae60; border-color: #2ecc71; }
        #pc-online { top: 10%; right: 10%; background: #2980b9; border-color: #3498db; }
        #pc-battle { top: 40%; left: 50%; transform: translateX(-50%); background: #c0392b; border-color: #e74c3c; }
        #pc-create { bottom: 10%; right: 10%; background: #8e44ad; border-color: #9b59b6; }

        /* JOGADORES */
        .player {
            position: absolute; width: 40px; height: 40px;
            background: #fff; border-radius: 50%;
            transform: translate(-50%, -50%); /* Centraliza no ponto */
            transition: top 0.5s linear, left 0.5s linear; /* Movimento suave */
            z-index: 10; border: 2px solid #000;
            display: flex; justify-content: center;
        }
        .player-name {
            position: absolute; top: -25px;
            background: rgba(0,0,0,0.7); color: white;
            padding: 2px 5px; border-radius: 4px;
            font-size: 0.7rem; white-space: nowrap;
            pointer-events: none;
        }

        /* MODAIS (Copiados e adaptados da vers√£o anterior) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #1a1a2e; width: 90%; max-width: 400px;
            padding: 20px; border-radius: 15px; border: 2px solid #fff;
            color: white; position: relative; max-height: 80vh; overflow-y: auto;
        }
        .close-btn { position: absolute; top: 10px; right: 10px; background: #e74c3c; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        select, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: none; }
        button { background: #3498db; color: white; cursor: pointer; font-weight: bold; }
        
        /* Grid da Pokedex */
        .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .roster-card { background: #222; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; border: 1px solid #444; }
        .roster-img { width: 60px; height: 60px; object-fit: contain; }

        /* Loader */
        .loader { border: 4px solid #333; border-top: 4px solid #f1c40f; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- √ÅREA DO JOGO -->
    <div id="gameArea">
        <div class="machine" id="pc-pokedex" onclick="moveToAndInteract(10, 10, 'pokedex')">
            POKEDEX<br>üíæ
        </div>
        <div class="machine" id="pc-online" onclick="moveToAndInteract(90, 10, 'online')">
            ONLINE<br>üåê
        </div>
        <div class="machine" id="pc-battle" onclick="moveToAndInteract(50, 40, 'battle')">
            TREINO<br>‚öîÔ∏è
        </div>
        <div class="machine" id="pc-create" onclick="moveToAndInteract(90, 90, 'create')">
            LAB<br>üß™
        </div>
    </div>

    <!-- MODAL POKEDEX -->
    <div class="modal-overlay" id="modalPokedex">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modalPokedex')">X</button>
            <h2 style="text-align:center">Meus Monstros</h2>
            <div class="roster-grid">
                <% entities.forEach(e => { %>
                    <div class="roster-card">
                        <% if(e.sprite) { %><img src="/uploads/<%= e.sprite %>" class="roster-img"><% } else { %>üì¶<% } %>
                        <div style="font-size:0.8rem; margin-top:5px;"><%= e.name %></div>
                    </div>
                <% }) %>
            </div>
        </div>
    </div>

    <!-- MODAL ONLINE -->
    <div class="modal-overlay" id="modalOnline">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modalOnline')">X</button>
            <h2 style="text-align:center; color:#3498db">Batalha Online</h2>
            <p style="text-align:center; font-size:0.8rem">Escolha seu lutador e aguarde.</p>
            <select id="onlineFighter">
                <% entities.forEach(e => { %><option value="<%= e.id %>"><%= e.name %></option><% }) %>
            </select>
            <button onclick="startSearch()">PROCURAR OPONENTE</button>
            <div id="searchStatus" style="display:none; text-align:center; margin-top:10px;">
                <div class="loader"></div>
                <small>Aguardando...</small>
            </div>
        </div>
    </div>

    <!-- MODAL BATALHA (AUTO/MANUAL) -->
    <div class="modal-overlay" id="modalBattle">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('modalBattle')">X</button>
            <h2 style="text-align:center; color:#e74c3c">Treino Local</h2>
            <form action="/battle" method="POST">
                <!-- Envia o nome do jogador -->
                <input type="hidden" name="playerName" value="<%= playerName %>">
                
                <label>Modo</label>
                <select name="mode">
                    <option value="auto">Autom√°tico</option>
                    <option value="manual">Manual</option>
                </select>
                <label>Seu Lutador</label>
                <select name="fighter1"><% entities.forEach(e => { %><option value="<%= e.id %>"><%= e.name %></option><% }) %></select>
                <label>Advers√°rio (CPU)</label>
                <select name="fighter2"><% entities.forEach(e => { %><option value="<%= e.id %>"><%= e.name %></option><% }) %></select>
                <button type="submit" style="background:#e74c3c; margin-top:15px;">INICIAR</button>
            </form>
        </div>
    </div>

    <!-- FORMS OCULTOS -->
    <form id="onlineRedirectForm" action="/battle/online" method="POST" style="display:none;">
        <input type="hidden" name="roomId" id="formRoomId">
        <input type="hidden" name="meData" id="formMeData">
        <input type="hidden" name="opponentData" id="formOpponentData">
    </form>

    <script>
        const socket = io();
        const myName = "<%= playerName %>";
        const gameArea = document.getElementById('gameArea');
        
        let myId = null;
        let isMoving = false;

        // --- SISTEMA DE MOVIMENTO E LOBBY ---
        
        // Entrar no lobby
        socket.on('connect', () => {
            myId = socket.id;
            socket.emit('enter_lobby', myName);
        });

        // Atualiza√ß√£o inicial
        socket.on('lobby_state', (players) => {
            // Limpa tudo (menos as m√°quinas)
            document.querySelectorAll('.player').forEach(el => el.remove());
            
            Object.values(players).forEach(p => createPlayerElement(p));
        });

        // Algu√©m entrou
        socket.on('player_joined', (p) => {
            createPlayerElement(p);
        });

        // Algu√©m moveu
        socket.on('player_moved', (data) => {
            const el = document.getElementById(`p-${data.id}`);
            if (el) {
                el.style.left = data.x + '%';
                el.style.top = data.y + '%';
                // Ajusta z-index baseado na profundidade (Y)
                el.style.zIndex = Math.floor(data.y);
            }
        });

        // Algu√©m saiu
        socket.on('player_left', (id) => {
            const el = document.getElementById(`p-${id}`);
            if (el) el.remove();
        });

        // Renderizar Jogador
        function createPlayerElement(p) {
            const div = document.createElement('div');
            div.id = `p-${p.id}`;
            div.className = 'player';
            div.style.left = p.x + '%';
            div.style.top = p.y + '%';
            div.style.backgroundColor = p.color;
            div.style.zIndex = Math.floor(p.y); // Profundidade simples

            const label = document.createElement('div');
            label.className = 'player-name';
            label.innerText = p.name;
            div.appendChild(label);

            gameArea.appendChild(div);
        }

        // Clicar para andar
        gameArea.addEventListener('click', (e) => {
            // Se clicar numa m√°quina, ignora (o onclick da m√°quina resolve)
            if (e.target.classList.contains('machine')) return;

            const rect = gameArea.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;

            moveMe(x, y);
        });

        function moveMe(x, y) {
            socket.emit('move_player', { x, y });
        }

        // --- INTERA√á√ïES ---

        function moveToAndInteract(targetX, targetY, type) {
            // 1. Move at√© perto
            moveMe(targetX, targetY + 5); // +5 pra ficar na frente da m√°quina

            // 2. Abre modal ap√≥s delay do "andar"
            setTimeout(() => {
                if (type === 'create') {
                    window.location.href = '/create'; // Redireciona pra criar
                } else if (type === 'pokedex') {
                    document.getElementById('modalPokedex').style.display = 'flex';
                } else if (type === 'online') {
                    document.getElementById('modalOnline').style.display = 'flex';
                } else if (type === 'battle') {
                    document.getElementById('modalBattle').style.display = 'flex';
                }
            }, 500);
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- L√ìGICA ONLINE (Modal) ---
        function startSearch() {
            const fighterId = document.getElementById('onlineFighter').value;
            document.getElementById('searchStatus').style.display = 'block';
            
            // Envia o Nome Real do jogador para a batalha
            socket.emit('find_match', fighterId, myName);
        }

        socket.on('match_found', (data) => {
            document.getElementById('formRoomId').value = data.roomId;
            document.getElementById('formMeData').value = JSON.stringify(data.me);
            document.getElementById('formOpponentData').value = JSON.stringify(data.opponent);
            document.getElementById('onlineRedirectForm').submit();
        });

    </script>
</body>
</html>