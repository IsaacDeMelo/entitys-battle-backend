<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vila Pok√©mon</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        
        body { 
            margin: 0; padding: 0; 
            background: #111; 
            overflow: hidden; 
            height: 100vh; width: 100vw; 
            font-family: 'Roboto', sans-serif; 
            user-select: none; 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* MAPA */
        #gameArea { 
            position: relative; 
            width: 100%; max-width: 500px; 
            height: 100%; max-height: 900px;
            
            background-image: url('/uploads/map_bg.png');
            image-rendering: pixelated; 
            background-size: cover; 
            background-position: center top;
            background-repeat: no-repeat;
            
            cursor: crosshair;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            overflow: hidden; 
        }

        @media (max-width: 600px) {
            body { padding: 0; }
            #gameArea { max-width: none; max-height: none; width: 100vw; height: 100vh; border-radius: 0; box-shadow: none; }
        }

        /* --- EDIF√çCIOS (M√ÅQUINAS) --- */
        .machine { 
            position: absolute; 
            
            /* AUMENTO DE TAMANHO AQUI */
            width: 180px;  
            height: 160px; 
            
            background-color: transparent; 
            border: none; 
            
            display: flex; flex-direction: column; 
            align-items: center; justify-content: flex-end; 
            
            cursor: pointer; 
            z-index: 5; 
            
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center bottom;
            
            color: #fff; 
            font-family: 'Press Start 2P'; font-size: 0.6rem; 
            text-shadow: 2px 2px 0 #000, -1px -1px 0 #000;
            padding-bottom: 5px;

            transition: transform 0.2s, filter 0.2s;
            filter: drop-shadow(0 10px 5px rgba(0,0,0,0.5));

            -webkit-tap-highlight-color: transparent;
            outline: none;
            user-select: none;
        }

        .machine:hover {
            transform: translateY(-5px) scale(1.05); 
            filter: drop-shadow(0 15px 8px rgba(0,0,0,0.6)) brightness(1.2);
        }

        .machine:active { transform: scale(0.95); }
        
        /* POSI√á√ïES */
        /* Galeria: Topo Esquerda */
        #pc-pokedex { 
            top: 2%; left: -2%; /* Ajuste fino pra n√£o cortar */
            background-image: url('/uploads/pokedex_building.png'); 
        }
        
        /* Online: Topo Direita */
        #pc-online { 
            top: 2%; right: -2%; 
            background-image: url('/uploads/online_building.png'); 
        }
        
        /* Arena: Centro (GIGANTE) */
        #pc-battle { 
            top: 32%; left: 50%; transform: translateX(-50%); 
            width: 220px; height: 200px; /* Arena maior que as outras */
            background-image: url('/uploads/arena_building.png'); 
            z-index: 4; 
        }
        
        /* Lab: Baixo Esquerda */
        #pc-create { 
            bottom: 5%; left: 2%; /* Mais pra baixo e esquerda */
            background-image: url('/uploads/lab_building.png'); 
            z-index: 90; 
        }

        /* --- PLAYER --- */
        .player { 
            position: absolute; width: 48px; height: 48px; 
            background-size: 400% auto; image-rendering: pixelated; 
            transform: translate(-50%, -50%); 
            transition: top 0.5s linear, left 0.5s linear; 
            z-index: 10;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.4));
        }
        
        <% for(let i = 1; i <= skinCount; i++) { %>
            .player[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); }
        <% } %>
        
        .player.walking { animation: walk-anim 0.6s steps(4) infinite; }
        @keyframes walk-anim { from { background-position-x: 0; } to { background-position-x: -400%; } }
        .player[data-dir="down"]  { background-position-y: 0%; }
        .player[data-dir="left"]  { background-position-y: 33.33%; }
        .player[data-dir="right"] { background-position-y: 66.66%; }
        .player[data-dir="up"]    { background-position-y: 100%; }
        .player-name { position: absolute; top: -20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; pointer-events: none; }

        /* UI ELEMENTS */
        #toastContainer { position: absolute; top: 20px; width: 100%; display: flex; justify-content: center; z-index: 2000; pointer-events: none; }
        .toast { background: rgba(0, 0, 0, 0.9); color: #f1c40f; border: 2px solid #f1c40f; padding: 10px; border-radius: 10px; font-family: 'Press Start 2P', cursive; font-size: 0.6rem; text-align: center; animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        #chatBar { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; display: flex; align-items: center; gap: 8px; z-index: 100; background: rgba(20, 26, 40, 0.95); border: 2px solid #3498db; padding: 5px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(5px); transition: 0.2s; }
        #chatBar:focus-within { transform: translateX(-50%) translateY(-2px); border-color: #f1c40f; }
        #chatInput { flex: 1; padding: 8px 10px; border: none; background: transparent; color: white; outline: none; font-family: 'Roboto', sans-serif; font-size: 0.9rem; }
        #chatSend { width: 35px; height: 35px; border-radius: 50%; border: none; background: linear-gradient(135deg, #f1c40f, #f39c12); color: #1a1a2e; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1rem; box-shadow: 0 3px 0 #c27c0e; }
        #chatSend:active { transform: translateY(3px); box-shadow: none; }
        
        .chat-bubble { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 5px 10px; border-radius: 10px; border: 2px solid #333; font-size: 0.8rem; white-space: nowrap; margin-bottom: 10px; z-index: 20; animation: popIn 0.2s; }
        .chat-bubble::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); border-width: 6px 6px 0; border-style: solid; border-color: #333 transparent transparent transparent; }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); } to { transform: translateX(-50%) scale(1); } }

        /* MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a2e; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; border: 2px solid #fff; color: white; position: relative; max-height: 85vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 10px; background: #e74c3c; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; z-index: 20; }
        select, button { width: 100%; padding: 10px; margin-top: 10px; border-radius: 5px; border: none; }
        button { background: #3498db; color: white; cursor: pointer; font-weight: bold; }
        .pokedex-container { display: flex; flex: 1; overflow: hidden; }
        #modalPokedex .modal-content { max-width: 700px; height: 500px; padding: 0; display: flex; flex-direction: column; }
        .dex-list { width: 40%; background: #111; border-right: 2px solid #3498db; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .dex-item { display: flex; align-items: center; gap: 10px; padding: 10px; background: #222; border-radius: 8px; cursor: pointer; border: 1px solid #333; }
        .dex-item:hover, .dex-item.active { background: #3498db; border-color: #fff; }
        .dex-thumb { width: 40px; height: 40px; object-fit: contain; image-rendering: pixelated; }
        .dex-details { width: 60%; padding: 20px; overflow-y: auto; background: radial-gradient(circle at top right, #2c3e50, #1a1a2e); display: flex; flex-direction: column; align-items: center; }
        .detail-img { width: 120px; height: 120px; object-fit: contain; image-rendering: pixelated; }
        .type-badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.7rem; background: #555; margin-top: 5px; }
        .type-fire { background: #e74c3c; } .type-water { background: #3498db; } .type-plant { background: #2ecc71; } .type-electric { background: #f1c40f; color: #000; } .type-ice { background: #74b9ff; color: #000; } .type-flying { background: #a29bfe; } .type-fighter { background: #e67e22; } .type-ghost { background: #8e44ad; } .type-normal { background: #95a5a6; }
        .detail-stats { width: 100%; margin: 20px 0; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; }
        .stat-row { display: flex; align-items: center; margin-bottom: 5px; font-size: 0.8rem; }
        .stat-bar-bg { flex: 1; height: 8px; background: #333; margin: 0 10px; border-radius: 4px; }
        .stat-bar-fill { height: 100%; background: #2ecc71; border-radius: 4px; }
        .detail-moves { width: 100%; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .move-pill { background: #222; padding: 8px; border-radius: 6px; font-size: 0.7rem; border: 1px solid #444; text-align: center; }
        .loader { border: 4px solid #333; border-top: 4px solid #f1c40f; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 600px) { .pokedex-container { flex-direction: column; } .dex-list { width: 100%; height: 35%; flex-direction: row; overflow-x: auto; } .dex-details { width: 100%; height: 65%; } }
    </style>
</head>
<body>

    <div id="gameArea">
        <div class="machine" id="pc-pokedex" onclick="moveToAndInteract(16, 18, 'pokedex')">
            GALERIA
        </div>
        <div class="machine" id="pc-online" onclick="moveToAndInteract(84, 18, 'online')">
            ONLINE
        </div>
        <div class="machine" id="pc-battle" onclick="moveToAndInteract(50, 48, 'battle')">
            ARENA
        </div>
        <div class="machine" id="pc-create" onclick="moveToAndInteract(19, 88, 'create')">
            LAB
        </div>
    </div>

    <div id="toastContainer"></div>

    <div id="chatBar">
        <input type="text" id="chatInput" placeholder="Mensagem..." autocomplete="off" maxlength="30">
        <button id="chatSend" onclick="sendChat()">üí¨</button>
    </div>

    <!-- Modais (Mantidos) -->
    <div class="modal-overlay" id="modalPokedex"><div class="modal-content"><button class="close-btn" onclick="closeModal('modalPokedex')">X</button><div style="padding:10px; background:#16213e; text-align:center; font-weight:bold; border-bottom:1px solid #333;">BANCO DE DADOS</div><div class="pokedex-container"><div class="dex-list"><% entities.forEach((e, index) => { %><div class="dex-item" onclick="selectDexMonster(<%= index %>, this)"><% if(e.sprite) { %><img src="/uploads/<%= e.sprite %>" class="dex-thumb"><% } else { %><span>üì¶</span><% } %><div class="dex-name"><%= e.name %></div></div><% }) %></div><div class="dex-details" id="dexDetailsView"><div style="margin:auto; color:#777;">Selecione um monstro.</div></div></div></div></div>
    <div class="modal-overlay" id="modalOnline"><div class="modal-content" style="padding:20px; display:block;"><button class="close-btn" onclick="closeModal('modalOnline')">X</button><h2 style="text-align:center; color:#3498db">Batalha Online</h2><p style="text-align:center">Escolha seu lutador.</p><select id="onlineFighter"><% entities.forEach(e => { %><option value="<%= e.id %>"><%= e.name %></option><% }) %></select><button onclick="startSearch()">PROCURAR</button><div id="searchStatus" style="display:none; text-align:center; margin-top:10px;"><div class="loader"></div><small>Aguardando...</small></div></div></div>
    <div class="modal-overlay" id="modalBattle"><div class="modal-content" style="padding:20px; display:block;"><button class="close-btn" onclick="closeModal('modalBattle')">X</button><h2 style="text-align:center; color:#e74c3c">Treino Local</h2><form action="/battle" method="POST"><input type="hidden" name="playerName" value="<%= playerName %>"><input type="hidden" name="playerSkin" value="<%= playerSkin %>"><label>Modo</label><select name="mode"><option value="auto">Autom√°tico</option><option value="manual">Manual</option></select><label>Seu Lutador</label><select name="fighter1"><% entities.forEach(e => { %><option value="<%= e.id %>"><%= e.name %></option><% }) %></select><label>Advers√°rio</label><select name="fighter2"><% entities.forEach(e => { %><option value="<%= e.id %>"><%= e.name %></option><% }) %></select><button type="submit" style="background:#e74c3c">INICIAR</button></form></div></div>
    <form id="onlineRedirectForm" action="/battle/online" method="POST" style="display:none;"><input type="hidden" name="roomId" id="formRoomId"><input type="hidden" name="meData" id="formMeData"><input type="hidden" name="opponentData" id="formOpponentData"></form>

    <script>
        const socket = io();
        const myName = "<%= playerName %>";
        const mySkin = "<%= playerSkin %>";
        const gameArea = document.getElementById('gameArea');
        const allMonsters = <%- JSON.stringify(entities) %>; 
        
        let myId = null;

        socket.on('connect', () => { myId = socket.id; socket.emit('enter_lobby', { name: myName, skin: mySkin }); });
        socket.on('lobby_state', (players) => { document.querySelectorAll('.player').forEach(el => el.remove()); Object.values(players).forEach(p => createPlayerElement(p)); });
        socket.on('player_joined', (p) => createPlayerElement(p));
        socket.on('player_moved', (data) => {
            const el = document.getElementById(`p-${data.id}`);
            if (el) {
                el.style.left = data.x + '%'; el.style.top = data.y + '%'; 
                el.style.zIndex = Math.floor(data.y); 
                el.setAttribute('data-dir', data.direction); el.classList.add('walking');
                const stopWalk = () => { el.classList.remove('walking'); };
                el.removeEventListener('transitionend', stopWalk); el.addEventListener('transitionend', stopWalk);
                moveBubble(data.id);
            }
        });
        socket.on('player_left', (id) => { const el = document.getElementById(`p-${id}`); if (el) el.remove(); });

        socket.on('global_message', (data) => { if(data.type === 'win') showToast(data.msg); });
        function showToast(msg) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div'); toast.className = 'toast'; toast.innerText = msg;
            container.appendChild(toast); setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 5000);
        }

        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });
        document.getElementById('chatBar').addEventListener('click', (e) => { e.stopPropagation(); });
        function sendChat() { const msg = chatInput.value.trim(); if (msg) { socket.emit('send_chat', msg); chatInput.value = ''; } }
        socket.on('chat_message', (data) => { showBubble(data.id, data.msg); });
        function showBubble(playerId, text) {
            const playerEl = document.getElementById(`p-${playerId}`); if (!playerEl) return;
            const oldBubble = playerEl.querySelector('.chat-bubble'); if (oldBubble) oldBubble.remove();
            const bubble = document.createElement('div'); bubble.className = 'chat-bubble'; bubble.innerText = text;
            playerEl.appendChild(bubble); setTimeout(() => { bubble.style.opacity = '0'; setTimeout(() => bubble.remove(), 200); }, 4000);
        }
        function moveBubble(id) {}

        function createPlayerElement(p) {
            const div = document.createElement('div'); div.id = `p-${p.id}`; div.className = 'player';
            div.style.left = p.x + '%'; div.style.top = p.y + '%';
            div.style.backgroundImage = `url('/uploads/${p.skin || "char1"}.png')`;
            div.setAttribute('data-dir', p.direction || 'down');
            div.style.zIndex = Math.floor(p.y);
            const label = document.createElement('div'); label.className = 'player-name'; label.innerText = p.name;
            div.appendChild(label); gameArea.appendChild(div);
        }

        gameArea.addEventListener('click', (e) => {
            if (e.target.classList.contains('machine')) return;
            const rect = gameArea.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            socket.emit('move_player', { x, y });
        });

        function moveToAndInteract(targetX, targetY, type) {
            socket.emit('move_player', { x: targetX, y: targetY }); 
            setTimeout(() => {
                if (type === 'create') {
                    window.location.href = '/create?playerName=' + encodeURIComponent(myName) + '&playerSkin=' + encodeURIComponent(mySkin);
                }
                else if (type === 'pokedex') { document.getElementById('modalPokedex').style.display = 'flex'; if(allMonsters.length > 0) selectDexMonster(0, document.querySelector('.dex-item')); }
                else if (type === 'online') document.getElementById('modalOnline').style.display = 'flex';
                else if (type === 'battle') document.getElementById('modalBattle').style.display = 'flex';
            }, 600);
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function selectDexMonster(index, element) {
            const mon = allMonsters[index];
            const view = document.getElementById('dexDetailsView');
            document.querySelectorAll('.dex-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
            let imgHTML = mon.sprite ? `<img src="/uploads/${mon.sprite}" class="detail-img">` : `<div style="font-size:80px">‚ùì</div>`;
            let movesHTML = ''; mon.moves.forEach(m => { movesHTML += `<div class="move-pill"><strong>${m.icon||''} ${m.name}</strong><small>${m.cost} EN</small></div>`; });
            view.innerHTML = `<div class="detail-header">${imgHTML}<div class="detail-name">${mon.name}</div><span class="type-badge type-${mon.type}">${mon.type}</span></div><div class="detail-stats">${renderStatBar('HP', mon.maxHp||mon.hp, 200, '#e74c3c')} ${renderStatBar('EN', mon.maxEnergy||mon.energy, 100, '#f1c40f')} ${renderStatBar('ATK', mon.stats.attack, 50, '#e67e22')} ${renderStatBar('DEF', mon.stats.defense, 50, '#3498db')} ${renderStatBar('SPD', mon.stats.speed, 20, '#9b59b6')}</div><div class="detail-moves">${movesHTML}</div>`;
            setTimeout(() => { document.querySelectorAll('.stat-bar-fill').forEach(bar => { bar.style.width = bar.getAttribute('data-pct') + '%'; }); }, 50);
        }
        function renderStatBar(l, v, m, c) { return `<div class="stat-row"><span class="stat-label">${l}</span><div class="stat-bar-bg"><div class="stat-bar-fill" data-pct="${Math.min(100,(v/m)*100)}" style="width:0%; background:${c}"></div></div><span class="stat-val">${v}</span></div>`; }

        function startSearch() {
            const fighterId = document.getElementById('onlineFighter').value;
            document.getElementById('searchStatus').style.display = 'block';
            socket.emit('find_match', fighterId, myName, mySkin);
        }
        socket.on('match_found', (data) => {
            document.getElementById('formRoomId').value = data.roomId;
            document.getElementById('formMeData').value = JSON.stringify(data.me);
            document.getElementById('formOpponentData').value = JSON.stringify(data.opponent);
            document.getElementById('onlineRedirectForm').submit();
        });
    </script>
</body>
</html>
