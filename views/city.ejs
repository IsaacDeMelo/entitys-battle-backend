<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rota Principal</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; padding: 0; background: #050505; overflow: hidden; height: 100vh; width: 100vw; font-family: 'Roboto', sans-serif; display: flex; justify-content: center; align-items: center; }
        
        /* JANELA DO JOGO */
        #gameViewport {
            position: relative;
            width: 100%; max-width: 500px;
            height: 100%; max-height: 900px;
            background-color: #111;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
        }

        /* √ÅREA DO MAPA (Background da sua imagem) */
        #gameArea { 
            position: relative; 
            width: 100%; height: 100%; 
            /* AQUI ENTRA A SUA IMAGEM DA ROTA */
            background-image: url('/uploads/route_bg.png'); 
            background-size: 100% 100%; 
            background-position: center; 
            image-rendering: pixelated; 
            cursor: crosshair; 
            z-index: 1; 
            transition: transform 0.5s ease;
        }

        /* MODO INTERIOR (Quando entra na casa) */
        #gameArea.indoor-mode {
            background-size: cover;
            border: 20px solid #111; /* Borda est√©tica */
        }

        /* CAMADAS L√ìGICAS */
        .layer-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        
        /* ENTIDADES (JOGADORES E NPCS) */
        .player { 
            position: absolute; width: 32px; height: 32px; 
            background-size: 400% auto; image-rendering: pixelated; 
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.6)); 
            margin-left: -16px; margin-top: -28px; z-index: 10; 
            pointer-events: none; 
            transition: top 0s linear, left 0s linear; 
        }
        <% for(let i = 1; i <= skinCount; i++) { %> .player[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); } <% } %>
        
        .player.walking { animation: walk-anim 0.6s steps(4) infinite; }
        @keyframes walk-anim { from { background-position-x: 0; } to { background-position-x: -400%; } }
        
        .player[data-dir="down"] { background-position-y: 0%; } 
        .player[data-dir="left"] { background-position-y: 33.33%; } 
        .player[data-dir="right"] { background-position-y: 66.66%; } 
        .player[data-dir="up"] { background-position-y: 100%; }
        
        .player-name { 
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.7); color: white; padding: 2px 5px; border-radius: 4px; 
            font-size: 0.6rem; white-space: nowrap; pointer-events: none; z-index: 500; font-weight: bold; 
        }
        
        /* NPC TEM CLICK HABILITADO */
        .npc-entity { pointer-events: auto !important; cursor: pointer; z-index: 11; }
        .npc-entity:hover { filter: brightness(1.2) drop-shadow(0 0 5px yellow); }
        .npc-entity .player-name { color: #f1c40f; border: 1px solid #c27c0e; }

        /* UI CHAT */
        .chat-bubble { position: absolute; bottom: 45px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 4px 8px; border-radius: 8px; border: 2px solid #333; font-size: 0.75rem; white-space: nowrap; z-index: 1000; animation: popIn 0.2s forwards; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
        
        #chatBar { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; display: flex; gap: 8px; z-index: 9999; pointer-events: auto; }
        #chatInput { flex: 1; padding: 10px 15px; border: 2px solid #3498db; background: rgba(26, 26, 46, 0.95); color: white; border-radius: 25px; font-family: 'Roboto', sans-serif; font-size: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #chatSend { width: 46px; height: 46px; border-radius: 50%; border: none; background: #f1c40f; color: #1a1a2e; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; box-shadow: 0 5px 0 #c27c0e; transition: 0.1s; }
        #chatSend:active { transform: translateY(4px); box-shadow: 0 1px 0 #c27c0e; }

        /* ADMIN / DEV MODE VISUALS */
        .collision-box { position: absolute; background: transparent; z-index: 5; }
        .grass-patch { position: absolute; z-index: 4; background: transparent; }
        .house-trigger { position: absolute; z-index: 6; background: transparent; cursor: pointer; }
        
        /* Cores para o modo de edi√ß√£o */
        .dev-collision { background: rgba(231, 76, 60, 0.5) !important; border: 1px dashed #e74c3c; pointer-events: auto !important; }
        .dev-grass { background: rgba(46, 204, 113, 0.5) !important; border: 1px dashed #2ecc71; pointer-events: auto !important; }
        .dev-house { background: rgba(52, 152, 219, 0.5) !important; border: 1px dashed #3498db; pointer-events: auto !important; }
        .dev-exit { background: rgba(241, 196, 15, 0.5) !important; border: 1px dashed #f1c40f; pointer-events: auto !important; }
        
        #adminToolbar { 
            position: fixed; top: 10px; right: 10px; z-index: 10000; 
            background: rgba(15, 23, 42, 0.95); padding: 10px; border-radius: 8px; border: 1px solid #f1c40f; 
            display: none; flex-direction: column; gap: 5px; color: white; font-size: 0.7rem; pointer-events: auto;
        }
        .tool-btn { background: #1e293b; color: white; border: 1px solid #475569; padding: 6px; cursor: pointer; border-radius: 4px; font-weight: bold; width: 100%; }
        .tool-btn.active { background: #f1c40f; color: black; border-color: white; }
        .tool-btn:hover { filter: brightness(1.2); }

        #loader { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; color: #f1c40f; font-family: 'Press Start 2P'; z-index: 20000; transition: opacity 0.5s; pointer-events: none; opacity: 0; }
        #loader.show { opacity: 1; pointer-events: auto; }
        
        /* SA√çDAS */
        .exit-zone { position: absolute; z-index: 2; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: rgba(255,255,255,0.5); font-weight: bold; font-family: 'Press Start 2P'; text-shadow: 1px 1px 0 #000; }
        #exit-forest { bottom: 0; left: 40%; width: 20%; height: 5%; border-top: 2px dashed rgba(46, 204, 113, 0.5); }
        #exit-forest::after { content: '‚ñº FLORESTA ‚ñº'; animation: blink 2s infinite; }
        @keyframes blink { 50% { opacity: 0.3; } }
    </style>
</head>
<body>
    <%- include('partials/menu') %>

    <!-- TELA DE CARREGAMENTO -->
    <div id="loader" class="show">CARREGANDO...</div>

    <!-- FERRAMENTAS DE DEV (S√ì ADMIN V√ä) -->
    <% if(user.isAdmin) { %>
    <div id="adminToolbar">
        <div style="text-align:center; color:#f1c40f; font-family:'Press Start 2P'; margin-bottom:5px;">DEV MODE</div>
        <button class="tool-btn" onclick="toggleDevMode()" id="btnDevToggle">ATIVAR EDITOR</button>
        <div id="devControls" style="display:none; flex-direction:column; gap:5px; margin-top:5px;">
            <button class="tool-btn" onclick="setTool('collision')" id="btnCol">üü• PAREDE</button>
            <button class="tool-btn" onclick="setTool('grass')" id="btnGrs">üü© GRAMA</button>
            <button class="tool-btn" onclick="setTool('house')" id="btnHse">üü¶ CASA (ENTRADA)</button>
            <div style="height:1px; background:#555; margin:2px 0;"></div>
            <button class="tool-btn" onclick="undoLast()">‚Ü©Ô∏è DESFAZER</button>
            <button class="tool-btn" onclick="exportConfig()" style="background:#27ae60;">üíæ SALVAR/COPIAR</button>
        </div>
        <textarea id="configOutput" style="width:150px; height:50px; display:none; font-size:9px;"></textarea>
    </div>
    <% } %>

    <!-- √ÅREA DO JOGO -->
    <div id="gameViewport">
        <div id="gameArea">
            <div id="exit-forest" class="exit-zone"></div>
            
            <!-- CAMADAS -->
            <div id="layer-collision" class="layer-container"></div>
            <div id="layer-grass" class="layer-container"></div>
            <div id="layer-triggers" class="layer-container"></div>
            
            <!-- CAMADA DE DESENHO DEV -->
            <div id="layer-dev" class="layer-container" style="z-index: 100;"></div>
        </div>
        
        <div id="chatBar">
            <input type="text" id="chatInput" placeholder="Digite sua mensagem..." autocomplete="off" maxlength="40">
            <button id="chatSend">‚û§</button>
        </div>
    </div>

    <!-- VARIAVEIS E LIBS -->
    <script>
        const socket = io();
        const myName = "<%= playerName %>";
        const mySkin = "<%= playerSkin %>";
        window.CURRENT_USER_ID = "<%= user._id %>"; 
        window.DEFEATED_NPCS = <%- JSON.stringify(user.defeatedNPCs || []) %>;
        
        // --- CONFIGURA√á√ÉO INICIAL (Baseada na imagem) ---
        // Aqui eu pre-defini algumas √°reas baseadas na imagem, mas voc√™ pode editar com o DEV MODE.
        let collisionMap = [
            {"x":0,"y":0,"w":15,"h":100}, // √Årvores Esquerda
            {"x":85,"y":0,"w":15,"h":100}, // √Årvores Direita
            {"x":15,"y":50,"w":10,"h":10}, // Cerca casa vermelha
            {"x":75,"y":50,"w":10,"h":10}  // Cerca casa azul
        ];
        let grassMap = [
            {"x":18,"y":15,"w":25,"h":30}, // Grama Alta Esquerda
            {"x":60,"y":70,"w":20,"h":15}  // Grama Alta Direita Baixa
        ];
        // Casas configuradas com base na imagem
        let housesData = [
            {
                "id": "house_red", 
                "bg": "/uploads/house_red_interior.png", // Imagem interior (exemplo)
                "trigger": {"x":20,"y":50,"w":12,"h":10}, // Posi√ß√£o visual da casa vermelha
                "spawn": {"x":50,"y":80},
                "collisions": [{"x":0,"y":0,"w":100,"h":10}], // Exemplo colis√£o interna
                "exit": {"x":40,"y":90,"w":20,"h":10}
            },
            {
                "id": "house_blue", 
                "bg": "/uploads/house_blue_interior.png",
                "trigger": {"x":75,"y":50,"w":12,"h":10}, // Posi√ß√£o visual da casa azul
                "spawn": {"x":50,"y":80},
                "collisions": [],
                "exit": {"x":40,"y":90,"w":20,"h":10}
            }
        ];
    </script>
    
    <!-- IMPORTANTE: Traz as funcionalidades de NPC, Batalha e Di√°logo -->
    <script src="/scripts/common.js"></script>

    <script>
        const gameArea = document.getElementById('gameArea');
        let myId = null; 
        const MOVEMENT_SPEED = 50; // Velocidade do boneco

        // Controle de Estado
        let currentMap = 'route'; // 'route' ou ID da casa
        let isDevMode = false;
        let currentTool = null;
        let isDrawing = false;
        let startDraw = {x:0, y:0};
        let tempDrawBox = null;
        
        // Pega parametros da URL (ex: spawn vindo da floresta)
        const urlParams = new URLSearchParams(window.location.search);
        let startX = urlParams.get('x') ? parseFloat(urlParams.get('x')) : 50;
        let startY = urlParams.get('y') ? parseFloat(urlParams.get('y')) : 90; // Default: Chega por baixo
        
        if(urlParams.get('from') === 'forest') { startX = 50; startY = 95; } // Vindo da floresta (baixo)
        if(urlParams.get('from') === 'city_center') { startX = 50; startY = 5; } // Vindo de cima

        // --- CONEX√ÉO SOCKET ---
        socket.on('connect', () => { 
            myId = socket.id;
            socket.emit('enter_map', { 
                userId: window.CURRENT_USER_ID, 
                name: myName, 
                skin: mySkin, 
                map: 'route_main', // Nome √∫nico para esta sala no socket
                x: startX, 
                y: startY, 
                direction: 'up' 
            });
        });

        // --- RENDERIZA√á√ÉO DE JOGADORES ---
        socket.on('map_state', (players) => {
            document.querySelectorAll('.player:not(.npc-entity)').forEach(el => {
                if(el.id !== `p-${myId}`) el.remove(); // N√£o remove o pr√≥prio player pra n√£o piscar
            });
            
            players.forEach(p => {
                if (p.id !== myId) createPlayer(p);
                else {
                    // Atualiza eu mesmo se necess√°rio (ex: primeira carga)
                    const me = document.getElementById(`p-${myId}`);
                    if(!me) createPlayer(p);
                }
            });
            
            document.getElementById('loader').classList.remove('show');
            renderLevelGeometry(); // Desenha paredes/grama
        });

        socket.on('player_joined', (p) => { if(p.id !== myId) createPlayer(p); });
        socket.on('player_left', (id) => { const el = document.getElementById(`p-${id}`); if(el) el.remove(); });
        
        socket.on('player_moved', (data) => {
            const el = document.getElementById(`p-${data.id}`);
            if (el) {
                // Interpola√ß√£o de movimento simples via CSS Transition
                const dur = data.teleport ? 0 : (dist(parseFloat(el.style.left), parseFloat(el.style.top), data.x, data.y) / MOVEMENT_SPEED);
                el.style.transition = dur > 0 ? `top ${dur}s linear, left ${dur}s linear` : 'none';
                
                // For√ßa reflow
                void el.offsetWidth;
                
                el.style.left = data.x + '%';
                el.style.top = data.y + '%';
                el.style.zIndex = Math.floor(data.y);
                el.setAttribute('data-dir', data.direction);

                // Anima√ß√£o de andar
                if (dur > 0) {
                    el.classList.add('walking');
                    clearTimeout(el.walkTimer);
                    el.walkTimer = setTimeout(() => {
                        el.classList.remove('walking');
                        // L√≥gica de Gatilho (s√≥ para mim)
                        if(data.id === myId) checkTriggers(data.x, data.y);
                    }, dur * 1000);
                }
            }
        });

        socket.on('chat_message', (data) => {
            const el = document.getElementById(data.id === myId ? `p-${myId}` : `p-${data.id}`);
            if(el) {
                const bubble = document.createElement('div');
                bubble.className = 'chat-bubble';
                bubble.innerText = data.msg;
                el.appendChild(bubble);
                setTimeout(() => bubble.remove(), 4000);
            }
        });
        
        // Recebe lista de NPCs (vem do servidor baseados no models/NPC)
        socket.on('npcs_list', (list) => {
            document.querySelectorAll('.npc-entity').forEach(e => e.remove());
            list.forEach(npc => {
                const div = document.createElement('div');
                div.className = 'player npc-entity';
                div.style.left = npc.x + '%'; div.style.top = npc.y + '%'; div.style.zIndex = Math.floor(npc.y);
                div.style.backgroundImage = `url('${npc.skin.startsWith('http')?npc.skin:'/uploads/'+npc.skin+'.png'}')`;
                
                const name = document.createElement('div');
                name.className = 'player-name'; name.innerText = npc.name;
                div.appendChild(name);
                
                // INTEGRA√á√ÉO COM COMMON.JS
                div.onclick = (e) => { 
                    e.stopPropagation(); 
                    if(typeof moveToAndTalkToNPC === 'function') {
                        moveToAndTalkToNPC(npc); // Usa a l√≥gica inteligente do common.js
                    }
                };
                
                gameArea.appendChild(div);
            });
        });

        // Batalha Selvagem (Grama)
        socket.on('encounter_found', () => {
             // Redireciona para batalha usando a l√≥gica do servidor
             if(typeof showLoading === 'function') showLoading('Entrando em Batalha...', 'left');
             const me = document.getElementById(`p-${myId}`);
             const cx = parseFloat(me.style.left); const cy = parseFloat(me.style.top);
             
             fetch('/battle/wild', {
                 method: 'POST',
                 headers: {'Content-Type':'application/json'},
                 body: JSON.stringify({ userId: window.CURRENT_USER_ID, currentMap: 'route_main', currentX: cx, currentY: cy })
             }).then(r=>r.json()).then(d => {
                 if(d.battleId) window.location.href = '/battle/' + d.battleId;
                 else { document.getElementById('loader').classList.remove('show'); alert(d.error); }
             });
        });

        // --- INPUT DO JOGADOR (CLIQUE PARA ANDAR) ---
        gameArea.addEventListener('mousedown', (e) => {
            if(isDevMode && currentTool) return; // Se estiver editando, n√£o anda
            
            const rect = gameArea.getBoundingClientRect();
            const clickX = ((e.clientX - rect.left) / rect.width) * 100;
            const clickY = ((e.clientY - rect.top) / rect.height) * 100;
            
            // Pega minha posi√ß√£o atual
            const me = document.getElementById(`p-${myId}`);
            if(!me) return;
            const startX = parseFloat(me.style.left);
            const startY = parseFloat(me.style.top);
            
            // Calcula rota segura (colis√£o simples)
            const target = getSafePath(startX, startY, clickX, clickY);
            
            // Envia movimento
            socket.emit('move_player', { x: target.x, y: target.y });
            
            // Efeito visual de clique
            createClickMarker(e.clientX, e.clientY);
        });

        // --- SISTEMAS DE L√ìGICA DO MAPA ---
        
        function getSafePath(x1, y1, x2, y2) {
            // Verifica colis√£o em passos
            const steps = 20;
            let finalX = x2, finalY = y2;
            
            // Qual mapa de colis√£o usar? (Rota ou Casa)
            let activeCollisions = (currentMap === 'route') ? collisionMap : 
                (housesData.find(h=>h.id===currentMap)?.collisions || []);

            for(let i=1; i<=steps; i++) {
                const t = i/steps;
                const tx = x1 + (x2-x1)*t;
                const ty = y1 + (y2-y1)*t;
                
                // Verifica se bateu em algo
                const hit = activeCollisions.some(c => 
                    tx >= c.x && tx <= c.x+c.w && ty >= c.y && ty <= c.y+c.h
                );
                
                if(hit) {
                    // Se bateu, retorna a ultima posi√ß√£o v√°lida
                    return { x: x1 + (x2-x1)*((i-1)/steps), y: y1 + (y2-y1)*((i-1)/steps) };
                }
            }
            return { x: x2, y: y2 };
        }

        function checkTriggers(x, y) {
            // 1. Sa√≠da para Floresta (Embaixo)
            if (currentMap === 'route' && y > 96 && x > 35 && x < 65) {
                window.location.href = '/forest?from=route&x=50&y=5&userId=' + window.CURRENT_USER_ID;
                return;
            }

            // 2. Entrar em Casas
            if (currentMap === 'route') {
                const house = housesData.find(h => 
                    x >= h.trigger.x && x <= h.trigger.x+h.trigger.w &&
                    y >= h.trigger.y && y <= h.trigger.y+h.trigger.h
                );
                if (house) enterHouse(house);
            }
            
            // 3. Sair de Casas
            if (currentMap !== 'route') {
                const house = housesData.find(h => h.id === currentMap);
                if (house && house.exit && 
                    x >= house.exit.x && x <= house.exit.x+house.exit.w &&
                    y >= house.exit.y && y <= house.exit.y+house.exit.h) {
                    exitHouse(house);
                }
            }
            
            // 4. Grama (Batalha)
            if (currentMap === 'route') {
                // Verifica se est√° na grama
                const inGrass = grassMap.some(g => x >= g.x && x <= g.x+g.w && y >= g.y && y <= g.y+g.h);
                // Envia para o servidor checar RNG (Chance global)
                if (inGrass) socket.emit('check_encounter', { grassId: 'route_grass' });
            }
        }

        function enterHouse(house) {
            currentMap = house.id;
            gameArea.style.backgroundImage = `url('${house.bg}')`;
            gameArea.classList.add('indoor-mode');
            renderLevelGeometry();
            
            // Teleporta visualmente
            const me = document.getElementById(`p-${myId}`);
            me.style.transition = 'none';
            me.style.left = (house.spawn?.x || 50) + '%';
            me.style.top = (house.spawn?.y || 80) + '%';
            
            // Avisa servidor (muda de sala socket se quiser l√≥gica avan√ßada, ou s√≥ atualiza pos)
            // Aqui mantemos 'route_main' mas mudamos pos visualmente
        }

        function exitHouse(house) {
            currentMap = 'route';
            gameArea.style.backgroundImage = `url('/uploads/route_bg.png')`;
            gameArea.classList.remove('indoor-mode');
            renderLevelGeometry();
            
            const me = document.getElementById(`p-${myId}`);
            me.style.transition = 'none';
            // Sai na frente da porta
            me.style.left = (house.trigger.x + house.trigger.w/2) + '%';
            me.style.top = (house.trigger.y + house.trigger.h + 5) + '%';
        }

        // --- SISTEMA DE DEV / ADMIN (PARA COLIS√ÉO) ---
        
        function toggleDevMode() {
            isDevMode = !isDevMode;
            document.getElementById('devControls').style.display = isDevMode ? 'flex' : 'none';
            document.getElementById('btnDevToggle').innerText = isDevMode ? 'DESATIVAR' : 'ATIVAR EDITOR';
            renderLevelGeometry();
        }

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            const map = {'collision':'btnCol', 'grass':'btnGrs', 'house':'btnHse'};
            if(map[t]) document.getElementById(map[t]).classList.add('active');
        }

        // Desenhar caixas
        gameArea.addEventListener('mousedown', (e) => {
            if(!isDevMode || !currentTool) return;
            e.stopPropagation(); e.preventDefault();
            isDrawing = true;
            const rect = gameArea.getBoundingClientRect();
            startDraw = {x: ((e.clientX-rect.left)/rect.width)*100, y: ((e.clientY-rect.top)/rect.height)*100};
            
            tempDrawBox = document.createElement('div');
            tempDrawBox.className = currentTool === 'collision' ? 'dev-collision' : (currentTool === 'grass' ? 'dev-grass' : 'dev-house');
            tempDrawBox.style.position = 'absolute';
            tempDrawBox.style.left = startDraw.x+'%'; tempDrawBox.style.top = startDraw.y+'%';
            document.getElementById('layer-dev').appendChild(tempDrawBox);
        });

        gameArea.addEventListener('mousemove', (e) => {
            if(!isDrawing) return;
            const rect = gameArea.getBoundingClientRect();
            const currX = ((e.clientX-rect.left)/rect.width)*100;
            const currY = ((e.clientY-rect.top)/rect.height)*100;
            
            const w = Math.abs(currX - startDraw.x);
            const h = Math.abs(currY - startDraw.y);
            const l = Math.min(currX, startDraw.x);
            const t = Math.min(currY, startDraw.y);
            
            tempDrawBox.style.width = w+'%'; tempDrawBox.style.height = h+'%';
            tempDrawBox.style.left = l+'%'; tempDrawBox.style.top = t+'%';
        });

        gameArea.addEventListener('mouseup', () => {
            if(!isDrawing) return; isDrawing = false;
            const rect = {
                x: parseFloat(tempDrawBox.style.left), y: parseFloat(tempDrawBox.style.top),
                w: parseFloat(tempDrawBox.style.width), h: parseFloat(tempDrawBox.style.height)
            };
            
            if(rect.w > 1 && rect.h > 1) {
                if(currentTool === 'collision') collisionMap.push(rect);
                if(currentTool === 'grass') grassMap.push(rect);
                if(currentTool === 'house') {
                    const id = prompt('ID da casa (ex: house_red):', 'house_'+Date.now());
                    const bg = prompt('URL do fundo (interior):', '/uploads/room_bg.png');
                    housesData.push({ id, bg, trigger: rect, collisions: [], spawn: {x:50,y:80}, exit: {x:40,y:90,w:20,h:10} });
                }
            }
            tempDrawBox.remove();
            renderLevelGeometry();
        });

        function undoLast() {
            if(currentTool === 'collision') collisionMap.pop();
            if(currentTool === 'grass') grassMap.pop();
            if(currentTool === 'house') housesData.pop();
            renderLevelGeometry();
        }

        function exportConfig() {
            const str = `let collisionMap = ${JSON.stringify(collisionMap)};\nlet grassMap = ${JSON.stringify(grassMap)};\nlet housesData = ${JSON.stringify(housesData)};`;
            const out = document.getElementById('configOutput');
            out.style.display = 'block'; out.value = str; out.select(); document.execCommand('copy');
            alert('Configura√ß√£o copiada! Cole no topo do arquivo.');
            out.style.display = 'none';
        }

        // --- FUN√á√ïES AUXILIARES ---

        function renderLevelGeometry() {
            const colL = document.getElementById('layer-collision'); colL.innerHTML = '';
            const grsL = document.getElementById('layer-grass'); grsL.innerHTML = '';
            const trgL = document.getElementById('layer-triggers'); trgL.innerHTML = '';

            // Se estiver na rota principal
            if (currentMap === 'route') {
                collisionMap.forEach(r => drawRect(colL, r, 'collision-box', 'dev-collision'));
                grassMap.forEach(r => drawRect(grsL, r, 'grass-patch', 'dev-grass'));
                housesData.forEach(h => drawRect(trgL, h.trigger, 'house-trigger', 'dev-house'));
            } else {
                // Se estiver dentro de casa
                const house = housesData.find(h => h.id === currentMap);
                if(house && house.collisions) {
                    house.collisions.forEach(r => drawRect(colL, r, 'collision-box', 'dev-collision'));
                }
                if(house && house.exit) {
                    drawRect(trgL, house.exit, 'house-trigger', 'dev-exit');
                }
            }
        }

        function drawRect(container, r, className, devClass) {
            const d = document.createElement('div');
            d.className = className + (isDevMode ? ' '+devClass : '');
            d.style.left = r.x+'%'; d.style.top = r.y+'%'; d.style.width = r.w+'%'; d.style.height = r.h+'%';
            container.appendChild(d);
        }

        function createPlayer(p) {
            const div = document.createElement('div');
            div.id = `p-${p.id}`; div.className = 'player';
            div.style.left = p.x+'%'; div.style.top = p.y+'%';
            div.style.backgroundImage = `url('${p.sprite || '/uploads/'+(p.skin||'char1')+'.png'}')`;
            
            const name = document.createElement('div');
            name.className = 'player-name'; name.innerText = p.name;
            div.appendChild(name);
            
            gameArea.appendChild(div);
        }

        function createClickMarker(x, y) {
            const m = document.createElement('div');
            m.style.position = 'fixed'; m.style.left = x+'px'; m.style.top = y+'px';
            m.style.width = '10px'; m.style.height = '10px'; m.style.background = 'rgba(255,255,255,0.4)';
            m.style.borderRadius = '50%'; m.style.pointerEvents = 'none'; m.style.zIndex = '9999';
            m.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(m);
            setTimeout(() => m.remove(), 300);
        }

        function dist(x1, y1, x2, y2) { return Math.sqrt(Math.pow(x2-x1, 2) + Math.pow(y2-y1, 2)); }

        // Chat
        const chatIn = document.getElementById('chatInput');
        document.getElementById('chatSend').onclick = () => {
            if(chatIn.value.trim()) { socket.emit('send_chat', chatIn.value); chatIn.value=''; }
        };
    </script>
</body>
</html>
