<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Rota Selvagem</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. RESET E BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; background: #111; overflow: hidden; height: 100vh; width: 100vw; font-family: 'Roboto', sans-serif; user-select: none; display: flex; justify-content: center; align-items: center; }
        
        #gameArea { 
            position: relative; 
            width: 100%; max-width: 500px; 
            height: 100%; max-height: 900px; 
            
            /* SUA NOVA IMAGEM DE MAPA AQUI */
            background-image: url('/uploads/route_map.png'); 
            
            background-size: 100% 100%; 
            background-position: center;
            background-repeat: no-repeat; 
            image-rendering: pixelated; 
            cursor: pointer; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            overflow: hidden; 
            z-index: 1; isolation: isolate; 
        }

        /* --- 2. JOGADOR --- */
        .player { 
            position: absolute; 
            width: 28px; height: 28px; 
            background-size: 400% auto; 
            image-rendering: pixelated; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); 
            margin-left: -14px; margin-top: -26px; /* Piv√¥ nos p√©s */
            z-index: 10; 
            transition: top 0s linear, left 0s linear; 
        }
        
        <% for(let i = 1; i <= skinCount; i++) { %> 
            .player[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); } 
        <% } %>
        
        .player.walking { animation: walk-anim 0.4s steps(4) infinite; }
        @keyframes walk-anim { from { background-position-x: 0; } to { background-position-x: -400%; } }
        
        .player[data-dir="down"] { background-position-y: 0%; } 
        .player[data-dir="left"] { background-position-y: 33.33%; } 
        .player[data-dir="right"] { background-position-y: 66.66%; } 
        .player[data-dir="up"] { background-position-y: 100%; }
        
        .player-name { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.6); color: white; padding: 1px 4px; border-radius: 3px; 
            font-size: 0.5rem; white-space: nowrap; pointer-events: none; z-index: 500; font-weight: bold;
        }

        /* --- 3. COLIS√ÉO VISUAL (PARA DEBUG) --- */
        /* IMPORTANTE: Mude 'rgba(255, 0, 0, 0.3)' para 'transparent' quando terminar de testar */
        .collision-box {
            position: absolute;
            background: rgba(255, 0, 0, 0.3); 
            pointer-events: none;
            z-index: 5;
            border: 1px solid rgba(255,0,0,0.5);
        }

        /* --- 4. √ÅREAS ESPECIAIS (Grama e Sa√≠das) --- */
        .grass-patch { position: absolute; z-index: 4; cursor: pointer; background: transparent; }
        
        /* Gatilhos de Sa√≠da de Mapa */
        .map-exit { position: absolute; z-index: 20; background: transparent; }
        
        /* --- 5. UI ELEMENTS --- */
        .chat-bubble { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 3px 6px; border-radius: 6px; border: 1px solid #333; font-size: 0.6rem; white-space: nowrap; z-index: 1000; animation: popIn 0.2s forwards; }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
        
        #chatBar { position: fixed; bottom: max(20px, env(safe-area-inset-bottom) + 15px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; display: flex; align-items: center; gap: 8px; z-index: 9999; background: #1a1a2e; border: 2px solid #3498db; padding: 8px; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.6); }
        #chatInput { flex: 1; padding: 5px 10px; border: none; background: transparent; color: white; outline: none; font-family: 'Roboto', sans-serif; font-size: 1rem; }
        #chatSend { width: 40px; height: 40px; border-radius: 50%; border: none; background: linear-gradient(135deg, #f1c40f, #f39c12); color: #1a1a2e; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        #toastContainer { position: fixed; top: 20px; width: 100%; display: flex; justify-content: center; z-index: 2000; pointer-events: none; }
        
        .loader-overlay { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.9); z-index: 99999; opacity: 0; pointer-events: none; transition: opacity .35s ease; }
        .loader-overlay.show { opacity: 1; pointer-events: auto; }
        .loader-box { background: linear-gradient(135deg,#0b1622,#071018); border: 1px solid rgba(255,255,255,0.05); padding: 20px 26px; border-radius: 12px; display:flex; align-items:center; gap:12px; color:#fff; font-family:'Press Start 2P'; }
        .loader-box .spinner { width: 28px; height: 28px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.08); border-top-color: #f1c40f; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <%- include('partials/menu') %>

    <div id="gameArea">
        <!-- Renderiza√ß√£o das Caixas de Colis√£o -->
        <div id="collision-container"></div>

        <!-- Matinhos (Locais de Batalha) -->
        <!-- Ajuste as coordenadas (top, left, width, height) para sua imagem -->
        <div id="grass-area-1" class="grass-patch" style="top: 15%; left: 15%; width: 25%; height: 30%;"></div>
        <div id="grass-area-2" class="grass-patch" style="top: 45%; left: 5%; width: 10%; height: 5%;"></div>
        <div id="grass-area-3" class="grass-patch" style="top: 10%; left: 65%; width: 20%; height: 10%;"></div>
        <div id="grass-area-4" class="grass-patch" style="top: 75%; left: 10%; width: 15%; height: 10%;"></div>
        <div id="grass-area-5" class="grass-patch" style="top: 85%; left: 60%; width: 20%; height: 10%;"></div>

        <!-- Sa√≠das do Mapa -->
        <!-- Ajuste as coordenadas conforme onde voc√™ quer as transi√ß√µes de mapa -->
        <div id="exit-top" class="map-exit" style="top: 0; left: 40%; width: 20%; height: 5%;"></div>
        <div id="exit-bottom" class="map-exit" style="bottom: 0; left: 40%; width: 20%; height: 5%;"></div>

        <!-- Chat -->
        <div id="chatBar"><input type="text" id="chatInput" placeholder="Mensagem..."><button id="chatSend">üí¨</button></div>
    </div>
    
    <div id="toastContainer"></div>
    <div id="loader" class="loader-overlay show"><div class="loader-box"><div class="spinner"></div><div class="loader-text">Carregando mapa...</div></div></div>

    <!-- SCRIPTS -->
    <script>
        const socket = io();
        const myName = "<%= playerName %>";
        const mySkin = "<%= playerSkin %>";
        window.CURRENT_USER_ID = "<%= user._id %>"; 
        
        // As coordenadas iniciais do jogador ao entrar neste mapa
        const startX = <%= startX %>;
        const startY = <%= startY %>;
        let myId = null;
        const MOVEMENT_SPEED = 50; 
        let isMoving = false;
        
        // --- 1. DEFINI√á√ÉO DE OBST√ÅCULOS (baseado na sua nova imagem) ---
        // As coordenadas s√£o em porcentagem (%) do tamanho da gameArea.
        // {x: left, y: top, w: width, h: height}
        const collisionMap = [
            // Bordas Superiores/Inferiores (para n√£o sair do mapa por cima/baixo do cen√°rio)
            {x: 0, y: 0, w: 100, h: 1},   // Borda superior
            {x: 0, y: 99, w: 100, h: 1},  // Borda inferior

            // √Årvores no topo
            {x: 5, y: 0, w: 15, h: 10},   // √Årvore Topo Esquerda
            {x: 80, y: 0, w: 15, h: 10},  // √Årvore Topo Direita

            // Casa Vermelha (esquerda)
            {x: 10, y: 50, w: 20, h: 15}, 
            
            // Casa Azul (direita)
            {x: 70, y: 50, w: 20, h: 15},
            
            // Casa Amarela (direita, abaixo da azul)
            {x: 70, y: 65, w: 20, h: 15},
            
            // Cercas (analisando a imagem)
            // A cerca √© um conjunto de pequenos blocos. Vamos consolidar.
            // Cerca Esquerda (pr√≥xima √† casa vermelha)
            {x: 30, y: 50, w: 10, h: 5},  // horizontal
            {x: 30, y: 55, w: 10, h: 5},  // horizontal
            {x: 30, y: 60, w: 10, h: 5},  // horizontal
            
            // Cerca Direita (pr√≥xima √†s casas azul/amarela)
            {x: 60, y: 50, w: 10, h: 5},  // horizontal
            {x: 60, y: 55, w: 10, h: 5},  // horizontal
            {x: 60, y: 60, w: 10, h: 5},  // horizontal

            // Postes da cerca (verticais no meio)
            {x: 40, y: 50, w: 5, h: 15},  // Vertical esquerdo
            {x: 55, y: 50, w: 5, h: 15},  // Vertical direito

            // Rochas
            {x: 65, y: 15, w: 5, h: 5},   // Rocha Topo Direita
            {x: 65, y: 80, w: 5, h: 5},   // Rocha Baixo Direita
            {x: 15, y: 80, w: 5, h: 5},   // Rocha Baixo Esquerda
            {x: 75, y: 30, w: 5, h: 5}    // Rocha Meio Direita
        ];

        // Renderiza as caixas de colis√£o para DEBUG.
        const debugContainer = document.getElementById('collision-container');
        collisionMap.forEach(rect => {
            const div = document.createElement('div');
            div.className = 'collision-box';
            div.style.left = rect.x + '%';
            div.style.top = rect.y + '%';
            div.style.width = rect.w + '%';
            div.style.height = rect.h + '%';
            debugContainer.appendChild(div);
        });

        // --- 2. SISTEMA DE MOVIMENTO (Raycast) ---
        function getSafeTarget(currX, currY, targetX, targetY) {
            const steps = 20; // N√∫mero de "passos" para verificar colis√µes na linha
            for (let i = 1; i <= steps; i++) {
                const t = i / steps;
                const px = currX + (targetX - currX) * t;
                const py = currY + (targetY - currY) * t;

                const hit = collisionMap.some(rect => 
                    px >= rect.x && px <= (rect.x + rect.w) &&
                    py >= rect.y && py <= (rect.y + rect.h)
                );

                if (hit) {
                    // Colidiu, retorna o ponto seguro anterior
                    const safeT = (i - 1) / steps;
                    return { x: currX + (targetX - currX) * safeT, y: currY + (targetY - currY) * safeT };
                }
            }
            return { x: targetX, y: targetY }; // N√£o colidiu, vai at√© o destino
        }

        // --- 3. EVENTOS DE CLIQUE ---
        const gameArea = document.getElementById('gameArea');
        gameArea.addEventListener('click', (e) => {
            if (e.target.closest('#chatBar') || isMoving) return;

            const rect = gameArea.getBoundingClientRect();
            const rawX = ((e.clientX - rect.left) / rect.width) * 100;
            const rawY = ((e.clientY - rect.top) / rect.height) * 100;

            const myPlayer = document.getElementById(`p-${myId}`);
            if (!myPlayer) return;

            const currX = parseFloat(myPlayer.style.left);
            const currY = parseFloat(myPlayer.style.top);
            const safeDest = getSafeTarget(currX, currY, rawX, rawY);

            isMoving = true;
            socket.emit('move_player', { x: safeDest.x, y: safeDest.y });
            
            // Verifica sa√≠das do mapa AP√ìS o movimento
            checkExits(safeDest.x, safeDest.y);
        });

        // --- 4. SOCKETS ---
        socket.on('connect', () => { 
            myId = socket.id; 
            // O 'map: 'city'' pode ser alterado para 'route1' ou similar se voc√™ renomear o arquivo
            socket.emit('enter_map', { userId: window.CURRENT_USER_ID, name: myName, skin: mySkin, map: 'city', x: startX, y: startY, direction: 'down' }); 
        });

        socket.on('map_state', (players) => { 
            document.querySelectorAll('.player').forEach(el => el.remove()); 
            players.forEach(createPlayer); 
            document.getElementById('loader').classList.remove('show');
        });
        
        socket.on('player_joined', (p) => { if(p.id !== myId) createPlayer(p); });
        
        socket.on('player_moved', (data) => {
            const el = document.getElementById(`p-${data.id}`);
            if (el) {
                const currX = parseFloat(el.style.left) || 50;
                const currY = parseFloat(el.style.top) || 50;
                const dist = Math.hypot(data.x - currX, data.y - currY);
                const time = dist > 0 ? (dist / MOVEMENT_SPEED) : 0;

                el.style.transition = `top ${time}s linear, left ${time}s linear`;
                void el.offsetWidth;
                el.style.left = data.x + '%';
                el.style.top = data.y + '%';
                el.style.zIndex = Math.floor(data.y); 

                const dx = data.x - currX;
                const dy = data.y - currY;
                if(Math.abs(dx) > Math.abs(dy)) el.setAttribute('data-dir', dx > 0 ? 'right' : 'left');
                else el.setAttribute('data-dir', dy > 0 ? 'down' : 'up');

                if (time > 0) {
                    el.classList.add('walking');
                    if (el.timeout) clearTimeout(el.timeout);
                    el.timeout = setTimeout(() => {
                        el.classList.remove('walking');
                        if (data.id === myId) isMoving = false;
                    }, time * 1000);
                } else if (data.id === myId) isMoving = false;
            }
        });

        socket.on('player_left', (id) => { const el = document.getElementById(`p-${id}`); if(el) el.remove(); });

        function createPlayer(p) {
            const div = document.createElement('div');
            div.id = `p-${p.id}`;
            div.className = 'player';
            div.style.left = p.x + '%';
            div.style.top = p.y + '%';
            div.setAttribute('data-skin', p.skin || 'char1');
            div.innerHTML = `<div class="player-name">${p.name}</div>`;
            gameArea.appendChild(div);
        }

        // --- 5. L√ìGICA DE SA√çDA DE MAPA ---
        function checkExits(destX, destY) {
            const myPlayer = document.getElementById(`p-${myId}`);
            if(!myPlayer) return;
            const currX = parseFloat(myPlayer.style.left);
            const currY = parseFloat(myPlayer.style.top);
            const dist = Math.hypot(destX - currX, destY - currY);
            const timeMs = (dist / MOVEMENT_SPEED) * 1000;

            setTimeout(() => {
                // Sa√≠da Topo (assumindo que leva para 'forest')
                if (destY < 5 && destX > 30 && destX < 70) {
                    changeMap('forest'); // Leva para /forest
                }
                // Sa√≠da Baixo (assumindo que leva para 'lobby' ou 'another_route')
                else if (destY > 95 && destX > 30 && destX < 70) {
                    changeMap('lobby'); // Leva para /lobby
                }
            }, timeMs);
        }

        function changeMap(destination) {
            document.getElementById('loader').classList.add('show');
            // Ajuste o redirect conforme suas rotas reais no servidor (app.js/server.js)
            if(destination === 'forest') window.location.href = '/forest?userId=' + window.CURRENT_USER_ID;
            if(destination === 'lobby') window.location.href = '/lobby?userId=' + window.CURRENT_USER_ID;
            // Exemplo: if(destination === 'route2') window.location.href = '/route2?userId=' + window.CURRENT_USER_ID;
        }

        // --- 6. GATILHOS DE BATALHA (Matinhos) ---
        // A l√≥gica de detec√ß√£o de encontro agora √© feita pelo clique na gameArea + elementsFromPoint.
        // O `onclick` nos divs de grama n√£o √© estritamente necess√°rio, mas mantido para clareza.
        gameArea.addEventListener('click', (e) => {
            // ... (c√≥digo de movimento j√° est√° aqui) ...
            const elements = document.elementsFromPoint(e.clientX, e.clientY);
            const grassEl = elements.find(el => el.classList && el.classList.contains('grass-patch'));
            if (grassEl) {
                socket.emit('check_encounter', { grassId: grassEl.id });
            }
        });

        // --- 7. UTILIT√ÅRIOS (Chat, Toast, Loader) ---
        const chatIn = document.getElementById('chatInput');
        document.getElementById('chatSend').onclick = () => { if(chatIn.value.trim()) { socket.emit('send_chat', chatIn.value); chatIn.value=''; } };
        socket.on('chat_message', (d) => { const p = document.getElementById(`p-${d.id}`); if(p) { const b = document.createElement('div'); b.className='chat-bubble'; b.innerText=d.msg; p.appendChild(b); setTimeout(()=>b.remove(), 4000); }});
        function showToast(msg, opts={}) { const c = document.getElementById('toastContainer'); const d = document.createElement('div'); d.style.background = opts.bg || '#333'; d.style.color = '#fff'; d.style.padding = '10px 20px'; d.style.marginBottom = '10px'; d.style.borderRadius = '5px'; d.innerText = msg; c.appendChild(d); setTimeout(() => d.remove(), 3000); }
        
        socket.on('encounter_found', () => {
             showToast('‚öîÔ∏è Batalha encontrada!', {bg:'#e74c3c'});
             document.getElementById('loader').classList.add('show');
             setTimeout(() => {
                 fetch('/battle/wild', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({userId: window.CURRENT_USER_ID, currentMap: 'city'}) }).then(r=>r.json()).then(d => { if(d.battleId) window.location.href = '/battle/' + d.battleId; });
             }, 1000);
        });
    </script>
</body>
</html>
