<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cidade</title>
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. RESET E BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; padding: 0; background: #111; overflow: hidden; height: 100vh; width: 100vw; font-family: 'Roboto', sans-serif; user-select: none; display: flex; justify-content: center; align-items: center; }
        
        #gameArea { 
            position: relative; 
            width: 100%; max-width: 500px; 
            height: 100%; max-height: 900px; 
            /* Imagem de Fundo */
            background-image: url('/uploads/city_map_large.png'); 
            background-size: 100% 100%; 
            background-position: center;
            background-repeat: no-repeat; 
            image-rendering: pixelated; 
            cursor: pointer; 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            overflow: hidden; 
            z-index: 1; isolation: isolate; 
        }

        /* --- 2. JOGADOR (MENOR E COM EFEITOS) --- */
        .player { 
            position: absolute; 
            width: 28px; height: 28px; /* Tamanho reduzido */
            background-size: 400% auto; 
            image-rendering: pixelated; 
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); 
            /* Piv√¥ nos p√©s */
            margin-left: -14px; margin-top: -26px; 
            z-index: 10; 
            /* Transi√ß√£o suave de movimento e de opacidade para entrar nas casas */
            transition: top 0s linear, left 0s linear, transform 0.3s ease, opacity 0.3s ease; 
        }

        /* Classe para sumir ao entrar */
        .player.entering-building {
            transform: scale(0.5) translateY(10px);
            opacity: 0;
        }
        
        <% for(let i = 1; i <= skinCount; i++) { %> 
            .player[data-skin="char<%= i %>"] { background-image: url('/uploads/char<%= i %>.png'); } 
        <% } %>
        
        .player.walking { animation: walk-anim 0.4s steps(4) infinite; }
        @keyframes walk-anim { from { background-position-x: 0; } to { background-position-x: -400%; } }
        
        .player[data-dir="down"] { background-position-y: 0%; } 
        .player[data-dir="left"] { background-position-y: 33.33%; } 
        .player[data-dir="right"] { background-position-y: 66.66%; } 
        .player[data-dir="up"] { background-position-y: 100%; }
        
        .player-name { 
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%); 
            background: rgba(0,0,0,0.6); color: white; padding: 1px 4px; border-radius: 3px; 
            font-size: 0.5rem; white-space: nowrap; pointer-events: none; z-index: 500; font-weight: bold;
        }

        /* --- 3. COLIS√ÉO VISUAL (DEBUG) --- */
        /* IMPORTANTE: Mude 'rgba(255, 0, 0, 0.2)' para 'transparent' quando terminar de testar */
        .collision-box {
            position: absolute;
            background: rgba(255, 0, 0, 0.2); 
            pointer-events: none;
            z-index: 5;
            /* border: 1px solid rgba(255,0,0,0.5); */
        }

        /* --- 4. GATILHOS (√Åreas no Ch√£o) --- */
        .interaction-trigger { position: absolute; z-index: 20; cursor: pointer; background: transparent; }
        
        /* Ajustado para ficar na CAL√áADA em frente √† porta */
        #trigger-shop { top: 43%; left: 30%; width: 8%; height: 5%; }
        #trigger-heal { top: 64%; left: 63%; width: 8%; height: 5%; }
        #trigger-exit { top: 96%; left: 40%; width: 20%; height: 4%; }

        /* Matinhos */
        .grass-patch { position: absolute; z-index: 4; cursor: pointer; background: transparent; }
        #grass-left { top: 39%; left: 0%; width: 14%; height: 17%; }
        #grass-bottom { top: 89%; left: 0%; width: 15%; height: 11%; }
        #grass-top { top: 3%; left: 28%; width: 15%; height: 10%; }

        /* --- 5. UI (Chat, Toast, Loader) --- */
        .chat-bubble { position: absolute; bottom: 35px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 3px 6px; border-radius: 6px; border: 1px solid #333; font-size: 0.6rem; white-space: nowrap; z-index: 1000; animation: popIn 0.2s forwards; }
        @keyframes popIn { from { transform: translateX(-50%) scale(0); opacity: 0; } to { transform: translateX(-50%) scale(1); opacity: 1; } }
        
        #chatBar { position: fixed; bottom: max(20px, env(safe-area-inset-bottom) + 15px); left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; display: flex; align-items: center; gap: 8px; z-index: 9999; background: #1a1a2e; border: 2px solid #3498db; padding: 8px; border-radius: 50px; box-shadow: 0 10px 20px rgba(0,0,0,0.6); }
        #chatInput { flex: 1; padding: 5px 10px; border: none; background: transparent; color: white; outline: none; font-family: 'Roboto', sans-serif; font-size: 1rem; }
        #chatSend { width: 40px; height: 40px; border-radius: 50%; border: none; background: linear-gradient(135deg, #f1c40f, #f39c12); color: #1a1a2e; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        
        #toastContainer { position: fixed; top: 20px; width: 100%; display: flex; justify-content: center; z-index: 2000; pointer-events: none; }
        
        .loader-overlay { position: fixed; inset: 0; display:flex; align-items:center; justify-content:center; background: rgba(0,0,0,0.9); z-index: 99999; opacity: 0; pointer-events: none; transition: opacity .35s ease; }
        .loader-overlay.show { opacity: 1; pointer-events: auto; }
        .loader-box { background: linear-gradient(135deg,#0b1622,#071018); border: 1px solid rgba(255,255,255,0.05); padding: 20px 26px; border-radius: 12px; display:flex; align-items:center; gap:12px; color:#fff; font-family:'Press Start 2P'; }
        .loader-box .spinner { width: 28px; height: 28px; border-radius: 50%; border: 4px solid rgba(255,255,255,0.08); border-top-color: #f1c40f; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Modais */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1a1a2e; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; border: 1px solid #3498db; color: white; position: relative; max-height: 85vh; overflow-y: auto; }
        .close-btn { position: absolute; top: 10px; right: 10px; background: #e74c3c; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold;}
    </style>
</head>
<body>
    <%- include('partials/menu') %>

    <div id="gameArea">
        <!-- Renderiza√ß√£o das Caixas de Colis√£o -->
        <div id="collision-container"></div>

        <!-- Gatilhos -->
        <div id="trigger-shop" class="interaction-trigger"></div>
        <div id="trigger-heal" class="interaction-trigger"></div>
        <div id="trigger-exit" class="interaction-trigger" onclick="goToForest()"></div>

        <!-- Matinhos -->
        <div id="grass-left" class="grass-patch" onclick="handleGrassClick(event, 'grass-left')"></div>
        <div id="grass-bottom" class="grass-patch" onclick="handleGrassClick(event, 'grass-bottom')"></div>
        <div id="grass-top" class="grass-patch" onclick="handleGrassClick(event, 'grass-top')"></div>

        <!-- Chat -->
        <div id="chatBar"><input type="text" id="chatInput" placeholder="Mensagem..."><button id="chatSend">üí¨</button></div>
    </div>
    
    <div id="toastContainer"></div>
    <div id="loader" class="loader-overlay show"><div class="loader-box"><div class="spinner"></div><div class="loader-text">Carregando mapa...</div></div></div>

    <!-- MODAL LOJA -->
    <div class="modal-overlay" id="modalShop">
        <div class="modal-content">
            <button class="close-btn" onclick="exitBuilding('modalShop')">X</button>
            <h2 style="text-align:center; color:#f1c40f; font-family:'Press Start 2P'; margin-bottom:20px;">LOJA</h2>
            <div style="text-align:center; color:#ccc; margin-bottom:20px; font-size:0.8rem;">Bem-vindo! O que deseja?</div>
            
            <div style="background:#0b1220; padding:15px; border-radius:8px; display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                <img src="/uploads/catchcube.gif" style="width:30px;">
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#fff;">CatchCube</div>
                    <div style="font-size:0.7rem; color:#aaa;">Captura monstros.</div>
                    <div style="color:#f1c40f;">$50</div>
                </div>
                <button onclick="buyItem('pokeball')" style="background:#27ae60; border:none; padding:8px; color:white; border-radius:5px; cursor:pointer;">COMPRAR</button>
            </div>
            
            <div style="background:#0b1220; padding:15px; border-radius:8px; display:flex; align-items:center; gap:10px;">
                <div style="font-size:24px;">üç¨</div>
                <div style="flex:1;">
                    <div style="font-weight:bold; color:#fff;">Rare Candy</div>
                    <div style="font-size:0.7rem; color:#aaa;">+1 N√≠vel.</div>
                    <div style="color:#f1c40f;">$2000</div>
                </div>
                <button onclick="buyItem('rareCandy')" style="background:#27ae60; border:none; padding:8px; color:white; border-radius:5px; cursor:pointer;">COMPRAR</button>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const socket = io();
        const myName = "<%= playerName %>";
        const mySkin = "<%= playerSkin %>";
        window.CURRENT_USER_ID = "<%= user._id %>"; 
        
        const startX = <%= startX %>;
        const startY = <%= startY %>;
        let myId = null;
        const MOVEMENT_SPEED = 50; 
        let isMoving = false;
        
        // --- 1. MAPEAMENTO DE COLIS√ÉO CORRIGIDO ---
        // As caixas param ANTES da porta (altura menor), permitindo andar no gatilho.
        const collisionMap = [
            // COLUNA 1 (Esquerda)
            {x: 2, y: 11, w: 11, h: 7},
            {x: 2, y: 21, w: 11, h: 7},
            {x: 2, y: 31, w: 11, h: 7},
            {x: 2, y: 61, w: 11, h: 7},
            {x: 2, y: 71, w: 11, h: 7},
            {x: 2, y: 81, w: 11, h: 7},

            // COLUNA 2 (Centro Esquerda)
            {x: 25, y: 19, w: 15, h: 10}, 
            {x: 25, y: 34, w: 15, h: 8},  // LOJA (Mais curto no Y para liberar a porta)
            {x: 25, y: 53, w: 15, h: 10}, 
            {x: 25, y: 69, w: 15, h: 10}, 
            {x: 25, y: 89, w: 12, h: 6},  

            // COLUNA 3 (Centro Direita)
            {x: 57, y: 4, w: 16, h: 10},  
            {x: 57, y: 19, w: 15, h: 9}, 
            {x: 57, y: 33, w: 15, h: 9}, 
            {x: 57, y: 49, w: 15, h: 13}, // CENTRO POKEMON (Mais curto no Y para liberar a porta)
            {x: 57, y: 67, w: 15, h: 9}, 
            {x: 57, y: 81, w: 15, h: 9}, 

            // COLUNA 4 (Direita)
            {x: 87, y: 13, w: 10, h: 7},
            {x: 87, y: 25, w: 10, h: 7},
            {x: 87, y: 35, w: 10, h: 7},
            {x: 87, y: 59, w: 10, h: 7},
            {x: 87, y: 70, w: 10, h: 7},
            {x: 87, y: 82, w: 10, h: 7},
            
            // OBST√ÅCULOS
            {x: 0, y: 0, w: 100, h: 2}, // Topo
        ];

        // Renderiza as caixas vermelhas (Debug)
        const debugContainer = document.getElementById('collision-container');
        collisionMap.forEach(rect => {
            const div = document.createElement('div');
            div.className = 'collision-box';
            div.style.left = rect.x + '%';
            div.style.top = rect.y + '%';
            div.style.width = rect.w + '%';
            div.style.height = rect.h + '%';
            debugContainer.appendChild(div);
        });

        // --- 2. SISTEMA DE MOVIMENTO SAFE (RAYCAST) ---
        function getSafeTarget(currX, currY, targetX, targetY) {
            const steps = 25; // Precis√£o
            
            for (let i = 1; i <= steps; i++) {
                const t = i / steps;
                const px = currX + (targetX - currX) * t;
                const py = currY + (targetY - currY) * t;

                // Verifica colis√£o do ponto atual
                const hit = collisionMap.some(rect => 
                    px >= rect.x && px <= (rect.x + rect.w) &&
                    py >= rect.y && py <= (rect.y + rect.h)
                );

                if (hit) {
                    // Retorna o passo anterior (antes de bater)
                    const safeT = (i - 1) / steps;
                    return {
                        x: currX + (targetX - currX) * safeT,
                        y: currY + (targetY - currY) * safeT
                    };
                }
            }
            return { x: targetX, y: targetY };
        }

        // --- 3. L√ìGICA DE CLIQUE E JOGO ---
        const gameArea = document.getElementById('gameArea');
        
        gameArea.addEventListener('click', (e) => {
            if (e.target.closest('#chatBar') || e.target.closest('.modal-content') || isMoving) return;

            const rect = gameArea.getBoundingClientRect();
            const rawX = ((e.clientX - rect.left) / rect.width) * 100;
            const rawY = ((e.clientY - rect.top) / rect.height) * 100;

            const myPlayer = document.getElementById(`p-${myId}`);
            if (!myPlayer) return;

            const currX = parseFloat(myPlayer.style.left);
            const currY = parseFloat(myPlayer.style.top);

            // Calcula onde parar se houver parede no caminho
            const safeDest = getSafeTarget(currX, currY, rawX, rawY);

            // Mover
            isMoving = true;
            socket.emit('move_player', { x: safeDest.x, y: safeDest.y });

            // Verificar se o destino (safeDest) interage com algo
            checkInteractions(safeDest.x, safeDest.y);
        });

        // --- 4. SOCKETS ---
        socket.on('connect', () => { 
            myId = socket.id; 
            socket.emit('enter_map', { userId: window.CURRENT_USER_ID, name: myName, skin: mySkin, map: 'city', x: startX, y: startY, direction: 'down' }); 
        });

        socket.on('map_state', (players) => { 
            document.querySelectorAll('.player').forEach(el => el.remove()); 
            players.forEach(createPlayer); 
            document.getElementById('loader').classList.remove('show');
        });
        
        socket.on('player_joined', (p) => { if(p.id !== myId) createPlayer(p); });
        
        socket.on('player_moved', (data) => {
            const el = document.getElementById(`p-${data.id}`);
            if (el) {
                const currX = parseFloat(el.style.left) || 50;
                const currY = parseFloat(el.style.top) || 50;
                const dist = Math.hypot(data.x - currX, data.y - currY);
                const time = dist > 0 ? (dist / MOVEMENT_SPEED) : 0;

                el.style.transition = `top ${time}s linear, left ${time}s linear`;
                void el.offsetWidth;
                el.style.left = data.x + '%';
                el.style.top = data.y + '%';
                el.style.zIndex = Math.floor(data.y); 

                // Sprite Direction
                const dx = data.x - currX;
                const dy = data.y - currY;
                if(Math.abs(dx) > Math.abs(dy)) el.setAttribute('data-dir', dx > 0 ? 'right' : 'left');
                else el.setAttribute('data-dir', dy > 0 ? 'down' : 'up');

                if (time > 0) {
                    el.classList.add('walking');
                    if (el.timeout) clearTimeout(el.timeout);
                    el.timeout = setTimeout(() => {
                        el.classList.remove('walking');
                        if (data.id === myId) isMoving = false;
                    }, time * 1000);
                } else if (data.id === myId) {
                    isMoving = false;
                }
            }
        });

        socket.on('player_left', (id) => { const el = document.getElementById(`p-${id}`); if(el) el.remove(); });

        function createPlayer(p) {
            const div = document.createElement('div');
            div.id = `p-${p.id}`;
            div.className = 'player';
            div.style.left = p.x + '%';
            div.style.top = p.y + '%';
            div.setAttribute('data-skin', p.skin || 'char1');
            div.innerHTML = `<div class="player-name">${p.name}</div>`;
            gameArea.appendChild(div);
        }

        // --- 5. INTERA√á√ÉO E EFEITOS ---
        function checkInteractions(destX, destY) {
            const myPlayer = document.getElementById(`p-${myId}`);
            if(!myPlayer) return;
            const currX = parseFloat(myPlayer.style.left);
            const currY = parseFloat(myPlayer.style.top);
            const dist = Math.hypot(destX - currX, destY - currY);
            const timeMs = (dist / MOVEMENT_SPEED) * 1000;

            setTimeout(() => {
                // SHOP (30, 43) - Toler√¢ncia de 6%
                if (isNear(destX, destY, 30, 43, 6)) {
                    enterBuilding('modalShop');
                }
                // HEAL (63, 64) - Toler√¢ncia de 6%
                else if (isNear(destX, destY, 63, 64, 6)) {
                    const p = document.getElementById(`p-${myId}`);
                    p.classList.add('entering-building');
                    healTeam();
                    setTimeout(() => p.classList.remove('entering-building'), 1200);
                }
                // SA√çDA SUL
                else if (destY > 94 && destX > 35 && destX < 65) {
                    goToForest();
                }
            }, timeMs);
        }

        function isNear(x1, y1, x2, y2, tol) {
            return Math.abs(x1 - x2) < tol && Math.abs(y1 - y2) < tol;
        }

        function enterBuilding(modalId) {
            const p = document.getElementById(`p-${myId}`);
            if(p) p.classList.add('entering-building');
            setTimeout(() => { document.getElementById(modalId).style.display = 'flex'; }, 300);
        }

        function exitBuilding(modalId) {
            document.getElementById(modalId).style.display = 'none';
            const p = document.getElementById(`p-${myId}`);
            if(p) {
                p.classList.remove('entering-building');
                // Pequeno ajuste para garantir que ele n√£o reative o gatilho imediatamente
                socket.emit('move_player', { x: parseFloat(p.style.left), y: parseFloat(p.style.top) + 2 });
            }
        }

        // --- API CALLS ---
        async function healTeam() {
            showToast('Curando Pok√©mons...', {bg: '#3498db'});
            try {
                await fetch('/api/heal', { 
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({userId: window.CURRENT_USER_ID}) 
                });
                setTimeout(() => showToast('Equipe recuperada!', {bg: '#2ecc71'}), 800);
            } catch(e) { showToast('Erro ao curar'); }
        }

        async function buyItem(item) {
            try {
                const res = await fetch('/api/buy-item', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userId: window.CURRENT_USER_ID, itemId: item, qty: 1 })
                });
                const d = await res.json();
                if(d.success) showToast('Item comprado!', {bg:'#2ecc71'});
                else showToast(d.error || 'Erro', {bg:'#e74c3c'});
            } catch(e) {}
        }

        function goToForest() {
            document.getElementById('loader').classList.add('show');
            window.location.href = '/forest?userId=' + window.CURRENT_USER_ID;
        }

        function handleGrassClick(e, grassId) {
            socket.emit('check_encounter', { grassId: grassId });
        }
        
        // Chat e Toast Helpers
        const chatIn = document.getElementById('chatInput');
        document.getElementById('chatSend').onclick = () => { if(chatIn.value.trim()) { socket.emit('send_chat', chatIn.value); chatIn.value=''; } };
        socket.on('chat_message', (d) => { const p = document.getElementById(`p-${d.id}`); if(p) { const b = document.createElement('div'); b.className='chat-bubble'; b.innerText=d.msg; p.appendChild(b); setTimeout(()=>b.remove(), 4000); }});
        function showToast(msg, opts={}) { const c = document.getElementById('toastContainer'); const d = document.createElement('div'); d.style.background = opts.bg || '#333'; d.style.color = '#fff'; d.style.padding = '10px 20px'; d.style.marginBottom = '10px'; d.style.borderRadius = '5px'; d.innerText = msg; c.appendChild(d); setTimeout(() => d.remove(), 3000); }
        
        socket.on('encounter_found', () => {
             showToast('‚öîÔ∏è Batalha encontrada!', {bg:'#e74c3c'});
             document.getElementById('loader').classList.add('show');
             setTimeout(() => {
                 fetch('/battle/wild', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({userId: window.CURRENT_USER_ID, currentMap: 'city'}) }).then(r=>r.json()).then(d => { if(d.battleId) window.location.href = '/battle/' + d.battleId; });
             }, 1000);
        });
    </script>
</body>
</html>
